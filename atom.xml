<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>鴻塵</title>
  
  
  <link href="https://hwame.top/atom.xml" rel="self"/>
  
  <link href="https://hwame.top/"/>
  <updated>2023-03-04T04:06:52.663Z</updated>
  <id>https://hwame.top/</id>
  
  <author>
    <name>鴻塵</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>归去来兮辞（并序）——陶渊明</title>
    <link href="https://hwame.top/20230304/returning-going-and-coming-back-home.html"/>
    <id>https://hwame.top/20230304/returning-going-and-coming-back-home.html</id>
    <published>2023-03-04T04:05:30.000Z</published>
    <updated>2023-03-04T04:06:52.663Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>Go语言中的通道</title>
    <link href="https://hwame.top/20220327/channel-and-goroutine-in-go.html"/>
    <id>https://hwame.top/20220327/channel-and-goroutine-in-go.html</id>
    <published>2022-03-27T11:06:16.000Z</published>
    <updated>2022-03-27T12:00:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：看完这篇，Go语言的通道及Goroutine你就都会了…<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章链接：</strong><a href="https://hwame.top/20220327/channel-and-goroutine-in-go.html">https://hwame.top/20220327/channel-and-goroutine-in-go.html</a><br><strong>原文链接：</strong><a href="https://mp.weixin.qq.com/s/-N1qUEE090wMpI6TWmFTWg">https://mp.weixin.qq.com/s/-N1qUEE090wMpI6TWmFTWg</a><br><strong>参考资料：</strong></p><ul><li><a href="https://mp.weixin.qq.com/s/-N1qUEE090wMpI6TWmFTWg">看完这篇，Go语言的通道及Goroutine你就都会了</a></li><li><a href="https://www.jb51.net/article/228730.htm">Go语言七篇入门教程四：通道及Goroutine</a></li><li><a href="https://learnku.com/go/t/31890">深入学习 Go 并发编程之通道</a></li></ul></blockquote><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>在go社区有这样一句话：不要通过共享内存来通信，而是通过通信来共享内存。</p><p>go官方是建议使用管道通信的方式来进行并发。<br> <strong>通道</strong>  是用于协程间交流的通信载体。严格地来说，通道就是数据传输的管道，数据通过这根管道被 “传入” 或被 “读出”。 因此协程可以发送数据到通道中，而另一个协程可以从该通道中读取数据。</p><p>在这里就要引入一个新名词： <strong>协程</strong><br>将线程再细分为多个协程，比如说是一条流水线上的多人协作。那么就可以减少各个线程内部的等待时间。</p><h2 id="2-通道简介"><a href="#2-通道简介" class="headerlink" title="2.通道简介"></a>2.通道简介</h2><p>Go 提供一个 chan 关键词去创建一个通道。一个通道只能传入一种类型的数据，其他的数据类型不允许被传输。<br><img src="https://img.jbzj.com/file_images/article/202111/2021110914311155.png" alt="picture"></p><p>将线程再分成更细的协程，使得中间等待时候更少，提高效率！</p><p><img src="https://img.jbzj.com/file_images/article/202111/2021110914311156.png" alt="picture"></p><h3 id="2-1-声明"><a href="#2-1-声明" class="headerlink" title="2.1.声明"></a>2.1.声明</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> channel <span class="keyword">chan</span> <span class="type">int</span></span><br><span class="line">    <span class="comment">//声明了一个可以传入 int 类型数据的通道 channel 。</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(channel)  </span><br><span class="line">    <span class="comment">//程序会打印nil, 因为通道的 0 值是 nil。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一个 nil 通道是没有用的。你不能向它传递数据或者读取数据。<br>因此，我们必须使用 make 函数器创建一个可以使用的通道。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>) </span><br><span class="line">    <span class="comment">//声明了一个可以传入 int 类型数据的通道 channel 。</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(channel)  </span><br><span class="line">    <span class="comment">//程序会打印channel的地址。 0xc0000180c0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它是一个指针内存地址。通道变量默认是一个指针。多数情况下，当你想要和一个协程沟通的时候，你可以给函数或者方法传递一个通道作为参数。当从协程接收到通道参数后，你不需要再对其进行解引用就可以从通道接收或者发送数据。</p><h3 id="2-2-读写"><a href="#2-2-读写" class="headerlink" title="2.2.读写"></a>2.2.读写</h3><p>Go 语言提供一个非常简洁的左箭头语法  <code>&lt;-</code>  去从通道读写数据。<br>有变量接受管道值<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel &lt;- data</span><br></pre></td></tr></table></figure></p><p>上面的代码意味着我们想要把 data 数据推入到通道 channel 中，注意看箭头的指向。</p><p>它表明是从 data数据 to到 通道 channel。因此我们可以当作我们正在把 data 推入到通道 channel。<br>无变量接受管道值<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;- data</span><br></pre></td></tr></table></figure></p><p>这个语句不会把数据传输给任何变量，但是仍然是一个有效的语句。</p><p>上面的通道操作默认是阻塞的。<br>在以前的课程中，我们知道可以使用 time.Sleep 去阻塞一个通道。通道操作本质上是阻塞的。当一些数据被写入通道，对应的协程将阻塞直到有其他的协程可以从此通道接收数据。</p><p>通道操作会通知调度器去调度其他的协程，这就是为什么程序不会一直阻塞在一个协程。通道的这些特性在不同的协程沟通的时候非常有用，它避免了我们使用锁或者一些 hack 手段去达到阻塞协程的目的。</p><h3 id="2-3-通道详解"><a href="#2-3-通道详解" class="headerlink" title="2.3.通道详解"></a>2.3.通道详解</h3><h4 id="2-3-1-例子"><a href="#2-3-1-例子" class="headerlink" title="2.3.1.例子"></a>2.3.1.例子</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Rush</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Hello &quot;</span>+ &lt;-c + <span class="string">&quot;!&quot;</span>)</span><br><span class="line">    <span class="comment">// 声明一个函数 greet, 这个函数的参数 c 是一个 string 类型的通道。</span></span><br><span class="line">    <span class="comment">// 在这个函数中，我们从通道 c 中接收数据并打印到控制台上。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Main Start&quot;</span>) </span><br><span class="line">    <span class="comment">// main 函数的第一个语句是打印 main start 到控制台。</span></span><br><span class="line"></span><br><span class="line">    channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    <span class="comment">// 在 main 函数中使用 make 函数创建一个 string 类型的通道赋值给 ‘ channel &#x27; 变量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> Rush(channel)        </span><br><span class="line">    <span class="comment">// 把 channel 通道传递给 greet 函数并用 go 关键词以协程方式运行它。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此时，程序有两个协程并且正在调度运行的是 main goroutine 主函数 </span></span><br><span class="line"></span><br><span class="line">    channel &lt;- <span class="string">&quot;DEMO&quot;</span></span><br><span class="line">       </span><br><span class="line">    <span class="comment">// 给通道 channel 传入一个数据 DEMO.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此时主线程将阻塞直到有协程接收这个数据. Go 的调度器开始调度 greet 协程接收通道 channel 的数据 </span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;Main Stop&quot;</span>)   </span><br><span class="line">    <span class="comment">// 然后主线程激活并且执行后面的语句，打印 main stopped</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Main Start</span></span><br><span class="line"><span class="comment">Hello DEMO!</span></span><br><span class="line"><span class="comment">Main Stop</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h4 id="2-3-2-死锁"><a href="#2-3-2-死锁" class="headerlink" title="2.3.2.死锁"></a>2.3.2.死锁</h4><p><img src="https://img.jbzj.com/file_images/article/202111/2021110914311257.png" alt="picture"></p><p>当通道读写数据时，所在协程会阻塞并且调度控制权会转移到其他未阻塞的协程。<br>如果当前协程正在从一个没有任何值的通道中读取数据，那么当前协程会阻塞并且等待其他协程往此通道写入值。</p><p>因此，读操作将被阻塞。类似的，如果你发送数据到一个通道，它将阻塞当前协程直到有其他协程从通道中读取数据。此时写操作将阻塞 。</p><p>下面是一个主线程在进行通道操作的时候造成死锁的例子<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main start&quot;</span>)</span><br><span class="line">    <span class="comment">// main 函数的第一个语句是打印 main start 到控制台。</span></span><br><span class="line"></span><br><span class="line">    channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    <span class="comment">// 在 main 函数中使用 make 函数创建一个 string 类型的通道赋值给 ‘ channel &#x27; 变量</span></span><br><span class="line"></span><br><span class="line">    channel &lt;- <span class="string">&quot;GoLang&quot;</span></span><br><span class="line">    <span class="comment">// 给通道 channel 传入一个数据 DEMO.</span></span><br><span class="line">    <span class="comment">// 此时主线程将阻塞直到有协程接收这个数据. Go 的调度器开始调度协程接收通道 channel 的数据</span></span><br><span class="line">    <span class="comment">// 但是由于没有协程接受，没有协程是可被调度的。所有协程都进入休眠状态，即是主程序阻塞了。</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">报错</span></span><br><span class="line"><span class="comment">main start</span></span><br><span class="line"><span class="comment">fatal error: all goroutines are asleep - deadlock!  //所有协程都进入休眠状态,死锁</span></span><br><span class="line"><span class="comment">goroutine 1 [chan send]:</span></span><br><span class="line"><span class="comment">main.main()</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p><h4 id="2-3-3-关闭通道"><a href="#2-3-3-关闭通道" class="headerlink" title="2.3.3.关闭通道"></a>2.3.3.关闭通道</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RushChan</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    &lt;- c</span><br><span class="line">    fmt.Println(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    &lt;- c</span><br><span class="line">    fmt.Println(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main start&quot;</span>)</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> RushChan(c)</span><br><span class="line">    c &lt;- <span class="string">&quot;Demo1&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(c)</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    不能向一个关了的channel发信息</span></span><br><span class="line"><span class="comment">    main start</span></span><br><span class="line"><span class="comment">    panic: send on closed channel</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    c &lt;- <span class="string">&quot;Demo2&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//close(c)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    close 放这里的话可以</span></span><br><span class="line"><span class="comment">    main start</span></span><br><span class="line"><span class="comment">    1</span></span><br><span class="line"><span class="comment">    2</span></span><br><span class="line"><span class="comment">    Main Stop</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;Main Stop&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一个操作  <code>c &lt;- &quot;Demo2&quot;</code>  将阻塞协程直到有其他协程从此通道中读取数据，因此 greet 会被调度器调度执行。<br>第一个操作  <code>&lt;-c</code>  是非阻塞的 因为现在通道 <code>c</code> 有数据可读。<br>第二个操作  <code>&lt;-c</code> 将被阻塞因为通道 <code>c</code> 已经没数据可读.<br>此时 <code>main</code> 协程将被激活并且程序执行 <code>close(c)</code> 关闭通道操作。</p><h4 id="2-3-4-缓冲区"><a href="#2-3-4-缓冲区" class="headerlink" title="2.3.4.缓冲区"></a>2.3.4.缓冲区</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> Type, n)</span><br></pre></td></tr></table></figure><p>当缓冲区参数不是 0 的时候。协程将不会阻塞除非缓冲区被填满。</p><p>当缓冲区满了之后，想要再往缓冲区发送数据只有等到有其他协程从缓冲区接收数据， 此时的发送协程是阻塞的。</p><p>有一点需要注意， 读缓冲区的操作是渴望式读取，意味着一旦读操作开始它将读取缓冲区所有数据，直到缓冲区为空。</p><p>原理上来说读操作的协程将不会阻塞直到缓冲区为空。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RushChan</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        val ,_ := &lt;-c</span><br><span class="line">        fmt.Println(val)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Main Start&quot;</span>)</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> RushChan(c)</span><br><span class="line">    c &lt;- <span class="string">&quot;Demo1&quot;</span></span><br><span class="line">    <span class="comment">//结果1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//c &lt;- &quot;Demo2&quot;  //结果2</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;Main Stop&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果1：</span></span><br><span class="line"><span class="comment">Main Start</span></span><br><span class="line"><span class="comment">Main Stop</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果2：</span></span><br><span class="line"><span class="comment">Main Start</span></span><br><span class="line"><span class="comment">Join</span></span><br><span class="line"><span class="comment">Mike</span></span><br><span class="line"><span class="comment">Main Stop</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p><p>由于这是一个缓冲的通道，当我只有 <code>c &lt;- Demo1</code> 的时候，这里面只是满了，但是是不会阻塞的。所以子协程接受到了这个数据 <code>Demo1</code> ，但是由于是非阻塞，所以主线程没有被阻塞，并没有等子协程完成就结束了，结果1就是这样出现了。</p><p>当加多一个 <code>c &lt;- Demo2</code>  的时候，这时就要等缓冲区空了，也就是等有协程把 <code>Demo1</code> 读取，所以就会导致主线程阻塞，此时的结果就是结果2了。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RushChan</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        val ,_ := &lt;-c</span><br><span class="line">        fmt.Println(val)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>,<span class="number">3</span>)</span><br><span class="line">    c &lt;- <span class="number">1</span></span><br><span class="line">    c &lt;- <span class="number">2</span></span><br><span class="line">    c &lt;- <span class="number">3</span></span><br><span class="line">    <span class="built_in">close</span>(c)</span><br><span class="line">    <span class="keyword">for</span> elem := <span class="keyword">range</span> c &#123;</span><br><span class="line">        fmt.Println(elem)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里虽然关闭了通道，但是其实数据不仅在通道里面，数据还在缓冲区中的，我们依然可以读取到这个数据。</p><h4 id="2-3-5-通道的长度和容量"><a href="#2-3-5-通道的长度和容量" class="headerlink" title="2.3.5.通道的长度和容量"></a>2.3.5.通道的长度和容量</h4><p>和切片类似，一个缓冲通道也有长度和容量。<br>通道的长度是其内部缓冲队列未读的数据量，而通道的容量是缓冲区可最大盛放的数据量。</p><p>我们可以使用 len 函数去计算通道的长度，使用 cap 函数去获得通道的容量。和切片用法神似<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RushChan</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        val ,_ := &lt;-c</span><br><span class="line">        fmt.Println(val)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>,<span class="number">3</span>)</span><br><span class="line">    c &lt;- <span class="number">1</span></span><br><span class="line">    c &lt;- <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;长度： &quot;</span>,<span class="built_in">len</span>(c))</span><br><span class="line">    fmt.Println(&lt;-c)</span><br><span class="line">    fmt.Println(<span class="string">&quot;长度： &quot;</span>,<span class="built_in">len</span>(c))</span><br><span class="line">    fmt.Println(&lt;-c)</span><br><span class="line">    fmt.Println(<span class="string">&quot;长度： &quot;</span>,<span class="built_in">len</span>(c))</span><br><span class="line">    fmt.Println(<span class="string">&quot;容量： &quot;</span>,<span class="built_in">cap</span>(c))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">长度：  2</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">长度：  1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">长度：  0</span></span><br><span class="line"><span class="comment">容量：  3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p><p>这个 c 通道容量为 3，但只盛放了 2 个数据。Go 就不用去阻塞主线程去调度其他协程。你也可以在主线程中去读取这些数据，因为虽然通道没有放满，也不会阻止你去从通道读取数据。</p><h4 id="2-3-6-单向通道"><a href="#2-3-6-单向通道" class="headerlink" title="2.3.6.单向通道"></a>2.3.6.单向通道</h4><p>目前为止，我们已经学习到可以双向传递数据的通道，或者说，我们可以对通道做读操作和写操作。但是事实上我们也可以创建单向通道。比如只读通道只允许读操作，只写通道只允许写操作。<br>单向通道也可以使用 make 函数创建，不过需要额外加一个箭头语法。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">roc := <span class="built_in">make</span>(&lt;-<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">soc := <span class="built_in">make</span>(<span class="keyword">chan</span>&lt;- <span class="type">int</span>)</span><br></pre></td></tr></table></figure></p><p>在上面的程序中， roc 是一个只读通道，<code>&lt;-</code> 在 chan 关键词前面。 soc is 只写通道，<code>&lt;-</code> 在 chan 关键词后面。 他们也算不同的数据类型。</p><p>但是单向通道有什么作用呢 ?<br>使用单向通道可以 提高程序的类型安全性， 使得程序不容易出错。</p><p>但是假如你在一个协程中只需要读操作某通道，但是在主线程中却需要读写操作这个通道该怎么办呢？</p><p>幸运的是 Go 提供了一个简单的语法去把双向通道转化为单向通道。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">greet</span><span class="params">(roc &lt;-<span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Hello &quot;</span> + &lt;-roc ,<span class="string">&quot;!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Main Start&quot;</span>)</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    <span class="keyword">go</span> greet(c)</span><br><span class="line">    c &lt;- <span class="string">&quot;Demo&quot;</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;Main Stop&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果</span></span><br><span class="line"><span class="comment">Main Start</span></span><br><span class="line"><span class="comment">Hello Demo !</span></span><br><span class="line"><span class="comment">Main Stop</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p><p>我们修改 greet 协程函数，把参数 c 类型从双向通道改成单向接收通道。<br>现在我们只能从通道中读取数据，通道上的任何写入操作将会发生错误：</p><blockquote><p><code>“invalid operation: roc &lt;- “Temp” (send to receive-only type &lt;-chan string)”.</code></p></blockquote><p><img src="https://img.jbzj.com/file_images/article/202111/2021110914311258.png" alt="picture"></p><h4 id="2-3-7-Select"><a href="#2-3-7-Select" class="headerlink" title="2.3.7.Select"></a>2.3.7.Select</h4><p>select 和 switch 很像，它不需要输入参数，并且仅仅被使用在通道操作上。<br>Select 语句被用来执行多个通道操作的一个和其附带的 case 块代码。</p><p>原理</p><p>让我们来看下面的例子，讨论下其执行原理<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> start time.Time</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    start = time.Now()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service1</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">    c &lt;- <span class="string">&quot;Hello from service 1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service2</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">    c &lt;- <span class="string">&quot;Hello from service 2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main start&quot;</span>, time.Since(start))</span><br><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    chan2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    <span class="keyword">go</span> service1(chan1)</span><br><span class="line">    <span class="keyword">go</span> service2(chan2)</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-chan1:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Response form service 1&quot;</span>, res, time.Since(start))</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-chan2:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Response form service 2&quot;</span>, res, time.Since(start))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop &quot;</span>,time.Since(start))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">main start 0s</span></span><br><span class="line"><span class="comment">Response form service 1 Hello from service 1 3.0018445s</span></span><br><span class="line"><span class="comment">main stop  3.0019815s</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p><p>从上面的程序来看，我们知道 select 语句和 switch 很像，不同点是用通道读写操作代替了布尔操作。通道将被阻塞，除非它有默认的 default 块 (之后将介绍)。一旦某个 case 条件执行，它将不阻塞。</p><p>所以一个 case 条件什么时候执行呢 ?</p><p>如果所有的 case 语句（通道操作）被阻塞，那么 select 语句将阻塞直到这些 case 条件的一个不阻塞（通道操作），case 块执行。<br>如果有多个 case 块（通道操作）都没有阻塞，那么运行时将随机选择一个不阻塞的 case 块立即执行。</p><p>为了演示上面的程序，我们开启两个协程并传入对应的通道变量。然后我们写一个带有两个 case 操作的 select 语句。 一个 case 操作从 chan1 读数据，另外一个从 chan2 读数据。这两个通道都是无缓冲的 , 读操作将被阻塞 。所以 select 语句将阻塞。因此 select 将等待，直到有 case 语句不阻塞。</p><ul><li>当程序执行到select语句后，主线程将阻塞并开始调度 service1 和service2协程。 service1 休眠 3 秒 后未阻塞的把数据写入通道 chan1 与其类似，service2等待 5 秒 后未阻塞的把数据写入通道chan2</li><li>因为 service1 比 service2 早一步执行完毕，case 1 将首先调度执行，其他的 cases 块 (这里指 case 2) 将被忽略。 一旦 case 块执行完毕， main 线程将开始继续执行。</li></ul><p>所以并没有输出case2的结果</p><p>上述程序真实模拟了一个数百万请求的服务器负载均衡的例子，它从多个有效服务中返回其中一个响应。<br>使用协程，通道和 select 语句，我们可以向多个服务器请求数据并获取其中最快响应的那个。</p><p>为了模拟上面哪个 case 块率先返回数据，我们可以直接去掉 Sleep 函数调用。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> start time.Time</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    start = time.Now()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service1</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    c &lt;- <span class="string">&quot;Hello from service 1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service2</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    c &lt;- <span class="string">&quot;Hello from service 2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main start&quot;</span>, time.Since(start))</span><br><span class="line"></span><br><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    chan2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> service1(chan1)</span><br><span class="line">    <span class="keyword">go</span> service2(chan2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-chan1:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Response form service 1&quot;</span>, res, time.Since(start))</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-chan2:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Response form service 2&quot;</span>, res, time.Since(start))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop &quot;</span>,time.Since(start))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果一：<br>main start 0s<br>Response form service 1 Hello from service 1 539.3µs<br>main stop 539.3µs<br>结果二：<br>main start 0s<br>Response form service 2 Hello from service 2 0s<br>main stop 0s</p></blockquote><p>结果一共有2个不同的结果</p><p>为了证明当所有 case 块都是非阻塞的时候，golang 会随机选择一个代码块执行打印 response，我们使用缓冲通道来改造程序。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> start time.Time</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    start = time.Now()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service1</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    c &lt;- <span class="string">&quot;Hello from service 1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service2</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    c &lt;- <span class="string">&quot;Hello from service 2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main start&quot;</span>, time.Since(start))</span><br><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>,<span class="number">2</span>)</span><br><span class="line">    chan2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>,<span class="number">2</span>)</span><br><span class="line">    chan1 &lt;- <span class="string">&quot;Value 1&quot;</span></span><br><span class="line">    chan1 &lt;- <span class="string">&quot;Value 2&quot;</span></span><br><span class="line">    chan2 &lt;- <span class="string">&quot;Value 1&quot;</span></span><br><span class="line">    chan2 &lt;- <span class="string">&quot;Value 2&quot;</span></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-chan1:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Response form service 1&quot;</span>, res, time.Since(start))</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-chan2:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Response form service 2&quot;</span>, res, time.Since(start))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop &quot;</span>,time.Since(start))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上述的程序的结果是有不同的</p><blockquote><p>结果一：<br>main start 0s<br>Response form service 1 Value 1 496.2µs<br>main stop 496.2µs<br>结果二：<br>main start 0s<br>Response form service 2 Value 1 0s<br>main stop 0s</p></blockquote><p>在上面的程序中，两个通道在其缓冲区中都有两个值。因为我们向容量为 2 的缓冲区通道分别发送了两个值，所以这些通道发送操作不会阻塞并且会执行下面的 select 块。 select 块中的所有 case 操作都不会阻塞，因为每个通道中都有两个值，而我们的 case 操作只需要取出其中一个值。因此，go 运行时会随机选择一个 case 操作并执行其中的代码。</p><h4 id="2-3-8-default-case-块"><a href="#2-3-8-default-case-块" class="headerlink" title="2.3.8.default case 块"></a>2.3.8.default case 块</h4><p>像 switch 一样， select 语句也有 default case 块。default case 块 是非阻塞的，不仅如此， default case 块可以使 select 语句永不阻塞，这意味着， 任何通道的 发送 和 接收 操作 (不管是缓冲或者非缓冲) 都不会阻塞当前线程。</p><p>如果有 case块的通道操作是非阻塞，那么 select会执行其case 块。如果没有那么 select将默认执行 default块.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> start time.Time</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    start = time.Now()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service1</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    c &lt;- <span class="string">&quot;Hello from service 1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service2</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    c &lt;- <span class="string">&quot;Hello from service 2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main start&quot;</span>, time.Since(start))</span><br><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    chan2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    <span class="keyword">go</span> service1(chan1)</span><br><span class="line">    <span class="keyword">go</span> service2(chan2)</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-chan1:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Response form service 1&quot;</span>, res, time.Since(start))</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-chan2:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Response form service 2&quot;</span>, res, time.Since(start))</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        fmt.Println(<span class="string">&quot;No Response received&quot;</span>,time.Since(start))</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop &quot;</span>,time.Since(start))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">main start 0s</span></span><br><span class="line"><span class="comment">No Response received 0s</span></span><br><span class="line"><span class="comment">main stop  0s</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><ul><li>在上面的程序中，因为通道是非缓冲的，case 块的通道操作都是阻塞的，所有 default 块将被执行。</li><li>如果上面的 select 语句没有 default 块，select 将阻塞，没有 response 会被打印出来，知道通道变成非阻塞。</li><li>如果带有 default, select 将是非阻塞的，调度器将不会从主线程转而调度其他协程。</li><li>但是我们可以使用 time.Sleep 改变这一点。 通过这种方式，主线程将把调度权转移到其他协程，在其他协程执行完毕后，调度权从新回到主线程手里。</li><li>当主线程重新执行的时候，通道里面已经有值了，case 操作将不会阻塞。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> start time.Time</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    start = time.Now()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service1</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;service1 start&quot;</span>)</span><br><span class="line">    c &lt;- <span class="string">&quot;Hello from service 1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service2</span><span class="params">(c <span class="keyword">chan</span> <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;service2 start&quot;</span>)</span><br><span class="line">    c &lt;- <span class="string">&quot;Hello from service 2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main start&quot;</span>, time.Since(start))</span><br><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    chan2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    <span class="keyword">go</span> service1(chan1)</span><br><span class="line">    <span class="keyword">go</span> service2(chan2)</span><br><span class="line">    time.Sleep(<span class="number">3</span>*time.Second)</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-chan1:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Response form service 1&quot;</span>, res, time.Since(start))</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-chan2:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Response form service 2&quot;</span>, res, time.Since(start))</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        fmt.Println(<span class="string">&quot;No Response received&quot;</span>,time.Since(start))</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop &quot;</span>,time.Since(start))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果不唯一。</span></span><br><span class="line"><span class="comment">main start 0s</span></span><br><span class="line"><span class="comment">service2 start</span></span><br><span class="line"><span class="comment">service1 start</span></span><br><span class="line"><span class="comment">Response form service 1 Hello from service 1 3.0006729s</span></span><br><span class="line"><span class="comment">main stop  3.0006729s</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h4 id="2-3-9-空-select"><a href="#2-3-9-空-select" class="headerlink" title="2.3.9.空 select"></a>2.3.9.空 select</h4><p>和 <code>for&#123;&#125;</code> 这样的空循环很像，空 <code>select&#123;&#125;</code> 语法也是有效的。但是有一点必须要说明。<br>我们知道 <code>select</code> 将被阻塞除非有 <code>case</code> 块没有阻塞。因为 <code>select&#123;&#125;</code> 没有 <code>case</code> 非阻塞语句，主线程将阻塞并可能会导致死锁。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Hello from service&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main started&quot;</span>)</span><br><span class="line">    <span class="keyword">go</span> service()</span><br><span class="line">    <span class="keyword">select</span> &#123;&#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果</span></span><br><span class="line"><span class="comment">main started</span></span><br><span class="line"><span class="comment">Hello from service</span></span><br><span class="line"><span class="comment">fatal error: all goroutines are asleep - deadlock!</span></span><br><span class="line"><span class="comment">goroutine 1 [select (no cases)]:</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p><img src="https://img.jbzj.com/file_images/article/202111/2021110914311259.png" alt="死锁"></p><p>在上面的程序中我们知道 select 将阻塞 main 线程，调度器将会调度 service 这个协程。在 service 执行完毕后，调度器会再去调度其他可用的协程，但是此时已经没有可用的协程，主线程也正在阻塞，所以最后的结果就是发生死锁.</p><h4 id="2-3-10-Deadlock"><a href="#2-3-10-Deadlock" class="headerlink" title="2.3.10.Deadlock"></a>2.3.10.Deadlock</h4><p>default 块在通道操作阻塞的时候是非常有用的，他可以避免死锁。 同时由于 default块的非阻塞特性，Go 可以避免在其他协程阻塞的时候去调度其他协程，从而避免死锁。<br>通道的发送操作也类似，， default 可以在其他协程不能被调度的时候被执行，从而避免死锁。</p><h4 id="2-3-11-nil通道"><a href="#2-3-11-nil通道" class="headerlink" title="2.3.11.nil通道"></a>2.3.11.nil通道</h4><h3 id="2-4-多协程协同工作"><a href="#2-4-多协程协同工作" class="headerlink" title="2.4.多协程协同工作"></a>2.4.多协程协同工作</h3><p>写两个协程，一个用来计算数字的平方，另一个用来计算数字的立方。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">square</span><span class="params">(c <span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;[square] reading&quot;</span>)</span><br><span class="line">    num := &lt;-c</span><br><span class="line">    c &lt;- num * num</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cube</span><span class="params">(c <span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;[cube] reading&quot;</span>)</span><br><span class="line">    num := &lt;-c</span><br><span class="line">    c &lt;- num * num * num</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;[main] main started&quot;</span>)</span><br><span class="line">    squareChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">    cubeChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">    <span class="keyword">go</span> square(squareChan)</span><br><span class="line">    <span class="keyword">go</span> cube(cubeChan)</span><br><span class="line">    testNum := <span class="number">3</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;[main] send testNum to squareChan&quot;</span>)</span><br><span class="line">    squareChan &lt;- testNum</span><br><span class="line">    fmt.Println(<span class="string">&quot;[main] resuming&quot;</span>)</span><br><span class="line">    fmt.Println(<span class="string">&quot;[main] send testNum to cubeChane&quot;</span>)</span><br><span class="line">    cubeChan &lt;- testNum</span><br><span class="line">    fmt.Println(<span class="string">&quot;[main] resuming&quot;</span>)</span><br><span class="line">    fmt.Println(<span class="string">&quot;[main] reading from channels&quot;</span>)</span><br><span class="line">    squareVal,cubeVal := &lt;-squareChan, &lt;-cubeChan</span><br><span class="line">    sum := squareVal + cubeVal</span><br><span class="line">    fmt.Println(<span class="string">&quot;[main] sum of square and cube of&quot;</span>,testNum,<span class="string">&quot; is&quot;</span>,sum)</span><br><span class="line">    fmt.Println(<span class="string">&quot;[main] main stop&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">[main] main started</span></span><br><span class="line"><span class="comment">[main] send testNum to squareChan</span></span><br><span class="line"><span class="comment">[cube] reading</span></span><br><span class="line"><span class="comment">[square] reading</span></span><br><span class="line"><span class="comment">[main] resuming</span></span><br><span class="line"><span class="comment">[main] send testNum to cubeChane</span></span><br><span class="line"><span class="comment">[main] resuming</span></span><br><span class="line"><span class="comment">[main] reading from channels</span></span><br><span class="line"><span class="comment">[main] sum of square and cube of 3  is 36</span></span><br><span class="line"><span class="comment">[main] main stop</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p><p>流程：</p><p>创建两个函数 square 和 cube 作为协程运行。</p><p>两个函数都有一个 int 类型通道参数c，从 c 中读取数据到变量num，最后把计算的数据再写入到通道 c 中。</p><p>在主线程中使用 make函数创建两个 int类型通道 squareChan and cubeChan然后分别运行square和cube 协程。因为调度权还在主线程，所以执行testNumb 赋值为 3。</p><p>然后我们把数据放入通道 squareChan 。主线程将阻塞直到通道的数据被读取。 一旦通道的数据被读取，主线程将继续执行。</p><p>在主线程中我们试图从这两个通道中读取数据，此时线程可能阻塞直到有数据写入到通道。这里我们使用:=语法来接收多个通道的值。</p><p>一旦这些协程把数据写入到通道，主线程将阻塞。当数据被写入通道中，主线程将继续执行，最后我们计算出数字的总和并打印到控制台。</p><h3 id="2-5-WaitGroup"><a href="#2-5-WaitGroup" class="headerlink" title="2.5.WaitGroup"></a>2.5.WaitGroup</h3><p>有一种业务场景是你需要知道所有的协程是否已执行完成他们的任务。这个和只需要随机选择一个条件为true 的 select 不同，他需要你满足所有的条件都是 true 才可以激活主线程继续执行。 这里的条件指的是非阻塞的通道操作。</p><h4 id="2-5-1-简介"><a href="#2-5-1-简介" class="headerlink" title="2.5.1.简介"></a>2.5.1.简介</h4><p>WaitGroup 是一个带着计数器的结构体，这个计数器可以追踪到有多少协程创建，有多少协程完成了其工作。当计数器为 0 的时候说明所有协程都完成了其工作。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">service</span><span class="params">(wg *sync.WaitGroup, instance <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">    fmt.Println(<span class="string">&quot;Service called on instance&quot;</span>,instance)</span><br><span class="line">    wg.Done() <span class="comment">//协程数-1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main started&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">1</span>;i&lt;= <span class="number">3</span>; i++&#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> service(&amp;wg,i)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()<span class="comment">//阻塞</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：(结果是不唯一的，一共有3!次可能的结果)</span></span><br><span class="line"><span class="comment">main started</span></span><br><span class="line"><span class="comment">Service called on instance 2</span></span><br><span class="line"><span class="comment">Service called on instance 1</span></span><br><span class="line"><span class="comment">Service called on instance 3</span></span><br><span class="line"><span class="comment">main stop</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>在上面的程序中，我们创建了一个sync.WaitGroup 类型的空结构体 (带着 0 值字段) wg 。 WaitGroup 结构体有一些像 noCopy, state1 和 sema 这样的内部字段。 这个结构体也有三个公开方法： Add, Wait 和 Done.</p><ul><li>Add 方法的参数是一个变量名叫 delta 的int 类型参数，主要用来内部计数。 内部计数器默认值为 0. 它用于记录多少个协程在运行。</li><li>当 WaitGroup创建后，计数器值为 0，我们可以通过给 Add方法传 int类型值来增加它的数量。 记住， 当协程建立后，计数器的值不会自动递增 ，因此需要我们手动递增它。</li><li>Wait 方法用来阻塞当前协程。一旦计数器为 0, 协程将恢复运行。 因此，我们需要一个方法去降低计数器的值。<br>Done 方法可以降低计数器的值。他不接受任何参数，因此，它每执行一次计数器就减 1。</li></ul><p>上面的例子中，我们在创建 wg 变量后，运行了三次 for 循环，每次运行的时候我们创建一个协程并给计数器加 1。</p><p>这意味着现在我们有三个协程在等待运行并且 WaitGroup 的计数器值为 3。注意我们传给协程函数的是一个指针，这是因为一旦在协程内部工作完成后，我们需要通过调用Done方法去降低计数器的值。</p><p>如果 wg 通过值复制方式传过去， 因为传递的是一个拷贝，主线程中的 wg将不会得到修改。</p><p>在 for 循环执行完成后，我们通过调用 wg.Wait()去阻塞当前主线程，并把调度权让给其他协程，直到计数器值为 0 之后，主线程才会被再次调度。</p><p>我们在另外三个协程中通过Done方法把计数器值降为 0，此时主线程将再次被调度并开始执行之后的代码。</p><h4 id="2-5-2-工作池"><a href="#2-5-2-工作池" class="headerlink" title="2.5.2.工作池"></a>2.5.2.工作池</h4><p>顾名思义，一个工作池并发执行某项工作的协程集合。 在上面，我们已经用到的多个协程执行一个任务，但是他们并没有执行特定的工作，只是 sleep 了一下。 如果你向协程中传一个通道，他们可以去完成一些工作，变成一个工作池。</p><p>所以工作池其实就是维护了多个工作协程，这些协程的功能是可以收到任务，执行任务并返回结果。他们完成任务后我们就可以收到结果。这些协程使用相同的通道来达到自己的目的。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sqrWorker</span><span class="params">(tasks &lt;-<span class="keyword">chan</span> <span class="type">int</span>, results <span class="keyword">chan</span> &lt;-<span class="type">int</span>, instance <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> num := <span class="keyword">range</span> tasks &#123;</span><br><span class="line">        time.Sleep(time.Millisecond) <span class="comment">//阻塞</span></span><br><span class="line">        fmt.Printf(<span class="string">&quot;[worker %v ] Sending result by worker %v \n&quot;</span>,instance,instance)</span><br><span class="line">        results &lt;- num*num</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main started&quot;</span>)</span><br><span class="line">    tasks := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>,<span class="number">10</span>)</span><br><span class="line">    results := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>,<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++&#123;</span><br><span class="line">        <span class="keyword">go</span> sqrWorker(tasks,results,i)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">        tasks &lt;- i*<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;[main] write 5 tasks&quot;</span>)</span><br><span class="line">    <span class="built_in">close</span>(tasks)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">        result := &lt;-results</span><br><span class="line">        fmt.Println(<span class="string">&quot;[main] Result&quot;</span> , i , <span class="string">&quot;:&quot;</span>, result)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">//结果之一</span></span><br><span class="line"><span class="comment">[main] write 5 tasks</span></span><br><span class="line"><span class="comment">[worker 0 ] Sending result by worker 0 </span></span><br><span class="line"><span class="comment">[worker 1 ] Sending result by worker 1 </span></span><br><span class="line"><span class="comment">[worker 2 ] Sending result by worker 2 </span></span><br><span class="line"><span class="comment">[main] Result 0 : 4</span></span><br><span class="line"><span class="comment">[main] Result 1 : 16</span></span><br><span class="line"><span class="comment">[main] Result 2 : 0</span></span><br><span class="line"><span class="comment">[worker 1 ] Sending result by worker 1 </span></span><br><span class="line"><span class="comment">[main] Result 3 : 64</span></span><br><span class="line"><span class="comment">[worker 0 ] Sending result by worker 0 </span></span><br><span class="line"><span class="comment">[main] Result 4 : 36</span></span><br><span class="line"><span class="comment">main stop</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>sqrWorker 是一个带有 tasks 通道，results 通道 和 id 三个参数的协程函数。这个协程函数的任务是把从 tasks 通道接收到的数字的平方发送到 results通道。</p><p>在主函数中，我们创建了两个带缓冲区，容量为 10 的通道tasks and result。因此在缓冲区被充满之前，任何操作都是非阻塞的。所以有时候设置一个大点的缓冲区是个好办法。</p><p>然后我们循环创建多个 sqrWorker 协程，并传入 tasks 通道， results 通道 和 id 三个参数，用来传递和获取协程执行前后的数据。</p><p>接着我们向 tasks 非阻塞通道放入 5 个任务数据。</p><p>因为我们已经向任务通道放入的数据，所以我们可以关闭它，虽然这个操作不是必须的，但是如果以后运行中出现错误的话可以防止通道 range 带来的死锁问题。</p><p>然后我们开启循环 5 次从 results 通道接收数据，因为目前通道缓冲区没有数据，所以通道读取操作造成主线程阻塞，调度器将调度工作池的协程，直到有数据添加到 results通道。</p><p>当前我们有 3 个work 协程在工作，我们使用了 sleep 操作来模拟阻塞操作，所以调度器在某一个阻塞的时候会去调用其他的 work 协程，当某个 work 协程 sleep 完成后会把计算数字的平方的结果数据放入 results 缓冲无阻塞通道。</p><p>当 3 个协程依次交替把 task 通道的任务都完成后，for range 循环将完成，并且因为之前我们已经关闭了任务通道，所以协程也不会发生死锁。调度器将继续返回调度主线程。</p><p>有时候所有的工作协程可能都在阻塞，此时调度器将去调度主线程，直到 results 通道再次为空。</p><p>当所有 work 协程都完成任务退出后，主线程将继续拿到调度权并打印 results 通道剩下的数据，继续之后代码的执行。</p><h4 id="2-5-3-Mutex"><a href="#2-5-3-Mutex" class="headerlink" title="2.5.3.Mutex"></a>2.5.3.Mutex</h4><p>互斥是 Go 中一个简单的概念。在我解释它之前，先要明白什么是竞态条件。 goroutines 都有自己的独立的调用栈，因此他们之间不分享任何数据。但是有一种情况是数据存放在堆上，并且被多个 goroutines 使用。 多个 goroutines 试图去操作一个内存区域的数据会造成意想不到的后果.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> i <span class="type">int</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(wg *sync.WaitGroup)</span></span> &#123;</span><br><span class="line">    i = i+<span class="number">1</span></span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main started&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++&#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> worker(&amp;wg)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop&quot;</span>,i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果是不同的！！</span></span><br><span class="line"><span class="comment">main started</span></span><br><span class="line"><span class="comment">main stop 985</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>i = i + 1 这个计算有 3 步<br>(1) 得到 i 的值<br>(2) 给 i 的值加 1<br>(3) 更新 i 的值</p><p>这里发生很多事情，因为go是协程，这三步里面不一定都是同时顺序执行的。有可能A是顺利执行，使得i=2，但是B是读取的是A没更新的之前的i也就是1，所以就是结果会小于等于1000的，</p><p>除非一个协程阻塞，否则其他协程是没有机会获得调度的。那么 i = i + 1 也没有阻塞，为什么 Go 的调度器会去调度其他协程呢？</p><p>在任何情况下，都不应该依赖 Go 的调度算法，而应该实现自己的逻辑来同步不同的 goroutine.</p><p>实现方法之一就是使用我们上面提到的互斥锁。互斥锁是一个编程概念，它保证了在同一时间只能有一个线程或者协程去操作同一个数据。当一个协程想要操作数据的时候，必须获取该数据的一个锁，操作完成后必须释放锁，如果没有获取到该数据的锁，那么就不能操作这个数据。</p><p>在 Go 中，互斥数据结构 ( map) 由 sync 包提供。在 Go 中，多协程去操作一个值都可能会引起竞态条件。我们需要在操作数据之前使用 mutex.Lock() 去锁定它，一旦我们完成操作，比如上面提到的 i = i + 1, 我们就可以使用 mutext.Unlock() 方法解锁。</p><p>如果在锁定的时候，有一个协程想要读写 i 的值，那么此协程将阻塞 直到前面的协程完成操作并解锁数据。因此在某一时刻有且仅有一个协程可以操作数据，从而避免竞态条件。记住，任何锁之间的变量在解锁之前对于其他协程都不是可用的。</p><p>让我们使用互斥锁修改上面的例子：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> i <span class="type">int</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(wg *sync.WaitGroup,m *sync.Mutex)</span></span> &#123;</span><br><span class="line">    m.Lock()</span><br><span class="line">    i = i+<span class="number">1</span></span><br><span class="line">    m.Unlock()</span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;main started&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    <span class="keyword">var</span> m sync.Mutex</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++&#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> worker(&amp;wg,&amp;m)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;main stop&quot;</span>,i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*结果</span></span><br><span class="line"><span class="comment">main started</span></span><br><span class="line"><span class="comment">main stop 1000</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>在上面的程序中，我们创建了一个互斥锁变量 m，并把它的指针传递给所有已创建的协程。<br>在协程内部，当我们要开始操作 i变量的时候，我们先通过 m.Lock()获得锁，操作完成后我们使用 m.Unlock()释放锁。<br>互斥锁可以帮助我们解决竞态条件。 但首要规则是避免 goroutine 之间共享资源。<br>所以官方建议不要共享内存并发，而是通过管道通信的方式并发。</p><h2 id="3-结语"><a href="#3-结语" class="headerlink" title="3.结语"></a>3.结语</h2><p>后部分go并发知识是参考作者summar的go并发以及书上的知识点，非常感谢作者的翻译工作，使得我能更好的理解go的channel并发机制！链接点这里<a href="https://learnku.com/go/t/31890">channel</a></p><p>随着业务的不断扩大，并发能更好的发挥服务器的性能。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：看完这篇，Go语言的通道及Goroutine你就都会了…</summary>
    
    
    
    <category term="Go" scheme="https://hwame.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hwame.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>Go语言什么时候使用指针</title>
    <link href="https://hwame.top/20220323/when-to-use-pointer-in-go.html"/>
    <id>https://hwame.top/20220323/when-to-use-pointer-in-go.html</id>
    <published>2022-03-23T12:49:57.000Z</published>
    <updated>2022-03-23T15:48:45.000Z</updated>
    
    <content type="html"><![CDATA[<style>    img {        display: inline !important;    }</style><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章链接：</strong><a href="https://hwame.top/20220323/when-to-use-pointer-in-go.html">https://hwame.top/20220323/when-to-use-pointer-in-go.html</a><br><strong>原文链接：</strong><a href="https://mp.weixin.qq.com/s/FQ83qRBb985FHB-0ttIYCQ">https://mp.weixin.qq.com/s/FQ83qRBb985FHB-0ttIYCQ</a><br><strong>文章说明：</strong>文章使用Go程序将<a href="https://mp.weixin.qq.com/s/FQ83qRBb985FHB-0ttIYCQ">微信公众号文章</a>转换为Markdown格式。<br><strong>参考资料：</strong></p><ul><li><a href="https://mp.weixin.qq.com/s/FQ83qRBb985FHB-0ttIYCQ">Go语言什么时候该使用指针？指针使用分析与讲解</a></li><li><a href="https://www.jb51.net/article/233949.htm">Go语言什么时候该使用指针</a></li></ul></blockquote><hr><h2 id="Go语言什么时候该使用指针？指针使用分析与讲解"><a href="#Go语言什么时候该使用指针？指针使用分析与讲解" class="headerlink" title="Go语言什么时候该使用指针？指针使用分析与讲解"></a>Go语言什么时候该使用指针？指针使用分析与讲解</h2><p><img src="https://img.shields.io/badge/copyright-原创-fff" alt="">        <img src="https://img.shields.io/badge/name-Go语言圈-fff" alt="">    <img src="https://img.shields.io/badge/date-2022--03--22%2018:00:00-fff" alt=""></p><p>收录于话题<code>#为什么要学Go语言</code> 47个   </p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/HvRgjyfjzzbS0SgWK0yOicRmkTcHib69Uia3t6QY1wxRudKTQbdLKPBzvWZSBOkXNq8pAc7Jr4LWDiaibqicHQUib6Yww/640?wx_fmt=png" alt="picture"></p><p><img src="https://mmbiz.qpic.cn/mmbiz_gif/HvRgjyfjzzbS0SgWK0yOicRmkTcHib69Uiat5cPkKPaQV0ib9jPjabSe4xskicA1dJQSV8IibKHMgicez2Oxy8hXjpqiaw/640?wx_fmt=gif" alt="picture"></p><p> <strong>什么是指针</strong><br>我们都知道，程序运行时的数据是存放在内存中的，每一个存储在内存中的数据都有一个编号，这个编号就是内存地址。我们可以根据这个内存地址来找到内存中存储的数据，而内存地址可以被赋值给一个指针。我们也可以简单的理解为指针就是内存地址。<br> <strong>指针的声明和定义</strong><br>在Go语言中，获取一个指针，直接使用取地址符<code>&amp;</code>就可以。<br>示例：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    name := <span class="string">&quot;Go语言圈&quot;</span></span><br><span class="line">    nameP := &amp;name <span class="comment">//取地址</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;name变量值为：&quot;</span>, name)</span><br><span class="line">    fmt.Println(<span class="string">&quot;name变量的内存地址为：&quot;</span>, nameP)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行结果：</span></span><br><span class="line"><span class="comment">//name变量值为：Go语言圈</span></span><br><span class="line"><span class="comment">//name变量的内存地址为： 0xc00004e240</span></span><br></pre></td></tr></table></figure></p><p>nameP 指针的类型是  <code>*string</code><br>Go语言中，<code>*</code> 类型名表示一个对应的指针类型<br><img src="https://mmbiz.qpic.cn/mmbiz_png/HvRgjyfjzzagmtamicekg2t5yZRCcvGiboBFzESicSxTywtBjb9IibxVtfOBBvBr5Zriajv0XdgYK0oqu2ZXicudLUkw/640?wx_fmt=png" alt="picture"></p><p>从上面表格可以看到：</p><ul><li>普通变量 name 的值是Go语言圈，存放在内存地址为 0xc00004e240 的内存中</li><li>指针变量 namep 的值是普通变量的内存地址 0xc00004e240</li><li>指针变量 nameP 的值存放在 内存地址为 0xc00004e360 的内存中</li><li>普通变量存的是数据，指针变量存的是数据的地址</li></ul><p> <strong>var 关键字声明</strong><br>我们也可以使用 var 关键字声明<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nameP *<span class="type">string</span></span><br><span class="line">nameP = &amp;name</span><br></pre></td></tr></table></figure></p><p> <strong>new 函数声明</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nameP := <span class="built_in">new</span>(<span class="type">string</span>)</span><br><span class="line">nameP = &amp;name</span><br></pre></td></tr></table></figure></p><p>可以传递类型给这个内置的  <code>new</code>  函数，它会返回对应的指针类型。<br> <strong>指针的操作</strong><br>这里强调一下：<br>指针变量是一个变量，这个变量的值是指针（内存地址）！<br>指针变量是一个变量，这个变量的值是指针（内存地址）！<br>指针变量是一个变量，这个变量的值是指针（内存地址）！<br>获取指针指向的值：<br>只需要在指针变量前加 <code>*</code> 号即可获得指针变量值所对应的数据：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameV := *nameP</span><br><span class="line">fmt.Println(<span class="string">&quot;nameP指针指向的值为:&quot;</span>, nameV)</span><br><span class="line"><span class="comment">//nameP指针指向的值为: Go语言圈</span></span><br></pre></td></tr></table></figure></p><p>修改指针指向的值：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">*nameP = <span class="string">&quot;公众号:Go语言圈&quot;</span></span><br><span class="line"><span class="comment">//修改指针指向的值</span></span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;nameP指针指向的值为:&quot;</span>,*nameP)</span><br><span class="line">fmt.Println(<span class="string">&quot;name变量的值为:&quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行结果：</span></span><br><span class="line"><span class="comment">//nameP指针指向的值为: 公众号:Go语言圈</span></span><br><span class="line"><span class="comment">//name变量的值为: 公众号:Go语言圈</span></span><br></pre></td></tr></table></figure></p><ul><li>我们发现nameP 指针指向的值被改变了，变量 name 的值也被改变了</li><li>因为变量 name 存储数据的内存就是指针 nameP 指向的内存，这块内存被 nameP 修改后，变量 name 的值也被修改了。</li></ul><p>通过 var 关键字直接定义的指针变量是不能进行赋值操作的，因为它的值为 nil，也就是还没有指向的内存地址<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//错误示例</span></span><br><span class="line"><span class="keyword">var</span> intP *<span class="type">int</span></span><br><span class="line">*intP = <span class="number">10</span></span><br><span class="line"><span class="comment">//错误，应该先给分配一块内存，内存地址作为变量 intP 的值，这个内存就可以存放 10 了。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//应该使用</span></span><br><span class="line"><span class="keyword">var</span> intP *<span class="type">int</span><span class="comment">//声明int类型的指针变量 intP</span></span><br><span class="line">intP = <span class="built_in">new</span>(<span class="type">int</span>) <span class="comment">// 给指针分配一块内存</span></span><br><span class="line">*intP = <span class="number">66</span> </span><br><span class="line">fmt.Println(<span class="string">&quot;:::&quot;</span>,intP)  <span class="comment">//::: 0xc0000ac088</span></span><br><span class="line">fmt.Println(*intP) <span class="comment">//66</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//简短写法</span></span><br><span class="line"><span class="keyword">var</span> intP := <span class="built_in">new</span>(<span class="type">int</span>)</span><br><span class="line">*intP=<span class="number">66</span></span><br></pre></td></tr></table></figure></p><p> <strong>指针参数</strong><br>当给一个函数使用指针作为参数的时候，就可以在函数中，通过形参改变实参的值：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    name := <span class="string">&quot;疯子&quot;</span></span><br><span class="line">    modify(&amp;name)</span><br><span class="line">    fmt.Println(<span class="string">&quot;name的值为:&quot;</span>,name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">modify</span><span class="params">(name *<span class="type">string</span>)</span></span>  &#123;</span><br><span class="line">    *name = <span class="string">&quot;wucs&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行结果：</span></span><br><span class="line"><span class="comment">//name的值为: wucs</span></span><br></pre></td></tr></table></figure></p><p> <strong>指针接收者</strong> </p><ul><li>如果接收者类型是 map、slice、channel 这类引用类型，不使用指针；</li><li>如果需要修改接收者，那么需要使用指针；</li><li>如果接收者是比较大的类型，可以考虑使用指针，因为内存拷贝廉价，所以效率高。</li></ul><p><strong>普通指针</strong><br>和C语言一样, 允许用一个变量来存放其它变量的地址, 这种专门用于存储其它变量地址的变量, 我们称之为指针变量.<br>和C语言一样, Go语言中的指针无论是什么类型占用内存都一样(32位4个字节, 64位8个字节)<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> p1 *<span class="type">int</span>;</span><br><span class="line">    <span class="keyword">var</span> p2 *<span class="type">float64</span>;</span><br><span class="line">    <span class="keyword">var</span> p3 *<span class="type">bool</span>;</span><br><span class="line"></span><br><span class="line">    fmt.Println(unsafe.Sizeof(p1)) <span class="comment">// 8</span></span><br><span class="line">    fmt.Println(unsafe.Sizeof(p2)) <span class="comment">// 8</span></span><br><span class="line">    fmt.Println(unsafe.Sizeof(p3)) <span class="comment">// 8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>和C语言一样, 只要一个指针变量保存了另一个变量对应的内存地址, 那么就可以通过<code>*</code>来访问指针变量指向的存储空间<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1.定义一个普通变量</span></span><br><span class="line">    <span class="keyword">var</span> num <span class="type">int</span> = <span class="number">666</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.定义一个指针变量</span></span><br><span class="line">    <span class="keyword">var</span> p *<span class="type">int</span> = &amp;num</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%p\n&quot;</span>, &amp;num) <span class="comment">// 0xc042064080</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%p\n&quot;</span>, p) <span class="comment">// 0xc042064080</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, p) <span class="comment">// *int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.通过指针变量操作指向的存储空间</span></span><br><span class="line">    *p = <span class="number">888</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.指针变量操作的就是指向变量的存储空间</span></span><br><span class="line">    fmt.Println(num) <span class="comment">// 888</span></span><br><span class="line">    fmt.Println(*p) <span class="comment">// 888</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p> <strong>指向数组指针</strong><br>在Go语言中通过数组名无法直接获取数组的内存地址<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> arr [<span class="number">3</span>]<span class="type">int</span> = [<span class="number">3</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>&#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%p\n&quot;</span>, arr) <span class="comment">// 乱七八糟东西</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%p\n&quot;</span>, &amp;arr) <span class="comment">// 0xc0420620a0</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%p\n&quot;</span>, &amp;arr[<span class="number">0</span>]) <span class="comment">// 0xc0420620a0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在Go语言中, 因为只有数据类型一模一样才能赋值, 所以只能通过<code>&amp;数组名</code>赋值给指针变量, 才代表指针变量指向了这个数组<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1.错误, 在Go语言中必须类型一模一样才能赋值</span></span><br><span class="line">    <span class="comment">// arr类型是[3]int, p1的类型是*[3]int</span></span><br><span class="line">    <span class="keyword">var</span> p1 *[<span class="number">3</span>]<span class="type">int</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, arr)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, p1)</span><br><span class="line">    p1 = arr <span class="comment">// 报错</span></span><br><span class="line">    p1[<span class="number">1</span>] = <span class="number">6</span></span><br><span class="line">    fmt.Println(arr[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.正确, &amp;arr的类型是*[3]int, p2的类型也是*[3]int</span></span><br><span class="line">    <span class="keyword">var</span> p2 *[<span class="number">3</span>]<span class="type">int</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, &amp;arr)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, p2)</span><br><span class="line">    p2 = &amp;arr</span><br><span class="line">    p2[<span class="number">1</span>] = <span class="number">6</span></span><br><span class="line">    fmt.Println(arr[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.错误, &amp;arr[0]的类型是*int, p3的类型也是*[3]int</span></span><br><span class="line">    <span class="keyword">var</span> p3 *[<span class="number">3</span>]<span class="type">int</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, &amp;arr[<span class="number">0</span>])</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, p3)</span><br><span class="line">    p3 = &amp;arr[<span class="number">0</span>] <span class="comment">// 报错</span></span><br><span class="line">    p3[<span class="number">1</span>] = <span class="number">6</span></span><br><span class="line">    fmt.Println(arr[<span class="number">1</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注意点:<br>Go语言中的指针, 不支持C语言中的<code>+1</code> <code>-1</code>和<code>++</code> <code>–-</code> 操作<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> arr [<span class="number">3</span>]<span class="type">int</span> = [<span class="number">3</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>&#125;</span><br><span class="line">    <span class="keyword">var</span> p *[<span class="number">3</span>]<span class="type">int</span></span><br><span class="line">    p = &amp;arr</span><br><span class="line"></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%p\n&quot;</span>, &amp;arr) <span class="comment">// 0xc0420620a0</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%p\n&quot;</span>, p) <span class="comment">// 0xc0420620a0</span></span><br><span class="line">    fmt.Println(&amp;arr) <span class="comment">// &amp;[1 3 5]</span></span><br><span class="line">    fmt.Println(p) <span class="comment">// &amp;[1 3 5]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指针指向数组之后操作数组的几种方式</span></span><br><span class="line">    <span class="comment">// 1.直接通过数组名操作</span></span><br><span class="line">    arr[<span class="number">1</span>] = <span class="number">6</span></span><br><span class="line">    fmt.Println(arr[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.通过指针间接操作</span></span><br><span class="line">    (*p)[<span class="number">1</span>] = <span class="number">7</span></span><br><span class="line">    fmt.Println((*p)[<span class="number">1</span>])</span><br><span class="line">    fmt.Println(arr[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.通过指针间接操作</span></span><br><span class="line">    p[<span class="number">1</span>] = <span class="number">8</span></span><br><span class="line">    fmt.Println(p[<span class="number">1</span>])</span><br><span class="line">    fmt.Println(arr[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意点: Go语言中的指针, 不支持+1 -1和++ --操作</span></span><br><span class="line">    *(p + <span class="number">1</span>) = <span class="number">9</span> <span class="comment">// 报错</span></span><br><span class="line">    fmt.Println(*p++) <span class="comment">// 报错</span></span><br><span class="line">    fmt.Println(arr[<span class="number">1</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p> <strong>指向切片的指针</strong><br>值得注意点的是切片的本质就是一个指针指向数组, 所以指向切片的指针是一个二级指针<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1.定义一个切片</span></span><br><span class="line">    <span class="keyword">var</span> sce[]<span class="type">int</span> = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.打印切片的地址</span></span><br><span class="line">    <span class="comment">// 切片变量中保存的地址, 也就是指向的那个数组的地址 sce = 0xc0420620a0</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;sce = %p\n&quot;</span>,sce )</span><br><span class="line">    fmt.Println(sce) <span class="comment">// [1 3 5]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 切片变量自己的地址, &amp;sce = 0xc04205e3e0</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;&amp;sce = %p\n&quot;</span>,&amp;sce )</span><br><span class="line">    fmt.Println(&amp;sce) <span class="comment">// &amp;[1 3 5]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.定义一个指向切片的指针</span></span><br><span class="line">    <span class="keyword">var</span> p *[]<span class="type">int</span></span><br><span class="line">    <span class="comment">// 因为必须类型一致才能赋值, 所以将切片变量自己的地址给了指针</span></span><br><span class="line">    p = &amp;sce</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.打印指针保存的地址</span></span><br><span class="line">    <span class="comment">// 直接打印p打印出来的是保存的切片变量的地址 p = 0xc04205e3e0</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;p = %p\n&quot;</span>, p)</span><br><span class="line">    fmt.Println(p) <span class="comment">// &amp;[1 3 5]</span></span><br><span class="line">    <span class="comment">// 打印*p打印出来的是切片变量保存的地址, 也就是数组的地址 *p = 0xc0420620a0</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;*p = %p\n&quot;</span>, *p)</span><br><span class="line">    fmt.Println(*p) <span class="comment">// [1 3 5]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.修改切片的值</span></span><br><span class="line">    <span class="comment">// 通过*p找到切片变量指向的存储空间(数组), 然后修改数组中保存的数据</span></span><br><span class="line">    (*p)[<span class="number">1</span>] = <span class="number">666</span></span><br><span class="line">    fmt.Println(sce[<span class="number">1</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>指向字典指针</strong><br>与普通指针并无差异<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> dict <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;lnj&quot;</span>, <span class="string">&quot;age&quot;</span>:<span class="string">&quot;33&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">var</span> p *<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> = &amp;dict</span><br><span class="line">    (*p)[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;zs&quot;</span></span><br><span class="line">    fmt.Println(dict)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p> <strong>指向结构体指针</strong><br>Go语言中指向结构体的指针和C语言一样<br>结构体和指针<br>创建结构体指针变量有两种方式<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    age <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// 创建时利用取地址符号获取结构体变量地址</span></span><br><span class="line">  <span class="keyword">var</span> p1 = &amp;Student&#123;<span class="string">&quot;lnj&quot;</span>, <span class="number">33</span>&#125;</span><br><span class="line">  fmt.Println(p1) <span class="comment">// &amp;&#123;lnj 33&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过new内置函数传入数据类型创建</span></span><br><span class="line">  <span class="comment">// 内部会创建一个空的结构体变量, 然后返回这个结构体变量的地址</span></span><br><span class="line">  <span class="keyword">var</span> p2 = <span class="built_in">new</span>(Student)</span><br><span class="line">  fmt.Println(p2) <span class="comment">// &amp;&#123; 0&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p> <strong>利用结构体指针操作结构体属性</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    age <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> p = &amp;Student&#123;&#125;</span><br><span class="line">  <span class="comment">// 方式一: 传统方式操作</span></span><br><span class="line">  <span class="comment">// 修改结构体中某个属性对应的值</span></span><br><span class="line">  <span class="comment">// 注意: 由于.运算符优先级比*高, 所以一定要加上()</span></span><br><span class="line">  (*p).name = <span class="string">&quot;lnj&quot;</span></span><br><span class="line">  <span class="comment">// 获取结构体中某个属性对应的值</span></span><br><span class="line">  fmt.Println((*p).name) <span class="comment">// lnj</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方式二: 通过Go语法糖操作</span></span><br><span class="line">  <span class="comment">// Go语言作者为了程序员使用起来更加方便, 在操作指向结构体的指针时可以像操作接头体变量一样通过.来操作</span></span><br><span class="line">  <span class="comment">// 编译时底层会自动转发为(*p).age方式</span></span><br><span class="line">  p.age = <span class="number">33</span></span><br><span class="line">  fmt.Println(p.age) <span class="comment">// 33</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p> <strong>什么情况下使用指针</strong> </p><ul><li>不要对 map、slice、channel 这类引用类型使用指针；</li><li>如果需要修改方法接收者内部的数据或者状态时，需要使用指针；</li><li>如果需要修改参数的值或者内部数据时，也需要使用指针类型的参数；</li><li>如果是比较大的结构体，每次参数传递或者调用方法都要内存拷贝，内存占用多，这时候可以考虑使用指针；</li><li>像 int、bool 这样的小数据类型没必要使用指针；</li><li>如果需要并发安全，则尽可能地不要使用指针，使用指针一定要保证并发安全；</li><li>指针最好不要嵌套，也就是不要使用一个指向指针的指针，虽然 Go 语言允许这么做，但是这会使你的代码变得异常复杂。</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;style&gt;
    img {
        display: inline !important;
    }
&lt;/style&gt;


&lt;blockquote&gt;
&lt;p&gt;&lt;font size=5&gt;&lt;b&gt;文章说明&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;strong&gt;文章作者：&lt;/str</summary>
      
    
    
    
    <category term="Go" scheme="https://hwame.top/categories/Go/"/>
    
    
    <category term="Go" scheme="https://hwame.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>Markdown中图片的高级用法</title>
    <link href="https://hwame.top/20220228/awesome-images-in-markdown.html"/>
    <id>https://hwame.top/20220228/awesome-images-in-markdown.html</id>
    <published>2022-02-28T15:27:50.000Z</published>
    <updated>2022-03-02T15:28:27.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章链接：</strong><a href="https://hwame.top/20220228/awesome-images-in-markdown.html">https://hwame.top/20220228/awesome-images-in-markdown.html</a><br><strong>原文作者：</strong><a href="https://www.52pojie.cn/home.php?mod=space&amp;uid=555510">吾乃木易先生</a><br><strong>原文链接：</strong><a href="https://www.52pojie.cn/thread-1522362-1-1.html">https://www.52pojie.cn/thread-1522362-1-1.html</a><br><strong>参考资料：</strong></p><ul><li><a href="https://www.52pojie.cn/thread-1522362-1-1.html">庆国诞72周年，分享我帖子中的链接小卡片是怎么做的</a></li><li><del>~2.6貌似有问题，style变成前内容了</del>~</li><li>【已更正】 <del>~由于此前将Hexo默认CSS修改为图片居中了，故本文显示不太顺眼，可移步原文！</del>~</li><li>解决办法：在文章前添加样式即可，<code>!important</code>不会被其他选择器覆盖掉<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">img</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: inline <span class="meta">!important</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></blockquote><style>    img {        display: inline !important;    }</style><hr><blockquote><p>之前我分享精品软件的时候用到了链接小卡片，有坛友问我怎么做，虽然我两三言简要回复过了，但没具体说。值此国诞72周年，特来分享。</p><p>前排提醒：需要会写基本的 <code>Markdown</code> 语法（当然，如果只想学会链接小卡片的话会写图片和链接的语法就可以了）。如果不会 <code>Markdown</code>，可以参考论坛里的这篇帖子（点击即可传送）： <a href="https://www.52pojie.cn/thread-1286100-1-1.html"><img src="https://img.shields.io/badge/%5B其他%5DMarkdown从入门到精通-楼主：一只小凡凡-1?colorA=fff&amp;colorB=fff&amp;style=for-the-badge&amp;logo=data:image/png;base64,AAABAAEAICAAAAAAAACoDAAAFgAAACgAAAAgAAAAQAAAAAEAGAAAAAAAgAwAAAAAAAAAAAAAAAAAAAAAAAD////////BwfdQUOr8/P7////Dw/ewsPWWlvKoqPTk5PvU1Pnt7fy0tPWFhfBxce7d3fu6uvapqfWnp/RZWev///+UlPJqau3T0/m8vPf09P3////j4/vLy/n///////////8JCeIKCuIFBeEAAOAAAOAAAOAAAOAAAOEAAOAAAOAAAOAAAOAAAOADA+EEBOEAAOAAAOEAAOAAAOAFBeEAAN8AAOAGBuEAAOAAAOAAAOAAAN8AAOAAAN+oqPX///+rq/QAAOAREeMAAOEAAOEAAOEDA+EHB+ILC+IPD+IQEOIAAOEAAOAQEOIREeMREeMQEOILC+JkZOwREeMbG+RfX+wMDOIAAOACAuEAAOAuLuZcXOsUFOMODuIAAN7JyfhOTuoNDeIAAODd3fqZmfKdnfKBgfCRkfHOzvkAAN4AAN+rq/SysvYAAN8ODuIREeMQEOIAAOD+/v6UlPIuLubr6/z////V1fp1de6/v/f///+EhPABAeEWFuMAAOCurvVzc+4GBuEuLubX1/plZe2SkvFycu5WVuvu7vybm/OlpfTMzPnNzflVVesSEuMODuIREeMJCeI2Nuf///8EBOEAAN5LS+n///////////+BgfAAAN8dHeQPD+IBAeGcnPOvr/UAAOEAAN/MzPj4+P3j4/v///+dnfP4+P5bW+tubu25ufbp6fzc3PqpqfUCAuEREeMQEOIAAN/U1PmMjPE/P+jAwPdubu0AAN4PD+L6+v5sbO0HB+EQEOIAAOC/v/fLy/kAAOAAAODf3/uurvWtrfWBgfAnJ+X///8nJ+UAAN+IiPGhofQAANsAAOAQEOIREeMREeMAAOAYGOT////s7P38/P7o6Py7u/eXl/Lx8f2amvMBAeEZGeQHB+FHR+n///8ICOIAAODR0fm/v/fR0fnNzflMTOr///7u7v339/7///////////+CgvAFBeEREeMCAuGhofOGhvD///+VlfI1NedVVep2du6NjfFkZOwAAOAJCeIPD+IAAOH///+5ufYQEOIAAODX1/qKivHV1fn7+/5XV+v4+P18fO+oqPWtrfTBwfgdHeQcHOQODuIQEOIHB+GMjPGiovOHh/D////09P3+/v79/f7+/v/5+f7m5vwuLuYLC+IBAeHh4fv///8ICOEAAODe3vovL+adnfJ5ee4wMOb7+/4/P+hWVusxMeZOTuoAAOAJCeIREeMREeMAAOGQkPHFxfcAANq+vvejo/MAAN0NDeIoKOVXV+v///8vL+YMDOIAAOGXl/Pp6fwwMOYAAODZ2fra2vr///////////95ee+1tfaMjPFJSen////8/P4TE+MNDeIQEOIAAOD////////t7fzPz/n///8pKeUHB+EAAN8AAN77+/6Hh/AJCeIBAeGDg/BhYewAAOAPD+KMjPEAAOAAAN54eO////8HB+IkJOX///8AAOAAAN3MzPmgoPMBAeEPD+IREeNxce4CAuHFxfjCwvfc3Pr////////j4/vk5Pz///+GhvAEBOEZGeSDg/CcnPMAAOAjI+Tz8/3W1vmvr/VlZeza2vrx8f0AANzZ2fqJifAAAN2dnfPGxvgAAOAREeMNDeINDeIFBeH///8AAOClpfRkZOxAQOj///9qau0rK+YAAOEODuIcHORpae1qau0EBOEUFOMAAN/f3/v///+qqvW1tfZSUurDw/f09P3///9tbe3///94eO4EBOEREeMDA+GQkPH///////+urvX///+Dg/ALC+JbW+u6uvcAAN8QEOIQEOMAAN////+5ufYKCuIPD+IMDOIBAeH///+goPMAAN8AAOBJSemNjfGsrPXCwvd0dO4AAOEQEOIREeMQEOIEBOESEuMzM+deXux+fu+7u/fo6Pz///////8lJeUMDOIREeMAAODCwvfi4vsAAOAQEOIREeMLC+IfH+QhIeQNDeIQEOMHB+EWFuMAAOAAAOADA+EQEOIREeMREeMREeMQEOINDeIJCeIGBuEDA+EAAOAAAOAJCeEAAOAPD+IQEOIQEOIAAOC6uvdtbe0ICOEQEOMQEOIREeMNDeIMDOIODuIGBuEPD+IPD+IREeMPD+ImJuUPD+IREeMREeMREeMREeMPD+IWFuMGBuIAAOAAAOAWFuMMDOJQUOoKCuISEuIYGOMAAOD////NzfkAAOAQEOIVFeMQEOIPD+IjI+QcHOR0dO4JCeIAAOANDeIQEOMHB+EGBuEREeMMDOIQEOMQEOIAAOBPT+qkpPTExPe9vfeenvNRUeoAAOAMDOIQEOIQEOIAAOBeXuvg4PsAAOAQEOIREeMJCeIAAOEAAOEwMOb///9vb+3BwfcQEOIAAN9ISOl2du8CAuFFRekLC+IAAOC2tvb///+RkfF0dO6AgPCnp/T////29v4QEOINDeIKCuJISOmysvbr6/wDA+EPD+IGBuFBQei1tfZZWesCAuH///8iIuS+vvf///+fn/P///98fO8EBOEKCuIzM+YAAN////8bG+QAAN8AAOECAuEAAOAICOH///+QkPECAuEQEOICAuGPj/Hl5fwAAOAQEOMVFeP///+WlvL///9ZWev4+P0bG+QDA+H///////9ISOkAAOAREeMPD+IgIOQAAN////+pqfREROkcHOQDA+EAAOAAAOD///+envMBAeEODuIYGOOqqvV9ffAjI+UAAOFBQej39/4AAN5lZezT0/nf3/siIuTi4vuVlfJnZ+z///8AAOAPD+IREeMLC+IAAOCiovPn5/zm5vv////////////////s7PwVFeMHB+EPD+IAAOD///+NjfEwMOY/P+hra+3///4AAN8pKeX09P7MzPg/P+gAAN8AAN8YGOP+/v5LS+kJCeIMDOInJ+UzM+cuLuYgIOQXF+MsLOYyMudlZewxMeYeHuQoKOUuLuYYGOMAAOCgoPTt7fwAAN9pae3q6vz///8/P+iBgfDn5/yqqvTS0vn09P1cXOs1Nef///9ZWesHB+ENDeKoqPT9/f7w8P38/P7////7+/7///////////////////////8AAOABAeGcnPO7u/YCAuEAAN/l5fzCwvfm5vv///9DQ+ilpfSjo/RRUer///////+8vPcFBeEODuIcHOQBAeEAAN8AAOAXF+P4+P4AANwAAN4AAN2oqPSZmfILC+IjI+QQEOMBAeGXl/J9fe8YGOMICOInJ+X7+/4AAN0AAN8AAN+np/TDw/cAAOD///8AAN0ICOEFBeEREeMODuIREeMAAODx8f3///////+8vPeYmPJ7e+/NzfmurvUAAOAMDOIQEOIDA+GNjfLS0vkAAOAQEOIAAN+goPOhofMAAN4AAN+Xl/Lx8f0AAN7///8AAN////85OecICOIeHuQPD+IMDOIEBOEoKOX////IyPja2vr+/v7q6vwrK+YLC+IREeIVFeMBAeGlpfX///8ZGeQDA+F4eO/5+f7////w8P3+/v719f7////v7/3///9lZe3w8P28vPcAAOAXF+MNDeIcHOQLC+ItLebl5fxoaO0AAN0AAN0AAN0AAN8AAOAQEOMQEOIAAODT0/l3d+8BAeENDeIlJeVISOk/P+hEROlISOkaGuMkJOVpae3///+qqvWjo/MrK+ULC+IQEOIAAODIyPj////////////////////h4fvm5vzn5/zm5vwAAOAQEOMAAODMzPldXewEBOEQEOMLC+IICOEVFeIPD+IICOIMDOIHB+EcHOT///8AAN4AAOALC+IQEOINDeILC+IzM+ZISOlEROlFRelISOlMTOpMTOlMTOpSUupLS+oICOEODuILC+L///////8AAN8EBOEmJuUAAOAAAOAICOIAAOACAuEAAOAEBOFGRukZGeQPD+ILC+IAAOElJeUCAuEAAOAAAN8dHeQAAN8tLeYAAN8AAOAAAOAAAN8PD+MODuIAAOAAAOD+/v7////q6vxiYuzOzvnT0/r39/6hofPb2/qvr/W9vfaUlPODg/Dc3Ps5Oed3d++vr/X09P1SUurn5/ympvRqau2BgfBUVOrs7PzKyvh1de/i4vvi4vuenvSCgvDn5/z///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt=""></a></p></blockquote><h1 id="1-什么是链接小卡片"><a href="#1-什么是链接小卡片" class="headerlink" title="1 什么是链接小卡片"></a>1 什么是链接小卡片</h1><p>这玩意儿实际上叫 <code>badge</code>，翻译过来是徽标的意思。大概是因为我每次用这个都是用作链接，而这玩意儿长得有点像小卡片，所以坛友贴心地起名叫“链接小卡片”。</p><p>在论坛中发帖使用请确保使用的是 <code>MD</code> 编辑器，具体使用方法见此贴（点击传送）：<a href="https://www.52pojie.cn/thread-717627-1-1.html"><img src="https://img.shields.io/badge/【帮助文档】Markdown插件使用说明-楼主：Hmily-1?colorA=fff&amp;colorB=fff&amp;style=for-the-badge&amp;logo=data:image/png;base64,AAABAAEAICAAAAAAAACoDAAAFgAAACgAAAAgAAAAQAAAAAEAGAAAAAAAgAwAAAAAAAAAAAAAAAAAAAAAAAD////////BwfdQUOr8/P7////Dw/ewsPWWlvKoqPTk5PvU1Pnt7fy0tPWFhfBxce7d3fu6uvapqfWnp/RZWev///+UlPJqau3T0/m8vPf09P3////j4/vLy/n///////////8JCeIKCuIFBeEAAOAAAOAAAOAAAOAAAOEAAOAAAOAAAOAAAOAAAOADA+EEBOEAAOAAAOEAAOAAAOAFBeEAAN8AAOAGBuEAAOAAAOAAAOAAAN8AAOAAAN+oqPX///+rq/QAAOAREeMAAOEAAOEAAOEDA+EHB+ILC+IPD+IQEOIAAOEAAOAQEOIREeMREeMQEOILC+JkZOwREeMbG+RfX+wMDOIAAOACAuEAAOAuLuZcXOsUFOMODuIAAN7JyfhOTuoNDeIAAODd3fqZmfKdnfKBgfCRkfHOzvkAAN4AAN+rq/SysvYAAN8ODuIREeMQEOIAAOD+/v6UlPIuLubr6/z////V1fp1de6/v/f///+EhPABAeEWFuMAAOCurvVzc+4GBuEuLubX1/plZe2SkvFycu5WVuvu7vybm/OlpfTMzPnNzflVVesSEuMODuIREeMJCeI2Nuf///8EBOEAAN5LS+n///////////+BgfAAAN8dHeQPD+IBAeGcnPOvr/UAAOEAAN/MzPj4+P3j4/v///+dnfP4+P5bW+tubu25ufbp6fzc3PqpqfUCAuEREeMQEOIAAN/U1PmMjPE/P+jAwPdubu0AAN4PD+L6+v5sbO0HB+EQEOIAAOC/v/fLy/kAAOAAAODf3/uurvWtrfWBgfAnJ+X///8nJ+UAAN+IiPGhofQAANsAAOAQEOIREeMREeMAAOAYGOT////s7P38/P7o6Py7u/eXl/Lx8f2amvMBAeEZGeQHB+FHR+n///8ICOIAAODR0fm/v/fR0fnNzflMTOr///7u7v339/7///////////+CgvAFBeEREeMCAuGhofOGhvD///+VlfI1NedVVep2du6NjfFkZOwAAOAJCeIPD+IAAOH///+5ufYQEOIAAODX1/qKivHV1fn7+/5XV+v4+P18fO+oqPWtrfTBwfgdHeQcHOQODuIQEOIHB+GMjPGiovOHh/D////09P3+/v79/f7+/v/5+f7m5vwuLuYLC+IBAeHh4fv///8ICOEAAODe3vovL+adnfJ5ee4wMOb7+/4/P+hWVusxMeZOTuoAAOAJCeIREeMREeMAAOGQkPHFxfcAANq+vvejo/MAAN0NDeIoKOVXV+v///8vL+YMDOIAAOGXl/Pp6fwwMOYAAODZ2fra2vr///////////95ee+1tfaMjPFJSen////8/P4TE+MNDeIQEOIAAOD////////t7fzPz/n///8pKeUHB+EAAN8AAN77+/6Hh/AJCeIBAeGDg/BhYewAAOAPD+KMjPEAAOAAAN54eO////8HB+IkJOX///8AAOAAAN3MzPmgoPMBAeEPD+IREeNxce4CAuHFxfjCwvfc3Pr////////j4/vk5Pz///+GhvAEBOEZGeSDg/CcnPMAAOAjI+Tz8/3W1vmvr/VlZeza2vrx8f0AANzZ2fqJifAAAN2dnfPGxvgAAOAREeMNDeINDeIFBeH///8AAOClpfRkZOxAQOj///9qau0rK+YAAOEODuIcHORpae1qau0EBOEUFOMAAN/f3/v///+qqvW1tfZSUurDw/f09P3///9tbe3///94eO4EBOEREeMDA+GQkPH///////+urvX///+Dg/ALC+JbW+u6uvcAAN8QEOIQEOMAAN////+5ufYKCuIPD+IMDOIBAeH///+goPMAAN8AAOBJSemNjfGsrPXCwvd0dO4AAOEQEOIREeMQEOIEBOESEuMzM+deXux+fu+7u/fo6Pz///////8lJeUMDOIREeMAAODCwvfi4vsAAOAQEOIREeMLC+IfH+QhIeQNDeIQEOMHB+EWFuMAAOAAAOADA+EQEOIREeMREeMREeMQEOINDeIJCeIGBuEDA+EAAOAAAOAJCeEAAOAPD+IQEOIQEOIAAOC6uvdtbe0ICOEQEOMQEOIREeMNDeIMDOIODuIGBuEPD+IPD+IREeMPD+ImJuUPD+IREeMREeMREeMREeMPD+IWFuMGBuIAAOAAAOAWFuMMDOJQUOoKCuISEuIYGOMAAOD////NzfkAAOAQEOIVFeMQEOIPD+IjI+QcHOR0dO4JCeIAAOANDeIQEOMHB+EGBuEREeMMDOIQEOMQEOIAAOBPT+qkpPTExPe9vfeenvNRUeoAAOAMDOIQEOIQEOIAAOBeXuvg4PsAAOAQEOIREeMJCeIAAOEAAOEwMOb///9vb+3BwfcQEOIAAN9ISOl2du8CAuFFRekLC+IAAOC2tvb///+RkfF0dO6AgPCnp/T////29v4QEOINDeIKCuJISOmysvbr6/wDA+EPD+IGBuFBQei1tfZZWesCAuH///8iIuS+vvf///+fn/P///98fO8EBOEKCuIzM+YAAN////8bG+QAAN8AAOECAuEAAOAICOH///+QkPECAuEQEOICAuGPj/Hl5fwAAOAQEOMVFeP///+WlvL///9ZWev4+P0bG+QDA+H///////9ISOkAAOAREeMPD+IgIOQAAN////+pqfREROkcHOQDA+EAAOAAAOD///+envMBAeEODuIYGOOqqvV9ffAjI+UAAOFBQej39/4AAN5lZezT0/nf3/siIuTi4vuVlfJnZ+z///8AAOAPD+IREeMLC+IAAOCiovPn5/zm5vv////////////////s7PwVFeMHB+EPD+IAAOD///+NjfEwMOY/P+hra+3///4AAN8pKeX09P7MzPg/P+gAAN8AAN8YGOP+/v5LS+kJCeIMDOInJ+UzM+cuLuYgIOQXF+MsLOYyMudlZewxMeYeHuQoKOUuLuYYGOMAAOCgoPTt7fwAAN9pae3q6vz///8/P+iBgfDn5/yqqvTS0vn09P1cXOs1Nef///9ZWesHB+ENDeKoqPT9/f7w8P38/P7////7+/7///////////////////////8AAOABAeGcnPO7u/YCAuEAAN/l5fzCwvfm5vv///9DQ+ilpfSjo/RRUer///////+8vPcFBeEODuIcHOQBAeEAAN8AAOAXF+P4+P4AANwAAN4AAN2oqPSZmfILC+IjI+QQEOMBAeGXl/J9fe8YGOMICOInJ+X7+/4AAN0AAN8AAN+np/TDw/cAAOD///8AAN0ICOEFBeEREeMODuIREeMAAODx8f3///////+8vPeYmPJ7e+/NzfmurvUAAOAMDOIQEOIDA+GNjfLS0vkAAOAQEOIAAN+goPOhofMAAN4AAN+Xl/Lx8f0AAN7///8AAN////85OecICOIeHuQPD+IMDOIEBOEoKOX////IyPja2vr+/v7q6vwrK+YLC+IREeIVFeMBAeGlpfX///8ZGeQDA+F4eO/5+f7////w8P3+/v719f7////v7/3///9lZe3w8P28vPcAAOAXF+MNDeIcHOQLC+ItLebl5fxoaO0AAN0AAN0AAN0AAN8AAOAQEOMQEOIAAODT0/l3d+8BAeENDeIlJeVISOk/P+hEROlISOkaGuMkJOVpae3///+qqvWjo/MrK+ULC+IQEOIAAODIyPj////////////////////h4fvm5vzn5/zm5vwAAOAQEOMAAODMzPldXewEBOEQEOMLC+IICOEVFeIPD+IICOIMDOIHB+EcHOT///8AAN4AAOALC+IQEOINDeILC+IzM+ZISOlEROlFRelISOlMTOpMTOlMTOpSUupLS+oICOEODuILC+L///////8AAN8EBOEmJuUAAOAAAOAICOIAAOACAuEAAOAEBOFGRukZGeQPD+ILC+IAAOElJeUCAuEAAOAAAN8dHeQAAN8tLeYAAN8AAOAAAOAAAN8PD+MODuIAAOAAAOD+/v7////q6vxiYuzOzvnT0/r39/6hofPb2/qvr/W9vfaUlPODg/Dc3Ps5Oed3d++vr/X09P1SUurn5/ympvRqau2BgfBUVOrs7PzKyvh1de/i4vvi4vuenvSCgvDn5/z///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt=""></a></p><h1 id="2-使用方法"><a href="#2-使用方法" class="headerlink" title="2 使用方法"></a>2 使用方法</h1><p>链接小卡片本质上是借助 <a href="https://shields.io"><img src="https://img.shields.io/badge/Shields.io-吾乃木易先生?color=222&amp;logo=shieldsdotio" alt=""></a> 这个网站来实现的图片。所以会用到 <code>Markdown</code> 图片语法，如果想做成链接，还需用到 <code>Markdown</code> 链接语法。</p><p><strong>所有参数值未加特殊说明均不可省略！</strong></p><p><strong>由于是通过其他网站实现显示图片，所以要想正常显示，必须确保有网。</strong></p><p><strong>前排提醒：本帖不是广告！此网站是开源、非商业、非盈利性网站，没有任何收费的项目！</strong></p><h2 id="2-1-单内容链接小卡片"><a href="#2-1-单内容链接小卡片" class="headerlink" title="2.1 单内容链接小卡片"></a>2.1 单内容链接小卡片</h2><p>我把只有一个内容项的称为 <strong>单内容链接小卡片</strong>。比如我的签名的第一个。</p><h3 id="2-1-1-语法"><a href="#2-1-1-语法" class="headerlink" title="2.1.1 语法"></a>2.1.1 语法</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/内容-防伪值?color=颜色值</span>)</span><br></pre></td></tr></table></figure><h3 id="2-1-2-示例"><a href="#2-1-2-示例" class="headerlink" title="2.1.2 示例"></a>2.1.2 示例</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/吾爱破解-吾乃木易先生?color=ff69b4</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/吾爱破解-吾乃木易先生?color=ff69b4" alt=""></p><h3 id="2-1-3-注意事项"><a href="#2-1-3-注意事项" class="headerlink" title="2.1.3 注意事项"></a>2.1.3 注意事项</h3><ul><li>使用时替换语法代码部分中的汉字内容即可</li><li>颜色值可省略（从 <code>?</code> 开始省略）</li><li>颜色值均指背景颜色，字体颜色会自动调整，无法自定义字体颜色</li><li>颜色值若使用 16 进制，不要加 <code>#</code> 号</li><li>默认的颜色是：<img src="https://img.shields.io/badge/绿得发光-吾乃木易先生" alt=""></li><li>防伪值只是我是这么叫的，因为它在这里不会显示</li><li><strong>只要出现防伪值，防伪值均不可省略，下同</strong></li></ul><h2 id="2-2-双内容链接小卡片"><a href="#2-2-双内容链接小卡片" class="headerlink" title="2.2 双内容链接小卡片"></a>2.2 双内容链接小卡片</h2><p>我把有两个内容项的称为 <strong>双内容链接小卡片</strong>。</p><h3 id="2-2-1-语法"><a href="#2-2-1-语法" class="headerlink" title="2.2.1 语法"></a>2.2.1 语法</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/前内容-后内容-后内容颜色值</span>)</span><br></pre></td></tr></table></figure><h3 id="2-2-2-示例"><a href="#2-2-2-示例" class="headerlink" title="2.2.2 示例"></a>2.2.2 示例</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/52PoJie-吾爱破解-fff</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/52PoJie-吾爱破解-fff" alt=""></p><h3 id="2-2-3-注意事项"><a href="#2-2-3-注意事项" class="headerlink" title="2.2.3 注意事项"></a>2.2.3 注意事项</h3><ul><li><strong>所有内容均不可省略，包括颜色值</strong></li><li>这里的颜色值只能修改后内容的颜色值</li></ul><h2 id="2-3-图标链接小卡片"><a href="#2-3-图标链接小卡片" class="headerlink" title="2.3 图标链接小卡片"></a>2.3 图标链接小卡片</h2><p>我把带有小图标的称为 <strong>图标链接小卡片</strong>。比如我签名中后面几个。</p><p>图标链接小卡片又分为 <strong>内置图标链接小卡片</strong> 和 <strong>自定义图标链接小卡片</strong>。</p><h3 id="2-3-1-内置图标链接小卡片"><a href="#2-3-1-内置图标链接小卡片" class="headerlink" title="2.3.1 内置图标链接小卡片"></a>2.3.1 内置图标链接小卡片</h3><p>内置图标可以直接使用。所有内置图标可以在这里找到（点击传送）：<a href="https://simpleicons.org/"><img src="https://img.shields.io/badge/Simple%20Icons-吾乃木易先生?color=222&amp;logo=simpleicons" alt=""></a></p><h4 id="2-3-1-1-语法"><a href="#2-3-1-1-语法" class="headerlink" title="2.3.1.1 语法"></a>2.3.1.1 语法</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/内容-防伪值?color=颜色&amp;logo=内置图标名</span>)</span><br><span class="line"></span><br><span class="line">;2. 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/前内容-后内容-后内容颜色值?logo=内置图标名</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-3-1-2-示例"><a href="#2-3-1-2-示例" class="headerlink" title="2.3.1.2 示例"></a>2.3.1.2 示例</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/QQ-吾乃木易先生?color=4ab7f5&amp;logo=tencentqq</span>)</span><br><span class="line"></span><br><span class="line">;2. 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/macOS-10.13+-367aff?logo=apple</span>)</span><br></pre></td></tr></table></figure><p>效果：</p><ol><li>单内容：<img src="https://img.shields.io/badge/QQ-吾乃木易先生?color=4ab7f5&amp;logo=tencentqq" alt=""></li><li>双内容：<img src="https://img.shields.io/badge/macOS-10.13+-367aff?logo=apple" alt=""></li></ol><h4 id="2-3-1-3-修改内置图标颜色"><a href="#2-3-1-3-修改内置图标颜色" class="headerlink" title="2.3.1.3 修改内置图标颜色"></a>2.3.1.3 修改内置图标颜色</h4><ul><li>部分内置图标默认是白色的，比如上面的示例</li><li>部分内置图标默认自带颜色，比如：<img src="https://img.shields.io/badge/WeChat-吾乃木易先生?color=fff&amp;logo=wechat" alt=""> 还有 <img src="https://img.shields.io/badge/AliPay-吾乃木易先生?color=fff&amp;logo=alipay" alt=""></li><li>哪些默认带颜色，哪些默认不带，需要自己试</li><li>内置图标的颜色可以修改</li></ul><h5 id="2-3-1-3-1-语法"><a href="#2-3-1-3-1-语法" class="headerlink" title="2.3.1.3.1 语法"></a>2.3.1.3.1 语法</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/内容-防伪值?color=颜色&amp;logo=内置图标名&amp;logoColor=内置图标颜色值</span>)</span><br><span class="line"></span><br><span class="line">;2. 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/前内容-后内容-后内容颜色值?logo=内置图标名&amp;logoColor=内置图标颜色值</span>)</span><br></pre></td></tr></table></figure><h5 id="2-3-1-3-2-示例"><a href="#2-3-1-3-2-示例" class="headerlink" title="2.3.1.3.2 示例"></a>2.3.1.3.2 示例</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/QQ-吾乃木易先生?color=fff&amp;logo=tencentqq&amp;logoColor=4ab7f5</span>)</span><br><span class="line"></span><br><span class="line">;2. 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/macOS-10.13+-367aff?logo=apple&amp;logoColor=f9d694</span>)</span><br></pre></td></tr></table></figure><p>效果：</p><ol><li><img src="https://img.shields.io/badge/QQ-吾乃木易先生?color=fff&amp;logo=tencentqq&amp;logoColor=4ab7f5" alt=""></li><li><img src="https://img.shields.io/badge/macOS-10.13+-367aff?logo=apple&amp;logoColor=f9d694" alt=""></li></ol><h3 id="2-3-2-自定义图标链接小卡片"><a href="#2-3-2-自定义图标链接小卡片" class="headerlink" title="2.3.2 自定义图标链接小卡片"></a>2.3.2 自定义图标链接小卡片</h3><p>自定义图标需将图片转换成 <code>Base64</code> 编码（这样的工具很多，论坛里也有人发过），同时需要原图片的长和宽均 <code>≥ 14px</code>。</p><h4 id="2-3-2-1-语法"><a href="#2-3-2-1-语法" class="headerlink" title="2.3.2.1 语法"></a>2.3.2.1 语法</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/内容-防伪值?color=颜色值&amp;logo=data:image/png;base64,一长串Base64编码</span>)</span><br><span class="line"></span><br><span class="line">;2. 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/前内容-后内容-防伪值?color=后内容颜色值&amp;logo=data:image/png;base64,一长串Base64编码</span>)</span><br></pre></td></tr></table></figure><h4 id="2-3-2-2-示例"><a href="#2-3-2-2-示例" class="headerlink" title="2.3.2.2 示例"></a>2.3.2.2 示例</h4><p>我把论坛的 Logo 转换成了 <code>Base64</code> 编码作为示例，不过编码太长了，放进来严重影响阅读，所以就省略不放了。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/吾乃木易先生-吾乃木易?color=fff&amp;logo=data:image/png;base64,AAA...A==</span>)</span><br><span class="line"></span><br><span class="line">;2. 双内容</span><br><span class="line">![](<span class="link">https://img.shields.io/badge/吾爱破解-吾乃木易先生-吾乃木易?color=fff&amp;logo=data:image/png;base64,AAA...A==</span>)</span><br></pre></td></tr></table></figure><p>效果：</p><ol><li><p>单内容：<img src="https://img.shields.io/badge/吾乃木易先生-吾乃木易?color=fff&amp;logo=data:image/png;base64,AAABAAEAICAAAAAAAACoDAAAFgAAACgAAAAgAAAAQAAAAAEAGAAAAAAAgAwAAAAAAAAAAAAAAAAAAAAAAAD////////BwfdQUOr8/P7////Dw/ewsPWWlvKoqPTk5PvU1Pnt7fy0tPWFhfBxce7d3fu6uvapqfWnp/RZWev///+UlPJqau3T0/m8vPf09P3////j4/vLy/n///////////8JCeIKCuIFBeEAAOAAAOAAAOAAAOAAAOEAAOAAAOAAAOAAAOAAAOADA+EEBOEAAOAAAOEAAOAAAOAFBeEAAN8AAOAGBuEAAOAAAOAAAOAAAN8AAOAAAN+oqPX///+rq/QAAOAREeMAAOEAAOEAAOEDA+EHB+ILC+IPD+IQEOIAAOEAAOAQEOIREeMREeMQEOILC+JkZOwREeMbG+RfX+wMDOIAAOACAuEAAOAuLuZcXOsUFOMODuIAAN7JyfhOTuoNDeIAAODd3fqZmfKdnfKBgfCRkfHOzvkAAN4AAN+rq/SysvYAAN8ODuIREeMQEOIAAOD+/v6UlPIuLubr6/z////V1fp1de6/v/f///+EhPABAeEWFuMAAOCurvVzc+4GBuEuLubX1/plZe2SkvFycu5WVuvu7vybm/OlpfTMzPnNzflVVesSEuMODuIREeMJCeI2Nuf///8EBOEAAN5LS+n///////////+BgfAAAN8dHeQPD+IBAeGcnPOvr/UAAOEAAN/MzPj4+P3j4/v///+dnfP4+P5bW+tubu25ufbp6fzc3PqpqfUCAuEREeMQEOIAAN/U1PmMjPE/P+jAwPdubu0AAN4PD+L6+v5sbO0HB+EQEOIAAOC/v/fLy/kAAOAAAODf3/uurvWtrfWBgfAnJ+X///8nJ+UAAN+IiPGhofQAANsAAOAQEOIREeMREeMAAOAYGOT////s7P38/P7o6Py7u/eXl/Lx8f2amvMBAeEZGeQHB+FHR+n///8ICOIAAODR0fm/v/fR0fnNzflMTOr///7u7v339/7///////////+CgvAFBeEREeMCAuGhofOGhvD///+VlfI1NedVVep2du6NjfFkZOwAAOAJCeIPD+IAAOH///+5ufYQEOIAAODX1/qKivHV1fn7+/5XV+v4+P18fO+oqPWtrfTBwfgdHeQcHOQODuIQEOIHB+GMjPGiovOHh/D////09P3+/v79/f7+/v/5+f7m5vwuLuYLC+IBAeHh4fv///8ICOEAAODe3vovL+adnfJ5ee4wMOb7+/4/P+hWVusxMeZOTuoAAOAJCeIREeMREeMAAOGQkPHFxfcAANq+vvejo/MAAN0NDeIoKOVXV+v///8vL+YMDOIAAOGXl/Pp6fwwMOYAAODZ2fra2vr///////////95ee+1tfaMjPFJSen////8/P4TE+MNDeIQEOIAAOD////////t7fzPz/n///8pKeUHB+EAAN8AAN77+/6Hh/AJCeIBAeGDg/BhYewAAOAPD+KMjPEAAOAAAN54eO////8HB+IkJOX///8AAOAAAN3MzPmgoPMBAeEPD+IREeNxce4CAuHFxfjCwvfc3Pr////////j4/vk5Pz///+GhvAEBOEZGeSDg/CcnPMAAOAjI+Tz8/3W1vmvr/VlZeza2vrx8f0AANzZ2fqJifAAAN2dnfPGxvgAAOAREeMNDeINDeIFBeH///8AAOClpfRkZOxAQOj///9qau0rK+YAAOEODuIcHORpae1qau0EBOEUFOMAAN/f3/v///+qqvW1tfZSUurDw/f09P3///9tbe3///94eO4EBOEREeMDA+GQkPH///////+urvX///+Dg/ALC+JbW+u6uvcAAN8QEOIQEOMAAN////+5ufYKCuIPD+IMDOIBAeH///+goPMAAN8AAOBJSemNjfGsrPXCwvd0dO4AAOEQEOIREeMQEOIEBOESEuMzM+deXux+fu+7u/fo6Pz///////8lJeUMDOIREeMAAODCwvfi4vsAAOAQEOIREeMLC+IfH+QhIeQNDeIQEOMHB+EWFuMAAOAAAOADA+EQEOIREeMREeMREeMQEOINDeIJCeIGBuEDA+EAAOAAAOAJCeEAAOAPD+IQEOIQEOIAAOC6uvdtbe0ICOEQEOMQEOIREeMNDeIMDOIODuIGBuEPD+IPD+IREeMPD+ImJuUPD+IREeMREeMREeMREeMPD+IWFuMGBuIAAOAAAOAWFuMMDOJQUOoKCuISEuIYGOMAAOD////NzfkAAOAQEOIVFeMQEOIPD+IjI+QcHOR0dO4JCeIAAOANDeIQEOMHB+EGBuEREeMMDOIQEOMQEOIAAOBPT+qkpPTExPe9vfeenvNRUeoAAOAMDOIQEOIQEOIAAOBeXuvg4PsAAOAQEOIREeMJCeIAAOEAAOEwMOb///9vb+3BwfcQEOIAAN9ISOl2du8CAuFFRekLC+IAAOC2tvb///+RkfF0dO6AgPCnp/T////29v4QEOINDeIKCuJISOmysvbr6/wDA+EPD+IGBuFBQei1tfZZWesCAuH///8iIuS+vvf///+fn/P///98fO8EBOEKCuIzM+YAAN////8bG+QAAN8AAOECAuEAAOAICOH///+QkPECAuEQEOICAuGPj/Hl5fwAAOAQEOMVFeP///+WlvL///9ZWev4+P0bG+QDA+H///////9ISOkAAOAREeMPD+IgIOQAAN////+pqfREROkcHOQDA+EAAOAAAOD///+envMBAeEODuIYGOOqqvV9ffAjI+UAAOFBQej39/4AAN5lZezT0/nf3/siIuTi4vuVlfJnZ+z///8AAOAPD+IREeMLC+IAAOCiovPn5/zm5vv////////////////s7PwVFeMHB+EPD+IAAOD///+NjfEwMOY/P+hra+3///4AAN8pKeX09P7MzPg/P+gAAN8AAN8YGOP+/v5LS+kJCeIMDOInJ+UzM+cuLuYgIOQXF+MsLOYyMudlZewxMeYeHuQoKOUuLuYYGOMAAOCgoPTt7fwAAN9pae3q6vz///8/P+iBgfDn5/yqqvTS0vn09P1cXOs1Nef///9ZWesHB+ENDeKoqPT9/f7w8P38/P7////7+/7///////////////////////8AAOABAeGcnPO7u/YCAuEAAN/l5fzCwvfm5vv///9DQ+ilpfSjo/RRUer///////+8vPcFBeEODuIcHOQBAeEAAN8AAOAXF+P4+P4AANwAAN4AAN2oqPSZmfILC+IjI+QQEOMBAeGXl/J9fe8YGOMICOInJ+X7+/4AAN0AAN8AAN+np/TDw/cAAOD///8AAN0ICOEFBeEREeMODuIREeMAAODx8f3///////+8vPeYmPJ7e+/NzfmurvUAAOAMDOIQEOIDA+GNjfLS0vkAAOAQEOIAAN+goPOhofMAAN4AAN+Xl/Lx8f0AAN7///8AAN////85OecICOIeHuQPD+IMDOIEBOEoKOX////IyPja2vr+/v7q6vwrK+YLC+IREeIVFeMBAeGlpfX///8ZGeQDA+F4eO/5+f7////w8P3+/v719f7////v7/3///9lZe3w8P28vPcAAOAXF+MNDeIcHOQLC+ItLebl5fxoaO0AAN0AAN0AAN0AAN8AAOAQEOMQEOIAAODT0/l3d+8BAeENDeIlJeVISOk/P+hEROlISOkaGuMkJOVpae3///+qqvWjo/MrK+ULC+IQEOIAAODIyPj////////////////////h4fvm5vzn5/zm5vwAAOAQEOMAAODMzPldXewEBOEQEOMLC+IICOEVFeIPD+IICOIMDOIHB+EcHOT///8AAN4AAOALC+IQEOINDeILC+IzM+ZISOlEROlFRelISOlMTOpMTOlMTOpSUupLS+oICOEODuILC+L///////8AAN8EBOEmJuUAAOAAAOAICOIAAOACAuEAAOAEBOFGRukZGeQPD+ILC+IAAOElJeUCAuEAAOAAAN8dHeQAAN8tLeYAAN8AAOAAAOAAAN8PD+MODuIAAOAAAOD+/v7////q6vxiYuzOzvnT0/r39/6hofPb2/qvr/W9vfaUlPODg/Dc3Ps5Oed3d++vr/X09P1SUurn5/ympvRqau2BgfBUVOrs7PzKyvh1de/i4vvi4vuenvSCgvDn5/z///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt=""></p></li><li><p>双内容：<img src="https://img.shields.io/badge/吾爱破解-吾乃木易先生-吾乃木易?color=fff&amp;logo=data:image/png;base64,AAABAAEAICAAAAAAAACoDAAAFgAAACgAAAAgAAAAQAAAAAEAGAAAAAAAgAwAAAAAAAAAAAAAAAAAAAAAAAD////////BwfdQUOr8/P7////Dw/ewsPWWlvKoqPTk5PvU1Pnt7fy0tPWFhfBxce7d3fu6uvapqfWnp/RZWev///+UlPJqau3T0/m8vPf09P3////j4/vLy/n///////////8JCeIKCuIFBeEAAOAAAOAAAOAAAOAAAOEAAOAAAOAAAOAAAOAAAOADA+EEBOEAAOAAAOEAAOAAAOAFBeEAAN8AAOAGBuEAAOAAAOAAAOAAAN8AAOAAAN+oqPX///+rq/QAAOAREeMAAOEAAOEAAOEDA+EHB+ILC+IPD+IQEOIAAOEAAOAQEOIREeMREeMQEOILC+JkZOwREeMbG+RfX+wMDOIAAOACAuEAAOAuLuZcXOsUFOMODuIAAN7JyfhOTuoNDeIAAODd3fqZmfKdnfKBgfCRkfHOzvkAAN4AAN+rq/SysvYAAN8ODuIREeMQEOIAAOD+/v6UlPIuLubr6/z////V1fp1de6/v/f///+EhPABAeEWFuMAAOCurvVzc+4GBuEuLubX1/plZe2SkvFycu5WVuvu7vybm/OlpfTMzPnNzflVVesSEuMODuIREeMJCeI2Nuf///8EBOEAAN5LS+n///////////+BgfAAAN8dHeQPD+IBAeGcnPOvr/UAAOEAAN/MzPj4+P3j4/v///+dnfP4+P5bW+tubu25ufbp6fzc3PqpqfUCAuEREeMQEOIAAN/U1PmMjPE/P+jAwPdubu0AAN4PD+L6+v5sbO0HB+EQEOIAAOC/v/fLy/kAAOAAAODf3/uurvWtrfWBgfAnJ+X///8nJ+UAAN+IiPGhofQAANsAAOAQEOIREeMREeMAAOAYGOT////s7P38/P7o6Py7u/eXl/Lx8f2amvMBAeEZGeQHB+FHR+n///8ICOIAAODR0fm/v/fR0fnNzflMTOr///7u7v339/7///////////+CgvAFBeEREeMCAuGhofOGhvD///+VlfI1NedVVep2du6NjfFkZOwAAOAJCeIPD+IAAOH///+5ufYQEOIAAODX1/qKivHV1fn7+/5XV+v4+P18fO+oqPWtrfTBwfgdHeQcHOQODuIQEOIHB+GMjPGiovOHh/D////09P3+/v79/f7+/v/5+f7m5vwuLuYLC+IBAeHh4fv///8ICOEAAODe3vovL+adnfJ5ee4wMOb7+/4/P+hWVusxMeZOTuoAAOAJCeIREeMREeMAAOGQkPHFxfcAANq+vvejo/MAAN0NDeIoKOVXV+v///8vL+YMDOIAAOGXl/Pp6fwwMOYAAODZ2fra2vr///////////95ee+1tfaMjPFJSen////8/P4TE+MNDeIQEOIAAOD////////t7fzPz/n///8pKeUHB+EAAN8AAN77+/6Hh/AJCeIBAeGDg/BhYewAAOAPD+KMjPEAAOAAAN54eO////8HB+IkJOX///8AAOAAAN3MzPmgoPMBAeEPD+IREeNxce4CAuHFxfjCwvfc3Pr////////j4/vk5Pz///+GhvAEBOEZGeSDg/CcnPMAAOAjI+Tz8/3W1vmvr/VlZeza2vrx8f0AANzZ2fqJifAAAN2dnfPGxvgAAOAREeMNDeINDeIFBeH///8AAOClpfRkZOxAQOj///9qau0rK+YAAOEODuIcHORpae1qau0EBOEUFOMAAN/f3/v///+qqvW1tfZSUurDw/f09P3///9tbe3///94eO4EBOEREeMDA+GQkPH///////+urvX///+Dg/ALC+JbW+u6uvcAAN8QEOIQEOMAAN////+5ufYKCuIPD+IMDOIBAeH///+goPMAAN8AAOBJSemNjfGsrPXCwvd0dO4AAOEQEOIREeMQEOIEBOESEuMzM+deXux+fu+7u/fo6Pz///////8lJeUMDOIREeMAAODCwvfi4vsAAOAQEOIREeMLC+IfH+QhIeQNDeIQEOMHB+EWFuMAAOAAAOADA+EQEOIREeMREeMREeMQEOINDeIJCeIGBuEDA+EAAOAAAOAJCeEAAOAPD+IQEOIQEOIAAOC6uvdtbe0ICOEQEOMQEOIREeMNDeIMDOIODuIGBuEPD+IPD+IREeMPD+ImJuUPD+IREeMREeMREeMREeMPD+IWFuMGBuIAAOAAAOAWFuMMDOJQUOoKCuISEuIYGOMAAOD////NzfkAAOAQEOIVFeMQEOIPD+IjI+QcHOR0dO4JCeIAAOANDeIQEOMHB+EGBuEREeMMDOIQEOMQEOIAAOBPT+qkpPTExPe9vfeenvNRUeoAAOAMDOIQEOIQEOIAAOBeXuvg4PsAAOAQEOIREeMJCeIAAOEAAOEwMOb///9vb+3BwfcQEOIAAN9ISOl2du8CAuFFRekLC+IAAOC2tvb///+RkfF0dO6AgPCnp/T////29v4QEOINDeIKCuJISOmysvbr6/wDA+EPD+IGBuFBQei1tfZZWesCAuH///8iIuS+vvf///+fn/P///98fO8EBOEKCuIzM+YAAN////8bG+QAAN8AAOECAuEAAOAICOH///+QkPECAuEQEOICAuGPj/Hl5fwAAOAQEOMVFeP///+WlvL///9ZWev4+P0bG+QDA+H///////9ISOkAAOAREeMPD+IgIOQAAN////+pqfREROkcHOQDA+EAAOAAAOD///+envMBAeEODuIYGOOqqvV9ffAjI+UAAOFBQej39/4AAN5lZezT0/nf3/siIuTi4vuVlfJnZ+z///8AAOAPD+IREeMLC+IAAOCiovPn5/zm5vv////////////////s7PwVFeMHB+EPD+IAAOD///+NjfEwMOY/P+hra+3///4AAN8pKeX09P7MzPg/P+gAAN8AAN8YGOP+/v5LS+kJCeIMDOInJ+UzM+cuLuYgIOQXF+MsLOYyMudlZewxMeYeHuQoKOUuLuYYGOMAAOCgoPTt7fwAAN9pae3q6vz///8/P+iBgfDn5/yqqvTS0vn09P1cXOs1Nef///9ZWesHB+ENDeKoqPT9/f7w8P38/P7////7+/7///////////////////////8AAOABAeGcnPO7u/YCAuEAAN/l5fzCwvfm5vv///9DQ+ilpfSjo/RRUer///////+8vPcFBeEODuIcHOQBAeEAAN8AAOAXF+P4+P4AANwAAN4AAN2oqPSZmfILC+IjI+QQEOMBAeGXl/J9fe8YGOMICOInJ+X7+/4AAN0AAN8AAN+np/TDw/cAAOD///8AAN0ICOEFBeEREeMODuIREeMAAODx8f3///////+8vPeYmPJ7e+/NzfmurvUAAOAMDOIQEOIDA+GNjfLS0vkAAOAQEOIAAN+goPOhofMAAN4AAN+Xl/Lx8f0AAN7///8AAN////85OecICOIeHuQPD+IMDOIEBOEoKOX////IyPja2vr+/v7q6vwrK+YLC+IREeIVFeMBAeGlpfX///8ZGeQDA+F4eO/5+f7////w8P3+/v719f7////v7/3///9lZe3w8P28vPcAAOAXF+MNDeIcHOQLC+ItLebl5fxoaO0AAN0AAN0AAN0AAN8AAOAQEOMQEOIAAODT0/l3d+8BAeENDeIlJeVISOk/P+hEROlISOkaGuMkJOVpae3///+qqvWjo/MrK+ULC+IQEOIAAODIyPj////////////////////h4fvm5vzn5/zm5vwAAOAQEOMAAODMzPldXewEBOEQEOMLC+IICOEVFeIPD+IICOIMDOIHB+EcHOT///8AAN4AAOALC+IQEOINDeILC+IzM+ZISOlEROlFRelISOlMTOpMTOlMTOpSUupLS+oICOEODuILC+L///////8AAN8EBOEmJuUAAOAAAOAICOIAAOACAuEAAOAEBOFGRukZGeQPD+ILC+IAAOElJeUCAuEAAOAAAN8dHeQAAN8tLeYAAN8AAOAAAOAAAN8PD+MODuIAAOAAAOD+/v7////q6vxiYuzOzvnT0/r39/6hofPb2/qvr/W9vfaUlPODg/Dc3Ps5Oed3d++vr/X09P1SUurn5/ympvRqau2BgfBUVOrs7PzKyvh1de/i4vvi4vuenvSCgvDn5/z///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt=""></p></li></ol><h2 id="2-4-双内容自定义颜色"><a href="#2-4-双内容自定义颜色" class="headerlink" title="2.4 双内容自定义颜色"></a>2.4 双内容自定义颜色</h2><p>前面提及双内容链接小卡片的语法和示例中可修改的颜色值都只能修改后内容的颜色。本小节将演示如何分别控制双内容的颜色。</p><h3 id="2-4-1-语法"><a href="#2-4-1-语法" class="headerlink" title="2.4.1 语法"></a>2.4.1 语法</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/后内容-防伪值?label=前内容&amp;colorA=前内容颜色值&amp;colorB=后内容颜色值</span>)</span><br></pre></td></tr></table></figure><h3 id="2-4-2-示例"><a href="#2-4-2-示例" class="headerlink" title="2.4.2 示例"></a>2.4.2 示例</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/macOS-吾乃木易先生?label=AppStore&amp;colorA=fff&amp;colorB=367aff&amp;logo=appstore</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/macOS-吾乃木易先生?label=AppStore&amp;colorA=fff&amp;colorB=367aff&amp;logo=appstore" alt=""></p><h3 id="2-4-3-注意事项"><a href="#2-4-3-注意事项" class="headerlink" title="2.4.3 注意事项"></a>2.4.3 注意事项</h3><ul><li>注意图片语法链接中的“前内容”跑到后面去了，“后内容”跑到前面去了，不要搞反了</li><li>如果要加上图标，比如上面的示例，直接在图片语法链接末尾加上 <code>&amp;logo=图标名</code> 即可，注意 <code>&amp;</code> 不要忘了</li><li>如果还要修改图标颜色，再继续在链接末尾继续加上 <code>&amp;logoColor=图标颜色值</code> 即可</li></ul><h2 id="2-5-增加超链接"><a href="#2-5-增加超链接" class="headerlink" title="2.5 增加超链接"></a>2.5 增加超链接</h2><p>我的软件分享贴的链接小卡片是可以点的，本帖当中的部分也是，这是因为在 <code>Markdown</code> 图片语法外层又套娃了一层超链接语法。</p><h3 id="2-5-1-语法"><a href="#2-5-1-语法" class="headerlink" title="2.5.1 语法"></a>2.5.1 语法</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">链接小卡片图片显示</span>](<span class="link">超链接地址</span>)</span><br></pre></td></tr></table></figure><h3 id="2-5-2-示例"><a href="#2-5-2-示例" class="headerlink" title="2.5.2 示例"></a>2.5.2 示例</h3><p>就是把 <code>2.1</code> ~ <code>2.4</code> 学到的放在超链接语法的 <code>[]</code> 里就行。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">![</span>](<span class="link">https://img.shields.io/badge/吾爱破解-吾乃木易先生?color=fff&amp;logo=data:image/png;base64,AAA...A==</span>)](<span class="link">https://www.52pojie.cn/</span>)</span><br></pre></td></tr></table></figure><p>效果：<br><img src="https://img.shields.io/badge/吾爱破解-吾乃木易先生?color=fff&amp;logo=data:image/png;base64,AAABAAEAICAAAAAAAACoDAAAFgAAACgAAAAgAAAAQAAAAAEAGAAAAAAAgAwAAAAAAAAAAAAAAAAAAAAAAAD////////BwfdQUOr8/P7////Dw/ewsPWWlvKoqPTk5PvU1Pnt7fy0tPWFhfBxce7d3fu6uvapqfWnp/RZWev///+UlPJqau3T0/m8vPf09P3////j4/vLy/n///////////8JCeIKCuIFBeEAAOAAAOAAAOAAAOAAAOEAAOAAAOAAAOAAAOAAAOADA+EEBOEAAOAAAOEAAOAAAOAFBeEAAN8AAOAGBuEAAOAAAOAAAOAAAN8AAOAAAN+oqPX///+rq/QAAOAREeMAAOEAAOEAAOEDA+EHB+ILC+IPD+IQEOIAAOEAAOAQEOIREeMREeMQEOILC+JkZOwREeMbG+RfX+wMDOIAAOACAuEAAOAuLuZcXOsUFOMODuIAAN7JyfhOTuoNDeIAAODd3fqZmfKdnfKBgfCRkfHOzvkAAN4AAN+rq/SysvYAAN8ODuIREeMQEOIAAOD+/v6UlPIuLubr6/z////V1fp1de6/v/f///+EhPABAeEWFuMAAOCurvVzc+4GBuEuLubX1/plZe2SkvFycu5WVuvu7vybm/OlpfTMzPnNzflVVesSEuMODuIREeMJCeI2Nuf///8EBOEAAN5LS+n///////////+BgfAAAN8dHeQPD+IBAeGcnPOvr/UAAOEAAN/MzPj4+P3j4/v///+dnfP4+P5bW+tubu25ufbp6fzc3PqpqfUCAuEREeMQEOIAAN/U1PmMjPE/P+jAwPdubu0AAN4PD+L6+v5sbO0HB+EQEOIAAOC/v/fLy/kAAOAAAODf3/uurvWtrfWBgfAnJ+X///8nJ+UAAN+IiPGhofQAANsAAOAQEOIREeMREeMAAOAYGOT////s7P38/P7o6Py7u/eXl/Lx8f2amvMBAeEZGeQHB+FHR+n///8ICOIAAODR0fm/v/fR0fnNzflMTOr///7u7v339/7///////////+CgvAFBeEREeMCAuGhofOGhvD///+VlfI1NedVVep2du6NjfFkZOwAAOAJCeIPD+IAAOH///+5ufYQEOIAAODX1/qKivHV1fn7+/5XV+v4+P18fO+oqPWtrfTBwfgdHeQcHOQODuIQEOIHB+GMjPGiovOHh/D////09P3+/v79/f7+/v/5+f7m5vwuLuYLC+IBAeHh4fv///8ICOEAAODe3vovL+adnfJ5ee4wMOb7+/4/P+hWVusxMeZOTuoAAOAJCeIREeMREeMAAOGQkPHFxfcAANq+vvejo/MAAN0NDeIoKOVXV+v///8vL+YMDOIAAOGXl/Pp6fwwMOYAAODZ2fra2vr///////////95ee+1tfaMjPFJSen////8/P4TE+MNDeIQEOIAAOD////////t7fzPz/n///8pKeUHB+EAAN8AAN77+/6Hh/AJCeIBAeGDg/BhYewAAOAPD+KMjPEAAOAAAN54eO////8HB+IkJOX///8AAOAAAN3MzPmgoPMBAeEPD+IREeNxce4CAuHFxfjCwvfc3Pr////////j4/vk5Pz///+GhvAEBOEZGeSDg/CcnPMAAOAjI+Tz8/3W1vmvr/VlZeza2vrx8f0AANzZ2fqJifAAAN2dnfPGxvgAAOAREeMNDeINDeIFBeH///8AAOClpfRkZOxAQOj///9qau0rK+YAAOEODuIcHORpae1qau0EBOEUFOMAAN/f3/v///+qqvW1tfZSUurDw/f09P3///9tbe3///94eO4EBOEREeMDA+GQkPH///////+urvX///+Dg/ALC+JbW+u6uvcAAN8QEOIQEOMAAN////+5ufYKCuIPD+IMDOIBAeH///+goPMAAN8AAOBJSemNjfGsrPXCwvd0dO4AAOEQEOIREeMQEOIEBOESEuMzM+deXux+fu+7u/fo6Pz///////8lJeUMDOIREeMAAODCwvfi4vsAAOAQEOIREeMLC+IfH+QhIeQNDeIQEOMHB+EWFuMAAOAAAOADA+EQEOIREeMREeMREeMQEOINDeIJCeIGBuEDA+EAAOAAAOAJCeEAAOAPD+IQEOIQEOIAAOC6uvdtbe0ICOEQEOMQEOIREeMNDeIMDOIODuIGBuEPD+IPD+IREeMPD+ImJuUPD+IREeMREeMREeMREeMPD+IWFuMGBuIAAOAAAOAWFuMMDOJQUOoKCuISEuIYGOMAAOD////NzfkAAOAQEOIVFeMQEOIPD+IjI+QcHOR0dO4JCeIAAOANDeIQEOMHB+EGBuEREeMMDOIQEOMQEOIAAOBPT+qkpPTExPe9vfeenvNRUeoAAOAMDOIQEOIQEOIAAOBeXuvg4PsAAOAQEOIREeMJCeIAAOEAAOEwMOb///9vb+3BwfcQEOIAAN9ISOl2du8CAuFFRekLC+IAAOC2tvb///+RkfF0dO6AgPCnp/T////29v4QEOINDeIKCuJISOmysvbr6/wDA+EPD+IGBuFBQei1tfZZWesCAuH///8iIuS+vvf///+fn/P///98fO8EBOEKCuIzM+YAAN////8bG+QAAN8AAOECAuEAAOAICOH///+QkPECAuEQEOICAuGPj/Hl5fwAAOAQEOMVFeP///+WlvL///9ZWev4+P0bG+QDA+H///////9ISOkAAOAREeMPD+IgIOQAAN////+pqfREROkcHOQDA+EAAOAAAOD///+envMBAeEODuIYGOOqqvV9ffAjI+UAAOFBQej39/4AAN5lZezT0/nf3/siIuTi4vuVlfJnZ+z///8AAOAPD+IREeMLC+IAAOCiovPn5/zm5vv////////////////s7PwVFeMHB+EPD+IAAOD///+NjfEwMOY/P+hra+3///4AAN8pKeX09P7MzPg/P+gAAN8AAN8YGOP+/v5LS+kJCeIMDOInJ+UzM+cuLuYgIOQXF+MsLOYyMudlZewxMeYeHuQoKOUuLuYYGOMAAOCgoPTt7fwAAN9pae3q6vz///8/P+iBgfDn5/yqqvTS0vn09P1cXOs1Nef///9ZWesHB+ENDeKoqPT9/f7w8P38/P7////7+/7///////////////////////8AAOABAeGcnPO7u/YCAuEAAN/l5fzCwvfm5vv///9DQ+ilpfSjo/RRUer///////+8vPcFBeEODuIcHOQBAeEAAN8AAOAXF+P4+P4AANwAAN4AAN2oqPSZmfILC+IjI+QQEOMBAeGXl/J9fe8YGOMICOInJ+X7+/4AAN0AAN8AAN+np/TDw/cAAOD///8AAN0ICOEFBeEREeMODuIREeMAAODx8f3///////+8vPeYmPJ7e+/NzfmurvUAAOAMDOIQEOIDA+GNjfLS0vkAAOAQEOIAAN+goPOhofMAAN4AAN+Xl/Lx8f0AAN7///8AAN////85OecICOIeHuQPD+IMDOIEBOEoKOX////IyPja2vr+/v7q6vwrK+YLC+IREeIVFeMBAeGlpfX///8ZGeQDA+F4eO/5+f7////w8P3+/v719f7////v7/3///9lZe3w8P28vPcAAOAXF+MNDeIcHOQLC+ItLebl5fxoaO0AAN0AAN0AAN0AAN8AAOAQEOMQEOIAAODT0/l3d+8BAeENDeIlJeVISOk/P+hEROlISOkaGuMkJOVpae3///+qqvWjo/MrK+ULC+IQEOIAAODIyPj////////////////////h4fvm5vzn5/zm5vwAAOAQEOMAAODMzPldXewEBOEQEOMLC+IICOEVFeIPD+IICOIMDOIHB+EcHOT///8AAN4AAOALC+IQEOINDeILC+IzM+ZISOlEROlFRelISOlMTOpMTOlMTOpSUupLS+oICOEODuILC+L///////8AAN8EBOEmJuUAAOAAAOAICOIAAOACAuEAAOAEBOFGRukZGeQPD+ILC+IAAOElJeUCAuEAAOAAAN8dHeQAAN8tLeYAAN8AAOAAAOAAAN8PD+MODuIAAOAAAOD+/v7////q6vxiYuzOzvnT0/r39/6hofPb2/qvr/W9vfaUlPODg/Dc3Ps5Oed3d++vr/X09P1SUurn5/ympvRqau2BgfBUVOrs7PzKyvh1de/i4vvi4vuenvSCgvDn5/z///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt=""></p><p>其他的可以自行尝试。</p><h2 id="2-6-样式"><a href="#2-6-样式" class="headerlink" title="2.6 样式"></a>2.6 样式</h2><p>有五种样式可供选择。</p><h3 id="2-6-1-默认"><a href="#2-6-1-默认" class="headerlink" title="2.6.1 默认"></a>2.6.1 默认</h3><p>默认就是这种带立体感的圆角矩形样式。</p><p>示例：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/style=plastic-吾乃木易先生?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/style=plastic-吾乃木易先生?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git" alt=""></p><blockquote><p>默认实际上就是 <code>&amp;style=plastic</code>。</p></blockquote><h3 id="2-6-2-扁平圆角矩形"><a href="#2-6-2-扁平圆角矩形" class="headerlink" title="2.6.2 扁平圆角矩形"></a>2.6.2 扁平圆角矩形</h3><h4 id="2-6-2-1-语法"><a href="#2-6-2-1-语法" class="headerlink" title="2.6.2.1 语法"></a>2.6.2.1 语法</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;style=flat</span><br></pre></td></tr></table></figure><h4 id="2-6-2-2-示例"><a href="#2-6-2-2-示例" class="headerlink" title="2.6.2.2 示例"></a>2.6.2.2 示例</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/style=flat-吾乃木易先生?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=flat</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/style%20=%20flat-吾乃木易先生?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=flat" alt=""></p><h3 id="2-6-3-扁平直角矩形"><a href="#2-6-3-扁平直角矩形" class="headerlink" title="2.6.3 扁平直角矩形"></a>2.6.3 扁平直角矩形</h3><h4 id="2-6-3-1-语法"><a href="#2-6-3-1-语法" class="headerlink" title="2.6.3.1 语法"></a>2.6.3.1 语法</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;style=flat-square</span><br></pre></td></tr></table></figure><h4 id="2-6-3-2-示例"><a href="#2-6-3-2-示例" class="headerlink" title="2.6.3.2 示例"></a>2.6.3.2 示例</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/style=flat--square-吾乃木易先生?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=flat-square</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/style%20=%20flat--square-吾乃木易先生?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=flat-square" alt=""></p><h3 id="2-6-4-大扁平圆角矩形-字母全大写"><a href="#2-6-4-大扁平圆角矩形-字母全大写" class="headerlink" title="2.6.4 大扁平圆角矩形 - 字母全大写"></a>2.6.4 大扁平圆角矩形 - 字母全大写</h3><h4 id="2-6-4-1-语法"><a href="#2-6-4-1-语法" class="headerlink" title="2.6.4.1 语法"></a>2.6.4.1 语法</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;style=for-the-badge</span><br></pre></td></tr></table></figure><h4 id="2-6-4-2-示例"><a href="#2-6-4-2-示例" class="headerlink" title="2.6.4.2 示例"></a>2.6.4.2 示例</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/style=for--the--badge-吾乃木易先生?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=for-the-badge</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/style%20=%20for--the--badge-吾乃木易先生?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=for-the-badge" alt=""></p><h3 id="2-6-5-GitHub-交流样式"><a href="#2-6-5-GitHub-交流样式" class="headerlink" title="2.6.5 GitHub 交流样式"></a>2.6.5 GitHub 交流样式</h3><h4 id="2-6-5-1-语法"><a href="#2-6-5-1-语法" class="headerlink" title="2.6.5.1 语法"></a>2.6.5.1 语法</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;style=social</span><br></pre></td></tr></table></figure><h4 id="2-6-5-2-示例"><a href="#2-6-5-2-示例" class="headerlink" title="2.6.5.2 示例"></a>2.6.5.2 示例</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/style=social-吾乃木易先生?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=social</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/style%20=%20social-吾乃木易先生?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=social" alt=""></p><h2 id="2-7-动态内容"><a href="#2-7-动态内容" class="headerlink" title="2.7 动态内容"></a>2.7 动态内容</h2><p>动态内容即显示的内容为可变的，主要用于 GitHub 等网站的某些数据显示。</p><p>这里的动态内容只介绍与 GitHub 相关的一部分，想了解更多可以去官网查询。</p><p>以 Linux 之父林纳斯·托瓦斯的 Linux 源代码仓库 <code>torvalds/linux</code> 为示例。</p><h2 id="2-7-1-Watch"><a href="#2-7-1-Watch" class="headerlink" title="2.7.1 Watch"></a>2.7.1 Watch</h2><p>语法：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/watchers/用户名/仓库名?style=social&amp;label=Watch</span>)</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/watchers/torvalds/linux?style=social&amp;label=Watch</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/github/watchers/torvalds/linux?style=social&amp;label=Watch" alt=""></p><h2 id="2-7-2-Star"><a href="#2-7-2-Star" class="headerlink" title="2.7.2 Star"></a>2.7.2 Star</h2><p>语法：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/stars/用户名/仓库名?style=social</span>)</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/stars/torvalds/linux?style=social&amp;label=star</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/github/stars/torvalds/linux?style=social&amp;label=star" alt=""></p><h2 id="2-7-3-Fork"><a href="#2-7-3-Fork" class="headerlink" title="2.7.3 Fork"></a>2.7.3 Fork</h2><p>语法：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/forks/用户名/仓库名?style=social&amp;label=Fork</span>)</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/github/forks/torvalds/linux?style=social&amp;label=Fork</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/github/forks/torvalds/linux?style=social&amp;label=Fork" alt=""></p><p>其他的可以自行尝试。</p><h1 id="3-特殊符号问题"><a href="#3-特殊符号问题" class="headerlink" title="3 特殊符号问题"></a>3 特殊符号问题</h1><p>有时候需要空格或者其他的特殊符号，直接打在链接里可能会导致结果不符合预期。</p><p>解决方法其实很简单，就是把特殊符号转换成 <code>url</code> 编码即可。</p><h2 id="3-1-空格示例"><a href="#3-1-空格示例" class="headerlink" title="3.1 空格示例"></a>3.1 空格示例</h2><p>之前 App Store 那个示例中是没有空格的，现在添加空格（空格的 <code>url</code> 编码是 <code>%20</code> ）：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/macOS-吾乃木易先生?label=App%20Store&amp;colorA=fff&amp;colorB=367aff&amp;logo=appstore</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/macOS-吾乃木易先生?label=App%20Store&amp;colorA=fff&amp;colorB=367aff&amp;logo=appstore" alt=""></p><h2 id="3-2-短横-符号示例"><a href="#3-2-短横-符号示例" class="headerlink" title="3.2 短横 - 符号示例"></a>3.2 短横 <code>-</code> 符号示例</h2><p>短横符号 <code>-</code> 比较特殊，它没有 <code>url</code> 编码，或者说它的 <code>url</code> 编码就是它本身。 要想在小卡片中显示它也很简单，写两遍就行。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](<span class="link">https://img.shields.io/badge/-everything--is--local-吾乃木易先生?label=git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git</span>)</span><br></pre></td></tr></table></figure><p>效果：<img src="https://img.shields.io/badge/-everything--is--local-吾乃木易先生?label=git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git" alt=""></p><h1 id="4-写在最后"><a href="#4-写在最后" class="headerlink" title="4. 写在最后"></a>4. 写在最后</h1><p>本帖内容的 <code>.md</code> 源文件也一并分享给大家，任何一款 Markdown 编辑器均支持以上所有操作和显示相关内容。</p><blockquote><p>纸上得来终觉浅，绝知此事要躬行。——陆游《冬夜读书示子聿》</p></blockquote><p>看和听再多，也比不上自己动手试一遍。学习这件事儿，眼睛和耳朵告诉脑子会了，也要脑子能指挥手会才行。</p><p>祝各位学习愉快，技术大成！<br>祝祖国繁荣昌盛，国泰民安！</p><p><img src="https://img.shields.io/badge/热烈庆祝中华人民共和国成立72周年！-吾乃木易先生?color=fff&amp;logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAgCAYAAABU1PscAAAAAXNSR0IArs4c6QAAAORlWElmTU0AKgAAAAgABgESAAMAAAABAAEAAAEaAAUAAAABAAAAVgEbAAUAAAABAAAAXgExAAIAAAAfAAAAZgEyAAIAAAAUAAAAhodpAAQAAAABAAAAmgAAAAAAAABIAAAAAQAAAEgAAAABQWRvYmUgUGhvdG9zaG9wIDIxLjAgKFdpbmRvd3MpAAAyMDIwOjEyOjI4IDA5OjI2OjU1AAAEkAQAAgAAABQAAADQoAEAAwAAAAEAAQAAoAIABAAAAAEAAAAwoAMABAAAAAEAAAAgAAAAADIwMjE6MDE6MDkgMTY6MzQ6NDAA5X3tpAAAAAlwSFlzAAALEwAACxMBAJqcGAAACtJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICAgICAgICAgICB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iCiAgICAgICAgICAgIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIgogICAgICAgICAgICB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIgogICAgICAgICAgICB4bWxuczpwaG90b3Nob3A9Imh0dHA6Ly9ucy5hZG9iZS5jb20vcGhvdG9zaG9wLzEuMC8iCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPGRjOmZvcm1hdD5pbWFnZS9wbmc8L2RjOmZvcm1hdD4KICAgICAgICAgPHhtcDpNb2RpZnlEYXRlPjIwMjAtMTItMjhUMDk6MjY6NTUrMDg6MDA8L3htcDpNb2RpZnlEYXRlPgogICAgICAgICA8eG1wOkNyZWF0b3JUb29sPkFkb2JlIFBob3Rvc2hvcCAyMS4wIChXaW5kb3dzKTwveG1wOkNyZWF0b3JUb29sPgogICAgICAgICA8eG1wOkNyZWF0ZURhdGU+MjAyMS0wMS0wOVQxNjozNDo0MCswODowMDwveG1wOkNyZWF0ZURhdGU+CiAgICAgICAgIDx4bXA6TWV0YWRhdGFEYXRlPjIwMjAtMTItMjhUMDk6MjY6NTUrMDg6MDA8L3htcDpNZXRhZGF0YURhdGU+CiAgICAgICAgIDx4bXBNTTpIaXN0b3J5PgogICAgICAgICAgICA8cmRmOlNlcT4KICAgICAgICAgICAgICAgPHJkZjpsaSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDpzb2Z0d2FyZUFnZW50PkFkb2JlIFBob3Rvc2hvcCAyMS4wIChXaW5kb3dzKTwvc3RFdnQ6c29mdHdhcmVBZ2VudD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OndoZW4+MjAyMS0wMS0wOVQxNjozNDo0MCswODowMDwvc3RFdnQ6d2hlbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0Omluc3RhbmNlSUQ+eG1wLmlpZDplMzkyNjg5OS1iMGI4LWNhNDctYWJkMC0yODkwMTZkNWNkNDc8L3N0RXZ0Omluc3RhbmNlSUQ+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDphY3Rpb24+Y3JlYXRlZDwvc3RFdnQ6YWN0aW9uPgogICAgICAgICAgICAgICA8L3JkZjpsaT4KICAgICAgICAgICAgICAgPHJkZjpsaSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDpzb2Z0d2FyZUFnZW50PkFkb2JlIFBob3Rvc2hvcCAyMS4wIChXaW5kb3dzKTwvc3RFdnQ6c29mdHdhcmVBZ2VudD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmNoYW5nZWQ+Lzwvc3RFdnQ6Y2hhbmdlZD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OndoZW4+MjAyMS0wMS0wOVQxNjozNzowNyswODowMDwvc3RFdnQ6d2hlbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0Omluc3RhbmNlSUQ+eG1wLmlpZDoyOGQ3ZjhmNi04ZmFkLWY0NDQtYjdiMS05NDhlNmEwYzVlMjg8L3N0RXZ0Omluc3RhbmNlSUQ+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDphY3Rpb24+c2F2ZWQ8L3N0RXZ0OmFjdGlvbj4KICAgICAgICAgICAgICAgPC9yZGY6bGk+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6c29mdHdhcmVBZ2VudD5BZG9iZSBQaG90b3Nob3AgMjEuMCAoV2luZG93cyk8L3N0RXZ0OnNvZnR3YXJlQWdlbnQ+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDpjaGFuZ2VkPi88L3N0RXZ0OmNoYW5nZWQ+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDp3aGVuPjIwMjAtMTItMjhUMDk6MjY6NTUrMDg6MDA8L3N0RXZ0OndoZW4+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDppbnN0YW5jZUlEPnhtcC5paWQ6MGI4M2Y4ZTAtYTEwMS1kZDRhLTgwZGMtZjE1ODMyYmQ2OTNlPC9zdEV2dDppbnN0YW5jZUlEPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6YWN0aW9uPnNhdmVkPC9zdEV2dDphY3Rpb24+CiAgICAgICAgICAgICAgIDwvcmRmOmxpPgogICAgICAgICAgICA8L3JkZjpTZXE+CiAgICAgICAgIDwveG1wTU06SGlzdG9yeT4KICAgICAgICAgPHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD54bXAuZGlkOmUzOTI2ODk5LWIwYjgtY2E0Ny1hYmQwLTI4OTAxNmQ1Y2Q0NzwveG1wTU06T3JpZ2luYWxEb2N1bWVudElEPgogICAgICAgICA8eG1wTU06RG9jdW1lbnRJRD5hZG9iZTpkb2NpZDpwaG90b3Nob3A6OGM1NWRiMGEtMzNiMC00YjRjLTg3NGEtOWQzNmQ5YTA5YWMyPC94bXBNTTpEb2N1bWVudElEPgogICAgICAgICA8eG1wTU06SW5zdGFuY2VJRD54bXAuaWlkOjBiODNmOGUwLWExMDEtZGQ0YS04MGRjLWYxNTgzMmJkNjkzZTwveG1wTU06SW5zdGFuY2VJRD4KICAgICAgICAgPHBob3Rvc2hvcDpJQ0NQcm9maWxlPnNSR0IgSUVDNjE5NjYtMi4xPC9waG90b3Nob3A6SUNDUHJvZmlsZT4KICAgICAgICAgPHBob3Rvc2hvcDpDb2xvck1vZGU+MzwvcGhvdG9zaG9wOkNvbG9yTW9kZT4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CqSBErgAAAUISURBVFgJ1ZjPa11FFMfP3PcjTdIkbUobIbXmCbWCBRf+By5c+GOjLhQVFLeKLrX/RZe6aoWCrt0YBBU3IrjRVpRCsGJTxSSa38nLy7vj5zv33nGMjS/WvD48ZO7MnDlzzvc7M2fuzXO/nT677sya3oy/PwWdGQ8pXTIS+tJ30R+nXsYgk3FhF8Zp762DQaKv+vvV6fzb2QBBsHbqDA4Rv56XVhVwA6ANYyX9NiU0qKgFPjtqln/rzA3hBiJWYwxHFdnSvJomL1GqsajYp7HXTn0Rk2jNtIYikAsrEsbCQ4ojlDmpkRZlhyIPmrmB8Sj8Plul423r2fEw22vOLmVvZFSpVCBS3e3ae+3SvsAzJxcBLarQs5ylG1bXX3dWewUzBrqXMnMzjImYCAgkK954cN08W+ceGTP/FZNPoF+kyK7yRfOwRUQEQ5jrxFFf4gnsbBLtKW/59cyaz20GIFuXxsydyc0vYr2OZZPSMFt7fcrcCWxnS7RLrMEU7g64Ewp6J1JiDqe5LhY6t75GzVn31zIr8sFZ46ENKOa2aRPW/bwAmR1j9Bhh59m/q+wMRMSyebFt2Zld23ln2PxH2LZQdzTWFwlghF1HKKyYmzPvns/d8KtrJGkBtja1TmJ6G5ldCWYOuu3Lo9Z9D+BnmX0KNcfJ/eSt+ei6Nc8vWWf2fhagXiR3/wiAvTikBQFA+BaKTzLrPlG30RduBsCWF0SGH/s59Dc+OG35p4C/j26boq0iFzzt7cvj1p4+avnXjE/jn9PXL9HKF8ho8B7Y4Qg1cl2DJF8+n1ntmV0be/eW1Sa3AoZ8+YitvjZt3St1y1qgVpJWiaq10DH6ESKeHLgHRbEsYW4/HgpZJnFHddgMt0sSc+9nJ0nWeWfZmO7NQpzaJHDIjjF0Ohpaggr8jRL8pDf/CwND5RhVP4QIihykIECTl5Oz49woC5kNvaXbx9vqhZatvt1itZ0NvbHBicG8wVx2K7jQbPG8lzR6f9NGPl622ktszRw63UQxDO1DFNxq+YLEzc6anIBFx9liB1ZrtvJyy/IrQmq2cmPGGo/vFDtwk7kCp/Ove5/z77/jnfHANkn8u2278YA7XA8xDHaHKLjV0gTvRQ5oXdXV0eCK9N+r4809HCrz31Bj784xTy9f0Wah/a3SjiPjns7NjcDrGjrNn8BGJPsgQq/Np+5EAooVUlskFFxWaxQJb+YwQx9ugLQFyjneZ2/y4uCotV8keYKULzLlQJ/AK0xKIB6hEF8julH41gkANCqdrkQttsYETHh/4CQ9yXcD452nps1/gQFva1ug7iN4Iv9FIgHCCqoLT5mUexSsBV4iC+lF6Ly3jYt8SpAP+Yfc/TMM/loZMt5HiViJEQkQPr4c9o0tfLp1TlKuOtv9Uh9F5IrAV1crmn5LijUSSFn9IwCREFhIuAlc6V2nIv1dkhRrJJCy6olDYLmFbImiI3WXJcX638KLCN4GKZFAuS2DxHLg2CnWSEDbcmAPAzZMsUYCKasB4+sZPsUaCaSsenoYsEGKNRJIWQ0YX8/wKdZIIGXV08OADVKskUDKasD4eoZPsUYCKaueHgZskGLNKjYwQf//kAqrsPOjSSFlvad7+ISqAHfguZrqYwMn+hbSLkjK6m/toDisRxrkX/qspoZaD4hkItAu//8IvwKh1Gd1IJm2FUx91ZLUpuqn48Fon4fmHtS2clHNKesAnrH2H0L4jqZ5ojB6AAAAAElFTkSuQmCC&amp;style=for-the-badge" alt=""></p><blockquote><p>此国旗图案来源于中国政府网的“网络使用的国旗图案标准版本”，使用符合《中华人民共和国国旗法》。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;font size=5&gt;&lt;b&gt;文章说明&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;strong&gt;文章作者：&lt;/strong&gt;&lt;a href=&quot;https://hwame.top&quot;&gt;鴻塵&lt;/a&gt;&lt;br&gt;&lt;strong&gt;文章链接：&lt;/strong&gt;&lt;a href</summary>
      
    
    
    
    <category term="miscellanea" scheme="https://hwame.top/categories/miscellanea/"/>
    
    
    <category term="miscellanea" scheme="https://hwame.top/tags/miscellanea/"/>
    
  </entry>
  
  <entry>
    <title>Shell正则表达式</title>
    <link href="https://hwame.top/20220116/shell-regular-expression.html"/>
    <id>https://hwame.top/20220116/shell-regular-expression.html</id>
    <published>2022-01-16T14:13:05.000Z</published>
    <updated>2022-02-22T16:10:38.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章链接：</strong><a href="https://hwame.top/20220116/shell-regular-expression.html">https://hwame.top/20220116/shell-regular-expression.html</a><br><strong>参考资料：</strong></p><ul><li><a href="https://www.cnblogs.com/DengGao/p/5935730.html">shell-正则表达式</a></li><li><a href="https://blog.csdn.net/weini1111/article/details/72896874">「通配符」和「正则表达式」的区别</a></li><li><a href="https://blog.eetop.cn/blog-554165-26125.html">正则表达式和通配符的区别</a></li></ul></blockquote><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1.定义"></a>1.定义</h2><p>正则表达式(regular expression)是指一个用来描述或者匹配一系列符合某个句法规则的字符串的单个字符串，它描述了一种字符串匹配的模式（pattern），可以用来检查一个串是否含有某种子串、将匹配的子串替换或者从某个串中取出符合某个条件的子串等。</p><p>只有掌握了正则表达式，才能全面地掌握 Linux 下的常用文本工具（例如：<code>grep</code>、<code>egrep</code>、GUN <code>sed</code>、 <code>awk</code> 等） 的用法。</p><h2 id="2-正则表达式分类"><a href="#2-正则表达式分类" class="headerlink" title="2.正则表达式分类"></a>2.正则表达式分类</h2><ul><li>基本的正则表达式（Basic Regular Expression，又叫 Basic RegEx，简称 BREs）；</li><li>扩展的正则表达式（Extended Regular Expression，又叫 Extended RegEx，简称 EREs）；</li><li>Perl 的正则表达式（Perl Regular Expression，又叫 Perl RegEx，简称 PREs）。</li></ul><h2 id="3-Linux常用文本工具与正则表达式的关系"><a href="#3-Linux常用文本工具与正则表达式的关系" class="headerlink" title="3.Linux常用文本工具与正则表达式的关系"></a>3.Linux常用文本工具与正则表达式的关系</h2><p>常握 Linux 下几种常用文本工具的特点，对于我们更好的使用正则表达式是很有帮助的。</p><blockquote><p>表格内容来自参考资料 <a href="https://www.cnblogs.com/DengGao/p/5935730.html">《shell-正则表达式》</a>，暂未对其验证。</p></blockquote><div class="table-container"><table><thead><tr><th style="text-align:center">命令</th><th style="text-align:center">BREs</th><th style="text-align:center">EREs</th><th style="text-align:center">PREs</th><th style="text-align:center">处理模式</th></tr></thead><tbody><tr><td style="text-align:center"><code>grep</code></td><td style="text-align:center">默认</td><td style="text-align:center"><code>-E</code>参数</td><td style="text-align:center"><code>-P</code>参数</td><td style="text-align:center">行</td></tr><tr><td style="text-align:center"><code>egrep</code></td><td style="text-align:center">——</td><td style="text-align:center">默认</td><td style="text-align:center"><code>-P</code>参数</td><td style="text-align:center">行</td></tr><tr><td style="text-align:center"><code>sed</code></td><td style="text-align:center">默认</td><td style="text-align:center"><code>-r</code>参数</td><td style="text-align:center">——</td><td style="text-align:center">行</td></tr><tr><td style="text-align:center"><code>awk</code></td><td style="text-align:center">——</td><td style="text-align:center">默认</td><td style="text-align:center">——</td><td style="text-align:center">列</td></tr></tbody></table></div><h2 id="4-正则表达式比较"><a href="#4-正则表达式比较" class="headerlink" title="4.正则表达式比较"></a>4.正则表达式比较</h2><p>注释见表格下方。</p><div class="table-container"><table><thead><tr><th style="text-align:center">字符</th><th style="text-align:center">BREs</th><th style="text-align:center">EREs</th><th style="text-align:center">Python</th><th style="text-align:center">PREs</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:center"><code>\</code></td><td style="text-align:center"><code>\</code></td><td style="text-align:center"><code>\</code></td><td style="text-align:center"><code>\</code></td><td style="text-align:center"><code>\</code></td><td style="text-align:left">转义字符</td></tr><tr><td style="text-align:center"><code>^</code></td><td style="text-align:center"><code>^</code></td><td style="text-align:center"><code>^</code></td><td style="text-align:center"><code>^</code></td><td style="text-align:center"><code>^</code></td><td style="text-align:left">匹配行首<sup><a href="#fn_[1]" id="reffn_[1]">[1]</a></sup></td></tr><tr><td style="text-align:center">$$`</td><td style="text-align:center">`$$</td><td style="text-align:center">$$`</td><td style="text-align:center">`$$</td><td style="text-align:center"><code>$</code></td><td style="text-align:left">匹配行尾<sup><a href="#fn_[2]" id="reffn_[2]">[2]</a></sup></td></tr><tr><td style="text-align:center"><code>^$</code></td><td style="text-align:center"><code>^$</code></td><td style="text-align:center"><code>^$</code></td><td style="text-align:center"><code>^$</code></td><td style="text-align:center"><code>^$</code></td><td style="text-align:left">匹配空行</td></tr><tr><td style="text-align:center"><code>\&lt;</code></td><td style="text-align:center"><code>\&lt;</code></td><td style="text-align:center"><code>\&lt;</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:left">匹配单词开头<sup><a href="#fn_[3]" id="reffn_[3]">[3]</a></sup>，等价于<code>\b</code></td></tr><tr><td style="text-align:center"><code>\&gt;</code></td><td style="text-align:center"><code>&gt;</code></td><td style="text-align:center"><code>\&gt;</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:left">匹配单词结尾，等价于<code>\b</code></td></tr><tr><td style="text-align:center"><code>\&lt;string\&gt;</code></td><td style="text-align:center"><code>\&lt;string\&gt;</code></td><td style="text-align:center"><code>\&lt;string\&gt;</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:left">匹配单词或特定字符<code>string</code><sup><a href="#fn_[4]" id="reffn_[4]">[4]</a></sup></td></tr><tr><td style="text-align:center"><code>()</code></td><td style="text-align:center"><code>\(\)</code></td><td style="text-align:center"><code>()</code></td><td style="text-align:center"><code>()</code></td><td style="text-align:center"><code>()</code></td><td style="text-align:left">匹配表达式<sup><a href="#fn_[5]" id="reffn_[5]">[5]</a></sup></td></tr><tr><td style="text-align:center"><code>?</code></td><td style="text-align:center"><code>\?</code></td><td style="text-align:center"><code>?</code></td><td style="text-align:center"><code>?</code></td><td style="text-align:center"><code>?</code></td><td style="text-align:left">匹配0次或1次<sup><a href="#fn_[6]" id="reffn_[6]">[6]</a></sup></td></tr><tr><td style="text-align:center"><code>?</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:left">非贪婪匹配<sup><a href="#fn_[7]" id="reffn_[7]">[7]</a></sup></td></tr><tr><td style="text-align:center"><code>.</code></td><td style="text-align:center"><code>.</code></td><td style="text-align:center"><code>.</code></td><td style="text-align:center"><code>.</code></td><td style="text-align:center"><code>.</code></td><td style="text-align:left">匹配任意单个字符<sup><a href="#fn_[8]" id="reffn_[8]">[8]</a></sup></td></tr><tr><td style="text-align:center"><code>*</code></td><td style="text-align:center"><code>*</code></td><td style="text-align:center"><code>*</code></td><td style="text-align:center"><code>*</code></td><td style="text-align:center"><code>*</code></td><td style="text-align:left">匹配0次或多次</td></tr><tr><td style="text-align:center"><code>+</code></td><td style="text-align:center"><code>\+</code></td><td style="text-align:center"><code>+</code></td><td style="text-align:center"><code>+</code></td><td style="text-align:center"><code>+</code></td><td style="text-align:left">匹配1次或多次</td></tr><tr><td style="text-align:center"><code>&#123;n&#125;</code></td><td style="text-align:center"><code>\&#123;n\&#125;</code></td><td style="text-align:center"><code>&#123;n&#125;</code></td><td style="text-align:center"><code>&#123;n&#125;</code></td><td style="text-align:center"><code>&#123;n&#125;</code></td><td style="text-align:left">匹配n次</td></tr><tr><td style="text-align:center"><code>&#123;n,&#125;</code></td><td style="text-align:center"><code>\&#123;n,\&#125;</code></td><td style="text-align:center"><code>&#123;n,&#125;</code></td><td style="text-align:center"><code>&#123;n,&#125;</code></td><td style="text-align:center"><code>&#123;n,&#125;</code></td><td style="text-align:left">匹配大于等于n次</td></tr><tr><td style="text-align:center"><code>&#123;n,m&#125;</code></td><td style="text-align:center"><code>\&#123;n,m\&#125;</code></td><td style="text-align:center"><code>&#123;n,m&#125;</code></td><td style="text-align:center"><code>&#123;n,m&#125;</code></td><td style="text-align:center"><code>&#123;n,m&#125;</code></td><td style="text-align:left">匹配n~m次<sup><a href="#fn_[9]" id="reffn_[9]">[9]</a></sup></td></tr><tr><td style="text-align:center"><code>x｜y</code></td><td style="text-align:center"><code>x｜y</code></td><td style="text-align:center"><code>x｜y</code></td><td style="text-align:center"><code>x｜y</code></td><td style="text-align:center"><code>x｜y</code></td><td style="text-align:left">匹配<code>x</code>或<code>y</code><sup><a href="#fn_[10]" id="reffn_[10]">[10]</a></sup></td></tr><tr><td style="text-align:center"><code>[0-9]</code></td><td style="text-align:center"><code>[0-9]</code></td><td style="text-align:center"><code>[0-9]</code></td><td style="text-align:center"><code>[0-9]</code></td><td style="text-align:center"><code>[0-9]</code></td><td style="text-align:left">匹配一个数字字符<sup><a href="#fn_[11]" id="reffn_[11]">[11]</a></sup></td></tr><tr><td style="text-align:center"><code>[xyz]</code></td><td style="text-align:center"><code>[xyz]</code></td><td style="text-align:center"><code>[xyz]</code></td><td style="text-align:center"><code>[xyz]</code></td><td style="text-align:center"><code>[xyz]</code></td><td style="text-align:left">匹配字符集合中的任一字符<sup><a href="#fn_[12]" id="reffn_[12]">[12]</a></sup></td></tr><tr><td style="text-align:center"><code>[^xyz]</code></td><td style="text-align:center"><code>[^xyz]</code></td><td style="text-align:center"><code>[^xyz]</code></td><td style="text-align:center"><code>[^xyz]</code></td><td style="text-align:center"><code>[^xyz]</code></td><td style="text-align:left">匹配字符集合以外的任一字符<sup><a href="#fn_[13]" id="reffn_[13]">[13]</a></sup></td></tr><tr><td style="text-align:center"><code>[A-Za-z]</code></td><td style="text-align:center"><code>[A-Za-z]</code></td><td style="text-align:center"><code>[A-Za-z]</code></td><td style="text-align:center"><code>[A-Za-z]</code></td><td style="text-align:center"><code>[A-Za-z]</code></td><td style="text-align:left">匹配任一字母</td></tr><tr><td style="text-align:center"><code>[^A-Za-z]</code></td><td style="text-align:center"><code>[^A-Za-z]</code></td><td style="text-align:center"><code>[^A-Za-z]</code></td><td style="text-align:center"><code>[^A-Za-z]</code></td><td style="text-align:center"><code>[^A-Za-z]</code></td><td style="text-align:left">匹配除字母外的任一字符</td></tr><tr><td style="text-align:center"><code>\d</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"><code>\d</code></td><td style="text-align:center"><code>\d</code></td><td style="text-align:left">匹配任一数字字符，等价于<code>[0-9]</code></td></tr><tr><td style="text-align:center"><code>\D</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"><code>\D</code></td><td style="text-align:center"><code>\D</code></td><td style="text-align:left">匹配任一非数字字符，等价于<code>[^0-9]</code></td></tr><tr><td style="text-align:center"><code>\s</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"><code>\s</code></td><td style="text-align:center"><code>\s</code></td><td style="text-align:left">匹配任一空白字符，等价于<code>[\f\n\r\t\v]</code></td></tr><tr><td style="text-align:center"><code>\S</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"><code>\S</code></td><td style="text-align:center"><code>\S</code></td><td style="text-align:left">匹配任一非空白字符，等价于<code>[^\f\n\r\t\v]</code></td></tr><tr><td style="text-align:center"><code>\w</code></td><td style="text-align:center"><code>\w</code></td><td style="text-align:center"><code>\w</code></td><td style="text-align:center"><code>\w</code></td><td style="text-align:center"><code>\w</code></td><td style="text-align:left">匹配任一单词字符，等价于<code>[A-Za-z0-9_]</code></td></tr><tr><td style="text-align:center"><code>\W</code></td><td style="text-align:center"><code>\W</code></td><td style="text-align:center"><code>\W</code></td><td style="text-align:center"><code>\W</code></td><td style="text-align:center"><code>\W</code></td><td style="text-align:left">匹配任一非单词字符，等价于<code>[^A-Za-z0-9_]</code></td></tr><tr><td style="text-align:center"><code>\b</code></td><td style="text-align:center"><code>\b</code></td><td style="text-align:center"><code>\b</code></td><td style="text-align:center"><code>\b</code></td><td style="text-align:center"><code>\b</code></td><td style="text-align:left">匹配单词边界，即单词和空格间的位置</td></tr><tr><td style="text-align:center"><code>\B</code></td><td style="text-align:center"><code>\B</code></td><td style="text-align:center"><code>\B</code></td><td style="text-align:center"><code>\B</code></td><td style="text-align:center"><code>\B</code></td><td style="text-align:left">匹配非单词边界</td></tr><tr><td style="text-align:center"><code>\t</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"><code>\t</code></td><td style="text-align:center"><code>\t</code></td><td style="text-align:left">匹配一个横向制表符，等价于<code>\x09</code>和<code>\cI</code></td></tr><tr><td style="text-align:center"><code>\v</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"><code>\v</code></td><td style="text-align:center"><code>\v</code></td><td style="text-align:left">匹配一个垂直制表符，等价于<code>\x0b</code>和<code>\cK</code></td></tr><tr><td style="text-align:center"><code>\n</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"><code>\n</code></td><td style="text-align:center"><code>\n</code></td><td style="text-align:left">匹配一个换行符，等价于<code>\x0a</code>和<code>\cJ</code></td></tr><tr><td style="text-align:center"><code>\f</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"><code>\f</code></td><td style="text-align:center"><code>\f</code></td><td style="text-align:left">匹配一个换页符，等价于<code>\x0c</code>和<code>\cL</code></td></tr><tr><td style="text-align:center"><code>\r</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"><code>\r</code></td><td style="text-align:center"><code>\r</code></td><td style="text-align:left">匹配一个回车符，等价于<code>\x0d</code>和<code>\cM</code></td></tr><tr><td style="text-align:center"><code>\\</code></td><td style="text-align:center"><code>\</code></td><td style="text-align:center"><code>\\</code></td><td style="text-align:center"><code>\\</code></td><td style="text-align:center"><code>\\</code></td><td style="text-align:left">匹配一个转义字符<code>\</code>本身</td></tr><tr><td style="text-align:center"><code>\cx</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"></td><td style="text-align:center"><code>\cx</code></td><td style="text-align:left">匹配由<code>x</code>指明的控制字符<sup><a href="#fn_[14]" id="reffn_[14]">[14]</a></sup></td></tr><tr><td style="text-align:center"><code>\xn</code></td><td style="text-align:center">——</td><td style="text-align:center">——</td><td style="text-align:center"></td><td style="text-align:center"><code>\xn</code></td><td style="text-align:left">匹配十六进制<code>n</code><sup><a href="#fn_[15]" id="reffn_[15]">[15]</a></sup></td></tr><tr><td style="text-align:center"><code>\num</code></td><td style="text-align:center">——</td><td style="text-align:center"><code>\num</code></td><td style="text-align:center"><code>\num</code></td><td style="text-align:center"></td><td style="text-align:left">匹配引用</td></tr><tr><td style="text-align:center"><code>[:alnum:]</code></td><td style="text-align:center"><code>[:alnum:]</code></td><td style="text-align:center"><code>[:alnum:]</code></td><td style="text-align:center"><code>[:alnum:]</code></td><td style="text-align:center"><code>[:alnum:]</code></td><td style="text-align:left">匹配任一字母或数字字符，等价于<code>[A-Za-z0-9]</code></td></tr><tr><td style="text-align:center"><code>[:alpha:]</code></td><td style="text-align:center"><code>[:alpha:]</code></td><td style="text-align:center"><code>[:alpha:]</code></td><td style="text-align:center"><code>[:alpha:]</code></td><td style="text-align:center"><code>[:alpha:]</code></td><td style="text-align:left">匹配任一字母字符，等价于<code>[A-Za-z]</code></td></tr><tr><td style="text-align:center"><code>[:digit:]</code></td><td style="text-align:center"><code>[:digit:]</code></td><td style="text-align:center"><code>[:digit:]</code></td><td style="text-align:center"><code>[:digit:]</code></td><td style="text-align:center"><code>[:digit:]</code></td><td style="text-align:left">匹配任一数字，等价于<code>[0-9]</code></td></tr><tr><td style="text-align:center"><code>[:lower:]</code></td><td style="text-align:center"><code>[:lower:]</code></td><td style="text-align:center"><code>[:lower:]</code></td><td style="text-align:center"><code>[:lower:]</code></td><td style="text-align:center"><code>[:lower:]</code></td><td style="text-align:left">匹配任一小写字母，等价于<code>[a-z]</code></td></tr><tr><td style="text-align:center"><code>[:upper:]</code></td><td style="text-align:center"><code>[:upper:]</code></td><td style="text-align:center"><code>[:upper:]</code></td><td style="text-align:center"><code>[:upper:]</code></td><td style="text-align:center"><code>[:upper:]</code></td><td style="text-align:left">匹配任一大写字母，等价于<code>[A-Z]</code></td></tr><tr><td style="text-align:center"><code>[:space:]</code></td><td style="text-align:center"><code>[:space:]</code></td><td style="text-align:center"><code>[:space:]</code></td><td style="text-align:center"><code>[:space:]</code></td><td style="text-align:center"><code>[:space:]</code></td><td style="text-align:left">匹配任一空白字符</td></tr><tr><td style="text-align:center"><code>[:blank:]</code></td><td style="text-align:center"><code>[:blank:]</code></td><td style="text-align:center"><code>[:blank:]</code></td><td style="text-align:center"><code>[:blank:]</code></td><td style="text-align:center"><code>[:blank:]</code></td><td style="text-align:left">匹配空格和制表符</td></tr><tr><td style="text-align:center"><code>[:graph:]</code></td><td style="text-align:center"><code>[:graph:]</code></td><td style="text-align:center"><code>[:graph:]</code></td><td style="text-align:center"><code>[:graph:]</code></td><td style="text-align:center"><code>[:graph:]</code></td><td style="text-align:left">匹配任一可见且可打印的字符<sup><a href="#fn_[16]" id="reffn_[16]">[16]</a></sup></td></tr><tr><td style="text-align:center"><code>[:print:]</code></td><td style="text-align:center"><code>[:print:]</code></td><td style="text-align:center"><code>[:print:]</code></td><td style="text-align:center"><code>[:print:]</code></td><td style="text-align:center"><code>[:print:]</code></td><td style="text-align:left">匹配任一可打印字符<sup><a href="#fn_[17]" id="reffn_[17]">[17]</a></sup></td></tr><tr><td style="text-align:center"><code>[:cntrl:]</code></td><td style="text-align:center"><code>[:cntrl:]</code></td><td style="text-align:center"><code>[:cntrl:]</code></td><td style="text-align:center"><code>[:cntrl:]</code></td><td style="text-align:center"><code>[:cntrl:]</code></td><td style="text-align:left">匹配任一控制字符<sup><a href="#fn_[18]" id="reffn_[18]">[18]</a></sup></td></tr><tr><td style="text-align:center"><code>[:punct:]</code></td><td style="text-align:center"><code>[:punct:]</code></td><td style="text-align:center"><code>[:punct:]</code></td><td style="text-align:center"><code>[:punct:]</code></td><td style="text-align:center"><code>[:punct:]</code></td><td style="text-align:left">匹配任一标点符号<sup><a href="#fn_[19]" id="reffn_[19]">[19]</a></sup></td></tr><tr><td style="text-align:center"><code>[:xdigit:]</code></td><td style="text-align:center"><code>[:xdigit:]</code></td><td style="text-align:center"><code>[:xdigit:]</code></td><td style="text-align:center"><code>[:xdigit:]</code></td><td style="text-align:center"><code>[:xdigit:]</code></td><td style="text-align:left">匹配任一十六进制数，即<code>[0-9a-fA-F]</code></td></tr></tbody></table></div><p>注释：<br><sup><a href="#fn_[1]" id="reffn_[1]">[1]</a></sup> <code>^string</code>匹配以字符串<code>string</code>开头的行，在<code>awk</code>中则是匹配字符串的开始（因为<code>awk</code>以列为单位）。<br><sup><a href="#fn_[2]" id="reffn_[2]">[2]</a></sup> <code>^string</code>匹配以字符串<code>string</code>结尾的行，在<code>awk</code>中则是匹配字符串的结束（因为<code>awk</code>以列为单位）。<br><sup><a href="#fn_[3]" id="reffn_[3]">[3]</a></sup> <code>\&lt;</code>和<code>\&gt;</code>匹配单词时等价于<code>\b</code>，<code>\&lt;string</code>和<code>string\&gt;</code>分别表示以<code>string</code>开头和结尾的单词。PREs中不支持此方式，但可用<code>\b</code>的等价写法。<br><sup><a href="#fn_[4]" id="reffn_[4]">[4]</a></sup> <code>\&lt;string\&gt;</code>匹配特定单词或字符<code>string</code>，等价于<code>\bstring\b</code>。PREs中不支持此方式，但可用<code>\b</code>的等价写法。<br><sup><a href="#fn_[5]" id="reffn_[5]">[5]</a></sup> <code>()</code>表示对匹配的表达式分组，可以<code>\num</code>形式引用。<br><sup><a href="#fn_[6]" id="reffn_[6]">[6]</a></sup> <code>?</code>表示匹配前面的子表达式0次或1次，等价于<code>\&#123;0,1\&#125;</code>，例如<code>where(is)</code>可匹配<code>where</code>及<code>whereis</code>。<br><sup><a href="#fn_[7]" id="reffn_[7]">[7]</a></sup> 若子表达式为 <strong>限制符（<code>*</code>、<code>+</code>、<code>?</code>、<code>&#123;n&#125;</code>、<code>&#123;n,&#125;</code>、<code>&#123;n,m&#125;</code>）</strong> 时表示非贪婪匹配，本文涉及的正则表达式用法不支持此方式（存疑），但可使用 <strong>修饰符<code>U</code></strong> （见下文）。<br><sup><a href="#fn_[8]" id="reffn_[8]">[8]</a></sup> <code>.</code>匹配除换行符之外的任一字符，在<code>awk</code>中能匹配换行符。如果要匹配包括换行符在内的任一字符，则在EREs中可使用<code>(^$)|(.)</code>，在Perl RE中可使用<code>[.\n]</code>。<br><sup><a href="#fn_[9]" id="reffn_[9]">[9]</a></sup> 最少匹配<code>n</code>次，且最多匹配<code>m</code>次。注意在逗号和两个数之间不能有空格。<br><sup><a href="#fn_[10]" id="reffn_[10]">[10]</a></sup> 由于半角<code>|</code>作为表格单元格分隔符且优先解析，即使写在行内代码中也会被解析成单元格，故此处使用全角<code>｜</code>。<br><sup><a href="#fn_[11]" id="reffn_[11]">[11]</a></sup> 数字需写成递增顺序。<br><sup><a href="#fn_[12]" id="reffn_[12]">[12]</a></sup> 若元字符（例如<code>.</code>、<code>*</code>等）置于方括号中，则将作为普通字符。<br><sup><a href="#fn_[13]" id="reffn_[13]">[13]</a></sup> <code>[^xyz]</code>表示负值字符集合且不包括换行符，在awk中表示匹配 <strong><code>未包含的任一字符＋换行符</code></strong> 。<br><sup><a href="#fn_[14]" id="reffn_[14]">[14]</a></sup> <code>\cx</code>匹配由<code>x</code>指明的控制字符即<code>Control-x</code>或回车符，<code>x</code>的值必须为<code>A-Z</code>或<code>a-z</code>之一，否则将<code>c</code>视为一个原义的字符<code>c</code>。<br><sup><a href="#fn_[15]" id="reffn_[15]">[15]</a></sup> <code>\xn</code>匹配十六进制转义值<code>n</code>，十六进制转义值必须为确定的两个数字长。例如：<code>\x41</code>匹配<code>A</code>（正则表达式中可以使用 ASCII 编码，十六进制41＝十进制65）；而<code>\x041</code>则等价于<code>\x04</code>＋<code>1</code>。<br><sup><a href="#fn_[16]" id="reffn_[16]">[16]</a></sup> <code>[:graph:]</code>不包括空格和换行符等。<br><sup><a href="#fn_[17]" id="reffn_[17]">[17]</a></sup> <code>[:print:]</code>不包括控制字符<code>[:cntrl:]</code>、字符串结束符<code>\0</code>、EOF文件结束符（-1）， 但包括空格符号。<br><sup><a href="#fn_[18]" id="reffn_[18]">[18]</a></sup> 控制字符<code>[:cntrl:]</code>指 ASCII 字符集中的前 32 个字符，即用十进制表示为从 0 到 31，例如换行符、制表符等。<br><sup><a href="#fn_[19]" id="reffn_[19]">[19]</a></sup> 标点符号<code>[:punct:]</code>不包括<code>[:alnum:]</code>、<code>[:cntrl:]</code>、<code>[:space:]</code>等字符集。</p><h2 id="5-说明"><a href="#5-说明" class="headerlink" title="5.说明"></a>5.说明</h2><ol><li>当使用 BERs（基本正则表达式）时，必须在特殊符号前加上转义字符（<code>\</code>），以屏蔽掉它们的特殊含义。特殊符号有<code>?</code>、<code>+</code>、<code>|</code>、<code>&#123;</code>、<code>&#125;</code>、<code>(</code>、<code>)</code>。</li><li>修饰符用在正则表达式结尾，例如<code>/dog/i</code>中的<code>i</code>就是修饰符，表示匹配时不区分大小写。常见的修饰符如下：<ul><li><code>g</code>，表示全局匹配（即：一行上的每个出现，而不只是一行上的第一个出现）；</li><li><code>s</code>，表示把整个匹配串当作一行处理；</li><li><code>m</code>，表示多行匹配；</li><li><code>i</code>，表示忽略大小写；</li><li><code>x</code>，表示允许注释和空格的出现；</li><li><code>U</code>，表示非贪婪匹配。</li></ul></li><li>111</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;font size=5&gt;&lt;b&gt;文章说明&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;strong&gt;文章作者：&lt;/strong&gt;&lt;a href=&quot;https://hwame.top&quot;&gt;鴻塵&lt;/a&gt;&lt;br&gt;&lt;strong&gt;文章链接：&lt;/strong&gt;&lt;a href</summary>
      
    
    
    
    <category term="Linux" scheme="https://hwame.top/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://hwame.top/tags/Linux/"/>
    
    <category term="shell" scheme="https://hwame.top/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>如何在安卓手机上安装Linux发行版</title>
    <link href="https://hwame.top/20211009/install-linux-on-android-phone.html"/>
    <id>https://hwame.top/20211009/install-linux-on-android-phone.html</id>
    <published>2021-10-09T15:16:37.000Z</published>
    <updated>2021-10-15T17:39:09.733Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：废旧的安卓手机root后安装Linux发行版，并在chroot容器中运行。<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章链接：</strong><a href="https://hwame.top/20211009/install-linux-on-android-phone.html">https://hwame.top/20211009/install-linux-on-android-phone.html</a><br><strong>文章说明：</strong>root手机上安装Linux系统，我折腾过很长的一段时间，查阅参考了很多文章，由于时间跨度较大，参考资料可能不全。<br><strong>参考资料：</strong></p><ul><li><a href="https://www.hannahtech.co/post/turn-your-old-cracked-android-phone-into-a-backup-server-urbackup-linux-deploy-tutorial-part-i">Turn Your Old, Cracked Android Phone Into a Backup Server!</a></li><li><a href="https://www.jianshu.com/p/077ceebb4f81">安卓手机装centos 当服务器 Linux deploy 超详细入门教程</a></li><li><a href="https://blog.csdn.net/qq_43436873/article/details/105418651">Linux Deploy 安装centos-altarch</a></li></ul></blockquote><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>在已root手机上安装Linux发行版，我曾做过很多尝试，成功失败的都有，但是即使成功也是安装的Debian系的，RedHat系从未成功过。</p><p>写这篇文章时看了看电脑里的资料，发现早在2020年的6月就已经开始尝试了，那时候正是暑假没开学疫情在家没事干的时候，恰好手上有一台完全root的安卓手机。但那时候不是刚利用学生身份白嫖了阿里云的1M2H4G服务器吗，虽然说半年之后因为「考试」没过不能续期半年而没法白嫖到一年……</p><p>没有了学生身份之后，购买云服务器的价格是越来越贵了，不管是阿里云还是腾讯云。我寻思着能不能找到什么替代品，这让我想起之前在知乎不经意看到的，可以把Android手机改造成Linux。</p><font color=purple><b>✉本文也是一边摸索一边采坑，才成功安装上不同的Linux发行版，建议同时参考Debian和CentOS的「配置LinuxDeploy」部分。</b></font><h2 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2.准备工作"></a>2.准备工作</h2><ul><li>root手机，需要获得系统级Root权限。<strong>注意</strong>，未获取Root权限的手机可通过Termux作为替代软件，从而在手机上安装Linux，但是很多Linux命令将无法使用，不过运行个python命令行还是可以的【未验证，自行尝试】。</li><li>需要连接网络，最好与电脑处于同一无线局域网，这样就可以在电脑上通过SecureCRT/XShell之类的软件进行连接；</li><li>手机上安装<code>Linux deploy</code>（必需）、<code>BusyBox</code>（必需），<code>JuiceSSH</code>（可选但建议），<code>RootExplorer</code>（可选），各软件作用如下：<ul><li><a href="https://github.com/meefik/busybox/releases">BusyBox</a>（需要Root权限）：用于扩展Android手机命令，因为在这装Linux之后，很多Linux命令都是没有的；</li><li><a href="https://github.com/meefik/linuxdeploy/releases">Linux deploy</a>（需要Root权限）：作为装载Linux系统的容器；</li><li>JuiceSSH：手机终端通过SSH连接Linux。</li><li>RootExplorer（需要Root权限）：强大的文件管理器，可操作系统文件、精简系统。</li></ul></li><li>安装BusyBox：打开BusyBox软件，可以看到状态为<code>*not installed</code>，点击右下方<code>INSTALL</code>，按提示赋予ROOT权限即可安装，如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20211014安装BusyBox.png" alt="安装BusyBox"></li></ul><h2 id="3-安装Debian系统"><a href="#3-安装Debian系统" class="headerlink" title="3.安装Debian系统"></a>3.安装Debian系统</h2><h3 id="3-1-配置LinuxDeploy"><a href="#3-1-配置LinuxDeploy" class="headerlink" title="3.1.配置LinuxDeploy"></a>3.1.配置LinuxDeploy</h3><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20211014配置LinuxDeploy.png" alt="配置LinuxDeploy"></p><p>打开Linux Deploy软件，首页可见简要安装步骤（如上图1）。点击首页右下角的「设置图标」进行如下配置（建议「引导设置」中的配置项「本地化」设置为<code>zh_CN.UTF-8</code>）：</p><div class="table-container"><table><thead><tr><th style="text-align:center">类别</th><th style="text-align:center">配置项</th><th style="text-align:center">属性</th><th style="text-align:left">备注</th></tr></thead><tbody><tr><td style="text-align:center">引导设置</td><td style="text-align:center">发行版GNU/Linux</td><td style="text-align:center">Debian</td><td style="text-align:left"></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">架构</td><td style="text-align:center"><code>arm64</code></td><td style="text-align:left">安装BusyBox时的architecture，没有就选最接近的</td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">发行版GNU/Linux版本</td><td style="text-align:center"><code>buster</code></td><td style="text-align:left"></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">源地址</td><td style="text-align:center"><a href="http://ftp.debian.org/debian/">http://ftp.debian.org/debian/</a></td><td style="text-align:left">可更换国内镜像源</td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">安装类型</td><td style="text-align:center">镜像文件</td><td style="text-align:left"></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">安装路径</td><td style="text-align:center"><code>/storage/emulated/0/linux.img</code></td><td style="text-align:left">可命名为<code>debian.img</code>以示区别</td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">镜像大小</td><td style="text-align:center">自动分配</td><td style="text-align:left">默认为2GB，可修改</td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">文件系统</td><td style="text-align:center"><code>ext4</code></td><td style="text-align:left"></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">用户名</td><td style="text-align:center"><code>root</code></td><td style="text-align:left">默认<code>android</code></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">用户密码</td><td style="text-align:center"><code>****</code></td><td style="text-align:left"></td></tr><tr><td style="text-align:center">初始化</td><td style="text-align:center">启用</td><td style="text-align:center">☑️</td><td style="text-align:left">貌似可不选</td></tr><tr><td style="text-align:center">初始化</td><td style="text-align:center">初始化系统</td><td style="text-align:center"><code>sysv</code></td><td style="text-align:left">貌似可不选</td></tr><tr><td style="text-align:center">挂载</td><td style="text-align:center">启用</td><td style="text-align:center">☑️</td><td style="text-align:left">貌似可不选</td></tr><tr><td style="text-align:center">SSH</td><td style="text-align:center">启用</td><td style="text-align:center">☑️</td><td style="text-align:left"><strong>必选</strong></td></tr></tbody></table></div><p>配置完成后返回首页，点击左上角菜单图标，选择设置（如上图2），配置「<code>环境</code>」项。其中，「<code>ENV目录</code>」默认即可，「<code>PATH变量</code>」设置为「<code>/system/xbin</code>」，然后点击「<code>更新环境</code>」来更新操作环境（如上图3）。</p><h3 id="3-2-安装过程"><a href="#3-2-安装过程" class="headerlink" title="3.2.安装过程"></a>3.2.安装过程</h3><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20211015安装Debian1.png" alt="Debian安装过程1"></p><p>更新完操作环境后，回到Linux Deploy主页，点击右上角选项图标 ，选择「安装」，按提示赋予ROOT权限即可开始安装（如上图1）。首先是系统和分区、软件包的Retrieving和Validating（如上图2），然后是Extracting、Unpacking、Configuring（如上图3），接着下载安装其他必要软件（如下图1、2），最后是Setting up、Creating、Processing，配置好<code>extra/ssh</code>后则部署完成（如下图3）。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20211015安装Debian2.png" alt="Debian安装过程2"></p><p>至此，Debian安装部署完成，第一次部署需要安装的软件很多，因此输出的日志很多很杂，「<code>&gt;&gt;&gt; deploy</code>」和「<code>&lt;&lt;&lt; deploy</code>」之间的输出即安装部署时的日志，如果失败则可从中检查。初次安装花费5分钟左右的时间，这取决于网速，例如此处运行时间为<code>[09:51:02]</code>～<code>[09:55:07]</code>。第二次再点安装时则只用了10秒，程序做必要的检查、软件的更新：<code>[11:55:29] 0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded</code>，如下图。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210724重新安装.jpg?40" alt="重新安装"></p><h3 id="3-3-容器的启动与停止"><a href="#3-3-容器的启动与停止" class="headerlink" title="3.3.容器的启动与停止"></a>3.3.容器的启动与停止</h3><p>安装完成后即可启动、连接、使用了。在Linux Deploy主页下方点击「启动」和「停止」即可完成服务器对应的操作，日志也会同步输出对应「<code>&gt;&gt;&gt; start</code> / <code>&lt;&lt;&lt; start</code>」和「<code>&gt;&gt;&gt; stop</code> / <code>&lt;&lt;&lt; stop</code>」的信息，如图所示。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210724容器启动和停止.jpg?40" alt="容器启动和停止"></p><p><strong>注意：</strong>初次安装完成后，应先点击「停止」进行分区及系统的卸载，然后重新点击「启动」。</p><h3 id="3-4-连接使用Linux"><a href="#3-4-连接使用Linux" class="headerlink" title="3.4.连接使用Linux"></a>3.4.连接使用Linux</h3><p>保持Linux处于 <strong>启动</strong> 状态，则可以通过SSH软件进行连接，例如<code>Juice SSH</code>、<code>X Shell</code>和<code>Secure CRT</code>等。</p><p>例如在同一局域网下，电脑IP为<code>192.168.0.104</code>，手机（Linux主机）IP为<code>192.168.0.107</code>，则可以进行连接，如图是使用命令行进行ssh连接。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210724远程连接SSH.png" alt="远程连接SSH"></p><p>【说明：】①貌似连接10分钟无操作则自动断开；②图示ssh命令第一次连接时会提示；③推荐使用专门软件，命令行过于简陋。</p><h2 id="4-安装CentOS系统"><a href="#4-安装CentOS系统" class="headerlink" title="4.安装CentOS系统"></a>4.安装CentOS系统</h2><h3 id="4-1-新建LinuxDeploy配置"><a href="#4-1-新建LinuxDeploy配置" class="headerlink" title="4.1.新建LinuxDeploy配置"></a>4.1.新建LinuxDeploy配置</h3><p>上面安装的Debian系统是在7月24日完成的，很多「非必要修改」的东西都是保持默认，比如镜像源、安装路径等配置项。</p><p>由于要安装CentOS，为了保留Debian和CentOS两者的配置，故新建一个配置文件而不是覆盖修改原来的Debian的配置。</p><p>在LinuxDeploy软件首页点击左上角菜单图标 ，选择配置文件，新建一个名称为<code>Centos</code>的配置文件。为了以示区别，将默认名称<code>Linux</code>修改为<code>Debian</code>。</p><p>选择Centos配置文件后返回主界面，点击左上角菜单图标 ，选择设置 ，配置「环境」项，与3.1节安装Debian系统时的<a href="#3-1-%E9%85%8D%E7%BD%AELinuxDeploy">配置LinuxDeploy</a>相同，不再赘述。</p><h3 id="4-2-配置LinuxDeploy"><a href="#4-2-配置LinuxDeploy" class="headerlink" title="4.2.配置LinuxDeploy"></a>4.2.配置LinuxDeploy</h3><p>打开Linux Deploy，首页可见简要安装步骤。点击右下角的设置图标 进行如下配置：</p><div class="table-container"><table><thead><tr><th style="text-align:center">类别</th><th style="text-align:center">配置项</th><th style="text-align:center">属性</th><th style="text-align:left">备注</th></tr></thead><tbody><tr><td style="text-align:center">引导设置</td><td style="text-align:center">发行版GNU/Linux</td><td style="text-align:center">Centos</td><td style="text-align:left"></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">架构</td><td style="text-align:center"><code>aarch64</code></td><td style="text-align:left">安装BusyBox时的architecture</td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">发行版GNU/Linux版本</td><td style="text-align:center"><code>7</code></td><td style="text-align:left"></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">源地址</td><td style="text-align:center"><a href="https://mirrors.bfsu.edu.cn/centos-altarch/">https://mirrors.bfsu.edu.cn/centos-altarch/</a></td><td style="text-align:left">清华源失败才换此源</td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">安装类型</td><td style="text-align:center">镜像文件</td><td style="text-align:left"></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">安装路径</td><td style="text-align:center"><code>/storage/emulated/0/centos.img</code></td><td style="text-align:left">与<code>debian.img</code>相区别</td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">镜像大小</td><td style="text-align:center">自动分配</td><td style="text-align:left">默认为2GB，可修改</td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">文件系统</td><td style="text-align:center"><code>ext4</code></td><td style="text-align:left"></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">用户名</td><td style="text-align:center"><code>android</code></td><td style="text-align:left">默认<code>android</code></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">用户密码</td><td style="text-align:center"><code>****</code></td><td style="text-align:left"></td></tr><tr><td style="text-align:center">引导设置</td><td style="text-align:center">本地化</td><td style="text-align:center"><code>zh_CN.UTF-8</code></td><td style="text-align:left">默认为<code>C</code></td></tr><tr><td style="text-align:center">SSH</td><td style="text-align:center">启用</td><td style="text-align:center">☑️</td><td style="text-align:left"><strong>必选</strong></td></tr></tbody></table></div><p><strong>说明：</strong></p><ul><li>①镜像源地址是最容易出错的地方，就笔者环境而言：官方源速度慢不稳定，清华源卡会在某一步动不了（原因是否是用户名设置为<code>root</code>还是启用初始化/挂载未知），阿里源没有<code>altarch</code>分支，故选择<a href="https://mirrors.bfsu.edu.cn/centos-altarch/">北京外国语大学镜像站</a>（只有这个才能成功安装CentOS）。</li><li>②因猜测清华源<code>root</code>用户名原因，故将用户名改为<code>android</code>而未直接设置<code>root</code>。待系统安装成功后，可删除<code>android</code>用户。</li><li>③镜像大小为0时即自动分配，默认只有2GB，若修改大小则需重装系统。</li></ul><h3 id="4-3-安装CentOS系统"><a href="#4-3-安装CentOS系统" class="headerlink" title="4.3.安装CentOS系统"></a>4.3.安装CentOS系统</h3><p>在Linux Deploy主页，点击右上角选项图标，选择「安装」，按提示赋予ROOT权限即可开始安装。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/2021101523.png" alt="安装CentOS系统1"></p><p>首先是<code>bootstrap/rootfs</code>的安装（快），然后是<code>bootstrap/centos</code>的安装（慢），如上图1。<br>经过软件包的Retrieving和Resolving Dependencies（如上图1、2），软件依赖分析完成后将列出待安装软件的信息（包名、架构、版本、仓库、大小），如上图3。</p><p>Transaction Summary列出待安装的57个安装包（Package）和87个依赖包（Dependent package），如下图1。随即开始软件包的下载（Downloading）、安装（Installing）和校验（Verifying），安装校验过程可以看到当前进度，如下图1、2。完成后将列出已安装的软件，如下图3。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/2021101524.png" alt="安装CentOS系统2"></p><p>接下来是一系列配置，关键是<code>extra/ssh</code>的安装和配置（几乎所有的失败都是这里的问题），如下图1。这项安装配置将会额外安装<code>openssh-server</code>，如下图2。安装完成后自动配置好<code>extra/ssh</code>则部署完成，如下图3。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/2021101525.png" alt="安装CentOS系统3"></p><p>注意到，在上图1中配置完<code>core/locale</code>本地化后界面语言就变成中文了，这得益于「引导设置」中的配置项「本地化」设置为<code>zh_CN.UTF-8</code>。</p><p>至此，CentOS安装部署完成，第一次部署需要安装的软件很多，因此输出的日志很多很杂，「<code>&gt;&gt;&gt; deploy</code>」和「<code>&lt;&lt;&lt; deploy</code>」之间的输出即安装部署时的日志，如果失败则可根据日志信息检查。初次安装花费5分钟左右的时间，这取决于网速，例如此处运行时间为<code>[08:44:47]</code>～<code>[08:49:14]</code>。</p><h3 id="4-4-启动停止与使用"><a href="#4-4-启动停止与使用" class="headerlink" title="4.4.启动停止与使用"></a>4.4.启动停止与使用</h3><p>同Debian，不再赘述。</p><h2 id="5-附件"><a href="#5-附件" class="headerlink" title="5.附件"></a>5.附件</h2><p>必不可少的安卓软件：</p><div class="table-container"><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">版本</th><th style="text-align:center">大小</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td style="text-align:center"><a href="https://github.com/meefik/busybox/releases">BusyBox</a></td><td style="text-align:center">1.31.1</td><td style="text-align:center">5.21MB</td><td style="text-align:center">Github下载，1年未更新</td></tr><tr><td style="text-align:center"><a href="https://github.com/meefik/linuxdeploy/releases">Linux deploy</a></td><td style="text-align:center">2.6.0</td><td style="text-align:center">10.1MB</td><td style="text-align:center">Github下载，1年未更新</td></tr></tbody></table></div><p>可选但强烈建议安装的安卓软件：</p><div class="table-container"><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">版本</th><th style="text-align:center">大小</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td style="text-align:center"><a href="https://juicessh-builds.s3.amazonaws.com/juicessh-v3.2.2_200.apk">JuiceSSH</a></td><td style="text-align:center">3.2.2</td><td style="text-align:center">23.6MB</td><td style="text-align:center"><a href="https://juicessh.com/">JuiceSSH官网</a>下载，最新版于2021-01-30</td></tr></tbody></table></div><p>安装日志文件可作为安装参考、查错依据，若与以下日志不同则可对比来定位问题。</p><div class="table-container"><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">Linux发行版</th><th style="text-align:center">版本</th><th style="text-align:center">大小</th></tr></thead><tbody><tr><td style="text-align:center"><a href="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/linux-debian.log">linux-debian.log</a></td><td style="text-align:center">Debian</td><td style="text-align:center">buster</td><td style="text-align:center">41.0KB</td></tr><tr><td style="text-align:center"><a href="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/linux-centos.log">linux-centos.log</a></td><td style="text-align:center">CentOS</td><td style="text-align:center">7</td><td style="text-align:center">85.6KB</td></tr></tbody></table></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：废旧的安卓手机root后安装Linux发行版，并在chroot容器中运行。</summary>
    
    
    
    <category term="miscellanea" scheme="https://hwame.top/categories/miscellanea/"/>
    
    
    <category term="miscellanea" scheme="https://hwame.top/tags/miscellanea/"/>
    
  </entry>
  
  <entry>
    <title>让你的Windows更具生产力</title>
    <link href="https://hwame.top/20210904/make-your-windows-productive.html"/>
    <id>https://hwame.top/20210904/make-your-windows-productive.html</id>
    <published>2021-09-04T15:45:56.000Z</published>
    <updated>2021-09-06T15:26:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：通过修改注册表的方式提升Windows使用体验、提高工作效率！<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章链接：</strong><a href="https://hwame.top/20210904/make-your-windows-productive.html">https://hwame.top/20210904/make-your-windows-productive.html</a><br><strong>参考资料：</strong></p><ul><li><a href="https://my.oschina.net/u/2304110/blog/419536">实例讲解映像劫持的使用技巧——通过映像劫持实现Notepad2替换记事本</a></li><li><a href="https://blog.csdn.net/qq_43227967/article/details/83280380">win10右键菜单添加「用记事本打开文件」</a></li><li><a href="https://blog.csdn.net/cxrsdn/article/details/84538767">Win10添加右键打开cmd和Powershell窗口</a></li><li><a href="https://windows10.pro/added-to-the-right-click-menu-copy-path-option/">在Win10右键菜单中添加「复制路径」选项</a></li><li><a href="https://www.codepeople.cn/2019/01/13/Windows10-PhotoViewer-back/">Windows照片查看器-召回大法</a></li></ul></blockquote><h2 id="1-替换系统记事本"><a href="#1-替换系统记事本" class="headerlink" title="1.替换系统记事本"></a>1.替换系统记事本</h2><p>众所周知，Windows自带的记事本notepad及其简陋，有时候只想查看一下文件内容但又不想打开IDE，这时候一个简单的带语法高亮的记事本就派上用场了。</p><p>通过 <strong>映像劫持</strong> 实现将Notepad2替换系统自带的记事本。</p><p><strong>说明①：</strong> Notepad2网上有很多版本，本人自用的【<a href="https://www.aliyundrive.com/s/f7GtgcnLu2L">Notepad2</a>】是仅有1.86M的单文件绿色版，所有配置 <strong>写死</strong> 到文件中，因此没有配置文件、没有主题文件、无法修改配置。<br><strong>说明②：</strong> Notepad2有些新的版本自带了「系统集成」的功能，可以一键替换，但我没有找到无需配置文件的单文件版，因此手动修改注册表。<br><strong>说明③：</strong> Notepad3支持的语法高亮更多，比如Markdown格式，奈何花里胡哨不在我的审美上。</p><blockquote><p><strong>参考文章：</strong> <a href="https://my.oschina.net/u/2304110/blog/419536">https://my.oschina.net/u/2304110/blog/419536</a></p><p>所谓「映像劫持」，就是Image File Execution Options，是<code>CreateProcess</code>函数中的一个功能，即在可执行程序运行时，Windows会先检测对应IFEO中的<code>Debugger</code>值，如果存在这个参数的话，就运行这个参数中指定的程序。</p><p>其实现原理为，修改Image File Execution Options键值后，在有notepad.exe运行请求的时候，就欺骗系统转而运行notepad2.exe，从而实现将原本系统默认的记事本改成了功能更为全面的Notepad2。</p><p>这种方式不但不需要修改文件关联，也无需修改系统文件，避免了以往的文件替换法导致的系统更新后就失效的问题。</p></blockquote><p>具体步骤如下：</p><ul><li>下载Notepad2.exe单文件，【<a href="https://www.aliyundrive.com/s/f7GtgcnLu2L">阿里云盘</a>】，【<a href="https://github.com/hwame/pics/blob/main/download/Notepad2.exe">Github下载</a>】，版权信息如下：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210905Notepad2.png" alt="Notepad2版权"></li><li>将其放在与原notepad.exe相同的位置，即<code>C:\Windows\System32\Notepad2.exe</code>。尽管这一步非必须，但仍建议这么做。</li><li><code>Win+R</code>运行输入<code>regedit</code>打开注册表，创建如下注册表项：<code>计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe</code>，如果无法修改，需要先右键取得权限。</li><li>在<code>notepad.exe</code>注册表项中，右键创建名为<code>Debugger</code>的字符串值（<code>REG_SZ</code>），如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210905编辑注册表项值.png" alt="编辑注册表项值"></li><li>将字符串值<code>Debugger</code>的数值数据修改为Notepad2.exe的完整路径，最后以 <code>/z</code> 参数结尾，即<code>&quot;C:\WINDOWS\system32\Notepad2.exe&quot; /z</code>，如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210905修改数值数据.png" alt="修改字符串值的数值数据"></li><li>至此文本文件用记事本打开即可，还可右键增加「用记事本打开」及图标，见下文。</li></ul><h2 id="2-右键用记事本打开"><a href="#2-右键用记事本打开" class="headerlink" title="2.右键用记事本打开"></a>2.右键用记事本打开</h2><p>上面已经将记事本替换成强大的Notepad2，但是一般情况下只有<code>txt</code>等文本文件才可直接用记事本打开。虽然可以右键选择打开方式，但未免太麻烦；那如果勾选「始终使用此应用打开xxx文件」，又会改变默认的打开方式，不符合我们的预期。例如<code>bat</code>文件双击运行，我们想用记事本打开查看内容就只能右键打开方式了。因此右键菜单增加「用记事本打开」也算是一个比较实用的提高生产力的功能了。</p><p>具体步骤如下：</p><ul><li><code>Win+R</code>运行输入<code>regedit</code>打开注册表，创建如下注册表项：<code>计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Classes\*\shell\notepad</code>，双击<code>默认</code>将数值数据修改为「用记事本打开」，如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210905创建notepad项.png" alt="创建notepad项"></li><li>我们也可以为右键菜单添加一个记事本图标。如上图，在<code>notepad</code>项下新建一个名为<code>Icon</code>的 <strong>字符串值</strong> ，将其数值数据修改为Notepad2.exe的文件路径<code>C:\Windows\System32\notepad2.exe</code>。</li><li>在<code>notepad</code>项下新建一个名为<code>command</code>的 <strong>项</strong> （即子项），双击<code>默认</code>将数值数据修改为「<code>notepad %1</code>」，注意空格，如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210905创建command子项.png" alt="创建command子项"></li></ul><h2 id="3-右键打开命令行"><a href="#3-右键打开命令行" class="headerlink" title="3.右键打开命令行"></a>3.右键打开命令行</h2><p>有时候我们需要在特定目录下打开命令行，通常会在开始菜单或运行中打开，此时路径一般为<code>C:\Users\鴻塵</code>或<code>C:\Windows\System32</code>，然后一层一层切换过去。</p><p>在右键菜单中添加「在此处打开命令行」，可以直接定位到当前文件夹，免去<code>cd</code>之苦。</p><p>本文打开命令行仅以普通用户权限，因为我的组策略已修改为「管理权限创建任务」，若有需要以管理员身份打开命令行，请移步参考文章。</p><p>具体步骤如下：</p><ul><li>右键打开CMD<ul><li><code>Win+R</code>运行输入<code>regedit</code>打开注册表，创建如下注册表项：<code>计算机\HKEY_CLASSES_ROOT\Directory\Background\shell\OpenCmdHere</code>，将「默认」字符串值的数值数据为「在此处打开命令行窗口」。此处项值和数值数据可随意。</li><li>在<code>OpenCmdHere</code>项下新建一个名为<code>Icon</code>的 <strong>字符串值</strong> ，将其数值数据修改为cmd.exe的文件路径<code>cmd.exe</code>。</li><li>在<code>OpenCmdHere</code>项下新建一个名为<code>command</code>的 <strong>项</strong> （即子项），双击<code>默认</code>将数值数据修改为「<code>cmd.exe /s /k pushd &quot;%V&quot;</code>」。</li><li>此处步骤与上文<a href="#2-%E5%8F%B3%E9%94%AE%E7%94%A8%E8%AE%B0%E4%BA%8B%E6%9C%AC%E6%89%93%E5%BC%80">右键用记事本打开</a>类似，简要截图如下：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210905右键打开CMD.png" alt="右键打开CMD"></li></ul></li><li>右键打开PowerShell<ul><li><code>Win+R</code>运行输入<code>regedit</code>打开注册表，创建如下注册表项：<code>计算机\HKEY_CLASSES_ROOT\Directory\Background\shell\Powershell_Here</code>，「默认」字符串值的数值数据为「在此处打开PowerShell」。此处项值和数值数据可随意。</li><li>在<code>Powershell_Here</code>项下新建一个名为<code>Icon</code>的 <strong>字符串值</strong> ，将其数值数据修改为powershell.exe的文件路径<code>powershell.exe</code>。</li><li>在<code>Powershell_Here</code>项下新建一个名为<code>command</code>的 <strong>项</strong> （即子项），双击<code>默认</code>将数值数据修改为「<code>powershell.exe -noexit -command Set-Location &#39;%V&#39;</code>」。</li><li>截图略。</li></ul></li></ul><p><strong>说明：</strong> 增加图标时没有写文件的完整路径，因为路径已在环境变量中，故上文<a href="#2-%E5%8F%B3%E9%94%AE%E7%94%A8%E8%AE%B0%E4%BA%8B%E6%9C%AC%E6%89%93%E5%BC%80">右键用记事本打开</a>中设置图标同理可简写。</p><h2 id="4-右键复制文件路径"><a href="#4-右键复制文件路径" class="headerlink" title="4.右键复制文件路径"></a>4.右键复制文件路径</h2><p>当我们需要用到某文件的绝对路径时，怎么获取该字符串呢？是先地址栏复制目录再复制文件名，还是文件属性的安全里面去复制对象名称？</p><p>因此在右键菜单添加一个复制文件（夹）路径，也能提高生产力。</p><p>但是我不会告诉你，选中文件（夹）后按住<code>Shift</code>右键就有「复制为路径」的选项！所以这里修改注册表其实也是多此一举，但是有多少人知道这种「复制为路径」的方法呢？</p><p>方法1.0来自<a href="https://www.52pojie.cn/">吾爱破解</a>论坛用户<a href="https://www.52pojie.cn/home.php?mod=space&amp;uid=896814">tmdgdx</a>的评论，详见<a href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1374242&amp;page=1#pid36998334">https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1374242&amp;page=1#pid36998334</a>。<br><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version <span class="number">5.00</span></span><br><span class="line"></span><br><span class="line">[<span class="params">HKEY_CLASSES_ROOT</span>\<span class="literal">Directory</span>\shell\copypath]</span><br><span class="line">@=<span class="string">&quot;复制文件夹路径&quot;</span></span><br><span class="line">[<span class="params">HKEY_CLASSES_ROOT</span>\<span class="literal">Directory</span>\shell\copypath\command]</span><br><span class="line">@=<span class="string">&quot;mshta vbscript:clipboarddata.setdata(\&quot;</span>text\<span class="string">&quot;,\&quot;</span>%<span class="number">1</span>\<span class="string">&quot;)(close)&quot;</span></span><br><span class="line"></span><br><span class="line">[<span class="params">HKEY_CLASSES_ROOT</span>\*\shell\copypath]</span><br><span class="line">@=<span class="string">&quot;复制文件路径&quot;</span></span><br><span class="line">[<span class="params">HKEY_CLASSES_ROOT</span>\*\shell\copypath\command]</span><br><span class="line">@=<span class="string">&quot;mshta vbscript:clipboarddata.setdata(\&quot;</span>text\<span class="string">&quot;,\&quot;</span>%<span class="number">1</span>\<span class="string">&quot;)(close)&quot;</span></span><br></pre></td></tr></table></figure></p><p>上述mshta这种方法有两个问题：</p><ul><li>①复制exe等格式的文件时会有类似「是否运行xxx」的警告；</li><li>②复制链接例如快捷方式会复制源文件路径，而不是快捷方式本身的路径。</li></ul><p>推荐使用<a href="https://windows10.pro/added-to-the-right-click-menu-copy-path-option/">在Win10右键菜单中添加「复制路径」选项</a>中的方法2.0：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Windows</span> Registry Editor Version <span class="number">5</span>.<span class="number">00</span></span><br><span class="line">[HKEY_CLASSES_ROOT\Allfilesystemobjects\shell\windows.copyaspath]</span><br><span class="line"><span class="string">&quot;CanonicalName&quot;</span>=<span class="string">&quot;&#123;707C7BC6-685A-4A4D-A275-3966A5A3EFAA&#125;&quot;</span></span><br><span class="line"><span class="string">&quot;CommandStateHandler&quot;</span>=<span class="string">&quot;&#123;3B1599F9-E00A-4BBF-AD3E-B3F99FA87779&#125;&quot;</span></span><br><span class="line"><span class="string">&quot;CommandStateSync&quot;</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="string">&quot;Description&quot;</span>=<span class="string">&quot;<span class="variable">@shell32</span>.dll,-30336&quot;</span></span><br><span class="line"><span class="string">&quot;Icon&quot;</span>=<span class="string">&quot;imageres.dll,-5302&quot;</span></span><br><span class="line"><span class="string">&quot;InvokeCommandOnSelection&quot;</span>=dword:<span class="number">00000001</span></span><br><span class="line"><span class="string">&quot;MUIVerb&quot;</span>=<span class="string">&quot;<span class="variable">@shell32</span>.dll,-30329&quot;</span></span><br><span class="line"><span class="string">&quot;VerbHandler&quot;</span>=<span class="string">&quot;&#123;f3d06e7c-1e45-4a26-847e-f9fcdee59be0&#125;&quot;</span></span><br><span class="line"><span class="string">&quot;VerbName&quot;</span>=<span class="string">&quot;copyaspath&quot;</span></span><br></pre></td></tr></table></figure><p>其中<code>&quot;Icon&quot;=&quot;imageres.dll,-5302&quot;</code>可以改成<code>4</code>，换成文件夹风格图标，如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210906右键复制路径.png" alt="右键复制路径"></p><h2 id="5-Windows照片查看器"><a href="#5-Windows照片查看器" class="headerlink" title="5.Windows照片查看器"></a>5.Windows照片查看器</h2><p>众所周知，Win10自带的「照片」极其难用，甚至可能需要安装第三方替代软件，这让我们不得不感叹还是Win7时代的「Windows照片查看器」最经典。</p><p>通过修改注册表的方式恢复「Windows照片查看器」，并且设置为默认。</p><p>具体步骤如下：</p><ul><li><code>Win+R</code>运行输入<code>regedit</code>打开注册表，定位到如下注册表项：<code>计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Photo Viewer\Capabilities\FileAssociations</code>。</li><li>在<code>FileAssociations</code>项下新建一个名为<code>.jpg</code>的 <strong>字符串值</strong> ，将其数值数据修改为<code>PhotoViewer.FileAssoc.Tiff</code>。</li><li>同样新建其他图片后缀名的字符串值，例如<code>.jpeg</code>、<code>.png</code>、<code>.gif</code>、<code>.bmp</code>、<code>.ico</code>等，数值数据皆为<code>PhotoViewer.FileAssoc.Tiff</code>，添加完成后的注册表如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210906修改图片文件关联.png" alt="修改图片文件关联"></li><li>双击图片打开时选择「Windows照片查看器」并勾选「始终使用此应用打开.xxx文件」即可设置为默认方式。若已设置其他为默认，右键打开方式选择其他应用，即可设置默认。如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210906选择图片默认打开方式.png" alt="选择图片默认打开方式"></li></ul><p><strong>注意①：</strong> 并非所有格式的图片都能用「Windows照片查看器」打开，如<code>.webp</code>、<code>.svg</code>等。<br><strong>注意②：</strong> 新建的 <strong>字符串值</strong> 名称为图片扩展名，且有一个点<code>.</code>。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：通过修改注册表的方式提升Windows使用体验、提高工作效率！</summary>
    
    
    
    <category term="miscellanea" scheme="https://hwame.top/categories/miscellanea/"/>
    
    
    <category term="miscellanea" scheme="https://hwame.top/tags/miscellanea/"/>
    
  </entry>
  
  <entry>
    <title>MongoDB聚合示例</title>
    <link href="https://hwame.top/20210814/mongodb-aggregation-examples.html"/>
    <id>https://hwame.top/20210814/mongodb-aggregation-examples.html</id>
    <published>2021-08-14T15:44:47.000Z</published>
    <updated>2021-09-30T16:40:26.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章链接：</strong><a href="https://hwame.top/20210814/mongodb-aggregation-examples.html">https://hwame.top/20210814/mongodb-aggregation-examples.html</a><br><strong>参考资料：</strong></p><ul><li>聚合示例来源：<a href="https://www.practical-mongodb-aggregations.com/">Practical MongoDB Aggregations</a>（by Paul Done<a href="https://twitter.com/TheDonester">@TheDonester</a>）</li><li>Ebook源码：<a href="https://github.com/pkdone/practical-mongodb-aggregations-book">Github @pkdone</a></li><li>MongoDB在线运行：<a href="https://mws.mongodb.com/">MongoDB Web Shell</a></li></ul><p><strong>温馨提示：</strong>测试数据可直接复制，方便生成数据；运行结果以图片形式展示，可以「点击图片」或「将图片拖曳到新标签页」来查看大图，从而获取更佳的浏览体验。</p></blockquote><hr><p>对MongoDB中聚合操作的理解和熟悉，需要配合大量例子，<a href="https://www.practical-mongodb-aggregations.com/">Practical MongoDB Aggregations Book</a>中提供了很多有助于理解的例子，但原文是英文版的且有一定概率无法访问，故在此记录下学习过程中对原文的翻译。</p><blockquote><p><strong>说明：</strong>本文仅作为聚合示例，由于篇幅限制，对于数据库的指定及索引的创建都进行删减，并且也不执行<code>explain</code>。</p></blockquote><h2 id="1-基础"><a href="#1-基础" class="headerlink" title="1.基础"></a>1.基础</h2><h3 id="1-TopN查询"><a href="#1-TopN查询" class="headerlink" title="(1)TopN查询"></a>(1)TopN查询</h3><blockquote><p>您想在由人组成的集合中查询，以找到职业为工程师的三个最年轻的人，按年龄从小到大排序。</p><p>此示例是本文中唯一一个可以以完全使用MQL实现的示例，同时也作为MQL和聚合管道之间的一个有用比较。</p></blockquote><p>测试数据如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;6392529400&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Elise&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;1972-01-13T09:32:07Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;ENGINEER&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123; <span class="string">&quot;number&quot;</span>: <span class="number">5625</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;Tipa Circle&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Wojzinmoj&quot;</span>&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;1723338115&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Olive&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Ranieri&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;1985-05-12T23:14:30Z&quot;</span>),    </span><br><span class="line">    <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;FEMALE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;ENGINEER&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123; <span class="string">&quot;number&quot;</span>: <span class="number">9303</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;Mele Circle&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Tobihbo&quot;</span>&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;8732762874&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Toni&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Jones&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;1991-11-23T16:53:56Z&quot;</span>),    </span><br><span class="line">    <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;POLITICIAN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123; <span class="string">&quot;number&quot;</span>: <span class="number">1</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;High Street&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Upper Abbeywoodington&quot;</span>&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;7363629563&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Bert&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Gooding&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;1941-04-07T22:11:52Z&quot;</span>),    </span><br><span class="line">    <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;FLORIST&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123; <span class="string">&quot;number&quot;</span>: <span class="number">13</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;Upper Bold Road&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Redringtonville&quot;</span>&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;1029648329&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Sophie&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Celements&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;1959-07-06T17:35:45Z&quot;</span>),    </span><br><span class="line">    <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;ENGINEER&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123; <span class="string">&quot;number&quot;</span>: <span class="number">5</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;Innings Close&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Basilbridge&quot;</span>&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;7363626383&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Carl&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Simmons&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;1998-12-26T13:13:55Z&quot;</span>),    </span><br><span class="line">    <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;ENGINEER&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123; <span class="string">&quot;number&quot;</span>: <span class="number">187</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;Hillside Road&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Kenningford&quot;</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>聚合管道定义如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">    &#123;<span class="string">&quot;$match&quot;</span>: &#123;<span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;ENGINEER&quot;</span>,&#125;&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;$sort&quot;</span>: &#123;<span class="string">&quot;dateofbirth&quot;</span>: -<span class="number">1</span>,&#125;&#125;,      </span><br><span class="line">    &#123;<span class="string">&quot;$limit&quot;</span>: <span class="number">3</span>&#125;,  </span><br><span class="line">    &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>, <span class="string">&quot;vocation&quot;</span>, <span class="string">&quot;address&quot;</span>,]&#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure></p><p>执行聚合操作后应该返回三个文档，代表三个最年轻的工程师（按年龄从小到大排序），省略每个人的<code>_id</code>或<code>address</code>属性，如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210928-1TopN查询.png" alt="TopN查询"></p><ul><li><p><strong>Index Use.</strong> A basic aggregation pipeline, where if many records belong to the collection, a compound index for <code>vocation + dateofbirth</code> should exist to enable the database to fully optimise the execution of the pipeline combining the filter of the <code>$match</code> stage with the sort from the <code>sort</code> stage and the limit of the <code>limit</code> stage.</p></li><li><p><strong>Unset Use.</strong> An <code>$unset</code> stage is used rather than a <code>$project</code> stage. This enables the pipeline to avoid being verbose. More importantly, it means the pipeline does not have to be modified if a new field appears in documents added in the future (for example, see the <code>gender</code> field that appears in only <em>Olive’s</em> record).</p></li><li><p><strong>MQL Similarity.</strong> For reference, the MQL equivalent for you to achieve the same result is shown below (you can try this in the Shell):</p></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">persons</span>.<span class="title function_">find</span>(</span><br><span class="line">    &#123;<span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;ENGINEER&quot;</span>&#125;, &#123;<span class="string">&quot;_id&quot;</span>: <span class="number">0</span>, <span class="string">&quot;vocation&quot;</span>: <span class="number">0</span>, <span class="string">&quot;address&quot;</span>: <span class="number">0</span>&#125;,</span><br><span class="line">  ).<span class="title function_">sort</span>(</span><br><span class="line">    &#123;<span class="string">&quot;dateofbirth&quot;</span>: -<span class="number">1</span>&#125;</span><br><span class="line">  ).<span class="title function_">limit</span>(<span class="number">3</span>);</span><br></pre></td></tr></table></figure><h3 id="2-分组汇总"><a href="#2-分组汇总" class="headerlink" title="(2)分组汇总"></a>(2)分组汇总</h3><blockquote><p>您想要生成一份报告以显示每个客户在 2020 年购买的商品。</p><p>您将按客户对个人订单记录进行分组，捕获每个客户的「首单日期」、「订单数量」、「订单总价」和一个按日期排序的订单项目列表。</p></blockquote><p>测试数据如下，<code>orders</code>集合由3个不同客户在2019-2021年间的9个订单组成：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;elise_smith@myemail.com&quot;</span>, <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-05-30T08:35:52Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;231.43&quot;</span>)&#125;,</span><br><span class="line">&#123;<span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;elise_smith@myemail.com&quot;</span>, <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-01-13T09:32:07Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;99.99&quot;</span>)&#125;,</span><br><span class="line">&#123;<span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;oranieri@warmmail.com&quot;</span>,   <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-01-01T08:25:37Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;63.13&quot;</span>)&#125;,</span><br><span class="line">&#123;<span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;tj@wheresmyemail.com&quot;</span>,    <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2019-05-28T19:13:32Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;2.01&quot;</span>)&#125;,  </span><br><span class="line">&#123;<span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;tj@wheresmyemail.com&quot;</span>,    <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-11-23T22:56:53Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;187.99&quot;</span>)&#125;,</span><br><span class="line">&#123;<span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;tj@wheresmyemail.com&quot;</span>,    <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-08-18T23:04:48Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.59&quot;</span>)&#125;,</span><br><span class="line">&#123;<span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;elise_smith@myemail.com&quot;</span>, <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-12-26T08:55:46Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;48.50&quot;</span>)&#125;,</span><br><span class="line">&#123;<span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;tj@wheresmyemail.com&quot;</span>,    <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-29T07:49:32Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;1024.89&quot;</span>)&#125;,</span><br><span class="line">&#123;<span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;elise_smith@myemail.com&quot;</span>, <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-10-03T13:49:44Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;102.24&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  &#123;<span class="string">&quot;$match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;orderdate&quot;</span>: &#123;<span class="string">&quot;$gte&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-01-01T00:00:00Z&quot;</span>), <span class="string">&quot;$lt&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-01-01T00:00:00Z&quot;</span>), &#125;,</span><br><span class="line">  &#125;&#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 按订单日期升序，需要选择下面的「first_purchase_date」</span></span><br><span class="line">  &#123;<span class="string">&quot;$sort&quot;</span>: &#123;<span class="string">&quot;orderdate&quot;</span>: <span class="number">1</span>, &#125;&#125;,</span><br><span class="line"></span><br><span class="line">  &#123;<span class="string">&quot;$group&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;$customer_id&quot;</span>,</span><br><span class="line">    <span class="string">&quot;first_purchase_date&quot;</span>: &#123;<span class="string">&quot;$first&quot;</span>: <span class="string">&quot;$orderdate&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;total_value&quot;</span>: &#123;<span class="string">&quot;$sum&quot;</span>: <span class="string">&quot;$value&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;total_orders&quot;</span>: &#123;<span class="string">&quot;$sum&quot;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">    <span class="string">&quot;orders&quot;</span>: &#123;<span class="string">&quot;$push&quot;</span>: &#123;<span class="string">&quot;orderdate&quot;</span>: <span class="string">&quot;$orderdate&quot;</span>, <span class="string">&quot;value&quot;</span>: <span class="string">&quot;$value&quot;</span>&#125;&#125;,</span><br><span class="line">  &#125;&#125;,</span><br><span class="line">  </span><br><span class="line">  &#123;<span class="string">&quot;$sort&quot;</span>: &#123;<span class="string">&quot;first_purchase_date&quot;</span>: <span class="number">1</span>, &#125;&#125;,    </span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;<span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;$_id&quot;</span>, &#125;&#125;,</span><br><span class="line">  &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>, ]&#125;,   </span><br><span class="line">];</span><br></pre></td></tr></table></figure></p><p>执行聚合操作后应该返回代表三个客户的三个文档，文档分别包含了2020年首次购买日期、订单总价值、订单数量，以及订单详情列表。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210928-2分组汇总.png" alt="分组汇总"></p><p>Note, the order of fields shown for each document may vary.</p><ul><li><p><strong>Double Sort Use.</strong> It is necessary to perform a <code>$sort</code> on the order date both before and after the <code>$group</code> stage. The <code>$sort</code> before the <code>$group</code> is required because the <code>$group</code> stage uses a <code>$first</code> group accumulator to capture just the first order’s <code>orderdate</code> value for each grouped customer. The <code>$sort</code> after the <code>$group</code> is required because the act of having just grouped on customer ID will mean that the records are no longer sorted by purchase date for the records coming out of the <code>$group</code> stage.</p></li><li><p><strong>Renaming Group.</strong> Towards the end of the pipeline, you will see what is a typical pattern for pipelines that use <code>$group</code>, consisting of a combination of <code>$set</code>+<code>$unset</code> stages, to essentially take the group’s key (which is always called <code>_id</code>) and substitute it with a more meaningful name (<code>customer_id</code>).</p></li><li><p><strong>Lossless Decimals.</strong> You may notice the pipeline uses a <code>NumberDecimal()</code> function to ensure the order amounts in the inserted records are using a lossless decimal type, <a href="https://docs.mongodb.com/manual/tutorial/model-monetary-data/">IEEE 754 decimal128</a>. In this example, if you use a JSON <em>float</em> or <em>double</em> type instead, the order totals will suffer from a loss of precision. For instance, for the customer <code>elise_smith@myemail.com</code>, if you use a <em>double</em> type, the <code>total_value</code> result will have the value shown in the second line below, rather than the first line:</p></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用decimal128类型获得的期望结果</span></span><br><span class="line"><span class="attr">total_value</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&#x27;482.16&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用float或double类型获得的结果</span></span><br><span class="line"><span class="attr">total_value</span>: <span class="number">482.15999999999997</span></span><br></pre></td></tr></table></figure><h3 id="3-解包数组及分组"><a href="#3-解包数组及分组" class="headerlink" title="(3)解包数组及分组"></a>(3)解包数组及分组</h3><blockquote><p>您想要生成零售报告以列出已售出「昂贵产品」（价值超过 15 美元）的总价值和数量。</p><p>数据源是一个商店订单列表，其中每个订单都包含一个购买的产品集。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;order_id&quot;</span>: <span class="number">6363763262239</span>,</span><br><span class="line">    <span class="string">&quot;products&quot;</span>: [</span><br><span class="line">      &#123;<span class="string">&quot;prod_id&quot;</span>: <span class="string">&quot;abc12345&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Asus Laptop&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;431.43&quot;</span>), &#125;,</span><br><span class="line">      &#123;<span class="string">&quot;prod_id&quot;</span>: <span class="string">&quot;def45678&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Karcher Hose Set&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;22.13&quot;</span>), &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;order_id&quot;</span>: <span class="number">1197372932325</span>,</span><br><span class="line">    <span class="string">&quot;products&quot;</span>: [</span><br><span class="line">      &#123;<span class="string">&quot;prod_id&quot;</span>: <span class="string">&quot;abc12345&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Asus Laptop&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;429.99&quot;</span>), &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;order_id&quot;</span>: <span class="number">9812343774839</span>,</span><br><span class="line">    <span class="string">&quot;products&quot;</span>: [</span><br><span class="line">      &#123;<span class="string">&quot;prod_id&quot;</span>: <span class="string">&quot;pqr88223&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Morphy Richardds Food Mixer&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;431.43&quot;</span>), &#125;,</span><br><span class="line">      &#123;<span class="string">&quot;prod_id&quot;</span>: <span class="string">&quot;def45678&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Karcher Hose Set&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;21.78&quot;</span>), &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;order_id&quot;</span>: <span class="number">4433997244387</span>,</span><br><span class="line">    <span class="string">&quot;products&quot;</span>: [</span><br><span class="line">      &#123;<span class="string">&quot;prod_id&quot;</span>: <span class="string">&quot;def45678&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Karcher Hose Set&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;23.43&quot;</span>), &#125;,</span><br><span class="line">      &#123;<span class="string">&quot;prod_id&quot;</span>: <span class="string">&quot;jkl77336&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Picky Pencil Sharpener&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;0.67&quot;</span>), &#125;,</span><br><span class="line">      &#123;<span class="string">&quot;prod_id&quot;</span>: <span class="string">&quot;xyz11228&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Russell Hobbs Chrome Kettle&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;15.76&quot;</span>), &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  <span class="comment">// 从每个订单的products中解包每个product，作为一个新的单独记录</span></span><br><span class="line">  &#123;<span class="string">&quot;$unwind&quot;</span>: &#123;<span class="string">&quot;path&quot;</span>: <span class="string">&quot;$products&quot;</span>, &#125;&#125;,</span><br><span class="line"></span><br><span class="line">  &#123;<span class="string">&quot;$match&quot;</span>: &#123;<span class="string">&quot;products.price&quot;</span>: &#123; <span class="string">&quot;$gt&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;15.00&quot;</span>), &#125;,&#125;&#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 按产品类型分组，统计每个产品的总价和数量</span></span><br><span class="line">  &#123;<span class="string">&quot;$group&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;$products.prod_id&quot;</span>,</span><br><span class="line">    <span class="string">&quot;product&quot;</span>: &#123;<span class="string">&quot;$first&quot;</span>: <span class="string">&quot;$products.name&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;total_value&quot;</span>: &#123;<span class="string">&quot;$sum&quot;</span>: <span class="string">&quot;$products.price&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;quantity&quot;</span>: &#123;<span class="string">&quot;$sum&quot;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">  &#125;&#125;,</span><br><span class="line"></span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;<span class="string">&quot;product_id&quot;</span>: <span class="string">&quot;$_id&quot;</span>, &#125;&#125;,</span><br><span class="line">  &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>,]&#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>执行聚合操作后应该返回4个文档，代表客户订单中出现次数最多的4个仅有的「昂贵产品」，每个文档包括了产品的总订单价值和数量，如下所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210928-3解包分组.png" alt="解包分组"></p><p>Note, the order of fields shown for each document may vary.</p><ul><li><p><strong>Unwinding Arrays.</strong> The <code>$unwind</code> stage is a powerful concept, although often unfamiliar to many developers initially. Distilled down, it does one simple thing: it generates a new record for each element in an array field of every input document. If a source collection has 3 documents and each document contains an array of 4 elements, then performing an <code>$unwind</code> on each record’s array field produces 12 records (3 x 4).</p></li><li><p><strong>Introducing A Partial Match</strong>. The current example pipeline scans all documents in the collection and then filters out unpacked products where <code>price &gt; 15.00</code>. If the pipeline executed this filter as the first stage, it would incorrectly produce some result product records with a value of 15 dollars or less. This would be the case for an order composed of both inexpensive and expensive products. However, you can still improve the pipeline by including an additional “partial match” filter at the start of the pipeline for products valued at over 15 dollars. The aggregation could leverage an index (on <code>products.price</code>), resulting in a partial rather than full collection scan. This extra filter stage is beneficial if the input data set is large and many customer orders are for inexpensive items only. This approach is described in the chapter <a href="../../guides/performance.md#partial_match">Pipeline Performance Considerations</a>.</p></li></ul><h3 id="4-列表去重"><a href="#4-列表去重" class="headerlink" title="(4)列表去重"></a>(4)列表去重</h3><blockquote><p>您想在persons集合中查询，其中每个文档都包含其所说的一种或多种语言。</p><p>查询结果应该是按字母顺序排序的去重的语言列表，开发人员随后可以使用它来填充用户界面下拉小部件中的值列表。</p><p>此示例等效于<a href="https://en.wikipedia.org/wiki/SQL">SQL</a>中的<code>SELECT DISTINCT</code>语句。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Elise&quot;</span>,   <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Smith&quot;</span>,     <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;ENGINEER&quot;</span>,   <span class="string">&quot;language&quot;</span>: <span class="string">&quot;English&quot;</span>,&#125;,</span><br><span class="line">&#123;<span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Olive&quot;</span>,   <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Ranieri&quot;</span>,   <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;ENGINEER&quot;</span>,   <span class="string">&quot;language&quot;</span>: [<span class="string">&quot;Italian&quot;</span>, <span class="string">&quot;English&quot;</span>],&#125;,</span><br><span class="line">&#123;<span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Toni&quot;</span>,    <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Jones&quot;</span>,     <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;POLITICIAN&quot;</span>, <span class="string">&quot;language&quot;</span>: [<span class="string">&quot;English&quot;</span>, <span class="string">&quot;Welsh&quot;</span>],&#125;,</span><br><span class="line">&#123;<span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Bert&quot;</span>,    <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Gooding&quot;</span>,   <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;FLORIST&quot;</span>,    <span class="string">&quot;language&quot;</span>: <span class="string">&quot;English&quot;</span>,&#125;,</span><br><span class="line">&#123;<span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Sophie&quot;</span>,  <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Celements&quot;</span>, <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;ENGINEER&quot;</span>,   <span class="string">&quot;language&quot;</span>: [<span class="string">&quot;Gaelic&quot;</span>, <span class="string">&quot;English&quot;</span>],&#125;,</span><br><span class="line">&#123;<span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Carl&quot;</span>,    <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Simmons&quot;</span>,   <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;ENGINEER&quot;</span>,   <span class="string">&quot;language&quot;</span>: <span class="string">&quot;English&quot;</span>,&#125;,</span><br><span class="line">&#123;<span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Diego&quot;</span>,   <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Lopez&quot;</span>,     <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;CHEF&quot;</span>,       <span class="string">&quot;language&quot;</span>: <span class="string">&quot;Spanish&quot;</span>,&#125;,</span><br><span class="line">&#123;<span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Helmut&quot;</span>,  <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Schneider&quot;</span>, <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;NURSE&quot;</span>,      <span class="string">&quot;language&quot;</span>: <span class="string">&quot;German&quot;</span>,&#125;,</span><br><span class="line">&#123;<span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Valerie&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Dubois&quot;</span>,    <span class="string">&quot;vocation&quot;</span>: <span class="string">&quot;SCIENTIST&quot;</span>,  <span class="string">&quot;language&quot;</span>: <span class="string">&quot;French&quot;</span>,&#125;,</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  &#123;<span class="string">&quot;$unwind&quot;</span>: &#123;<span class="string">&quot;path&quot;</span>: <span class="string">&quot;$language&quot;</span>&#125;&#125;, <span class="comment">// 解包language字段，该字段为数组或单个值</span></span><br><span class="line">  &#123;<span class="string">&quot;$group&quot;</span>: &#123;<span class="string">&quot;_id&quot;</span>: <span class="string">&quot;$language&quot;</span>&#125;&#125;,</span><br><span class="line">  &#123;<span class="string">&quot;$sort&quot;</span>: &#123;<span class="string">&quot;_id&quot;</span>: <span class="number">1</span>&#125;&#125;, </span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;<span class="string">&quot;language&quot;</span>: <span class="string">&quot;$_id&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;$$REMOVE&quot;</span>&#125;&#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure></p><p>执行聚合操作后应该返回按字母序的7个文档，代表不同的7种语言，如下所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210928-4列表去重.png" alt="列表去重"></p><ul><li><p><strong>Unwinding Non-Arrays.</strong> In some of the example’s documents, the <code>language</code> field is an array, whilst in others, the field is a simple string value. The <code>$unwind</code> stage can seamlessly deal with both field types and does not throw an error if it encounters a non-array value. Instead, if the field is not an array, the stage outputs a single record using the field’s string value in the same way it would if the field was an array containing just one element. If you are sure the field in every document will only ever be a simple field rather than an array, you can omit this first stage (<code>$unwind</code>) from the pipeline.</p></li><li><p><strong>Group ID Provides Unique Values.</strong> By grouping on a single field and not accumulating other fields such as total or count, the output of a <code>$group</code> stage is just every unique group’s ID, which in this case is every unique language.</p></li><li><p><strong>Unset Alternative.</strong> For the pipeline to be consistent with earlier examples in this book, it could have included an additional <code>$unset</code> stage to exclude the <code>_id</code> field. However, partly to show another way, the example pipeline used here marks the <code>_id</code> field for exclusion in the <code>$set</code> stage by being assigned the <code>$$REMOVE</code> variable.</p></li></ul><h2 id="2-数据联结"><a href="#2-数据联结" class="headerlink" title="2.数据联结"></a>2.数据联结</h2><h3 id="1-一对一联结"><a href="#1-一对一联结" class="headerlink" title="(1)一对一联结"></a>(1)一对一联结</h3><blockquote><p>您想要生成一个报告来列出 2020 年所有的购买情况，显示每个订单的产品名称和类别，而不是产品ID。</p><p>为此您需要获取客户「订单集合<code>orders</code>」，并将每个订单记录与「产品集合<code>products</code>」中的对应的产品相<strong>联结</strong>。</p><p>两个集合之间存在「多对一<code>many:1</code>」关系，因此在将订单与产品匹配时会产生「一对一<code>1:1</code>」的联结。联结将根据产品的<code>id</code>在双方之间使用单个字段比较。</p><p>数据包括2019-2021年间的产品<code>products</code>和订单<code>orders</code>两个集合，如下所示。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 集合products</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;a1b2c3d4&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Asus Laptop&quot;</span>,</span><br><span class="line">    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;ELECTRONICS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Good value laptop for students&quot;</span>,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;z9y8x7w6&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;The Day Of The Triffids&quot;</span>,</span><br><span class="line">    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;BOOKS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Classic post-apocalyptic novel&quot;</span>,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;ff11gg22hh33&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Morphy Richardds Food Mixer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;KITCHENWARE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Luxury mixer turning good cakes into great&quot;</span>,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;pqr678st&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Karcher Hose Set&quot;</span>,</span><br><span class="line">    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;GARDEN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Hose + nosels + winder for tidy storage&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 集合orders</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;elise_smith@myemail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-05-30T08:35:52Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;product_id&quot;</span>: <span class="string">&quot;a1b2c3d4&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;431.43&quot;</span>),</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;tj@wheresmyemail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2019-05-28T19:13:32Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;product_id&quot;</span>: <span class="string">&quot;z9y8x7w6&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;5.01&quot;</span>),</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;oranieri@warmmail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-01-01T08:25:37Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;product_id&quot;</span>: <span class="string">&quot;ff11gg22hh33&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;63.13&quot;</span>),</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;jjones@tepidmail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-12-26T08:55:46Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;product_id&quot;</span>: <span class="string">&quot;a1b2c3d4&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;429.65&quot;</span>),</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  &#123;<span class="string">&quot;$match&quot;</span>: &#123;<span class="string">&quot;orderdate&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;$gte&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-01-01T00:00:00Z&quot;</span>), <span class="string">&quot;$lt&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-01-01T00:00:00Z&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Join &quot;product_id&quot; in orders collection to &quot;id&quot; in products&quot; collection</span></span><br><span class="line">  &#123;<span class="string">&quot;$lookup&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: <span class="string">&quot;products&quot;</span>, <span class="string">&quot;localField&quot;</span>: <span class="string">&quot;product_id&quot;</span>, <span class="string">&quot;foreignField&quot;</span>: <span class="string">&quot;id&quot;</span>, <span class="string">&quot;as&quot;</span>: <span class="string">&quot;product_mapping&quot;</span>,</span><br><span class="line">  &#125;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For this data model, will always be 1 record in right-side</span></span><br><span class="line">  <span class="comment">// of join, so take 1st joined array element</span></span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;<span class="string">&quot;product_mapping&quot;</span>: &#123;<span class="string">&quot;$first&quot;</span>: <span class="string">&quot;$product_mapping&quot;</span>&#125;, &#125;&#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Extract the joined embeded fields into top level fields</span></span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;product_name&quot;</span>: <span class="string">&quot;$product_mapping.name&quot;</span>, <span class="string">&quot;product_category&quot;</span>: <span class="string">&quot;$product_mapping.category&quot;</span>,</span><br><span class="line">  &#125;&#125;,</span><br><span class="line">  </span><br><span class="line">  &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>, <span class="string">&quot;product_id&quot;</span>, <span class="string">&quot;product_mapping&quot;</span>, ]&#125;,     </span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>执行聚合操作后应该返回代表2020年的3个订单文档，但每个订单的<code>product_id</code>字段替换成了两个新查找的字段<code>product_name</code>和<code>product_category</code>，如下所示。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210928-5一对一联结.png" alt="一对一联结"></p><ul><li><p><strong>Single Field Match.</strong> The pipeline includes a <code>$lookup</code> join between a single field from each collection. For an illustration of performing a join based on two or more matching fields, see the <a href="./multi-one-to-many.html">Multi-Field Join &amp; One-to-Many</a> example.</p></li><li><p><strong>First Element Assumption.</strong> In this particular data model example, the join between the two collections is 1:1. Therefore the returned array of joined elements coming out of the <code>$lookup</code> stage always contains precisely one array element. As a result, the pipeline extracts the data from this first array element only, using the <code>$first</code> operator. For an illustration of performing a 1:many join instead, see the <a href="./multi-one-to-many.html">Multi-Field Join &amp; One-to-Many</a> example.</p></li></ul><h3 id="2-多字段联结及一对多"><a href="#2-多字段联结及一对多" class="headerlink" title="(2)多字段联结及一对多"></a>(2)多字段联结及一对多</h3><blockquote><p>您想要生成一份报告，列出2020年每种产品所生成的所有订单。</p><p>为此，您需要将商店的「产品集合<code>products</code>」中的每个产品<code>product</code>，与产品对应的订单<code>order</code>（订单位于<code>orders</code>集合）相联结。</p><p>基于每侧两个字段的匹配，两个集合之间存在「一对多<code>1:many</code>」的关系。</p><p>联结需要使用两个公共字段（<code>product_name</code>和<code>product_variation</code>），而不是像<code>product_id</code>（此数据集中不存在该字段）这样的单个字段。</p><p><strong>注意：</strong>执行一对多<code>1:many</code>的联结并不强制要求在每一侧通过多个字段进行联结。然而在这个例子中，在一个地方展示这两个方面被认为是有益的。</p><p>数据包括2019-2021年间的产品<code>products</code>和订单<code>orders</code>两个集合，如下所示。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 集合products</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Asus Laptop&quot;</span>,</span><br><span class="line">    <span class="string">&quot;variation&quot;</span>: <span class="string">&quot;Ultra HD&quot;</span>,</span><br><span class="line">    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;ELECTRONICS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Great for watching movies&quot;</span>,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Asus Laptop&quot;</span>,</span><br><span class="line">    <span class="string">&quot;variation&quot;</span>: <span class="string">&quot;Normal Display&quot;</span>,</span><br><span class="line">    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;ELECTRONICS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Good value laptop for students&quot;</span>,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;The Day Of The Triffids&quot;</span>,</span><br><span class="line">    <span class="string">&quot;variation&quot;</span>: <span class="string">&quot;1st Edition&quot;</span>,</span><br><span class="line">    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;BOOKS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Classic post-apocalyptic novel&quot;</span>,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;The Day Of The Triffids&quot;</span>,</span><br><span class="line">    <span class="string">&quot;variation&quot;</span>: <span class="string">&quot;2nd Edition&quot;</span>,</span><br><span class="line">    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;BOOKS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Classic post-apocalyptic novel&quot;</span>,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Morphy Richards Food Mixer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;variation&quot;</span>: <span class="string">&quot;Deluxe&quot;</span>,</span><br><span class="line">    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;KITCHENWARE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Luxury mixer turning good cakes into great&quot;</span>,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Karcher Hose Set&quot;</span>,</span><br><span class="line">    <span class="string">&quot;variation&quot;</span>: <span class="string">&quot;Full Monty&quot;</span>,</span><br><span class="line">    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;GARDEN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Hose + nosels + winder for tidy storage&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 集合orders</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;elise_smith@myemail.com&quot;</span>, <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-05-30T08:35:52Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;product_name&quot;</span>: <span class="string">&quot;Asus Laptop&quot;</span>, <span class="string">&quot;product_variation&quot;</span>: <span class="string">&quot;Normal Display&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;431.43&quot;</span>),</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;tj@wheresmyemail.com&quot;</span>, <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2019-05-28T19:13:32Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;product_name&quot;</span>: <span class="string">&quot;The Day Of The Triffids&quot;</span>, <span class="string">&quot;product_variation&quot;</span>: <span class="string">&quot;2nd Edition&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;5.01&quot;</span>),</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;oranieri@warmmail.com&quot;</span>, <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-01-01T08:25:37Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;product_name&quot;</span>: <span class="string">&quot;Morphy Richards Food Mixer&quot;</span>, <span class="string">&quot;product_variation&quot;</span>: <span class="string">&quot;Deluxe&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;63.13&quot;</span>),</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;jjones@tepidmail.com&quot;</span>, <span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-12-26T08:55:46Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;product_name&quot;</span>: <span class="string">&quot;Asus Laptop&quot;</span>, <span class="string">&quot;product_variation&quot;</span>: <span class="string">&quot;Normal Display&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;429.65&quot;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  <span class="comment">// 将产品集合中的 2 个字段连接到订单集合中的 2 个字段</span></span><br><span class="line">  &#123;<span class="string">&quot;$lookup&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: <span class="string">&quot;orders&quot;</span>,</span><br><span class="line">    <span class="string">&quot;let&quot;</span>: &#123;<span class="string">&quot;prdname&quot;</span>: <span class="string">&quot;$name&quot;</span>, <span class="string">&quot;prdvartn&quot;</span>: <span class="string">&quot;$variation&quot;</span>, &#125;,</span><br><span class="line">    <span class="comment">// Embedded pipeline to control how the join is matched</span></span><br><span class="line">    <span class="string">&quot;pipeline&quot;</span>: [</span><br><span class="line">      <span class="comment">// Join by two fields in each side</span></span><br><span class="line">      &#123;<span class="string">&quot;$match&quot;</span>:</span><br><span class="line">        &#123;<span class="string">&quot;$expr&quot;</span>: &#123;<span class="string">&quot;$and&quot;</span>: [</span><br><span class="line">            &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$product_name&quot;</span>, <span class="string">&quot;$$prdname&quot;</span>]&#125;, &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$product_variation&quot;</span>, <span class="string">&quot;$$prdvartn&quot;</span>]&#125;,</span><br><span class="line">          ]&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Match only orders made in 2020</span></span><br><span class="line">      &#123;<span class="string">&quot;$match&quot;</span>: &#123;<span class="string">&quot;orderdate&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;$gte&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-01-01T00:00:00Z&quot;</span>), <span class="string">&quot;$lt&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-01-01T00:00:00Z&quot;</span>),</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;&#125;,</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Exclude some unwanted fields from the right side of the join</span></span><br><span class="line">      &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>, <span class="string">&quot;product_name&quot;</span>, <span class="string">&quot;product_variation&quot;</span>, ]&#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">as</span>: <span class="string">&quot;orders&quot;</span>,</span><br><span class="line">  &#125;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only show products that have at least one order</span></span><br><span class="line">  &#123;<span class="string">&quot;$match&quot;</span>: &#123;<span class="string">&quot;orders&quot;</span>: &#123;<span class="string">&quot;$ne&quot;</span>: []&#125;,&#125;&#125;,</span><br><span class="line"></span><br><span class="line">  &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>,]&#125;, </span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>执行聚合操作后应该返回2个文档，代表 2020 年有一个或多个订单的两个产品，每个产品对应的订单以数组形式展示，如下所示。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210928-6多字段联结及一对多.png" alt="多字段联结及一对多"></p><ul><li><p><strong>Multiple Join Fields.</strong> To perform a join of two or more fields between the two collections, you need to use a <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/#join-conditions-and-uncorrelated-sub-queries">let</a> parameter rather than specifying the <code>localField</code> and <code>foreignField</code> parameters used in a single field join. With a <code>let</code> parameter, you bind multiple fields from the first collection into variables ready to be used in the joining process. You use an embedded <code>pipeline</code> inside the <code>$lookup</code> stage to match the <em>bind</em> variables with fields in the second collection’s records. In this instance,  because the <code>$expr</code> operator performs an equality comparison specifically (as opposed to a range comparison), the aggregation runtime can employ an appropriate index for this match.</p></li><li><p><strong>Reducing Array Content.</strong> The presence of an embedded pipeline in the <code>$lookup</code> stage provides an opportunity to filter out three unwanted fields brought in from the second collection. Instead, you could use an <code>$unset</code> stage later in the top-level pipeline to project out these unwanted array elements. If you need to perform more complex array content filtering rules, you can use the approach described in section <em><a href="../../guides/performance.md#avoid_unwinding">2. Avoid Unwinding &amp; Regrouping Documents Just To Process Array Elements</a></em>“ of the <em>Pipeline Performance Considerations</em> chapter.</p></li></ul><h2 id="3-数据类型转换"><a href="#3-数据类型转换" class="headerlink" title="3.数据类型转换"></a>3.数据类型转换</h2><h3 id="1-强类型转换"><a href="#1-强类型转换" class="headerlink" title="(1)强类型转换"></a>(1)强类型转换</h3><blockquote><p>一组零售订单<em>retail orders</em>已被某三方机构导入MongoDB集合中，但是所有数据类型都丢失了，因此所有字段值被存储为字符串形式。</p><p>您想为所有文档重新建立正确的数据，并将它们复制到一个新的「清理过的」集合中。您可以在聚合管道中包含该类型的转换逻辑，因为您知道每个字段在原始记录中的结构类型。</p><p>与本文中的大多数示例不同，聚合管道将其输出写入一个集合，而不是将结果流式地返回给调用的应用程序。</p><p>订单集合<code>orders</code>包含三个订单文档，其中每个订单只有字符串形式的<strong>文本字段</strong>（注意，第二个文档有意缺少<code>further_info</code>子文档中的<code>reported</code>字段），如下所示。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;elise_smith@myemail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;order_date&quot;</span>: <span class="string">&quot;2020-05-30T08:35:52&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="string">&quot;231.43&quot;</span>,</span><br><span class="line">    <span class="string">&quot;further_info&quot;</span>: &#123;<span class="string">&quot;item_qty&quot;</span>: <span class="string">&quot;3&quot;</span>, <span class="string">&quot;reported&quot;</span>: <span class="string">&quot;false&quot;</span>,&#125;,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;oranieri@warmmail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;order_date&quot;</span>: <span class="string">&quot;2020-01-01T08:25:37&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="string">&quot;63.13&quot;</span>,</span><br><span class="line">    <span class="string">&quot;further_info&quot;</span>: &#123;<span class="string">&quot;item_qty&quot;</span>: <span class="string">&quot;2&quot;</span>,&#125;,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;customer_id&quot;</span>: <span class="string">&quot;tj@wheresmyemail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;order_date&quot;</span>: <span class="string">&quot;2019-05-28T19:13:32&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="string">&quot;2.01&quot;</span>,</span><br><span class="line">    <span class="string">&quot;further_info&quot;</span>: &#123;<span class="string">&quot;item_qty&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;reported&quot;</span>: <span class="string">&quot;true&quot;</span>, &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  <span class="comment">// 将字符串转换为所需类型</span></span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;order_date&quot;</span>: &#123;<span class="string">&quot;$toDate&quot;</span>: <span class="string">&quot;$order_date&quot;</span>&#125;,    </span><br><span class="line">    <span class="string">&quot;value&quot;</span>: &#123;<span class="string">&quot;$toDecimal&quot;</span>: <span class="string">&quot;$value&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;further_info.item_qty&quot;</span>: &#123;<span class="string">&quot;$toInt&quot;</span>: <span class="string">&quot;$further_info.item_qty&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;further_info.reported&quot;</span>: &#123;<span class="string">&quot;$switch&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;branches&quot;</span>: [</span><br><span class="line">        &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [&#123;<span class="string">&quot;$toLower&quot;</span>: <span class="string">&quot;$further_info.reported&quot;</span>&#125;, <span class="string">&quot;true&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [&#123;<span class="string">&quot;$toLower&quot;</span>: <span class="string">&quot;$further_info.reported&quot;</span>&#125;, <span class="string">&quot;false&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;default&quot;</span>: &#123;<span class="string">&quot;$ifNull&quot;</span>: [<span class="string">&quot;$further_info.reported&quot;</span>, <span class="string">&quot;$$REMOVE&quot;</span>]&#125;,</span><br><span class="line">    &#125;&#125;,     </span><br><span class="line">  &#125;&#125;,     </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 输出到未分片（unsharded）或分片（sharded）的集合</span></span><br><span class="line">  &#123;<span class="string">&quot;$merge&quot;</span>: &#123;<span class="string">&quot;into&quot;</span>: <span class="string">&quot;orders_typed&quot;</span>, &#125;&#125;,    </span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>执行聚合操作后将生成一个新的名为<code>orders_typed</code>的集合，新集合<code>orders_typed</code>应该与原集合<code>orders</code>具有相同数量的文档、相同的字段结构和字段名称，但现在使用了合适的强类型的<strong>布尔值</strong>、<strong>日期</strong>、<strong>整数</strong>和<strong>十进制值</strong>，集合内容如下所示。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210928-7强类型转换.png" alt="强类型转换"></p><ul><li><p><strong>Boolean Conversion.</strong> The pipeline’s conversions for integers, decimals, and dates are straightforward using the corresponding expression operators, <code>$toInt</code>, <code>$toDecimal</code> and <code>$toDate</code>. However, the expression operator <code>$toBool</code> is not used for the boolean conversion. This is because <code>$toBool</code> will convert any non-empty string to <em>true</em> regardless of its value. As a result, the pipeline uses a <code>$switch</code> operator to compare the lowercase version of strings with the text <code>&#39;true&#39;</code> and <code>&#39;false&#39;</code>, returning the matching boolean.</p></li><li><p><strong>Preserving Non-Existence.</strong> The field <code>further_info.reported</code> is an optional field in this scenario. The field may not always appear in a document, as illustrated by one of the three documents in the example. If a field is not present in a document, this potentially significant fact should never be lost. The pipeline includes additional logic for the <code>further_info.reported</code> field to preserve this information. The pipeline ensures the field is not included in the output document if it didn’t exist in the source document. A <code>$ifNull</code> conditional operator is used, which returns the <code>$$REMOVE</code> marker flag if the field is missing, instructing the aggregation engine to omit it.</p></li><li><p><strong>Output To A Collection.</strong> The pipeline uses a <code>$merge</code> stage to instruct the aggregation engine to write the output to a collection rather than returning a stream of results. For this example, the default settings for <code>$merge</code> are sufficient. Each transformed record coming out of the aggregation pipeline becomes a new record in the target collection. The pipeline could have used a <code>$out</code> rather than a <code>$merge</code> stage. However, because <code>$merge</code> supports both unsharded and sharded collections, whereas <code>$out</code> only supports the former, <code>$merge</code> provides a more universally applicable example. If your aggregation needs to create a brand new unsharded collection, <code>$out</code> may be a little faster because the aggregation will completely replace the existing collection if it exists. Using <code>$merge</code>, the system has to perform more checks for every record the aggregation inserts (even though, in this case, it will be to a new collection).</p></li><li><p><strong>Trickier Date Conversions.</strong> In this example, the date strings contain all the date parts required by the <code>$toDate</code> operator to perform a conversion correctly. In some situations, this may not be the case, and a date string may be missing some valuable information (e.g. which century a 2-character year string is for, such as the century <code>19</code> or <code>21</code>). To understand how to deal with these cases, see the <a href="./convert-incomplete-dates.md">Convert Incomplete Date Strings</a> example chapter.</p></li></ul><h3 id="2-残缺日期转换"><a href="#2-残缺日期转换" class="headerlink" title="(2)残缺日期转换"></a>(2)残缺日期转换</h3><blockquote><p>应用程序正在将<code>payment</code>文档提取到 MongoDB 集合中，其中每个文档的<code>payment date</code>字段都包含一个「看起来有点像日期时间」的字符串，例如<code>&quot;01-JAN-20 01.01.01.123000000&quot;</code>。</p><p>您希望在聚合时将每个<code>payment date</code>转换为有效的<code>BSON</code>日期类型，但是<strong>该字段不包含能准确确定确切日期时间所需的所有信息</strong>。因此，您不能直接使用 MongoDB 的<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/#date-expression-operators">日期表达式运算符</a>将文本转换为日期。</p><p>这些文本字段中的每一个都缺少以下信息：</p><ul><li>明确的<strong>世纪</strong>：例如是1900s，还是2000s，还是其他；</li><li>明确的<strong>时区</strong>：例如是GMT，是IST，还是PST，还是其他；</li><li>三个字母的月份缩写所代表的具体<strong>语言</strong>：例如「JAN」是法语，还是英语，还是其他。</li></ul><p>假设您随后了解到所有付款记录仅发生在21世纪，提取数据时使用的时区是UTC，使用的语言是英语。有了这些信息，您就可以构建一个聚合管道来将这些文本字段转换为日期字段。</p><p>缴费集合<code>payments</code>包含12个支付文档，包括了时间乱序的覆盖了2020年所有12个月的数据，如下所示。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;010101&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;01-JAN-20 01.01.01.123000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">1.01</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;020202&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;02-FEB-20 02.02.02.456000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">2.02</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;030303&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;03-MAR-20 03.03.03.789000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">3.03</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;040404&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;04-APR-20 04.04.04.012000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">4.04</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;050505&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;05-MAY-20 05.05.05.345000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">5.05</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;060606&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;06-JUN-20 06.06.06.678000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">6.06</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;070707&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;07-JUL-20 07.07.07.901000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">7.07</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;080808&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;08-AUG-20 08.08.08.234000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">8.08</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;090909&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;09-SEP-20 09.09.09.567000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">9.09</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;101010&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;10-OCT-20 10.10.10.890000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">10.10</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;111111&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;11-NOV-20 11.11.11.111000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">11.11</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;account&quot;</span>: <span class="string">&quot;121212&quot;</span>, <span class="string">&quot;payment_date&quot;</span>: <span class="string">&quot;12-DEC-20 12.12.12.999000000&quot;</span>, <span class="string">&quot;amount&quot;</span>: <span class="number">12.12</span>&#125;</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  <span class="comment">// 将字段从字符串转换为日期类型，填补缺失的空白</span></span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;payment_date&quot;</span>: &#123;    </span><br><span class="line">      <span class="string">&quot;$let&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;vars&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;txt&quot;</span>: <span class="string">&quot;$payment_date&quot;</span>,  <span class="comment">// Assign &quot;payment_date&quot; field to variable &quot;txt&quot;,</span></span><br><span class="line">          <span class="string">&quot;month&quot;</span>: &#123;<span class="string">&quot;$substrCP&quot;</span>: [<span class="string">&quot;$payment_date&quot;</span>, <span class="number">3</span>, <span class="number">3</span>]&#125;,  <span class="comment">// Extract month text</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;in&quot;</span>: &#123; </span><br><span class="line">          <span class="string">&quot;$dateFromString&quot;</span>: &#123;<span class="string">&quot;format&quot;</span>: <span class="string">&quot;%d-%m-%Y %H.%M.%S.%L&quot;</span>, <span class="string">&quot;dateString&quot;</span>:</span><br><span class="line">            &#123;<span class="string">&quot;$concat&quot;</span>: [</span><br><span class="line">              &#123;<span class="string">&quot;$substrCP&quot;</span>: [<span class="string">&quot;$$txt&quot;</span>, <span class="number">0</span>, <span class="number">3</span>]&#125;,  <span class="comment">// Use 1st 3 chars in string</span></span><br><span class="line">              &#123;<span class="string">&quot;$switch&quot;</span>: &#123;<span class="string">&quot;branches&quot;</span>: [  <span class="comment">// Replace month 3 chars with month number</span></span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;JAN&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;01&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;FEB&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;02&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;MAR&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;03&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;APR&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;04&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;MAY&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;05&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;JUN&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;06&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;JUL&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;07&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;AUG&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;08&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;SEP&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;09&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;OCT&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;10&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;NOV&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;11&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;case&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$$month&quot;</span>, <span class="string">&quot;DEC&quot;</span>]&#125;, <span class="string">&quot;then&quot;</span>: <span class="string">&quot;12&quot;</span>&#125;,</span><br><span class="line">               ], <span class="string">&quot;default&quot;</span>: <span class="string">&quot;ERROR&quot;</span>&#125;&#125;,</span><br><span class="line">              <span class="string">&quot;-20&quot;</span>,  <span class="comment">// Add hyphen + hardcoded century 2 digits</span></span><br><span class="line">              &#123;<span class="string">&quot;$substrCP&quot;</span>: [<span class="string">&quot;$$txt&quot;</span>, <span class="number">7</span>, <span class="number">15</span>]&#125;  <span class="comment">// Use remaining 3 millis (ignore last 6 nanosecs)</span></span><br><span class="line">            ]</span><br><span class="line">          &#125;&#125;                  </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;        </span><br><span class="line">    &#125;,             </span><br><span class="line">  &#125;&#125;,</span><br><span class="line"></span><br><span class="line">  &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>, ]&#125;,         </span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>执行聚合操作后应该返回对应于原文档的12个文档，但将<code>payment_date</code>从文本值转换为正确的日期类型，如下所示。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210928-8残缺日期转换.png" alt="残缺日期转换"></p><ul><li><p><strong>Concatenation Explanation.</strong> In this pipeline, the text fields (e.g. <code>&#39;12-DEC-20 12.12.12.999000000&#39;</code>) are each converted to date fields (e.g. <code>2020-12-12T12:12:12.999Z</code>). This is achieved by concatenating together the following four example elements before passing them to the <code>$dateFromString</code> operator to convert to a date type:</p><ul><li><code>&#39;12-&#39;</code> <em>(day of the month from the input string + the hyphen suffix already present in the text)</em></li><li><code>&#39;12&#39;</code> <em>(replacing ‘DEC’)</em></li><li><code>&#39;-20&#39;</code> <em>(hard-coded hyphen + hardcoded century)</em></li><li><code>&#39;20 12.12.12.999&#39;</code> <em>(the rest of input string apart from the last 6 nanosecond digits)</em></li></ul></li><li><p><strong>Further Reading.</strong> This example is based on the output of the blog post: <a href="https://pauldone.blogspot.com/2020/05/aggregation-convert-nasty-date-strings.html">Converting Gnarly Date Strings to Proper Date Types Using a MongoDB Aggregation Pipeline</a>.</p></li></ul><h2 id="4-趋势分析"><a href="#4-趋势分析" class="headerlink" title="4.趋势分析"></a>4.趋势分析</h2><h3 id="1-特征分类（分面检索）"><a href="#1-特征分类（分面检索）" class="headerlink" title="(1)特征分类（分面检索）"></a>(1)特征分类（分面检索）</h3><blockquote><p>您希望在零售网站上提供<a href="https://en.wikipedia.org/wiki/Faceted_search">分面检索</a>功能，使客户能够在网页中列出的产品结果中，通过选择指定特征来改善他们的产品搜索。</p><p>按不同维度对产品进行分类是有益的，其中每个维度（即「分面facet」）对应于产品记录中的特定字段（例如「产品评级」、「产品价格」）。每个分面都应分解为子范围，以便客户可以为特定分面（例如「评级」）选择特定的子范围（例如4~5星）。</p><p>聚合管道将根据每个分面的字段（<code>rating</code>和<code>price</code>）来分析<code>products</code>集合，以确定每个分面的值的分布。</p><p>产品集合<code>products</code>包含如下16个文档。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Asus Laptop&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;ELECTRONICS&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Good value laptop for students&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;431.43&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.2&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;The Day Of The Triffids&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;BOOKS&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Classic post-apocalyptic novel&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;5.01&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.8&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Morphy Richardds Food Mixer&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;KITCHENWARE&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Luxury mixer turning good cakes into great&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;63.13&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;3.8&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Karcher Hose Set&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;GARDEN&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Hose + nosels + winder for tidy storage&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;22.13&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.3&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Oak Coffee Table&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;HOME&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;size is 2m x 0.5m x 0.4m&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;22.13&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;3.8&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Lenovo Laptop&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;ELECTRONICS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;High spec good for gaming&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;1299.99&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.1&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;One Day in the Life of Ivan Denisovich&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;BOOKS&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Brutal life in a labour camp&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.29&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.9&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Russell Hobbs Chrome Kettle&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;KITCHENWARE&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Nice looking budget kettle&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;15.76&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;3.9&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Tiffany Gold Chain&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;JEWELERY&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Looks great for any age and gender&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;582.22&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.0&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Raleigh Racer 21st Century Classic&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;BICYCLES&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Modern update to a classic 70s bike design&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;523.00&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.5&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Diesel Flare Jeans&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;CLOTHES&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Top end casual look&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;129.89&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.3&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jazz Silk Scarf&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;CLOTHES&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Style for the winder months&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;28.39&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;3.7&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Dell XPS 13 Laptop&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;ELECTRONICS&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Developer edition&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;1399.89&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.4&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;NY Baseball Cap&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;CLOTHES&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Blue &amp; white&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;18.99&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.0&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Tots Flower Pots&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;GARDEN&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Set of three&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;9.78&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.1&quot;</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Picky Pencil Sharpener&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;Stationery&quot;</span>, </span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Ultra budget&quot;</span>, </span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;0.67&quot;</span>), <span class="string">&quot;rating&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;1.2&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  <span class="comment">// Group products by 2 facets: 1) by price ranges, 2) by rating ranges</span></span><br><span class="line">  &#123;<span class="string">&quot;$facet&quot;</span>: &#123;</span><br><span class="line">    <span class="comment">// ①Group by price ranges</span></span><br><span class="line">    <span class="string">&quot;by_price&quot;</span>: [</span><br><span class="line">      <span class="comment">// Group into 3 ranges: inexpensive small price range to expensive large price range</span></span><br><span class="line">      &#123;<span class="string">&quot;$bucketAuto&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;groupBy&quot;</span>: <span class="string">&quot;$price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;buckets&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="string">&quot;granularity&quot;</span>: <span class="string">&quot;1-2-5&quot;</span>,</span><br><span class="line">        <span class="string">&quot;output&quot;</span>: &#123;<span class="string">&quot;count&quot;</span>: &#123;<span class="string">&quot;$sum&quot;</span>: <span class="number">1</span>&#125;, <span class="string">&quot;products&quot;</span>: &#123;<span class="string">&quot;$push&quot;</span>: <span class="string">&quot;$name&quot;</span>&#125;,&#125;,</span><br><span class="line">      &#125;&#125;,</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Tag range info as &quot;price_range&quot;</span></span><br><span class="line">      &#123;<span class="string">&quot;$set&quot;</span>: &#123;<span class="string">&quot;price_range&quot;</span>: <span class="string">&quot;$_id&quot;</span>,&#125;&#125;,         </span><br><span class="line">      </span><br><span class="line">      &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>,]&#125;,         </span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ②Group by rating ranges</span></span><br><span class="line">    <span class="string">&quot;by_rating&quot;</span>: [</span><br><span class="line">      <span class="comment">// Group products evenly across 5 rating ranges from low to high</span></span><br><span class="line">      &#123;<span class="string">&quot;$bucketAuto&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;groupBy&quot;</span>: <span class="string">&quot;$rating&quot;</span>,</span><br><span class="line">        <span class="string">&quot;buckets&quot;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&quot;output&quot;</span>: &#123;<span class="string">&quot;count&quot;</span>: &#123;<span class="string">&quot;$sum&quot;</span>: <span class="number">1</span>&#125;, <span class="string">&quot;products&quot;</span>: &#123;<span class="string">&quot;$push&quot;</span>: <span class="string">&quot;$name&quot;</span>&#125;,&#125;,</span><br><span class="line">      &#125;&#125;,</span><br><span class="line">      </span><br><span class="line">      &#123;<span class="string">&quot;$set&quot;</span>: &#123;<span class="string">&quot;rating_range&quot;</span>: <span class="string">&quot;$_id&quot;</span>,&#125;&#125;,         </span><br><span class="line">      &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>,]&#125;,         </span><br><span class="line">    ],</span><br><span class="line">  &#125;&#125;,  </span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>执行聚合操作后应该返回一个单独的文档，文档包含 2 个分面（分别关闭<code>by_price</code>和关闭<code>by_rating</code>），每个分面显示「其值的子范围」以及「属于每个子范围的产品」，如下所示。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210928-9特征分类之分面检索.png" alt="特征分类之分面检索"></p><ul><li><p><strong>Multiple Pipelines.</strong> The <code>$facet</code> stage doesn’t have to be employed for you to use the <code>$bucketAuto</code> stage. In most <em>faceted search</em> scenarios, you will want to understand a collection by multiple dimensions at once (<em>price</em> &amp; <em>rating</em> in this case). The <code>$facet</code> stage is convenient because it allows you to define various <code>$bucketAuto</code> dimensions in one go in a single pipeline. Otherwise, a client application must invoke an aggregation multiple times, each using a new <code>$bucketAuto</code> stage to process a different field. In fact, each section of a <code>$facet</code> stage is just a regular aggregation [sub-]pipeline, able to contain any type of stage (with a few specific <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/facet/#behavior">documented exceptions</a>) and may not even contain <code>$bucketAuto</code> or <code>$bucket</code> stages at all. </p></li><li><p><strong>Single Document Result.</strong> If the result of a <code>$facet</code> based aggregation is allowed to be multiple documents, this will cause a problem. The results will contain a mix of records originating from different facets but with no way of ascertaining the facet each result record belongs to. Consequently, when using <code>$facet</code>, a single document is always returned, containing top-level fields identifying each facet. Having only a single result record is not usually a problem. A typical requirement for faceted search is to return a small amount of grouped summary data about a collection rather than large amounts of raw data from the collection. Therefore the 16MB document size limit should not be an issue.</p></li><li><p><strong>Spread Of Ranges.</strong> In this example, each of the two employed bucketing facets uses a different granularity number scheme for spreading out the sub-ranges of values. You choose a numbering scheme based on what you know about the nature of the facet. For instance, most of the <em>ratings</em> values in the sample collection have scores bunched between late 3s and early 4s. If a numbering scheme is defined to reflect an even spread of ratings, most products will appear in the same sub-range bucket and some sub-ranges would contain no products (e.g. ratings 2 to 3 in this example). This wouldn’t provide website customers with much selectivity on product ratings.</p></li></ul><h3 id="2-最大图网络"><a href="#2-最大图网络" class="headerlink" title="(2)最大图网络"></a>(2)最大图网络</h3><blockquote><p>基于类似于 <em>Twitter</em> 的社交网络数据库，您的组织希望了解新营销活动的最佳目标。</p><p>您想要搜索「社交网络用户」的集合，其中每个用户记录文档都包含一个<strong>用户名</strong>和该用户的<strong>关注者</strong>。</p><p>您将执行一个聚合管道查询，遍历每个用户记录的<code>followed_by</code>数组，从而确定哪个用户具有最大的 <em>network reach</em> ，即最广的<strong>朋友圈</strong>。</p><p>请注意，为简洁起见，此示例仅使用了一个简单的数据模型。然而这不太可能是一个最佳数据模型，例如拥有很多粉丝的社交网络用户对于<code>$graphLookup</code>的大规模使用，抑或是在分片环境中运行。有关此类问题的更多指导，请参阅<a href="https://github.com/mongodb-labs/socialite">Socialite</a>。</p><p>用户集合<code>users</code>包含以下10个社交网络用户文档，可考虑加上一个索引<code>db.users.createIndex(&#123;&quot;name&quot;: 1&#125;)</code>来帮助优化 <strong>图的遍历</strong> 。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Paul&quot;</span>,  <span class="string">&quot;followed_by&quot;</span>: [] &#125;,</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Toni&quot;</span>,  <span class="string">&quot;followed_by&quot;</span>: [<span class="string">&quot;Paul&quot;</span>] &#125;,</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Janet&quot;</span>, <span class="string">&quot;followed_by&quot;</span>: [<span class="string">&quot;Paul&quot;</span>, <span class="string">&quot;Toni&quot;</span>] &#125;,</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;David&quot;</span>, <span class="string">&quot;followed_by&quot;</span>: [<span class="string">&quot;Janet&quot;</span>, <span class="string">&quot;Paul&quot;</span>, <span class="string">&quot;Toni&quot;</span>] &#125;,</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Fiona&quot;</span>, <span class="string">&quot;followed_by&quot;</span>: [<span class="string">&quot;David&quot;</span>, <span class="string">&quot;Paul&quot;</span>] &#125;,</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Bob&quot;</span>,   <span class="string">&quot;followed_by&quot;</span>: [<span class="string">&quot;Janet&quot;</span>] &#125;,</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Carl&quot;</span>,  <span class="string">&quot;followed_by&quot;</span>: [<span class="string">&quot;Fiona&quot;</span>] &#125;,</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Sarah&quot;</span>, <span class="string">&quot;followed_by&quot;</span>: [<span class="string">&quot;Carl&quot;</span>, <span class="string">&quot;Paul&quot;</span>] &#125;,</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Carol&quot;</span>, <span class="string">&quot;followed_by&quot;</span>: [<span class="string">&quot;Helen&quot;</span>, <span class="string">&quot;Sarah&quot;</span>] &#125;,</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Helen&quot;</span>, <span class="string">&quot;followed_by&quot;</span>: [<span class="string">&quot;Paul&quot;</span>] &#125;,</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  <span class="comment">// 对于每个用户，图遍历他们的followed_by数组</span></span><br><span class="line">  &#123;<span class="string">&quot;$graphLookup&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: <span class="string">&quot;users&quot;</span>,</span><br><span class="line">    <span class="string">&quot;startWith&quot;</span>: <span class="string">&quot;$followed_by&quot;</span>,</span><br><span class="line">    <span class="string">&quot;connectFromField&quot;</span>: <span class="string">&quot;followed_by&quot;</span>,</span><br><span class="line">    <span class="string">&quot;connectToField&quot;</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">    <span class="string">&quot;depthField&quot;</span>: <span class="string">&quot;depth&quot;</span>,</span><br><span class="line">    <span class="string">&quot;as&quot;</span>: <span class="string">&quot;extended_network&quot;</span>,</span><br><span class="line">  &#125;&#125;,</span><br><span class="line"></span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;</span><br><span class="line">    <span class="comment">// Count the extended connection reach</span></span><br><span class="line">    <span class="string">&quot;network_reach&quot;</span>: &#123;<span class="string">&quot;$size&quot;</span>: <span class="string">&quot;$extended_network&quot;</span>&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Gather the list of the extended connections&#x27; names</span></span><br><span class="line">    <span class="string">&quot;extended_connections&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;$map&quot;</span>: &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;$extended_network&quot;</span>, <span class="string">&quot;as&quot;</span>: <span class="string">&quot;connection&quot;</span>,<span class="string">&quot;in&quot;</span>: <span class="string">&quot;$$connection.name&quot;</span>&#125;</span><br><span class="line">    &#125;,    </span><br><span class="line">  &#125;&#125;,</span><br><span class="line">    </span><br><span class="line">  &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>, <span class="string">&quot;followed_by&quot;</span>, <span class="string">&quot;extended_network&quot;</span>,]&#125;,   </span><br><span class="line">  &#123;<span class="string">&quot;$sort&quot;</span>: &#123;<span class="string">&quot;network_reach&quot;</span>: -<span class="number">1</span>,&#125;&#125;,   </span><br><span class="line">];</span><br></pre></td></tr></table></figure></p><p>执行聚合操作后应该返回对应原来的10个源社交网络用户的10个文档，每个文档包括用户的 <em>网络到达数<code>network reach count</code></em> 和 <em>扩展连接名称<code>extended connection names</code></em> ，按网络覆盖面最广的用户排序，如下所示。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210929-1最大图网络.png" alt="最大图网络"></p><ul><li><p><strong>Following Graphs.</strong> The <code>$graphLookup</code> stage helps you traverse relationships between records, looking for patterns that aren’t necessarily evident from looking at each record in isolation. In this example, by looking at <em>Paul’s</em> record in isolation, it is evident that <em>Paul</em> has no <em>friends</em> and thus has the lowest network reach. However, it is not obvious that <em>Carol</em> has the greatest network reach just by looking at the number of people <em>Carol</em> is directly followed by, which is two. <em>David</em>, for example, is followed by three people (one more than <em>Carol</em>). However, the executed aggregation pipeline can deduce that <em>Carol</em> has the most extensive network reach.</p></li><li><p><strong>Index Use.</strong> The <code>$graphLookup</code> stage can leverage the index on the field <code>name</code> for each of its <code>connectToField</code> hops.</p></li></ul><h3 id="3-增量分析"><a href="#3-增量分析" class="headerlink" title="(3)增量分析"></a>(3)增量分析</h3><blockquote><p>您有一组累积多年的 <em>商店订单</em> ，零售渠道在每个交易日不断向<code>orders</code>集合添加新订单记录。</p><p>您希望经常生成汇总报告，以便管理层了解业务状态并对不断变化的业务趋势做出反应。多年来，生成所有每日总和和平均值的报告所需的时间越来越长，因为需要处理的数据天数越来越多。</p><p>从现在开始，为了解决这个问题，您将只在一天结束时生成当天的摘要分析，并将其存储在不同的集合中，该集合会随着时间的推移积累每日摘要记录。</p><p>与本文中的大多数示例不同，聚合管道将其输出写入一个集合，而不是将结果以流的形式传输回调用应用程序。</p><p>订单集合<code>orders</code>包含9个文档，分别代表 2021-02-01 的 5 个订单和 2021-02-02 的 4 个订单，如下所示。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-01T08:35:52Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;231.43&quot;</span>),&#125;,</span><br><span class="line">&#123;<span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-01T09:32:07Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;99.99&quot;</span>),&#125;,</span><br><span class="line">&#123;<span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-01T08:25:37Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;63.13&quot;</span>),&#125;,</span><br><span class="line">&#123;<span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-01T19:13:32Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;2.01&quot;</span>),&#125;,  </span><br><span class="line">&#123;<span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-01T22:56:53Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;187.99&quot;</span>),&#125;,</span><br><span class="line">&#123;<span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-02T23:04:48Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;4.59&quot;</span>),&#125;,</span><br><span class="line">&#123;<span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-02T08:55:46Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;48.50&quot;</span>),&#125;,</span><br><span class="line">&#123;<span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-02T07:49:32Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;1024.89&quot;</span>),&#125;,</span><br><span class="line">&#123;<span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-02T13:49:44Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;102.24&quot;</span>),&#125;,</span><br></pre></td></tr></table></figure><p>定义一个函数来创建聚合管道，将「开始日期」和「结束日期」作为函数的参数，以便于在不同的日期多次执行聚合：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getDayAggPipeline</span>(<span class="params">startDay, endDay</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    &#123;<span class="string">&quot;$match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;orderdate&quot;</span>: &#123;<span class="string">&quot;$gte&quot;</span>: <span class="title class_">ISODate</span>(startDay), <span class="string">&quot;$lt&quot;</span>: <span class="title class_">ISODate</span>(endDay)&#125;</span><br><span class="line">    &#125;&#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将当天的所有订单组合成一个汇总记录</span></span><br><span class="line">    &#123;<span class="string">&quot;$group&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;_id&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;date_parts&quot;</span>: &#123;<span class="string">&quot;$first&quot;</span>: &#123;<span class="string">&quot;$dateToParts&quot;</span>: &#123;<span class="string">&quot;date&quot;</span>: <span class="string">&quot;$orderdate&quot;</span>&#125;&#125;&#125;,</span><br><span class="line">      <span class="string">&quot;total_value&quot;</span>: &#123;<span class="string">&quot;$sum&quot;</span>: <span class="string">&quot;$value&quot;</span>&#125;,</span><br><span class="line">      <span class="string">&quot;total_orders&quot;</span>: &#123;<span class="string">&quot;$sum&quot;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">    &#125;&#125;,</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// 从1个订单中获取日期部分（对于UTC而言需要年、月、日）</span></span><br><span class="line">    &#123;<span class="string">&quot;$set&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;day&quot;</span>: &#123;<span class="string">&quot;$dateFromParts&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;year&quot;</span>: <span class="string">&quot;$date_parts.year&quot;</span>, </span><br><span class="line">          <span class="string">&quot;month&quot;</span>: <span class="string">&quot;$date_parts.month&quot;</span>,</span><br><span class="line">          <span class="string">&quot;day&quot;</span>:<span class="string">&quot;$date_parts.day&quot;</span></span><br><span class="line">       &#125;&#125;,</span><br><span class="line">    &#125;&#125;,</span><br><span class="line">        </span><br><span class="line">    &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>, <span class="string">&quot;date_parts&quot;</span>, ]&#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将日期摘要添加到摘要集合中（若已存在则覆盖）</span></span><br><span class="line">    &#123;<span class="string">&quot;$merge&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;into&quot;</span>: <span class="string">&quot;daily_orders_summary&quot;</span>, <span class="string">&quot;on&quot;</span>: <span class="string">&quot;day&quot;</span>,</span><br><span class="line">      <span class="string">&quot;whenMatched&quot;</span>: <span class="string">&quot;replace&quot;</span>, <span class="string">&quot;whenNotMatched&quot;</span>: <span class="string">&quot;insert&quot;</span></span><br><span class="line">    &#125;&#125;,   </span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>仅对于 2021-02-01 的订单，调用上述<code>getDayAggPipeline</code>函数构建聚合管道，执行聚合后将结果写入汇总集合<code>daily_orders_summary</code>，查看汇总集合内容应该只有1条记录【仅生成了 2021-02-01 的单个订单摘要，其中包含当天的总价值和订单数量】。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 【第一天】</span></span><br><span class="line"><span class="keyword">var</span> pipeline = <span class="title function_">getDayAggPipeline</span>(<span class="string">&quot;2021-02-01T00:00:00Z&quot;</span>, <span class="string">&quot;2021-02-02T00:00:00Z&quot;</span>);</span><br><span class="line">db.<span class="property">orders</span>.<span class="title function_">aggregate</span>(pipeline);</span><br><span class="line">db.<span class="property">daily_orders_summary</span>.<span class="title function_">find</span>()</span><br></pre></td></tr></table></figure><p>现在仅在第二天（即仅对于 2021-02-02 的订单），构建管道并执行聚合。从结果中，您可以看到这两天的订单摘要都存在（在第一天的基础上追加了第二天）。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 【第二天】</span></span><br><span class="line"><span class="keyword">var</span> pipeline = <span class="title function_">getDayAggPipeline</span>(<span class="string">&quot;2021-02-02T00:00:00Z&quot;</span>, <span class="string">&quot;2021-02-03T00:00:00Z&quot;</span>);</span><br><span class="line">db.<span class="property">orders</span>.<span class="title function_">aggregate</span>(pipeline);</span><br><span class="line">db.<span class="property">daily_orders_summary</span>.<span class="title function_">find</span>()</span><br></pre></td></tr></table></figure><p>为了模拟组织偶尔需要追溯更正旧订单，回到第一天并添加新的「高价值」订单。然后仅在第一天（2021-02-01）重新运行聚合，以表明您可以安全正确地重新计算 <strong>仅一天</strong> 的摘要：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回顾性地将订单添加到第一天（2021-02-01）以模拟「漏掉一单」</span></span><br><span class="line">db.<span class="property">orders</span>.<span class="title function_">insertOne</span>(</span><br><span class="line">  &#123;<span class="string">&quot;orderdate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-02-01T09:32:07Z&quot;</span>), <span class="string">&quot;value&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;11111.11&quot;</span>)&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 【第一天（新）】重新为第一天构建运行聚合管道，覆盖汇总集合daily_orders_summary中的第一条记录</span></span><br><span class="line"><span class="keyword">var</span> pipeline = <span class="title function_">getDayAggPipeline</span>(<span class="string">&quot;2021-02-01T00:00:00Z&quot;</span>, <span class="string">&quot;2021-02-02T00:00:00Z&quot;</span>);</span><br><span class="line">db.<span class="property">orders</span>.<span class="title function_">aggregate</span>(pipeline);</span><br><span class="line">db.<span class="property">daily_orders_summary</span>.<span class="title function_">find</span>()</span><br></pre></td></tr></table></figure><p>执行上述三个聚合操作后，汇总集合<code>daily_orders_summary</code>如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210929-2增量分析.png" alt="增量分析"></p><p>从结果中，您可以看到仍然存在两个订单摘要，两个交易日各一个，但第一天的总价值和订单数量发生了变化。如下图所示，当需要更正某天的订单摘要时，只要重新为那一天构建运行聚合管道即可修正。</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210818模拟漏单情况.png" alt="模拟漏单情况修正对比"></p><ul><li><p><strong>Merging Results.</strong> The pipeline uses a <code>$merge</code> stage to instruct the aggregation engine to write the output to a collection rather than returning a stream of results. In this example, with the options you provide to <code>$merge</code>, the aggregation inserts a new record in the destination collection if a matching one doesn’t already exist. If a matching record already exists, it replaces the previous version.</p></li><li><p><strong>Incremental Updates.</strong> The example illustrates just two days of shop orders, albeit with only a few orders, to keep the example simple. At the end of each new trading day, you run the aggregation pipeline to generate the current day’s summary only. Even after the source collection has increased in size over many years, the time it takes you to bring the summary collection up to date again stays constant. In a real-world scenario, the business might expose a graphical chart showing the changing daily orders trend over the last rolling year. This charting dashboard is not burdened by the cost of periodically regenerating values for all days in the year. There could be hundreds of thousands of orders received per day for real-world retailers, especially large ones. A day’s summary may take many seconds to generate in that situation. Without an <em>incremental analytics</em> approach, if you need to generate a year’s worth of daily summaries every time, it would take hours to refresh the business dashboard.</p><ul><li><p><strong>Idempotency.</strong> If a retailer is aggregating tens of thousands of orders per day, then during end-of-day processing, it may choose to generate 24 hourly summary records rather than a single daily record.  This provides the business with finer granularity to understand trends better. As with any software process, when generating hourly results into the summary collection, there is the risk of not fully completing if a system failure occurs. If an in-flight aggregation terminates abnormally, it may not have written all 24 summary collection records. The failure leaves the summary collection in an indeterminate and incomplete state for one of its days. However, this isn’t a problem because of the way the aggregation pipeline uses the <code>$merge</code> stage. When an aggregation fails to complete, it can just be re-run. When re-run, it will regenerate all the results for the day, replacing existing summary records and filling in the missing ones. The aggregation pipeline is idempotent, and you can run it repeatedly without damaging the summary collection. The overall solution is self-healing and naturally tolerant of inadvertently aborted aggregation jobs.</p></li><li><p><strong>Retrospective Changes.</strong> Sometimes, an organisation may need to go back and correct records from the past, as illustrated in this example. For instance, a bank may need to fix a past payment record due to a settlement issue that only comes to light weeks later. With the approach used in this example, it is straightforward to re-execute the aggregation pipeline for a prior date, using the updated historical data. This will correctly update the specific day’s summary data only, to reflect the business’s current state.</p></li></ul></li></ul><h2 id="5-数据安全"><a href="#5-数据安全" class="headerlink" title="5.数据安全"></a>5.数据安全</h2><h3 id="1-严格视图"><a href="#1-严格视图" class="headerlink" title="(1)严格视图"></a>(1)严格视图</h3><blockquote><p>您有一个 <code>persons</code> 集合，其中不应允许特定客户端应用程序查看敏感信息。因此，您将仅提供一个筛选后的人员数据子集的只读视图。</p><p>在实际情况中，您还可以使用 MongoDB 的<strong>基于角色的访问控制（Role-Based Access Control，RBAC）</strong>来限制客户端应用程序只能访问视图而不是原始集合。</p><p>您将使用 <code>adults</code> 视图以两种方式限制客户端应用程序的个人数据：</p><ol><li>仅显示 18 岁及以上的人（通过检查每个人的<code>dateofbirth</code>字段）；</li><li>从结果中排除每个人的<code>social_security_num</code>字段。</li></ol><p>本质上，这是对 MongoDB 中实现「记录级（record-level）」访问控制的一个说明。</p><p><code>persons</code>集合包含5条记录，如下所示。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;6392529400&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Elise&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;1972-01-13T09:32:07Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;FEMALE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;elise_smith@myemail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;social_security_num&quot;</span>: <span class="string">&quot;507-28-9805&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123;<span class="string">&quot;number&quot;</span>: <span class="number">5625</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;Tipa Circle&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Wojzinmoj&quot;</span>&#125;,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;1723338115&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Olive&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Ranieri&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;1985-05-12T23:14:30Z&quot;</span>),    </span><br><span class="line">    <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;FEMALE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;oranieri@warmmail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;social_security_num&quot;</span>: <span class="string">&quot;618-71-2912&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123;<span class="string">&quot;number&quot;</span>: <span class="number">9303</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;Mele Circle&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Tobihbo&quot;</span>&#125;,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;8732762874&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Toni&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Jones&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2014-11-23T16:53:56Z&quot;</span>),    </span><br><span class="line">    <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;FEMALE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;tj@wheresmyemail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;social_security_num&quot;</span>: <span class="string">&quot;001-10-3488&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123;<span class="string">&quot;number&quot;</span>: <span class="number">1</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;High Street&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Upper Abbeywoodington&quot;</span>&#125;,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;7363629563&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Bert&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Gooding&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;1941-04-07T22:11:52Z&quot;</span>),    </span><br><span class="line">    <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;MALE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;bgooding@tepidmail.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;social_security_num&quot;</span>: <span class="string">&quot;230-43-7633&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123;<span class="string">&quot;number&quot;</span>: <span class="number">13</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;Upper Bold Road&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Redringtonville&quot;</span>&#125;,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;person_id&quot;</span>: <span class="string">&quot;1029648329&quot;</span>,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Sophie&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Celements&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dateofbirth&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2013-07-06T17:35:45Z&quot;</span>),    </span><br><span class="line">    <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;FEMALE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;sophe@celements.net&quot;</span>,</span><br><span class="line">    <span class="string">&quot;social_security_num&quot;</span>: <span class="string">&quot;377-30-5364&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123;<span class="string">&quot;number&quot;</span>: <span class="number">5</span>, <span class="string">&quot;street&quot;</span>: <span class="string">&quot;Innings Close&quot;</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Basilbridge&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  &#123;<span class="string">&quot;$match&quot;</span>: &#123;<span class="string">&quot;$expr&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;$lt&quot;</span>: [<span class="string">&quot;$dateofbirth&quot;</span>, &#123;<span class="string">&quot;$subtract&quot;</span>: [<span class="string">&quot;$$NOW&quot;</span>, <span class="number">18</span>*<span class="number">365.25</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>]&#125;]</span><br><span class="line">  &#125;&#125;&#125;,</span><br><span class="line">  &#123;<span class="string">&quot;$unset&quot;</span>: [<span class="string">&quot;_id&quot;</span>, <span class="string">&quot;social_security_num&quot;</span>]&#125;,    </span><br><span class="line">];</span><br></pre></td></tr></table></figure></p><p>首先，在创建视图之前执行聚合操作（并观察explain），以测试该定义的聚合管道。然后创建新的<code>adults</code>视图，它会在任何人查询视图时自动应用聚合管道。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">persons</span>.<span class="title function_">aggregate</span>(pipeline);</span><br><span class="line">db.<span class="property">persons</span>.<span class="title function_">explain</span>(<span class="string">&quot;executionStats&quot;</span>).<span class="title function_">aggregate</span>(pipeline);</span><br><span class="line">db.<span class="title function_">createView</span>(<span class="string">&quot;adults&quot;</span>, <span class="string">&quot;persons&quot;</span>, pipeline);</span><br></pre></td></tr></table></figure><p>对创建的视图执行常规 MQL 查询，没有任何过滤条件，并观察其explain；或者创建的视图执行 MQL 查询，指定过滤器为仅返回女性成年人，观察explain注意性别过滤器<code>gender</code>是如何影响它的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 常规MQL查询</span></span><br><span class="line">db.<span class="property">adults</span>.<span class="title function_">find</span>();</span><br><span class="line">db.<span class="property">adults</span>.<span class="title function_">explain</span>(<span class="string">&quot;executionStats&quot;</span>).<span class="title function_">find</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带性别过滤器的MQL查询</span></span><br><span class="line">db.<span class="property">adults</span>.<span class="title function_">find</span>(&#123;<span class="string">&quot;gender&quot;</span>: <span class="string">&quot;FEMALE&quot;</span>&#125;);</span><br><span class="line">db.<span class="property">adults</span>.<span class="title function_">explain</span>(<span class="string">&quot;executionStats&quot;</span>).<span class="title function_">find</span>(&#123;<span class="string">&quot;gender&quot;</span>: <span class="string">&quot;FEMALE&quot;</span>&#125;);</span><br></pre></td></tr></table></figure><p>对于<code>aggregate()</code>和<code>find()</code>命令在 <em>视图</em> 上执行的结果应该是一样的，都返回3个文档，表示超过18岁的3个人，但是没有显示他们实际的出生日期，如图所示：</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210929-3严格视图1.png" alt="严格视图之常规MQL查询和聚合查询"></p><p>带有<code>&quot;gender&quot;: &quot;FEMALE&quot;</code>过滤器的<code>find()</code>命令在 <em>视图</em> 上运行的结果应该仅有2条 <strong>女性</strong> 记录，因为男性记录已被排除，如下所示：</p><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210929-3严格视图2.png" alt="严格视图之带过滤器的MQL查询"></p><ul><li><p><strong>Expr &amp; Indexes.</strong> The <a href="https://docs.mongodb.com/manual/reference/aggregation-variables/">“NOW” system variable</a> used here returns the current system date-time. However, you can only access this system variable via an <a href="https://docs.mongodb.com/manual/meta/aggregation-quick-reference/#expressions">aggregation expression</a> and not directly via the regular MongoDB query syntax used by MQL and <code>$match</code>. You must wrap an expression using <code>$$NOW</code> inside an <code>$expr</code> operator. As described in the section <em><a href="../../guides/expressions.md#expression-restrictions">Restrictions When Using Expressions</a></em> in an earlier chapter, if you use an <a href="https://docs.mongodb.com/manual/reference/operator/query/expr/">$expr query operator</a> to perform a range comparison, you can’t make use of an index in versions of MongoDB earlier then 5.0. Therefore, in this example, unless you use MongoDB 5.0, the aggregation will not take advantage of an index on <code>dateofbirth</code>. For a view, because you specify the pipeline earlier than it is ever run, you cannot obtain the current date-time at runtime by other means.</p></li><li><p><strong>View Finds &amp; Indexes.</strong> Even for versions of MongoDB before 5.0, the explain plan for the <em>gender query</em> run against the view shows an index has been used (the index defined for the <code>gender</code> field). At runtime, a view is essentially just an aggregation pipeline defined “ahead of time”. When <code>db.adults.find(&#123;&quot;gender&quot;: &quot;FEMALE&quot;&#125;)</code> is executed, the database engine dynamically appends a new <code>$match</code> stage to the end of the pipeline for the gender match. It then optimises the pipeline by moving the new <code>$match</code> stage to the pipeline’s start. Finally, it adds the filter extracted from the new <code>$match</code> stage to the aggregation’s initial query, and hence it can then leverage an index containing the <code>gender</code> field. The following two excerpts, from an explain plan from a MongoDB version before 5.0, illustrate how the filter on <code>gender</code> and the filter on <code>dateofbirth</code> combine at runtime and how the index for <code>gender</code> is used to avoid a full collection scan:</p> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;$cursor&#x27;</span>: &#123;</span><br><span class="line">  <span class="attr">queryPlanner</span>: &#123;</span><br><span class="line">    <span class="attr">plannerVersion</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">namespace</span>: <span class="string">&#x27;book-restricted-view.persons&#x27;</span>,</span><br><span class="line">    <span class="attr">indexFilterSet</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">parsedQuery</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;$and&#x27;</span>: [</span><br><span class="line">        &#123; <span class="attr">gender</span>: &#123; <span class="string">&#x27;$eq&#x27;</span>: <span class="string">&#x27;FEMALE&#x27;</span> &#125; &#125;,</span><br><span class="line">        &#123; <span class="string">&#x27;$expr&#x27;</span>: &#123; <span class="string">&#x27;$lt&#x27;</span>: [ <span class="string">&#x27;$dateofbirth&#x27;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">             <span class="string">&#x27;$subtract&#x27;</span>: [ <span class="string">&#x27;$$NOW&#x27;</span>, &#123; <span class="string">&#x27;$const&#x27;</span>: <span class="number">568036800000</span> &#125; ]</span><br><span class="line">             ...</span><br></pre></td></tr></table></figure> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inputStage</span>: &#123;</span><br><span class="line">  <span class="attr">stage</span>: <span class="string">&#x27;IXSCAN&#x27;</span>,</span><br><span class="line">  <span class="attr">keyPattern</span>: &#123; <span class="attr">gender</span>: <span class="number">1</span> &#125;,</span><br><span class="line">  <span class="attr">indexName</span>: <span class="string">&#x27;gender_1&#x27;</span>,</span><br><span class="line">  <span class="attr">direction</span>: <span class="string">&#x27;forward&#x27;</span>,</span><br><span class="line">  <span class="attr">indexBounds</span>: &#123; <span class="attr">gender</span>: [ <span class="string">&#x27;[&quot;FEMALE&quot;, &quot;FEMALE&quot;]&#x27;</span> ] &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> In MongoDB 5.0, the explain plan will show the aggregation runtime executing the pipeline more optimally by entirely using the compound index based on both the fields <code>gender</code> and <code>dateofbirth</code>.</p></li><li><p><strong>Further Reading.</strong> The ability for <em>find</em> operations on a view to automatically push filters into the view’s aggregation pipeline, and then be further optimised, is described in the blog post: <a href="https://pauldone.blogspot.com/2020/11/mongdb-views-optimisations.html">Is Querying A MongoDB View Optimised?</a></p></li></ul><h3 id="2-隐藏敏感字段"><a href="#2-隐藏敏感字段" class="headerlink" title="(2)隐藏敏感字段"></a>(2)隐藏敏感字段</h3><p>由于使用<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/rand/">$rand</a>运算符，要求MongoDB版本最低为 4.4。</p><blockquote><p>您想对 <em>信用卡付款</em> 集合的敏感字段执行不可逆屏蔽，准备将输出数据集提供给第 3 方进行分析，而不会将敏感信息暴露给第 3 方。</p><p>您需要对付款字段进行的具体更改是：</p><ul><li>部分混淆持卡人姓名；</li><li>混淆卡号的前 12 位数字，只保留最后 4 位数字；</li><li>通过添加或减去最多 30 天（约 1 个月）的随机金额来调整卡的到期时间；</li><li>用一组随机的 3 位数字替换卡的 3 位安全码；</li><li>通过添加或减去最多为原始金额 10% 的随机金额来调整交易金额；</li><li>将大约 20% 的记录中<code>reported</code>字段的布尔值更改为相反值；</li><li>如果嵌套子文档<code>customer_info</code>的<code>category</code>字段为 <em><code>RESTRICTED</code></em> ，则排除整个子文档<code>customer_info</code>。</li></ul><p><code>payments</code>集合包含2条信用卡付款记录的文档，其中包含敏感数据，如下所示。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;card_name&quot;</span>: <span class="string">&quot;Mrs. Jane A. Doe&quot;</span>,</span><br><span class="line">    <span class="string">&quot;card_num&quot;</span>: <span class="string">&quot;1234567890123456&quot;</span>,</span><br><span class="line">    <span class="string">&quot;card_expiry&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2023-08-31T23:59:59Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;card_sec_code&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">    <span class="string">&quot;card_type&quot;</span>: <span class="string">&quot;CREDIT&quot;</span>,        </span><br><span class="line">    <span class="string">&quot;transaction_id&quot;</span>: <span class="string">&quot;eb1bd77836e8713656d9bf2debba8900&quot;</span>,</span><br><span class="line">    <span class="string">&quot;transaction_date&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-01-13T09:32:07Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;transaction_amount&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;501.98&quot;</span>),</span><br><span class="line">    <span class="string">&quot;reported&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;customer_info&quot;</span>: &#123;<span class="string">&quot;category&quot;</span>: <span class="string">&quot;RESTRICTED&quot;</span>, <span class="string">&quot;rating&quot;</span>: <span class="number">89</span>, <span class="string">&quot;risk&quot;</span>: <span class="number">3</span>,&#125;,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;card_name&quot;</span>: <span class="string">&quot;Jim Smith&quot;</span>,</span><br><span class="line">    <span class="string">&quot;card_num&quot;</span>: <span class="string">&quot;9876543210987654&quot;</span>,</span><br><span class="line">    <span class="string">&quot;card_expiry&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2022-12-31T23:59:59Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;card_sec_code&quot;</span>: <span class="string">&quot;987&quot;</span>,</span><br><span class="line">    <span class="string">&quot;card_type&quot;</span>: <span class="string">&quot;DEBIT&quot;</span>,        </span><br><span class="line">    <span class="string">&quot;transaction_id&quot;</span>: <span class="string">&quot;634c416a6fbcf060bb0ba90c4ad94f60&quot;</span>,</span><br><span class="line">    <span class="string">&quot;transaction_date&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2020-11-24T19:25:57Z&quot;</span>),</span><br><span class="line">    <span class="string">&quot;transaction_amount&quot;</span>: <span class="title class_">NumberDecimal</span>(<span class="string">&quot;64.01&quot;</span>),</span><br><span class="line">    <span class="string">&quot;reported&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;customer_info&quot;</span>: &#123;<span class="string">&quot;category&quot;</span>: <span class="string">&quot;NORMAL&quot;</span>, <span class="string">&quot;rating&quot;</span>: <span class="number">78</span>, <span class="string">&quot;risk&quot;</span>: <span class="number">55</span>,&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>聚合管道定义如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipeline = [</span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;card_name&quot;</span>: &#123;<span class="string">&quot;$regexFind&quot;</span>: &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;$card_name&quot;</span>, <span class="string">&quot;regex&quot;</span>: <span class="regexp">/(\S+)$/</span>&#125;&#125;,</span><br><span class="line">    <span class="string">&quot;card_num&quot;</span>: &#123;<span class="string">&quot;$concat&quot;</span>: [<span class="string">&quot;XXXXXXXXXXXX&quot;</span>, &#123;<span class="string">&quot;$substrCP&quot;</span>: [<span class="string">&quot;$card_num&quot;</span>, <span class="number">12</span>, <span class="number">4</span>]&#125;,]&#125;,</span><br><span class="line">    <span class="string">&quot;card_expiry&quot;</span>: &#123;<span class="string">&quot;$add&quot;</span>: [<span class="string">&quot;$card_expiry&quot;</span>, &#123;<span class="string">&quot;$floor&quot;</span>: &#123;<span class="string">&quot;$multiply&quot;</span>: [&#123;<span class="string">&quot;$subtract&quot;</span>: [&#123;<span class="string">&quot;$rand&quot;</span>: &#123;&#125;&#125;, <span class="number">0.5</span>]&#125;, <span class="number">2</span>*<span class="number">30</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>]&#125;&#125;,]&#125;,</span><br><span class="line">    <span class="string">&quot;card_sec_code&quot;</span>: &#123;<span class="string">&quot;$concat&quot;</span>: [</span><br><span class="line">                       &#123;<span class="string">&quot;$toString&quot;</span>: &#123;<span class="string">&quot;$floor&quot;</span>: &#123;<span class="string">&quot;$multiply&quot;</span>: [&#123;<span class="string">&quot;$rand&quot;</span>: &#123;&#125;&#125;, <span class="number">10</span>]&#125;&#125;&#125;,</span><br><span class="line">                       &#123;<span class="string">&quot;$toString&quot;</span>: &#123;<span class="string">&quot;$floor&quot;</span>: &#123;<span class="string">&quot;$multiply&quot;</span>: [&#123;<span class="string">&quot;$rand&quot;</span>: &#123;&#125;&#125;, <span class="number">10</span>]&#125;&#125;&#125;,</span><br><span class="line">                       &#123;<span class="string">&quot;$toString&quot;</span>: &#123;<span class="string">&quot;$floor&quot;</span>: &#123;<span class="string">&quot;$multiply&quot;</span>: [&#123;<span class="string">&quot;$rand&quot;</span>: &#123;&#125;&#125;, <span class="number">10</span>]&#125;&#125;&#125;,</span><br><span class="line">                     ]&#125;,</span><br><span class="line">    <span class="string">&quot;transaction_amount&quot;</span>: &#123;<span class="string">&quot;$add&quot;</span>: [<span class="string">&quot;$transaction_amount&quot;</span>, &#123;<span class="string">&quot;$multiply&quot;</span>: [&#123;<span class="string">&quot;$subtract&quot;</span>: [&#123;<span class="string">&quot;$rand&quot;</span>: &#123;&#125;&#125;, <span class="number">0.5</span>]&#125;, <span class="number">0.2</span>, <span class="string">&quot;$transaction_amount&quot;</span>]&#125;,]&#125;,</span><br><span class="line">    <span class="string">&quot;reported&quot;</span>: &#123;<span class="string">&quot;$cond&quot;</span>: &#123;</span><br><span class="line">                   <span class="string">&quot;if&quot;</span>:   &#123;<span class="string">&quot;$lte&quot;</span>: [&#123;<span class="string">&quot;$rand&quot;</span>: &#123;&#125;&#125;, <span class="number">0.8</span>]&#125;,</span><br><span class="line">                   <span class="string">&quot;then&quot;</span>: <span class="string">&quot;$reported&quot;</span>,</span><br><span class="line">                   <span class="string">&quot;else&quot;</span>: &#123;<span class="string">&quot;$not&quot;</span>: [<span class="string">&quot;$reported&quot;</span>]&#125;,</span><br><span class="line">                &#125;&#125;,      </span><br><span class="line">    <span class="string">&quot;customer_info&quot;</span>: &#123;<span class="string">&quot;$cond&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;if&quot;</span>:   &#123;<span class="string">&quot;$eq&quot;</span>: [<span class="string">&quot;$customer_info.category&quot;</span>, <span class="string">&quot;RESTRICTED&quot;</span>]&#125;, </span><br><span class="line">                        <span class="string">&quot;then&quot;</span>: <span class="string">&quot;$$REMOVE&quot;</span>,     </span><br><span class="line">                        <span class="string">&quot;else&quot;</span>: <span class="string">&quot;$customer_info&quot;</span>,</span><br><span class="line">                     &#125;&#125;,                                         </span><br><span class="line">    <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;$$REMOVE&quot;</span>,                </span><br><span class="line">  &#125;&#125;,</span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;<span class="string">&quot;card_name&quot;</span>: &#123;<span class="string">&quot;$concat&quot;</span>: [<span class="string">&quot;Mx. Xxx &quot;</span>, &#123;<span class="string">&quot;$ifNull&quot;</span>: [<span class="string">&quot;$card_name.match&quot;</span>, <span class="string">&quot;Anonymous&quot;</span>]&#125;]&#125;,&#125;&#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>执行聚合操作后应该返回与源文档对应的2个文档，但它们的许多字段都被编辑和混淆了，并且标记为<code>RESTRICTED</code>的<code>customer_info</code>字段被省略了，如下所示。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210929-4隐藏敏感字段.png" alt="隐藏敏感字段"></p><ul><li><p><strong>Targeted Redaction.</strong> The pipeline uses a <code>$cond</code> operator to return the <code>$$REMOVE</code> marker variable if the <code>category</code> field is equal to <code>RESTRICTED</code>. This informs the aggregation engine to exclude the whole <code>customer_info</code> sub-document from the stage’s output for the record. Alternatively, the pipeline could have used a <code>$redact</code> stage to achieve the same. However, <code>$redact</code> typically has to perform more processing work due to needing to check every field in the document. Hence, if a pipeline is only to redact out one specific sub-document, use the approach outlined in this example.</p></li><li><p><strong>Regular Expression.</strong> For masking the <code>card_name</code> field, a regular expression operator is used to extract the last word of the field’s original value. <code>$regexFind</code> returns metadata into the stage’s output records, indicating if the match succeeded and what the matched value is. Therefore, an additional <code>$set</code> stage is required later in the pipeline to extract the actual matched word from this metadata and prefix it with some hard-coded text.</p></li><li><p><strong>Meaningful Insight.</strong> Even though the pipeline is irreversibly obfuscating fields, it doesn’t mean that the masked data is useless for performing analytics to gain insight. The pipeline masks some fields by fluctuating the original values by a small but limited random percentage (e.g. <code>card_expiry</code>, <code>transaction_amount</code>), rather than replacing them with completely random values (e.g. <code>card_sec_code</code>). In such cases, if the input data set is sufficiently large, then minor variances will be equalled out. For the fields that are only varied slightly, users can derive similar trends and patterns from analysing the masked data as they would the original data.</p></li><li><p><strong>Further Reading.</strong> This example is based on the output of two blog posts: 1) <a href="https://pauldone.blogspot.com/2021/02/mongdb-data-masking.html">MongoDB Irreversible Data Masking</a>, and 2) <a href="https://pauldone.blogspot.com/2021/02/mongdb-reversible-data-masking.html">MongoDB Reversible Data Masking</a>.</p></li></ul><h2 id="6-时间序列"><a href="#6-时间序列" class="headerlink" title="6.时间序列"></a>6.时间序列</h2><h3 id="1-IOT电力消耗"><a href="#1-IOT电力消耗" class="headerlink" title="(1)IOT电力消耗"></a>(1)IOT电力消耗</h3><p>由于使用<a href="https://docs.mongodb.com/manual/core/timeseries-collections/">时间序列集合</a>、<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/setWindowFields/">$setWindowFields</a>阶段和<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/integral/">$integral</a>运算符，要求MongoDB版本最低为 5.0。</p><blockquote><p>您正在监控工业园区两栋建筑中运行的各种空调机组。每 30 分钟，每个机组中的一个设备将该机组当前的功耗读数发送回基地，中央数据库将保留该读数。</p><p>您想分析此数据，以查看每个空调机组在过去一小时内针对收到的每个读数所消耗的能量（以千瓦时 (kWh) 为单位）。此外，您还想计算每个建筑物中所有空调机组每小时消耗的总能量。</p><p>首先创建一个<code>device_readings</code>集合，包含了两栋不同建筑物一天内的3个小时之间的设备读数，使用「时间序列集合」进行优化处理：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="title function_">createCollection</span>(<span class="string">&quot;device_readings&quot;</span>,</span><br><span class="line">    &#123;<span class="string">&quot;timeseries&quot;</span>: &#123;<span class="string">&quot;timeField&quot;</span>: <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;metaField&quot;</span>: <span class="string">&quot;deviceID&quot;</span>, <span class="string">&quot;granularity&quot;</span>: <span class="string">&quot;minutes&quot;</span>&#125;&#125;</span><br><span class="line">  );</span><br></pre></td></tr></table></figure><br>注意，这个命令可以被注释掉，完整的例子仍然有效。<code>device_readings</code>集合的18条数据如下，分别为<code>ABC</code>和<code>XYZ</code>两栋建筑物的<code>111</code>、<code>222</code>和<code>666</code>三台设备在<code>11:29am</code>、<code>11:59am</code>、<code>12:29pm</code>、<code>12:59pm</code>、<code>13:29pm</code>、<code>13:59pm</code>的三个小时6个时段的电表读数。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-111&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T11:29:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">8</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-222&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T11:29:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">7</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-XYZ&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-666&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T11:29:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">10</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-222&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T11:59:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">9</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-111&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T11:59:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">8</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-XYZ&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-666&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T11:59:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">11</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-222&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T12:29:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">9</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-111&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T12:29:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">9</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-XYZ&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-666&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T12:29:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">10</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-222&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T12:59:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">8</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-111&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T12:59:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">8</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-XYZ&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-666&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T12:59:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">11</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-222&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T13:29:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">9</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-111&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T13:29:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">9</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-XYZ&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-666&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T13:29:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">10</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-222&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T13:59:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">8</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-ABC&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-111&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T13:59:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">8</span>,     </span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;Building-XYZ&quot;</span>, <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;UltraAirCon-666&quot;</span>,    </span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2021-07-03T13:59:59Z&quot;</span>), <span class="string">&quot;powerKilowatts&quot;</span>: <span class="number">11</span>,     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了计算空调机组在过去一小时内针对收到的每个读数所消耗的能量，定义一个「原始读数」的聚合管道如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipelineRawReadings = [</span><br><span class="line">  &#123;<span class="string">&quot;$setWindowFields&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;partitionBy&quot;</span>: <span class="string">&quot;$deviceID&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sortBy&quot;</span>: &#123;<span class="string">&quot;timestamp&quot;</span>: <span class="number">1</span>&#125;,    </span><br><span class="line">    <span class="string">&quot;output&quot;</span>: &#123;<span class="string">&quot;consumedKilowattHours&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;$integral&quot;</span>: &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;$powerKilowatts&quot;</span>, <span class="string">&quot;unit&quot;</span>: <span class="string">&quot;hour&quot;</span>,&#125;,</span><br><span class="line">        <span class="string">&quot;window&quot;</span>: &#123;<span class="string">&quot;range&quot;</span>: [-<span class="number">1</span>, <span class="string">&quot;current&quot;</span>],<span class="string">&quot;unit&quot;</span>: <span class="string">&quot;hour&quot;</span>,&#125;,</span><br><span class="line">      &#125;&#125;,</span><br><span class="line">  &#125;&#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>为了计算每个建筑物中所有空调机组每小时消耗的总能量，定义一个「建筑物概要」的聚合管道如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pipelineBuildingsSummary = [</span><br><span class="line">  &#123;<span class="string">&quot;$setWindowFields&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;partitionBy&quot;</span>: <span class="string">&quot;$deviceID&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sortBy&quot;</span>: &#123;<span class="string">&quot;timestamp&quot;</span>: <span class="number">1</span>&#125;,    </span><br><span class="line">    <span class="string">&quot;output&quot;</span>: &#123;<span class="string">&quot;consumedKilowattHours&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;$integral&quot;</span>: &#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;$powerKilowatts&quot;</span>, <span class="string">&quot;unit&quot;</span>: <span class="string">&quot;hour&quot;</span>,&#125;,</span><br><span class="line">        <span class="string">&quot;window&quot;</span>: &#123;<span class="string">&quot;range&quot;</span>: [-<span class="number">1</span>, <span class="string">&quot;current&quot;</span>], <span class="string">&quot;unit&quot;</span>: <span class="string">&quot;hour&quot;</span>,&#125;,</span><br><span class="line">      &#125;&#125;,</span><br><span class="line">  &#125;&#125;,</span><br><span class="line">  &#123;<span class="string">&quot;$sort&quot;</span>: &#123;<span class="string">&quot;deviceID&quot;</span>: <span class="number">1</span>, <span class="string">&quot;timestamp&quot;</span>: <span class="number">1</span>&#125;&#125;,    </span><br><span class="line">  &#123;<span class="string">&quot;$group&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_id&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;deviceID&quot;</span>: <span class="string">&quot;$deviceID&quot;</span>,</span><br><span class="line">      <span class="string">&quot;date&quot;</span>: &#123;<span class="string">&quot;$dateTrunc&quot;</span>: &#123;<span class="string">&quot;date&quot;</span>: <span class="string">&quot;$timestamp&quot;</span>,<span class="string">&quot;unit&quot;</span>: <span class="string">&quot;hour&quot;</span>&#125;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    <span class="string">&quot;buildingID&quot;</span>: &#123;<span class="string">&quot;$last&quot;</span>: <span class="string">&quot;$buildingID&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;consumedKilowattHours&quot;</span>: &#123;<span class="string">&quot;$last&quot;</span>: <span class="string">&quot;$consumedKilowattHours&quot;</span>&#125;,</span><br><span class="line">  &#125;&#125;,    </span><br><span class="line">  &#123;<span class="string">&quot;$group&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_id&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;$buildingID&quot;</span>,</span><br><span class="line">      <span class="string">&quot;dayHour&quot;</span>: &#123;<span class="string">&quot;$dateToString&quot;</span>: &#123;<span class="string">&quot;format&quot;</span>: <span class="string">&quot;%Y-%m-%d  %H&quot;</span>, <span class="string">&quot;date&quot;</span>: <span class="string">&quot;$_id.date&quot;</span>&#125;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    <span class="string">&quot;consumedKilowattHours&quot;</span>: &#123;<span class="string">&quot;$sum&quot;</span>: <span class="string">&quot;$consumedKilowattHours&quot;</span>&#125;,</span><br><span class="line">  &#125;&#125;,    </span><br><span class="line">  &#123;<span class="string">&quot;$sort&quot;</span>: &#123;<span class="string">&quot;_id.buildingID&quot;</span>: <span class="number">1</span>, <span class="string">&quot;_id.dayHour&quot;</span>: <span class="number">1</span>&#125;&#125;,    </span><br><span class="line">  &#123;<span class="string">&quot;$set&quot;</span>: &#123;<span class="string">&quot;buildingID&quot;</span>: <span class="string">&quot;$_id.buildingID&quot;</span>, <span class="string">&quot;dayHour&quot;</span>: <span class="string">&quot;$_id.dayHour&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;$$REMOVE&quot;</span>&#125;&#125;,      </span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>执行「原始读数」的聚合管道<code>pipelineRawReadings</code>，来计算空调机组在过去一小时内针对收到的每个读数所消耗的能量，返回的结果如下所示（简洁起见，省略<code>_id</code>字段）：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210929-5IOT电力消耗1.png" alt="IOT电力消耗之原始数据聚合"></p><p>执行「建筑物概要」的聚合管道<code>pipelineBuildingsSummary</code>，来计算每个建筑物中所有空调机组每小时消耗的总能量，返回的结果如下所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210929-5IOT电力消耗2.png" alt="IOT电力消耗之建筑物概要聚合"></p><ul><li><p><strong>Integral Trapezoidal Rule.</strong> As <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/integral/">documented in the MongoDB Manual</a>, <code>$integral</code> <em>“returns an approximation for the mathematical integral value, which is calculated using the trapezoidal rule”</em>. For non-mathematicians, this explanation may be hard to understand. You may find it easier to comprehend the behaviour of the <code>$integral</code> operator by studying the illustration below and the explanation that follows:</p><p>  <img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/MongoDB/20210822梯形法则示例.png" alt="使用梯形法则通过近似积分计算功耗的示例"></p><p>  Essentially the <a href="https://en.wikipedia.org/wiki/Trapezoidal_rule">trapezoidal rule</a> determines the area of a region between two points under a graph by matching the region with a trapezoid shape that approximately fits this region and then calculating the area of this trapezoid. You can see a set of points on the illustrated graph with the matched trapezoid shape underneath each pair of points. For this IOT Power Consumption example, the points on the graph represent an air-conditioning unit’s power readings captured every 30 minutes. The Y-axis is the <em>power rate</em> in Kilowatts, and the X-axis is <em>time</em> to indicate when the device captured each reading. Consequently, for this example, the energy consumed by the air-conditioning unit for a given hour’s span is the area of the hour’s specific section under the graph. This section’s area is approximately the area of the two trapezoids shown. Using the <code>$integral</code> operator for the window of time you define in the <code>$setWindowFields</code> stage, you are asking for this approximate area to be calculated, which is the Kilowatt-hours consumed by the air-conditioning unit in one hour.</p></li><li><p><strong>Window Range Definition.</strong> For every captured document representing a device reading, this example’s pipeline identifies a window of <em>1-hour</em> of previous documents relative to this <em>current</em> document. The pipeline uses this set of documents as the input for the <code>$integral</code> operator. It defines this window range in the setting <code>range: [-1, &quot;current&quot;], unit: &quot;hour&quot;</code>. The pipeline assigns the output of the <code>$integral</code> calculation to a new field called <code>consumedKilowattHours</code>.</p></li><li><p><strong>One Hour Range Vs Hours Output.</strong> The fact that the <code>$setWindowFields</code> stage in the pipeline defines <code>unit: &quot;hour&quot;</code> in two places may appear redundant at face value. However, this is not the case, and each serves a different purpose. As described in the previous observation, <code>unit: &quot;hour&quot;</code> for the <code>&quot;window&quot;</code> option helps dictate the size of the window of the previous number of documents to analyse. However, <code>unit: &quot;hour&quot;</code> for the <code>$integral</code> operator defines that the output should be in hours (“Kilowatt-hours” in this example), yielding the result <code>consumedKilowattHours: 8.5</code> for one of the processed device readings. However, if the pipeline defined this <code>$integral</code> parameter to be <code>&quot;unit&quot;: &quot;minute&quot;</code> instead, which is perfectly valid, the output value would be <code>510</code> Kilowatt-minutes (i.e. 8.5 x 60 minutes).</p></li><li><p><strong>Optional Time Series Collection.</strong> This example uses a <a href="https://docs.mongodb.com/manual/core/timeseries-collections/">time series collection</a> to store sequences of device measurements over time efficiently. Employing a time series collection is optional, as shown in the <code>NOTE</code> Javascript comment in the example code. The aggregation pipeline does not need to be changed and achieves the same output if you use a regular collection instead. However, when dealing with large data sets, the aggregation will complete quicker by employing a time series collection.</p></li><li><p><strong>Index for Partition By &amp; Sort By.</strong> In this example, you define the index <code>&#123;deviceID: 1, timestamp: 1&#125;</code> to optimise the use of the combination of the <code>partitionBy</code> and <code>sortBy</code> parameters in the <code>$setWindowFields</code> stage. This means that the aggregation runtime does not have to perform a slow in-memory sort based on these two fields, and it also avoids the pipeline stage memory limit of 100 MB. It is beneficial to use this index regardless of whether you employ a regular collection or adopt a time series collection.</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;font size=5&gt;&lt;b&gt;文章说明&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;strong&gt;文章作者：&lt;/strong&gt;&lt;a href=&quot;https://hwame.top&quot;&gt;鴻塵&lt;/a&gt;&lt;br&gt;&lt;strong&gt;文章链接：&lt;/strong&gt;&lt;a href</summary>
      
    
    
    
    <category term="MongoDB" scheme="https://hwame.top/categories/MongoDB/"/>
    
    
    <category term="MongoDB" scheme="https://hwame.top/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>MongoDB聚合操作</title>
    <link href="https://hwame.top/20210806/mongodb-aggregation-operation.html"/>
    <id>https://hwame.top/20210806/mongodb-aggregation-operation.html</id>
    <published>2021-08-06T13:37:49.000Z</published>
    <updated>2021-08-10T16:15:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：7.26~8.6参加了为期12天的培训，MongoDB最重要的聚合也迟迟未能更新。<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章链接：</strong><a href="https://hwame.top/20210806/mongodb-aggregation-operation.html">https://hwame.top/20210806/mongodb-aggregation-operation.html</a><br><strong>参考资料：</strong></p><ul><li><a href="https://docs.mongodb.com/manual/aggregation/">Aggregation: Version 5.0 latest</a></li><li><a href="https://www.practical-mongodb-aggregations.com/">Practical MongoDB Aggregations</a>（by Paul Done）</li></ul></blockquote><h2 id="聚合操作"><a href="#聚合操作" class="headerlink" title="聚合操作"></a>聚合操作</h2><p>MongDDB中集合操作（aggregation）处理数据记录并返回计算结果，聚合操作将来自多个文档的值结合在一起，并且可以对分组数据执行各种操作以返回单个结果。</p><p>MongoDB提供了三种执行聚合操作的方法：<strong>聚合管道</strong>【最常用】、<strong>map-reduce函数</strong> 和 <strong>单一用途聚合方法</strong>。</p><blockquote><p>聚合操作方法：<code>db.collection.aggregate(pipeline=&lt;arr&gt;, options=[doc])</code>。</p><p><code>pipeline</code>，一系列数据聚合「<strong>操作</strong>operation」或「<strong>阶段</strong>stage」，详见<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">聚合管道运算符</a>。</p><blockquote><p>我的理解是，<code>pipeline</code>是由「<strong>阶段stage</strong>（将operation也称stage更易于理解）」组成的数组，官方文档描述不贴切 / 或者说翻译字面意思过于近似，而且官方文档都在<code>https://docs.mongodb.com/manual/reference/operator/aggregation/*</code>同一路由下，没有区分「aggregation-stage」和「aggregation-operator」。</p><p><code>A sequence of data aggregation oparotions or stages.</code>理解为stage，operation和operator的区别可以意会。</p></blockquote><p>在禁用<code>options</code>参数时，可以将「管道阶段」作为单独的参数而不是数组中的元素。</p></blockquote><p>通常「聚合管道」包括了「聚合管道 <strong>阶段<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">stage</a></strong>」 和「聚合管道 <strong>操作符<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/">operator</a></strong>」。</p><ul><li>管道阶段<a href="https://docs.mongodb.com/manual/aggregation/#aggregation-pipeline">https://docs.mongodb.com/manual/aggregation/#aggregation-pipeline</a>：<ul><li>最基本的 <strong><em>管道阶段</em></strong> 提供「<strong>过滤器</strong>（与查询类似）」和「<strong>文档转换</strong>（修改输出形式）」。</li><li>其他 <strong><em>管道操作</em></strong> 提供工具，用于①按字段对文档进行分组和排序，②聚合数组内容或文档数组。</li><li>此外， <strong><em>管道阶段</em></strong> 可以使用「运算符（操作符）operator」执行诸如计算平均值或连接字符串之类的任务。</li></ul></li><li>管道操作符。</li></ul><p><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/#accumulators---group-">Accumulators used in GROUP stage</a></p><p><a href="https://developer.aliyun.com/ask/85525">aggregate例子$group当中的{$sum: 1}</a>，按照<code>$group</code>的条件，满足一条就加1。如下例，也就是<code>count</code>是<code>$group</code>中，每种<code>zipcode</code>的数量：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.restaurants.aggregate(</span><br><span class="line">[</span><br><span class="line">    &#123;<span class="variable">$match</span>: &#123;<span class="string">&quot;borough&quot;</span>: <span class="string">&quot;Queens&quot;</span>, <span class="string">&quot;cuisine&quot;</span>: <span class="string">&quot;Brazilian&quot;</span>&#125;&#125;</span><br><span class="line">    &#123;<span class="variable">$group</span>: &#123;<span class="string">&quot;_id&quot;</span>: <span class="string">&quot;<span class="variable">$address</span>.zipcode&quot;</span>, <span class="string">&quot;count&quot;</span>: &#123;<span class="variable">$sum</span>: 1&#125;&#125;&#125;</span><br><span class="line">]</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p><code>&#123;$sum: 1&#125;</code>等价于<code>&#123;$count: &#123;&#125;&#125;</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> cust_id,</span><br><span class="line">             ord_date</span><br><span class="line">      <span class="keyword">FROM</span> orders</span><br><span class="line">      <span class="keyword">GROUP</span> <span class="keyword">BY</span> cust_id,</span><br><span class="line">               ord_date)</span><br><span class="line">      <span class="keyword">as</span> DerivedTable</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：7.26~8.6参加了为期12天的培训，MongoDB最重要的聚合也迟迟未能更新。</summary>
    
    
    
    <category term="MongoDB" scheme="https://hwame.top/categories/MongoDB/"/>
    
    
    <category term="MongoDB" scheme="https://hwame.top/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>MongoDB增删改查</title>
    <link href="https://hwame.top/20210716/mongodb-crud-operations.html"/>
    <id>https://hwame.top/20210716/mongodb-crud-operations.html</id>
    <published>2021-07-16T00:37:42.000Z</published>
    <updated>2021-07-24T18:02:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：MongoDB学习过程中对CRUD用法的记录，毕竟好记性不如烂笔头。<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong>鴻塵<br><strong>文章链接：</strong><a href="https://hwame.top/20210716/mongodb-crud-operations.html">https://hwame.top/20210716/mongodb-crud-operations.html</a><br><strong>参考资料：</strong><a href="https://docs.mongodb.com/manual/crud/">MongoDB CRUD Operations: Version 5.0 latest</a></p></blockquote><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h2><h3 id="1-1-写作的动机"><a href="#1-1-写作的动机" class="headerlink" title="1.1.写作的动机"></a>1.1.写作的动机</h3><p>由于工作需要，捡起了遗忘多时的MongoDB，项目中使用的是4.2版本，恰好本地电脑上多年前装的也是4.2版本，如今官方文档都已经更新到5.0了。</p><p>相比旧版本，5.0增加了一些新功能，比如聚合里的一些stage，4.2版本算是一个比较经典的版本吧（就好比mysql的5.7和8.0）。</p><p>决定记录的另一个动机，则是网上的教程不够全面，官方文档也没有中文版的，有些翻译很生硬且不准确：</p><ul><li><a href="https://www.bookstack.cn/">书栈网</a><ul><li>英文版教程<a href="https://www.bookstack.cn/books/mongodb-4.2-manual">MongoDB v4.2 Manual</a>，与官方文档无异。</li><li><a href="https://www.bookstack.cn/books/mongodb-doc-cn">MongoDB (v3.4) 中文手册</a>翻译不全，很多章节仍然是英文。</li><li><a href="https://www.bookstack.cn/books/Getting-Started-with-MongoDB">MongoDB入门指南</a>和<a href="https://www.bookstack.cn/books/linfenliang-mongodb">MongoDB学习总结</a>过于简洁、不够全面。</li><li><a href="https://www.bookstack.cn/books/aliyun-mongodb">MongoDB数据库最佳实践</a>更侧重于实际应用，适合于进阶实战。</li></ul></li><li><a href="https://www.runoob.com">菜鸟教程</a>的<a href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB教程</a>相比上面几个要好得多，但是毕竟偏向入门，很多细节没有展开。</li></ul><p>在比较之后遂决定啃<a href="https://docs.mongodb.com/manual/crud/">最新的5.0官方文档</a>，怎么说呢，任何问题都可以从中找到答案。</p><blockquote><p>MongoDB提供了一个在线版的<a href="https://mws.mongodb.com/">Mongo shell</a>，默认为<code>latest</code>即v5.0，可以通过参数选择版本，例如<a href="https://mws.mongodb.com/?version=4.2">https://mws.mongodb.com/?version=4.2</a>。<br>唯一的缺点就是连接维持的时间比较短，一不留神就断开了，重连会丢失之前的数据。</p></blockquote><h3 id="1-2-啃文档的一些感受"><a href="#1-2-啃文档的一些感受" class="headerlink" title="1.2.啃文档的一些感受"></a>1.2.啃文档的一些感受</h3><p>这篇文章写的是CRUD，是相对比较基础的部分，目前在看管道聚合，准备写下一篇。</p><p>在看过几天文档（尤其是管道聚合部分）后有一些感受，主要来自管道聚合，但是估计下一篇内容会很多，这篇内容较少就放在这里吧。主要有以下几点：</p><ul><li><font color=purple><b>①官方文档写的很细</b></font>，例如<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">Aggregation Pipeline Stages</a>和<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/">Aggregation Pipeline Operators</a>都有名为<code>$count</code>的<strong>累积器accumulator</strong>和<strong>管道阶段stage</strong>，<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/">Aggregation Pipeline Operators</a>里有分别名为<code>$first</code>和<code>$last</code>的同名<strong>累积器accumulator</strong>和<strong>操作符operator</strong>。文档不厌其烦地在每个出现的地方都有「消除歧义<strong>Disambiguation</strong>」的提示，但这也导致了文档比较冗杂。</li><li><font color=purple><b>②官方文档内容比较混乱</b></font>，从路由上就可以看出来。比如<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">Aggregation Pipeline Stages</a>和<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/">Aggregation Pipeline Operators</a>路由的命名分别为<code>aggregation-pipeline</code>和<code>aggregation</code>，但是这两个对应的类似<code>$xxx</code>的格式却都是<code>https://docs.mongodb.com/manual/reference/operator/aggregation/xxx/</code>，这难免让人摸不着头脑。为何不将路由命名为<code>aggregation-pipeline-stages</code>和<code>aggregation-pipeline-operators</code>，且将对应<code>$xxx</code>放到各自路径下呢？</li><li><font color=purple><b>③官方文档内容分类不够具体</b></font>，如果能按分类添加下级路由，那么文档的结构和层次会更清楚了。如下两例：<ul><li>例如，<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">Aggregation Pipeline Stages</a>可分为「<strong><em><code>db.collection.aggregate()</code>Stages</em></strong>」、「<strong><em><code>db.aggregate()</code>Stages</em></strong>」和「<strong><em>Stages Available for Updates</em></strong>」三个部分，完全可以添加三个子路由啊。</li><li>还有，<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/">Aggregation Pipeline Operators</a>操作表达式分为「<strong><em>算术表达式操作符</em></strong>」、「<strong><em>数组表达式操作符</em></strong>」、「<strong><em>布尔表达式操作符</em></strong>」、「<strong><em>比较表达式操作符</em></strong>」、「<strong><em>条件表达式操作符</em></strong>」、「<strong><em>自定义聚合表达式操作符</em></strong>」、「<strong><em>数据尺寸操作符</em></strong>」、「<strong><em>日期表达式操作符</em></strong>」、「<strong><em>字面表达式操作符</em></strong>」、「<strong><em>杂项操作符</em></strong>」、「<strong><em>对象表达式操作符</em></strong>」、「<strong><em><code>set</code>表达式操作符</em></strong>」、「<strong><em>字符串表达式操作符</em></strong>」、「<strong><em>文本表达式操作符</em></strong>」、「<strong><em>三角函数表达式操作符</em></strong>」、「<strong><em>类型表达式操作符</em></strong>」、「<strong><em><code>$group</code>阶段的累积器</em></strong>」、「<strong><em>非<code>$group</code>阶段的累积器</em></strong>」、「<strong><em>变量表达式操作符</em></strong>」和「<strong><em>窗口操作符</em></strong>」。单单是分类就已经有20个之多，内容那就更多了。如果按分类添加20个子路由，文档的结构和层次会更清楚了。</li><li>当然，文档很贴心地在<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">Aggregation Pipeline Stages</a>和<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/">Aggregation Pipeline Operators</a>最后添加了按字母排序的列表（Alphabetical Listing）以供索引查阅。需要说明的是，各分类并不是互斥的，各类里面有重叠的项，大概这就是官方不予添加子路由的原因吧。</li></ul></li><li><font color=purple><b>④相近的概念没有辨析清楚</b></font>【这里应该与翻译和表达有关，不全是官方的锅】，比如「管道聚合」里的stage和operation是并列的，operator用于stage/operation里，中文里「<strong>操作</strong>」一词即可作名词也可做动词，翻译阅读起来就会产生歧义，所以我把stage和operation统一当成「<strong>阶段</strong>」，operator则称为「<strong>操作符</strong>」或「<strong>操作表达式</strong>」。从这个层面上说，官方文档的描述还是很准确的，只不过全是长难句一连串的定语有时候都分不清修饰的到底是谁，引起理解上的歧义。</li></ul><p>我们常说的CRUD即是「增删改查」，具体说来：</p><ul><li><code>C</code>＝<code>Create</code>，增，即创建操作；</li><li><code>R</code>＝ <code>Read</code> ，查，即查询操作；</li><li><code>U</code>＝<code>Update</code>，改，即更新操作；</li><li><code>D</code>＝<code>Delete</code>，删，即删除操作。</li></ul><h2 id="2-创建操作"><a href="#2-创建操作" class="headerlink" title="2.创建操作"></a>2.创建操作</h2><p>创建/插入是针对单个集合而言，「写操作」在单个文档级别上具有「原子性」。如果当前集合不存在，则插入操作将创建该集合。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插入单个文档是「&#123;&#125;」，多个是「[&#123;&#125;, &#123;&#125;, ...]」</span></span><br><span class="line"><span class="string">db.collection.insertOne()</span>  <span class="comment"># 单个</span></span><br><span class="line"><span class="string">db.collection.insertMany()</span> <span class="comment"># 多个</span></span><br><span class="line"><span class="string">db.collection.insert()</span>     <span class="comment"># 单个或多个</span></span><br></pre></td></tr></table></figure><br>与<code>upsert: true</code> <strong>选项</strong> 一起使用时也可实现插入:</p><ul><li><code>db.collection.update()</code>，<code>db.collection.updateOne()</code>，<code>db.collection.updateMany()</code>；</li><li><code>db.collection.findAndModify()</code>，<code>db.collection.findOneAndUpdate()</code>，<code>db.collection.findOneAndReplace()</code>；</li><li><code>db.collection.bulkWrite()</code>：<strong><em>Performs multiple write operations with controls for order of execution</em></strong>。</li></ul><h2 id="3-查询操作"><a href="#3-查询操作" class="headerlink" title="3.查询操作"></a>3.查询操作</h2><p>查询操作语法为<code>db.collection.find(query, projection)</code>，其中<code>query</code>指定查询条件，<code>projection</code>指定返回的字段。</p><p>以下示例使用<code>inventory</code>集合，包含如下数据：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">item:</span> <span class="string">&quot;journal&quot;</span>, <span class="attr">qty:</span> <span class="number">25</span>, <span class="attr">size:</span> &#123; <span class="attr">h:</span> <span class="number">14</span>, <span class="attr">w:</span> <span class="number">21</span>, <span class="attr">uom:</span> <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status:</span> <span class="string">&quot;A&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">item:</span> <span class="string">&quot;notebook&quot;</span>, <span class="attr">qty:</span> <span class="number">50</span>, <span class="attr">size:</span> &#123; <span class="attr">h:</span> <span class="number">8.5</span>, <span class="attr">w:</span> <span class="number">11</span>, <span class="attr">uom:</span> <span class="string">&quot;in&quot;</span> &#125;, <span class="attr">status:</span> <span class="string">&quot;A&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">item:</span> <span class="string">&quot;paper&quot;</span>, <span class="attr">qty:</span> <span class="number">100</span>, <span class="attr">size:</span> &#123; <span class="attr">h:</span> <span class="number">8.5</span>, <span class="attr">w:</span> <span class="number">11</span>, <span class="attr">uom:</span> <span class="string">&quot;in&quot;</span> &#125;, <span class="attr">status:</span> <span class="string">&quot;D&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">item:</span> <span class="string">&quot;planner&quot;</span>, <span class="attr">qty:</span> <span class="number">75</span>, <span class="attr">size:</span> &#123; <span class="attr">h:</span> <span class="number">22.85</span>, <span class="attr">w:</span> <span class="number">30</span>, <span class="attr">uom:</span> <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status:</span> <span class="string">&quot;D&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">item:</span> <span class="string">&quot;postcard&quot;</span>, <span class="attr">qty:</span> <span class="number">45</span>, <span class="attr">size:</span> &#123; <span class="attr">h:</span> <span class="number">10</span>, <span class="attr">w:</span> <span class="number">15.25</span>, <span class="attr">uom:</span> <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status:</span> <span class="string">&quot;A&quot;</span> &#125;</span><br></pre></td></tr></table></figure></p><ol><li>选择集合中的所有文档：<code>query=&#123;&#125;</code>或<code>query=</code>（留空不写），相当于<code>SELECT * FROM inventory</code>。</li><li>指定相等条件：<code>query=&#123;&lt;field1&gt;: &lt;valve1&gt;, ...&#125;</code>，例如<code>&#123;status: &quot;D&quot;&#125;</code>相当于<code>SELECT * FROM inventory WHERE status = &quot;D&quot;</code>。</li><li>使用查询运算符（Query Operators）指定条件：<code>&#123;&lt;field1&gt;: &#123;&lt;operator1&gt;: &lt;value1&gt;&#125;, ...&#125;</code>，例如<code>&#123;status: &#123;$in: [&quot;A&quot;, &quot;D&quot;]&#125;&#125;</code>相当于<code>SELECT * FROM inventory WHERE status in (&quot;A&quot;, &quot;D&quot;)</code>【此处也可用<code>$or</code>，但对同一字段应该用<code>$in</code>而非<code>$or</code>】。</li><li>指定<code>AND</code>条件：<code>&#123;&lt;and1&gt;: &lt;value1&gt;, &lt;and2&gt;: &lt;value2&gt;, ...&#125;</code>，例如<code>&#123;status: &quot;A&quot;, qty: &#123;$lt: 30&#125;&#125;</code>相当于<code>SELECT * FRON inventory WHERE status = &quot;A&quot; AND qty &lt; 30</code>。</li><li>指定<code>OR</code>条件：<code>&#123;$or: [&lt;query1&gt;, &lt;query2&gt;, ...]&#125;</code>，例如<code>&#123;$or: [&#123;status: “A&quot;&#125;, &#123;qty: &#123;$lt: 30&#125;&#125;]&#125;</code>相当于<code>SELECT * FROM inventory WHERE status = &quot;A&quot; OR qty &lt; 30</code>。</li><li>指定<code>AND</code>以及<code>OR</code>条件【即 <strong><code>4＋5</code></strong> 组含】：<code>&lt;and&gt;: &lt;value&gt;, $or: [&lt;query1&gt;, &lt;query2&gt;, ...]</code>，例如<code>&#123;status: &quot;A&quot;, $or: [qty: &#123;$lt: 30&#125;&#125;, &#123;item: /^p/&#125;]&#125;</code>相当于<code>SELECT * FROM inventory WHERE status = &quot;A&quot; AND (qty &lt; 30 OR item LIKE &quot;p%&quot;)</code>【支持正则表达式】。</li></ol><h3 id="3-1-查询嵌入-嵌套文档"><a href="#3-1-查询嵌入-嵌套文档" class="headerlink" title="3.1.查询嵌入/嵌套文档"></a>3.1.查询嵌入/嵌套文档</h3><ul><li>嵌套文档匹配即<code>&lt;value = document&gt;</code>，格式为：<code>query=&#123;&lt;field1&gt;: &lt;doc1&gt;, ...&#125;</code>，例如<code>&#123;size: &#123;h: 14, w: 21，uom: &quot;cm&quot;&#125;&#125;</code>；<strong>注意: </strong>整个嵌入文档的相等匹配需要精确匹配，包括顺序!</li><li>嵌套字段匹配即嵌套文挡中字殿的匹配，字段使用点表示法：<code>field.subField</code>。<ul><li>相等匹配：<code>&#123;&lt;field.subField&gt;: &lt;value&gt;, ...&#125;</code>，例如<code>&#123;&quot;size.uom&quot;: &quot;in&quot;&#125;</code>；</li><li>查询运算符：<code>&#123;&lt;field1&gt;: &#123;&lt;operator1&gt;: &lt;value1&gt;&#125;, ...&#125;</code>，例如<code>&#123;&quot;size.h&quot;: &#123;$lt: 15&#125;&#125;</code>，与 <strong>3.</strong> 相同；</li><li>指定<code>AND</code>条件：<code>&#123;&lt;field1.subField1&gt;: &lt;valuel&gt;, ...&#125;</code>，例加<code>&#123;&quot;size.h&quot;: &#123;$lt: 15&#125;, &quot;size.uom&quot;: &quot;in&quot;, states: &quot;D&quot;&#125;</code>，与 <strong>4.</strong> 相同。</li></ul></li></ul><h3 id="3-2-查询数组"><a href="#3-2-查询数组" class="headerlink" title="3.2.查询数组"></a>3.2.查询数组</h3><ul><li>匹配一个数组，即<code>value = array</code>，精确匹配包括顺序。<ul><li>例如<code>&#123;tags: [&quot;red&quot;, &quot;black&quot;]&#125;</code>只匹配包含2个元素的定序的<code>[&quot;red&quot;, &quot;black&quot;]</code>；</li><li>若要匹配无序的包含此2元素的数组（<code>len ≥ 2</code>），则需使用<code>$all</code>运算符：<code>&#123;tags: &#123;$all: [&quot;red&quot;, &quot;black&quot;]&#125;&#125;</code>。</li></ul></li><li>查询一个元素的数组（包含指定元素的数组），即<code>arrField = arrValue</code>。<ul><li>例如<code>&#123;tags: &quot;red&quot;&#125;</code>匹配<code>&quot;red&quot; in array(tags)</code>；</li><li>可以对<code>arrValue</code>指定条件过滤器，即<code>&#123;arrField1: &#123;operator1: value1, ...&#125;&#125;</code>，例如<code>&#123;dim_cm: &#123;$gt: 25&#125;&#125;</code>匹配<code>any(dim_cm[i] &gt; 25)</code>，即<code>dim_cm</code>中存在大于25的元素。</li></ul></li><li>为数组元素指定多个条件（复合条件），使 <strong>单个数组元素</strong> 满足这些条件或 <strong>数组元素的任意组合</strong> 满足条件。<ul><li><em>在数组元素上使用复合过滤条件查询数组</em>：数组中存在满足条件的元素（这些元素同时存在于该数组即可，无需是同一个元素），例如<code>&#123;dim_cm: &#123;Sgt: 15, slt: 20&#125;&#125;</code>表示<code>dim_cm[i] &gt; 15 AND dim_cm[j] &lt; 20</code>或<code>15 &lt; dim_cm[kJ &lt; 20</code>；</li><li><em>查询满足多个条件的数组元素</em>：一个元素同时满足条件，例如<code>&#123;dim_cm: &#123;$elemMatch: &#123;Sgt: 15, $lt: 20&#125;&#125;&#125;</code>表示<code>15 &lt; dim_cm[i] &lt; 20</code>；</li><li><em>通过数组索引位置查询元素</em>：点表示法（dot notation）可以为指定位置的元素设置条件，索引从0开始【 <strong>字段和嵌套字段必须在引号内</strong> 】，例如<code>&#123;&quot;dim_cm.1&quot;: &#123;$gt: 25&#125;&#125;</code>表示<code>dim_cm[1] &gt; 25</code>；</li><li><em>按数组长度查询数组</em>：<code>&#123;&quot;tags&quot;: &#123;$size: 3&#125;&#125;</code>表示<code>len(tags) = 3</code>。</li></ul></li></ul><h3 id="3-3-查询嵌套文档数组"><a href="#3-3-查询嵌套文档数组" class="headerlink" title="3.3.查询嵌套文档数组"></a>3.3.查询嵌套文档数组</h3><blockquote><p>嵌套文档数组（Array of Embedded Documents）即以文档为元素的数组，集合<code>inventory</code>文档格式为<code>&#123;item: &quot;xx&quot;, instock: [&#123;warehouse: &quot;A&quot;, qty: 5&#125;, &#123;&#125;...]&#125;</code>。</p></blockquote><ul><li>查询嵌套在数组中的文档：<code>&#123;field: doc&#125;</code>即<code>doc in array(field)</code>（查询数组2：包含指定元素的数组），<code>doc</code>精确匹配包括顺序。例如<code>&#123;&quot;instock&quot;: &#123;warehouse: &quot;A&quot;, qty: 5&#125;&#125;</code>匹配的数组<code>instock</code>包含整个「有序」文档<code>&#123;warehouse: &quot;A&quot;, qty: 5&#125;</code>。</li><li>在文档数组中的字段上指定查询条件【点表示法 <strong>字段和嵌套字段必须在引号内</strong> 】。<ul><li>对嵌入在文档数组中的字段指定查询条件：例如<code>&#123;&#39;instock.qty&#39;: &#123;$lte: 20&#125;&#125;</code>匹配数组元素<code>instock[i] = doc，doc.qty ≤ 20</code>，不检查<code>doc</code>位置；</li><li>使用数组索引查询嵌入文档中的字段: 例如<code>&#123;&#39;instock.0.qty&#39;: &#123;$lte: 20&#125;&#125;</code>匹配数组元素<code>instock[0] = doc，doc.qty ≤ 20</code>，指定<code>doc</code>位置为0，因此结果是上一个的 <strong>子集</strong> 。</li></ul></li><li>为文档数组指定多个条件，使得数组中的文档或文档组合满足条件。<ul><li>单个嵌套文档在嵌套字段上满足多个查询条件，例如<code>&#123;&quot;instock&quot;: &#123;$elemMatch: &#123;qty: 5, warehouse: &quot;A&quot;&#125;&#125;&#125;</code>匹配<code>instock[i]=doc，&#123;qty: 5, warehouse: &quot;A&quot;&#125; in doc</code>，此处<code>doc</code>包含这两值即可且无序。再如<code>&#123;&quot;instock&quot;: &#123;$elemMatch: &#123;qty: &#123;$gt: 10, $lte: 20&#125;&#125;&#125;&#125;</code>匹配<code>instock[i]=doc，10 &lt; doc.qty &lt; 20</code>；</li><li>元素组合满足条件， 若数组字段上的复合查询条件不使用<code>$elemMatch</code>运算行，则匹配「文档组合满足条件的数组」，注意是 <strong>文档组合</strong> 满足而非 <strong>文档</strong> 满足。例如<code>&#123;&quot;instock.qty&quot;: &#123;$gt: 10, $lte: 20&#125;&#125;</code>匹配<code>instock[i].qty &gt; 10，instock[j].qty &lt; 20</code>【上一个是单个文档同时满足，使用了<code>$elemMatch</code>】。类似的，<code>&#123;&quot;instock.qty&quot;: 5, &quot;instock.warehouse&quot;: &quot;A&quot;&#125;</code>将匹配<code>instock[i].qty = 5，instock[j].warehouse = &quot;A&quot;</code>而不要求位于同一文档中。</li></ul></li></ul><h3 id="3-4-从查询返回指定字段"><a href="#3-4-从查询返回指定字段" class="headerlink" title="3.4.从查询返回指定字段"></a>3.4.从查询返回指定字段</h3><blockquote><p>从查询返回指定字段即投影（Projection），查询语法<code>db.inventory.find(query, projection)</code>，其中<code>projection.field = (1=true | 0=false)</code>。<br>查询默认返回所有字段【相当于<code>SELECT *</code>】，使用投影（Projection）来指定或限制返回的字段【相当于<code>SELECT field1, field2...</code>】。</p></blockquote><ul><li>返回匹配文档中的所有字段：不指定<code>projection</code>相当于<code>SELECT *</code>。</li><li>仅返回指定字段和<code>_id</code>：<code>projection = &#123;field1: 1, field2: 1&#125;</code>，默认会返回<code>_id</code>字段，相当于<code>SELECT _id, field1, field2</code>。</li><li>禁用<code>_id</code>字段，通过 <strong>显式地置0</strong> 从结果中删除<code>_id</code>字段：<code>projection = &#123;field1: 1, field2: 1, _id: 0&#125;</code>。</li><li>返回除排除字段之外的所有字段（补集思想），通过置0来排除字段，返回剩下的字段。 <strong>注意：</strong> 除了<code>_id</code>字段以外，不能在<code>projection</code>文档中对「包含和排除语句」进行组合，即不能同时出现0和1。</li><li>返回/禁用嵌套文档中的特定字段：使用点表示法指定嵌套文档中的特定字段，如<code>projection = &#123;item: 1, status: 1, &quot;size.uom&quot;: 1&#125;</code>、<code>projection = &#123;&quot;size.uom&quot;: 0&#125;</code>。</li><li>数组中嵌入文档的投影，使用点表示法在嵌入数组的文档中投影特定字段，例如<code>projection = &#123;item: 1, status: 1, &quot;instock.qty&quot;: 1&#125;</code>的查询结果中<code>instock</code>数组元素（即<code>doc</code>文档）只有<code>qty</code>字段。</li><li>在返回的数组中投影指定数组元素：对于包含了数组的字段，投影算子<script type="math/tex">elemMatch`、`$slice`和`</script>用来操作数组。例如<code>projection = &#123;item: 1, status: 1, instock: &#123;$slice: -1&#125;&#125;</code> 表示只取<code>instock</code>数组最后一个元素。<blockquote><p>上述3个投影算子是「从返回数组中」投影「指定元素」的 <strong>唯一</strong> 方法。也就是说，不能使用素引<code>&#123;&quot;instock.0&quot;: 1&#125;</code>，将报错SyntaxError <code>expected property name, got &#39;&#123;&#39;</code>。</p></blockquote></li></ul><h3 id="3-5-查询空字段或缺失字段"><a href="#3-5-查询空字段或缺失字段" class="headerlink" title="3.5.查询空字段或缺失字段"></a>3.5.查询空字段或缺失字段</h3><p>MongoDB中的不同查询运算符对<code>null</code>值的处理方式不同。查询语法<code>db.inventory.find(query, projection)</code>，示例集合<code>inventory</code>为：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">_id:</span> <span class="number">1</span>, <span class="attr">item:</span> <span class="literal">null</span>&#125;</span><br><span class="line">&#123; <span class="attr">_id:</span> <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure></p><ul><li>相等过滤器：<code>query = &#123;item: null&#125;</code>查询匹配<code>item = null OR !item</code>，结果返回所有的两个文档。</li><li>类型检查：<code>query = &#123;item: &#123;$type: 10&#125;&#125;</code>查询匹配<code>item = null</code>即字段<code>item</code>的值为「BSON类型值<code>Null</code>，其类型编号为10」，结果返回<code>_id = 1</code>的文档。</li><li>存在检查，<code>$exists</code>检查是否存在指定字段：<code>query = &#123;item: &#123;$exists: false&#125;&#125;</code>查询匹配<code>!item</code>即<code>exists(item) = false</code>，结果返回<code>_id = 2</code>的文档（不包含<code>item</code>字段）。</li></ul><h2 id="4-更新操作"><a href="#4-更新操作" class="headerlink" title="4.更新操作"></a>4.更新操作</h2><p>更新操作用于修改集合中已有的文档，在单个文档级别上具有「原子性」，<strong>（与「增」相同）</strong>。<br>可以指定条件或过滤器，来进行更新：<br><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update<span class="constructor">One(&lt;<span class="params">filter</span>&gt;, &lt;<span class="params">update</span>&gt;, &lt;<span class="params">options</span>&gt;)</span></span><br><span class="line">db.collection.update<span class="constructor">Many(&lt;<span class="params">filter</span>&gt;, &lt;<span class="params">update</span>&gt;, &lt;<span class="params">options</span>&gt;)</span></span><br><span class="line">db.collection.replace<span class="constructor">One(&lt;<span class="params">filter</span>&gt;, &lt;<span class="params">update</span>&gt;, &lt;<span class="params">options</span>&gt;)</span></span><br></pre></td></tr></table></figure><br>利用<strong>更新操作符</strong>如<code>$set</code>来修改字段值，「更新方法」的格式：<br><strong>注意：</strong>如果字段不存在，某些更新运算符（例如<code>$set</code>）将创建该字段。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="tag">&lt;<span class="name">update_operator1</span>&gt;</span>: &#123;<span class="tag">&lt;<span class="name">field1</span>&gt;</span>: <span class="tag">&lt;<span class="name">value1</span>&gt;</span>, ...&#125;,</span><br><span class="line">    <span class="tag">&lt;<span class="name">update_operator2</span>&gt;</span>: &#123;<span class="tag">&lt;<span class="name">field2</span>&gt;</span>: <span class="tag">&lt;<span class="name">value2</span>&gt;</span>, ...&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="例1：更新单个文档"><a href="#例1：更新单个文档" class="headerlink" title="例1：更新单个文档"></a>例1：更新单个文档</h3><p>例如原文档：<code>&#123;item: &quot;paper&quot;, qty: 100, size: &#123;h: 8.5, w: 11, uom: &quot;in&quot;&#125;, status: &quot;D&quot;&#125;</code>；<br>更新后文档：<code>&#123;item: &quot;paper&quot;, qty: 100, size: &#123;h: 8.5, w: 11, uom: &quot;cm&quot;&#125;, status: &quot;P&quot;, lastModified: ISODate(&quot;2021-07-21T02:40:43.515Z&quot;)&#125;</code>。<br>更新操作：</p><ul><li>使用<code>$set</code>修改<code>&quot;size.uom&quot; = &quot;cm&quot;</code>和<code>status = &quot;p&quot;</code>；</li><li>使用<code>$currentDate</code>将<code>lastModified</code>更新为当前日期，不存在的字段将被创建。</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">db.inventory.updateOne(</span></span><br><span class="line">    &#123;<span class="attr">item:</span> <span class="string">&quot;paper&quot;</span>&#125;<span class="string">,</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">$set:</span> &#123;<span class="attr">&quot;size.uom&quot;:</span> <span class="string">&quot;cm&quot;</span>, <span class="attr">status:</span> <span class="string">&quot;P&quot;</span>&#125;,</span><br><span class="line">        <span class="string">$currentDate:</span> &#123;<span class="attr">lastModified:</span> <span class="literal">true</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure><h3 id="例2：更新多个文档"><a href="#例2：更新多个文档" class="headerlink" title="例2：更新多个文档"></a>例2：更新多个文档</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如原文档</span></span><br><span class="line">&#123;<span class="attr">item:</span> <span class="string">&quot;journal&quot;</span>,  <span class="attr">qty:</span> <span class="number">25</span>, <span class="attr">size:</span> &#123;<span class="attr">h:</span> <span class="number">14</span>, <span class="attr">w:</span> <span class="number">21</span>,    <span class="attr">uom:</span> <span class="string">&quot;cm&quot;</span>&#125;, <span class="attr">status:</span> <span class="string">&quot;A&quot;</span>&#125;<span class="string">,</span></span><br><span class="line">&#123;<span class="attr">item:</span> <span class="string">&quot;mousepad&quot;</span>, <span class="attr">qty:</span> <span class="number">25</span>, <span class="attr">size:</span> &#123;<span class="attr">h:</span> <span class="number">19</span>, <span class="attr">w:</span> <span class="number">22.85</span>, <span class="attr">uom:</span> <span class="string">&quot;cm&quot;</span>&#125;, <span class="attr">status:</span> <span class="string">&quot;P&quot;</span>&#125;<span class="string">,</span></span><br><span class="line">&#123;<span class="attr">item:</span> <span class="string">&quot;postcard&quot;</span>, <span class="attr">qty:</span> <span class="number">45</span>, <span class="attr">size:</span> &#123;<span class="attr">h:</span> <span class="number">10</span>, <span class="attr">w:</span> <span class="number">15.25</span>, <span class="attr">uom:</span> <span class="string">&quot;cm&quot;</span>&#125;, <span class="attr">status:</span> <span class="string">&quot;A&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新后文档</span></span><br><span class="line">&#123;<span class="attr">item:</span> <span class="string">&quot;journal&quot;</span>,  <span class="attr">qty:</span> <span class="number">25</span>, <span class="attr">size:</span> &#123;<span class="attr">h:</span> <span class="number">14</span>, <span class="attr">w:</span> <span class="number">21</span>,    <span class="attr">uom:</span> <span class="string">&quot;in&quot;</span>&#125;, <span class="attr">status:</span> <span class="string">&quot;P&quot;</span>, <span class="attr">lastModified:</span> <span class="string">ISODate(&quot;2021-07-21T02:56:56.020Z&quot;)</span>&#125;<span class="string">,</span></span><br><span class="line">&#123;<span class="attr">item:</span> <span class="string">&quot;mousepad&quot;</span>, <span class="attr">qty:</span> <span class="number">25</span>, <span class="attr">size:</span> &#123;<span class="attr">h:</span> <span class="number">19</span>, <span class="attr">w:</span> <span class="number">22.85</span>, <span class="attr">uom:</span> <span class="string">&quot;in&quot;</span>&#125;, <span class="attr">status:</span> <span class="string">&quot;P&quot;</span>, <span class="attr">lastModified:</span> <span class="string">ISODate(&quot;2021-07-21T02:56:56.020Z&quot;)</span>&#125;<span class="string">,</span></span><br><span class="line">&#123;<span class="attr">item:</span> <span class="string">&quot;postcard&quot;</span>, <span class="attr">qty:</span> <span class="number">45</span>, <span class="attr">size:</span> &#123;<span class="attr">h:</span> <span class="number">10</span>, <span class="attr">W:</span> <span class="number">15.25</span>, <span class="attr">uom:</span> <span class="string">&quot;in&quot;</span>&#125;, <span class="attr">status:</span> <span class="string">&quot;P&quot;</span>, <span class="attr">lastModified:</span> <span class="string">ISODate(&quot;2021-07-21T02:56:56.020Z&quot;)</span>&#125;</span><br></pre></td></tr></table></figure><p>更新操作:</p><ul><li>更新满足<code>qty &lt; 50</code>的所有文档（例1中<code>qty = 100</code>）；</li><li>使用<code>$set</code>修改<code>&quot;size.uom&quot; = &quot;in&quot;</code>和<code>status = &quot;p&quot;</code>；</li><li>使用<code>$currentDate</code>将<code>lastModified</code>更新为当前日期，不存在的字段将被创建。</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">db.inventory.updateMany(</span></span><br><span class="line">    &#123;<span class="attr">&quot;qty&quot;:</span> &#123;<span class="string">$lt:</span> <span class="number">50</span>&#125;&#125;<span class="string">,</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">$set:</span> &#123;<span class="attr">&quot;size.uom&quot;:</span> <span class="string">&quot;in&quot;</span>, <span class="attr">status:</span> <span class="string">&quot;P&quot;</span>&#125;,</span><br><span class="line">        <span class="string">$currentDate:</span> &#123;<span class="attr">LastModified:</span> <span class="literal">true</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure><h3 id="例3-替换单个文档"><a href="#例3-替换单个文档" class="headerlink" title="例3:替换单个文档"></a>例3:替换单个文档</h3><p>例如文档的更新情况：</p><ul><li>原始示例文档：<code>&#123;item: &quot;paper&quot;, qty: 100, size: &#123;h: 8.5, w: 11, uom: &quot;in&quot;&#125;, status: &quot;D&quot;&#125;</code>；</li><li>例1修改后文档：<code>&#123;item: &quot;paper&quot;, qty: 100, size: &#123;h: 8.5, w: 11, uom: &quot;cm&quot;&#125;, status: &quot;P&quot;, lastModified: ISODate(&quot;2021-07-21T02:40:43.515Z&quot;)&#125;</code>；</li><li>例3修改后文档：<code>&#123;item: &quot;paper&quot;, instock: [&#123;warehouse: &quot;A&quot;, qty: 60&#125;, &#123;warehouse: &quot;B&quot;, qty: 40&#125;]&#125;</code>。</li></ul><p>更新操作，直接修改整个<code>item</code>字段为<code>paper</code>的文档：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">db.inventory.replaceOne(</span></span><br><span class="line">    &#123;<span class="attr">item:</span> <span class="string">&quot;paper&quot;</span>&#125;<span class="string">,</span></span><br><span class="line">    &#123;<span class="attr">item:</span> <span class="string">&quot;paper&quot;</span>, <span class="attr">instock:</span> [&#123;<span class="attr">warehouse:</span> <span class="string">&quot;A&quot;</span>, <span class="attr">qty:</span> <span class="number">60</span>&#125;, &#123;<span class="attr">warehouse:</span> <span class="string">&quot;B&quot;</span>, <span class="attr">qty:</span> <span class="number">40</span>&#125;]&#125;</span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure></p><h3 id="使用聚合管道更新"><a href="#使用聚合管道更新" class="headerlink" title="使用聚合管道更新"></a>使用聚合管道更新</h3><p>从MongoDB 4.2开始，更新操作可以使用<strong>聚合管道（Aggregation Pipeline）</strong>，聚合管道可以由以下stage组成：<code>$addFields</code>、<code>$set</code>、<code>$project</code>、<code>$unset</code>、<code>$replaceRoot</code>和<code>$repaceWith</code>。</p><p>使用聚合管道允许更具表现力的<code>update</code>语句，例如基于当前字段值来表示条件更新，或者使用另一个字段的值更新一个字段。</p><ul><li><strong>示例1。</strong><code>db.students.updateOne(&#123;_id: 3&#125;, [&#123;$set: &#123;&quot;test3&quot;: 98，modified: &quot;$$NOW&quot;&#125;&#125;])</code>更新文档<code>_id: 3</code>，其中<code>$set</code>stage将创建不存在的字段<code>test3 = 98</code>，并将字段<code>modified</code>更新为当前时间。该操作使用「<strong>聚合变量（aggregation variable）</strong>」<code>NOW</code>获取当前时间，使用<strong>「双dollar符前缀」并「加引号」</strong>来访问变量：<code>&quot;$$NOW&quot;</code>。</li><li><strong>示例2。</strong>使用聚合管道来标准化文档中的字段，即集合中的文档应具有相同的字段，同时更新<code>modified</code>字段。其中：<ul><li>带有<code>$mergeObjects</code>表达式的<code>$replaceRoot</code>stage用来为<code>quiz1</code>、<code>quiz2</code>、<code>test1</code>和<code>test2</code>字段设置默认值，聚合变量<code>ROOT</code>指的是当前正在修改的文档。当前文档字段将覆盖默认值。</li><li><code>$set</code>stage将<code>modified</code>字段更新为当前时间。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">db.students2.insertMany([</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">1</span>, <span class="attr">quiz1:</span> <span class="number">8</span>, <span class="attr">test2:</span> <span class="number">100</span>, <span class="attr">quiz2:</span> <span class="number">9</span>, <span class="attr">modified:</span> <span class="string">new</span> <span class="string">Date(&quot;01/05/2020&quot;)</span>&#125;<span class="string">,</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">2</span>, <span class="attr">quiz2:</span> <span class="number">5</span>, <span class="attr">test1:</span> <span class="number">80</span>, <span class="attr">test2:</span> <span class="number">89</span>, <span class="attr">modified:</span> <span class="string">new</span> <span class="string">Date(&quot;01/05/2020&quot;)</span>&#125;<span class="string">,</span></span><br><span class="line"><span class="string">])</span></span><br><span class="line"></span><br><span class="line"><span class="string">db.students2.updateMany(&#123;&#125;,</span></span><br><span class="line">    [</span><br><span class="line">        &#123;<span class="string">$replaceRoot:</span> &#123;<span class="attr">newRoot:</span></span><br><span class="line">            &#123;<span class="string">$mergeObjects:</span> [&#123;<span class="attr">quiz1:</span> <span class="number">0</span>, <span class="attr">quiz2:</span> <span class="number">0</span>, <span class="attr">test1:</span> <span class="number">0</span>, <span class="attr">test2:</span> <span class="number">0</span>&#125;, <span class="string">&quot;$$ROOT&quot;</span>]&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;<span class="string">$set:</span> &#123;<span class="attr">modified:</span> <span class="string">&quot;$$NOW&quot;</span>&#125;&#125;</span><br><span class="line">    ]</span><br><span class="line"><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：</span></span><br><span class="line"><span class="comment"># &#123;_id: 1, quiz1: 8, quiz2: 9, test1: 0, test2: 100, modified: ISODate(&quot;2021-07-21T04:03:43.185Z&quot;)&#125;,</span></span><br><span class="line"><span class="comment"># &#123;_id: 2, quiz1: 0, quiz2: 5, test1: 80, test2: 89, modified: ISODate(&quot;2021-07-21T04:03:43.185Z&quot;)&#125;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><strong>示例3。</strong>使用聚合管道来计算「平均分数和成绩等级」，同时更新<code>modified</code>字段。其中：<ul><li>第一个<code>$set</code>stage用来①计算<code>tests</code>数组的平均值（<code>&#123;$avg: &quot;$tests&quot;&#125;</code>）并截断取整（<code>&#123;$trunc: [&lt;number&gt;, 0]&#125;</code>），将取整的值赋给<code>average</code>并创建；②将<code>modified</code>字段更新为当前时间。【<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/trunc/">$trunc用法</a>】</li><li>第二个<code>$set</code>stage根据上一步的<code>average</code>，使用<code>$switch</code>表达式创建<code>grade</code>。【<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/switch/">$switch用法</a>】<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">db.students3.insert([</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">1</span>, <span class="attr">&quot;tests&quot;:</span> [<span class="number">95</span>, <span class="number">92</span>, <span class="number">98</span>], <span class="attr">&quot;modified&quot;:</span> <span class="string">ISODate(&quot;2019-01-01T00:00:00Z&quot;)</span>&#125;<span class="string">,</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">2</span>, <span class="attr">&quot;tests&quot;:</span> [<span class="number">94</span>, <span class="number">88</span>, <span class="number">90</span>], <span class="attr">&quot;modified&quot;:</span> <span class="string">ISODate(&quot;2019-01-01T00:00:00Z&quot;)</span>&#125;<span class="string">,</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">3</span>, <span class="attr">&quot;tests&quot;:</span> [<span class="number">70</span>, <span class="number">75</span>, <span class="number">82</span>], <span class="attr">&quot;modified&quot;:</span> <span class="string">ISODate(&quot;2019-01-01T00:00:00Z&quot;)</span>&#125;</span><br><span class="line"><span class="string">]);</span></span><br><span class="line"></span><br><span class="line"><span class="string">db.students3.updateMany(&#123;&#125;,</span></span><br><span class="line">    [</span><br><span class="line">        &#123;<span class="string">$set:</span> &#123;<span class="attr">average:</span> &#123;<span class="string">$trunc</span> [&#123;<span class="string">$avg:</span> <span class="string">&quot;$tests&quot;</span>&#125;, <span class="number">0</span>]&#125;, <span class="attr">modified:</span> <span class="string">&quot;$$NOW&quot;</span>&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">$set:</span> &#123;<span class="attr">grade:</span> &#123;<span class="string">$switch:</span> &#123;</span><br><span class="line">                            <span class="attr">branches:</span> [</span><br><span class="line">                                &#123;<span class="attr">case:</span> &#123;<span class="string">$gte:</span> [<span class="string">&quot;$average&quot;</span>, <span class="number">90</span>]&#125;, <span class="attr">then:</span> <span class="string">&quot;A&quot;</span>&#125;,</span><br><span class="line">                                &#123;<span class="attr">case:</span> &#123;<span class="string">$gte:</span> [<span class="string">&quot;$average&quot;</span>, <span class="number">80</span>]&#125;, <span class="attr">then:</span> <span class="string">&quot;B&quot;</span>&#125;,</span><br><span class="line">                                &#123;<span class="attr">case:</span> &#123;<span class="string">$gte:</span> [<span class="string">&quot;$average&quot;</span>, <span class="number">70</span>]&#125;, <span class="attr">then:</span> <span class="string">&quot;C&quot;</span>&#125;,</span><br><span class="line">                                &#123;<span class="attr">case:</span> &#123;<span class="string">$gte:</span> [<span class="string">&quot;$average&quot;</span>, <span class="number">60</span>]&#125;, <span class="attr">then:</span> <span class="string">&quot;D&quot;</span>&#125;</span><br><span class="line">                            ],</span><br><span class="line">                            <span class="attr">default:</span> <span class="string">&quot;F&quot;</span></span><br><span class="line">        &#125;&#125;&#125;&#125;</span><br><span class="line">    ]</span><br><span class="line"><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：</span></span><br><span class="line"><span class="comment"># &#123;&quot;_id&quot;: 1, &quot;tests&quot;: [95, 92, 90], &quot;modified&quot;: ISODate(&quot;2021-07-21T06:06:50.533Z&quot;), &quot;average&quot;: 92, &quot;grade&quot;: &quot;A&quot;&#125;,</span></span><br><span class="line"><span class="comment"># &#123;&quot;_id&quot;: 2, &quot;tests&quot;: [94, 88, 90], &quot;modified&quot;: ISODate(&quot;2021-07-21T06:06:50.533Z&quot;), &quot;average&quot;: 90, &quot;grade&quot;: &quot;A&quot;&#125;,</span></span><br><span class="line"><span class="comment"># &#123;&quot;_id&quot;: 3, &quot;tests&quot;: [70, 75, 82], &quot;modified&quot;: ISODate(&quot;2021-07-21T06:06:50.533Z&quot;), &quot;average&quot;: 75, &quot;grade&quot;: &quot;C&quot;&#125;,</span></span><br></pre></td></tr></table></figure></li></ul></li><li><strong>示例4。</strong>使用聚合管道进行array的拼接:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">db.students4.insertMany([</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">1</span>, <span class="attr">&quot;quizzes&quot;:</span> [<span class="number">4</span>, <span class="number">6</span>, <span class="number">7</span>]&#125;<span class="string">,</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">2</span>, <span class="attr">&quot;quizzes&quot;:</span> [<span class="number">5</span>]&#125;<span class="string">,</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">3</span>, <span class="attr">&quot;quizzes&quot;:</span> [<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>]&#125;</span><br><span class="line"><span class="string">])</span></span><br><span class="line"></span><br><span class="line"><span class="string">db.students4.updateOne(&#123;_id:</span> <span class="number">2</span><span class="string">&#125;,</span></span><br><span class="line">    [</span><br><span class="line">        &#123;<span class="string">$set:</span> &#123;<span class="attr">quizzes:</span> &#123;<span class="string">$concatArrays:</span> [<span class="string">&quot;$quizzes&quot;</span>, [<span class="number">8</span>, <span class="number">6</span>]]&#125;&#125;&#125;</span><br><span class="line">    ]</span><br><span class="line"><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果:</span></span><br><span class="line"><span class="comment"># &#123;&quot;_id&quot;: 1, &quot;quizzes&quot;: [4, 6, 7]&#125;,</span></span><br><span class="line"><span class="comment"># &#123;&quot;_id&quot;: 2, &quot;quizzes&quot;: [5, 8, 6]&#125;,</span></span><br><span class="line"><span class="comment"># &#123;&quot;_id&quot;: 3, &quot;quizzes&quot;: [10, 10, 10]&#125;</span></span><br></pre></td></tr></table></figure></li><li><strong>示例5。</strong>使用聚合管道将「摄氏温度」转换为「华氏温度」，其中：<ul><li>管道包含<code>$addFields</code>stage（与<code>$set</code>等价），用以创建新的数组字段<code>tempsF</code>（包含华氏温度的数组）；</li><li>该stage使用<code>$map``$add</code>和<code>$multiply</code>表达式来进行温度转换$F=C\times \frac{9}{5}+32$。【<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/map/">$map用法</a>，对<code>len(tempsC)</code>无要求】<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">db.temperatures.insertMany([</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">1</span>, <span class="attr">&quot;date&quot;:</span> <span class="string">ISODate(&quot;2019-06-23&quot;)</span>, <span class="attr">&quot;tempsC&quot;:</span> [ <span class="number">4</span>, <span class="number">12</span>, <span class="number">17</span>]&#125;<span class="string">,</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">2</span>, <span class="attr">&quot;date&quot;:</span> <span class="string">ISODate(&quot;2019-07-07&quot;)</span>, <span class="attr">&quot;tempsC&quot;:</span> [<span class="number">14</span>, <span class="number">24</span>, <span class="number">11</span>]&#125;<span class="string">,</span></span><br><span class="line">    &#123;<span class="attr">&quot;_id&quot;:</span> <span class="number">3</span>, <span class="attr">&quot;date&quot;:</span> <span class="string">ISODate(&quot;2019-10-30&quot;)</span>, <span class="attr">&quot;tempsC&quot;:</span> [<span class="number">18</span>,  <span class="number">6</span>,  <span class="number">8</span>]&#125;</span><br><span class="line"><span class="string">])</span></span><br><span class="line"></span><br><span class="line"><span class="string">db.temperatures.updateMany(&#123;&#125;,</span></span><br><span class="line">    [</span><br><span class="line">        &#123;<span class="string">$addFields:</span> &#123;<span class="attr">&quot;tempsF&quot;:</span> &#123;</span><br><span class="line">            <span class="string">$map:</span> &#123;</span><br><span class="line">                <span class="attr">input:</span> <span class="string">&quot;$tempsC&quot;</span>,</span><br><span class="line">                <span class="attr">as:</span> <span class="string">&quot;celsius&quot;</span>,</span><br><span class="line">                <span class="attr">in:</span> &#123;<span class="string">$add:</span> [&#123;<span class="string">$multiply:</span> [<span class="string">&quot;$$celsius&quot;</span>, <span class="number">9</span><span class="string">/5</span>]&#125;, <span class="number">32</span>]&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;&#125;&#125;</span><br><span class="line">    ]</span><br><span class="line"><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：</span></span><br><span class="line"><span class="comment"># &#123;&quot;_id&quot;: 1, &quot;date&quot;: ISODate(&quot;2019-06-23T00:00:00.000Z&quot;), &quot;tempsC&quot;: [ 4, 12, 17], &quot;tempsF&quot;: [39.2, 53.6, 62.6]&#125;,</span></span><br><span class="line"><span class="comment"># &#123;&quot;_id&quot;: 2, &quot;date&quot;: ISODate(&quot;2019-07-07T00:00:00.000Z&quot;), &quot;tempsC&quot;: [14, 24, 11], &quot;tempsF&quot;: [57.2, 75.2, 51.8]&#125;,</span></span><br><span class="line"><span class="comment"># &#123;&quot;_id&quot;: 3, &quot;date&quot;: ISODate(&quot;2019-10-30T00:00:00.000Z&quot;), &quot;tempsC&quot;: [18,  6,  8], &quot;tempsF&quot;: [64.4, 42.8, 46.4]&#125;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="update方法"><a href="#update方法" class="headerlink" title="update方法"></a>update方法</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.collection</span><span class="selector-class">.updateOne</span>()</span><br><span class="line">db<span class="selector-class">.collection</span><span class="selector-class">.updateMany</span>()</span><br><span class="line">db<span class="selector-class">.collection</span><span class="selector-class">.replaceOne</span>()</span><br><span class="line">db<span class="selector-class">.collection</span><span class="selector-class">.update</span>()</span><br><span class="line">db<span class="selector-class">.collection</span><span class="selector-class">.findOneAndReplace</span>()</span><br><span class="line">db<span class="selector-class">.collection</span><span class="selector-class">.findOneAndUpdate</span>()</span><br><span class="line">db<span class="selector-class">.collection</span><span class="selector-class">.findAndModify</span>()</span><br><span class="line">db<span class="selector-class">.collection</span><span class="selector-class">.bulkWrite</span>()</span><br></pre></td></tr></table></figure><h2 id="5-删除操作"><a href="#5-删除操作" class="headerlink" title="5.删除操作"></a>5.删除操作</h2><p>从集合中删除文档，具有<strong>「原子性」</strong>，也可指定条件或过滤器：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.collection</span><span class="selector-class">.deleteOne</span>(<span class="attribute">filter</span>)</span><br><span class="line">db<span class="selector-class">.collection</span><span class="selector-class">.deleteMany</span>(<span class="attribute">filter</span>)</span><br></pre></td></tr></table></figure></p><ul><li>删除所有文档。将过滤器文档置空：<code>db.inventory.deleteMany(&#123;&#125;)</code>。</li><li>删除所有符合条件的文档。指定用于标识要删除文档的条件或过滤器，过滤器语法与查询操作相同。在「<strong>查询过滤器文档（query filter docuent）</strong>」中使用<code>field: value</code>表达式来指定相等匹配条件：<code>&#123;&lt;field1&gt;: &lt;value1&gt;, ...&#125;</code>，同理，将<code>value</code>替换成「<strong>查询操作符</strong>」来指定匹配条件：<code>&#123;&lt;field1&gt;: &#123;&lt;operator1&gt;: &lt;value1&gt;&#125;, ...&#125;</code>。</li><li>只删除一个符合条件的文档。即使多个文档相匹配，也只删除第一个：<code>db.collection.deleteOne(filter)</code>。</li><li>删除方法：<ul><li><code>db.collection.deleteOne()</code>；</li><li><code>db.collection.deleteMany()</code>；</li><li><code>db.collection.remove()</code>；</li><li><code>db.collection.findOneAndDelete()</code>；</li><li><code>db.collection.findAndModify()</code>；</li><li><code>db.collection.bulkWrite()</code>。</li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：MongoDB学习过程中对CRUD用法的记录，毕竟好记性不如烂笔头。</summary>
    
    
    
    <category term="MongoDB" scheme="https://hwame.top/categories/MongoDB/"/>
    
    
    <category term="MongoDB" scheme="https://hwame.top/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>Python虚拟环境</title>
    <link href="https://hwame.top/20210629/python-virtual-environment.html"/>
    <id>https://hwame.top/20210629/python-virtual-environment.html</id>
    <published>2021-06-28T23:54:48.000Z</published>
    <updated>2021-07-08T00:04:25.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：本文介绍Python中常用虚拟环境的用法。<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>参考资料：</strong></p><ul><li><a href="http://python.iswbm.com/en/latest/chapters/p12.html">Python中文指南第十二章：虚拟环境</a><ul><li><a href="http://python.iswbm.com/en/latest/c12/c12_01.html">12.1 【虚拟环境】为什么要有虚拟环境？</a></li><li><a href="http://python.iswbm.com/en/latest/c12/c12_02.html">12.2 【虚拟环境】方案一：使用 virtualenv</a></li><li><a href="http://python.iswbm.com/en/latest/c12/c12_03.html">12.3 【虚拟环境】方案二：使用 pipenv</a></li><li><a href="http://python.iswbm.com/en/latest/c12/c12_04.html">12.4 【虚拟环境】方案三：使用 pipx</a></li><li><a href="http://python.iswbm.com/en/latest/c12/c12_05.html">12.5 【虚拟环境】方案四：使用 poetry</a></li></ul></li><li><a href="https://docs.python.org/zh-cn/3/library/venv.html">Python标准库venv-创建虚拟环境</a></li><li><a href="https://www.cnblogs.com/liudinglong/p/12538579.html">Python 虚拟环境的使用-virtualenv/virtualenvwrapper、pycharm使用</a></li><li><a href="https://www.runoob.com/manual/pythontutorial3/docs/html/venv.html">Runoob Python tutorial-虚拟环境和包-pyvenv</a></li><li><a href="https://blog.csdn.net/godot06/article/details/81079064">Python为什么要使用虚拟环境-Python虚拟环境的安装和配置-virtualenv</a></li><li><a href="https://zhuanlan.zhihu.com/p/60647332">知乎：最全的Python虚拟环境使用方法-virtualenv/conda/pipenv</a></li></ul><p><strong>文章链接：</strong><a href="https://hwame.top/20210629/python-virtual-environment.html">Python虚拟环境</a><br><strong>文章说明接：</strong>这片文章是复制的<a href="http://python.iswbm.com/en/latest/chapters/p12.html">Python中文指南第十二章：虚拟环境</a>，后面再慢慢整理吧慢慢改吧。</p></blockquote><h2 id="虚拟环境"><a href="#虚拟环境" class="headerlink" title="虚拟环境"></a>虚拟环境</h2><p>所谓<a href="https://docs.python.org/zh-cn/3/glossary.html#term-virtual-environment">虚拟环境（virtual environment）</a>，是指一种采用协作式隔离的运行时环境，允许 Python 用户和应用程序在安装和升级 Python 分发包时不会干扰到同一系统上运行的其他 Python 应用程序的行为。</p><p>使用虚拟环境有以下优点：</p><ul><li>使不同应用开发环境独立；</li><li>环境升级不影响其他应用，也不会影响全局的python环境；</li><li>可以防止系统中出现包管理混乱和版本的冲突；</li><li>不同环境中Python依赖包相互独立，互不干扰。</li></ul><p>管理Python版本和环境的工具有很多，常用的有以下几种：</p><ul><li><code>venv</code>：Python自带的模块，</li><li><code>virtualenv</code>：</li><li><code>virtualenvwrapper</code>：</li><li><code>pipenv</code>：</li><li><code>pyvenv</code>：</li></ul><h2 id="12-1【虚拟环境】为什么要有虚拟环境？"><a href="#12-1【虚拟环境】为什么要有虚拟环境？" class="headerlink" title="12.1【虚拟环境】为什么要有虚拟环境？"></a>12.1【虚拟环境】为什么要有虚拟环境？</h2><p>虚拟环境的意义，就如同虚拟机 一样，它可以实现不同环境中Python依赖包相互独立，互不干扰。</p><p>举个例子吧。</p><p>假设我们的电脑里有两个项目，他们都用到同一个第三方包，本来一切都顺利。但是由于某种原因，项目B由于某些原因要使用这个第三方包的一些新特性（新版本才有），而如果就这样贸然升级了，对项目A的影响我们无法评估，这个时候我们就特别需要有一种解决方案可以让项目A和B，处于两个不同的Python环境中。互不影响。</p><p>为了方便大家对虚拟环境有个认识，我列举了下其优点：</p><ul><li>使不同应用开发环境独立</li><li>环境升级不影响其他应用，也不会影响全局的python环境</li><li>可以防止系统中出现包管理混乱和版本的冲突</li></ul><p>市场上管理 Python 版本和环境的工具有很多，这里列举几个：</p><ul><li><code>p</code>：非常简单的交互式 python 版本管理工具。</li><li><code>pyenv</code>：简单的 Python 版本管理工具。</li><li><code>Vex</code>：可以在虚拟环境中执行命令。</li><li><code>virtualenv</code>：创建独立 Python 环境的工具。</li><li><code>virtualenvwrapper</code>：virtualenv 的一组扩展。</li></ul><p>工具很多，但个人认为最好用的，当属 <code>virtualenvwrapper</code>，推荐大家也使用。</p><h2 id="12-2-【虚拟环境】方案一：使用-virtualenv"><a href="#12-2-【虚拟环境】方案一：使用-virtualenv" class="headerlink" title="12.2 【虚拟环境】方案一：使用 virtualenv"></a>12.2 【虚拟环境】方案一：使用 virtualenv</h2><h3 id="1-安装virtualenv"><a href="#1-安装virtualenv" class="headerlink" title="1. 安装virtualenv"></a>1. 安装virtualenv</h3><p>由于 virtualenvwrapper 是 virtualenv 的一组扩展，所以如果要使用 virtualenvwrapper，就必须先安装 virtualenv。</p><p><strong>基本使用</strong></p><p>由于virtualenv创建虚拟环境是在当前环境下创建的。所以我们要准备一个专门存放虚拟环境的目录。（以下操作在Linux在完成，windows相对简单，请自行完成，有不明白的请微信与我联系。）</p><p><strong>创建</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 准备目录并进入</span></span><br><span class="line">$ <span class="built_in">mkdir</span> -p /home/wangbm/Envs</span><br><span class="line">$ <span class="built_in">cd</span> !$</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建虚拟环境（按默认的Python版本）</span></span><br><span class="line"><span class="comment">## 执行完，当前目录下会有一个my_env01的目录</span></span><br><span class="line">$ virtualenv my_env01</span><br><span class="line"></span><br><span class="line"><span class="comment">## 你也可以指定版本</span></span><br><span class="line">$ virtualenv -p /usr/bin/python2.7 my_env01</span><br><span class="line">$ virtualenv -p /usr/bin/python3.6 my_env02</span><br><span class="line"></span><br><span class="line"><span class="comment">## 你肯定觉得每次都要指定版本，相当麻烦吧？</span></span><br><span class="line"><span class="comment">## 在Linux下，你可以把这个选项写进入环境变量中</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python2.7&quot;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure><p><strong>进入/退出</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/wangbm/Envs</span><br><span class="line"></span><br><span class="line"><span class="comment">## 进入</span></span><br><span class="line">$ <span class="built_in">source</span> my_env01/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment">## 退出</span></span><br><span class="line">$ deactivate</span><br></pre></td></tr></table></figure><p><strong>删除</strong><br>删除虚拟环境，只需删除对应的文件夹就行了。并不会影响全局的Python和其他环境。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/wangbm/Envs</span><br><span class="line">$ <span class="built_in">rm</span> -rf my_env01</span><br></pre></td></tr></table></figure><blockquote><p>注意：<br>创建的虚拟环境，不会包含原生全局环境的第三方包，其会保证新建虚拟环境的干净。</p></blockquote><p>如果你需要和全局环境使用相同的第三方包。可以使用如下方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 导出依赖包</span></span><br><span class="line">$ pip freeze &gt; requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装依赖包</span></span><br><span class="line">$ pip install -r requirements.txt </span><br></pre></td></tr></table></figure><h3 id="2-使用-virtualenvwrapper"><a href="#2-使用-virtualenvwrapper" class="headerlink" title="2. 使用 virtualenvwrapper"></a>2. 使用 virtualenvwrapper</h3><p>virtualenv 虽然已经相当好用了，可是功能还是不够完善。</p><p>你可能也发现了，要进入虚拟环境，必须得牢记之前设置的虚拟环境目录，如果你每次按规矩来，都将环境安装在固定目录下也没啥事。但是很多情况下，人是会懒惰的，到时可能会有很多个虚拟环境散落在系统各处，你将有可能忘记它们的名字或者位置。</p><p>还有一点，virtualenv 切换环境需要两步，退出 -&gt; 进入。不够简便。</p><p>为了解决这两个问题，virtualenvwrapper就诞生了。</p><p><strong>安装</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装 - Linux</span></span><br><span class="line">pip install virtualenvwrapper</span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装 - Windows</span></span><br><span class="line">pip install virtualenvwrapper-win</span><br></pre></td></tr></table></figure><p><strong>配置</strong><br>先find一下<code>virtualenvwrapper.sh</code>文件的位置</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find / <span class="literal">-name</span> virtualenvwrapper.sh</span><br><span class="line"><span class="comment">## /usr/bin/virtualenvwrapper.sh</span></span><br></pre></td></tr></table></figure><p>若是 windows 则使用everything 查找 virtualenvwrapper.bat 脚本</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:<span class="string">\Program</span> Files (x86)<span class="string">\Python38-32\Scripts\virtualenvwrapper.bat</span></span><br></pre></td></tr></table></figure><p>在~/.bashrc 文件新增配置</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">WORKON_HOME</span>=<span class="variable">$HOME</span>/.virtualenvs</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">PROJECT_HOME</span>=<span class="variable">$HOME</span>/workspace</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">VIRTUALENVWRAPPER_SCRIPT</span>=/usr/bin/virtualenvwrapper.sh</span><br><span class="line">source /usr/bin/virtualenvwrapper.sh</span><br></pre></td></tr></table></figure><p>若是 windows 则新增环境变量：<code>WORKON_HOME</code></p><p><img src="http://image.iswbm.com/20200209161935.png" alt=""></p><p><strong>基本语法</strong>：</p><p>mkvirtualenv [-a project_path] [-i package] [-r requirements_file] [virtualenv options] ENVNAME</p><p><strong>常用方法</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建</span></span><br><span class="line">$ mkvirtualenv my_env01</span><br><span class="line"></span><br><span class="line"><span class="comment">## 进入</span></span><br><span class="line">$ workon my_env01</span><br><span class="line"></span><br><span class="line"><span class="comment">## 退出</span></span><br><span class="line">$ deactivate</span><br><span class="line"></span><br><span class="line"><span class="comment">## 列出所有的虚拟环境，两种方法</span></span><br><span class="line">$ workon</span><br><span class="line">$ lsvirtualenv</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在虚拟环境内直接切换到其他环境</span></span><br><span class="line">$ workon my_env02</span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除虚拟环境</span></span><br><span class="line">$ rmvirtualenv my_env01</span><br></pre></td></tr></table></figure><p><strong>其他命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 列出帮助文档</span></span><br><span class="line">$ virtualenvwrapper</span><br><span class="line"></span><br><span class="line"><span class="comment">## 拷贝虚拟环境</span></span><br><span class="line">$ cpvirtualenv ENVNAME [TARGETENVNAME]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在所有的虚拟环境上执行命令</span></span><br><span class="line">$ allvirtualenv pip install -U pip</span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除当前环境的所有第三方包</span></span><br><span class="line">$ wipeenv</span><br><span class="line"></span><br><span class="line"><span class="comment">## 进入到当前虚拟环境的目录</span></span><br><span class="line">$ cdsitepackages</span><br><span class="line"></span><br><span class="line"><span class="comment">## 进入到当前虚拟环境的site-packages目录</span></span><br><span class="line">$ cdvirtualenv</span><br><span class="line"></span><br><span class="line"><span class="comment">## 显示 site-packages 目录中的内容</span></span><br><span class="line">$ lssitepackages</span><br></pre></td></tr></table></figure><p>更多内容，可查看 官方文档<br><a href="https://virtualenvwrapper.readthedocs.io/en/latest/command_ref.html">https://virtualenvwrapper.readthedocs.io/en/latest/command_ref.html</a></p><h3 id="3-实战演示"><a href="#3-实战演示" class="headerlink" title="3. 实战演示"></a>3. 实战演示</h3><p>以上内容，是一份使用指南。接下来，一起来看看，如何在项目中使用虚拟环境。</p><p>如何使用在我们的开发中使用我们的虚拟环境呢</p><p>通常我们使用的场景有如下几种</p><ul><li>交互式中</li><li>PyCharm中</li><li>工程中</li></ul><p>接下来，我将一一展示。</p><h4 id="3-1-交互式中"><a href="#3-1-交互式中" class="headerlink" title="3.1 交互式中"></a>3.1 交互式中</h4><p>先对比下，全局环境和虚拟环境的区别，全局环境中有requests包，而虚拟环境中并未安装。<br>当我们敲入 <code>workon my_env01</code>，前面有<code>my_env01</code>的标识，说明我们已经处在虚拟环境中。后面所有的操作，都将在虚拟环境下执行。<br><img src="https://i.loli.net/2018/06/11/5b1e7d36ce8ad.png" alt=""></p><h4 id="3-2-工程项目中"><a href="#3-2-工程项目中" class="headerlink" title="3.2 工程项目中"></a>3.2 工程项目中</h4><p>我们的工程项目，都有一个入口文件，仔细观察，其首行可以指定Python解释器。</p><p>倘若我们要在虚拟环境中运行这个项目，只要更改这个文件头部即可。</p><p>现在我还是以，<code>import requests</code> 为例，来说明，是否是在虚拟环境下运行的，如果是，则和上面一样，会报错。</p><p>文件内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/root/.virtualenvs/my_env01/bin/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;ok&quot;</span></span><br></pre></td></tr></table></figure><p>运行前，注意添加执行权限。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">chmod</span> +x ming.py</span><br></pre></td></tr></table></figure><p>好了。来执行一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./ming.py</span><br></pre></td></tr></table></figure><p>发现和预期一样，真的报错了。说明我们指定的虚拟环境有效果。<br><img src="https://i.loli.net/2018/06/11/5b1e7f140be6a.png" alt=""></p><h4 id="3-3-PyCharm中"><a href="#3-3-PyCharm中" class="headerlink" title="3.3 PyCharm中"></a>3.3 PyCharm中</h4><p>点击 File - Settings - Project - Interpreter<br><img src="https://i.loli.net/2018/06/11/5b1e805c996c8.png" alt=""><br>点击小齿轮。如图点击添加，按提示添加一个虚拟环境。然后点 OK 就可以使用这个虚拟环境，之后的项目都会在这个虚拟环境下运行。<br><img src="https://i.loli.net/2018/06/11/5b1e812db603f.png" alt=""></p><p><img src="http://image.iswbm.com/20210606214719.png" alt=""></p><h2 id="12-3-【虚拟环境】方案二：使用-pipenv"><a href="#12-3-【虚拟环境】方案二：使用-pipenv" class="headerlink" title="12.3 【虚拟环境】方案二：使用 pipenv"></a>12.3 【虚拟环境】方案二：使用 pipenv</h2><p>以前一直使用pip+virtualenv+virtualwrapper管理模块和环境， 但是virtualwrapper在windows上使用不太方便，而且包和环境分开管理确实经常不记得哪个是哪个了。 </p><p>为什么 会推荐 pipenv 呢？</p><ul><li>它是 <code>virtualenv</code> 和 <code>pip</code> 的合体，可以合起来使用；</li><li>使用<code>Pipfile</code> 和 <code>Pipfile.lock</code>替代<code>requirements.txt</code></li><li>可以使用 <code>pipenv graph</code>很方便的看出包的依赖关系。</li><li>通过加载<code>.env</code>文件简化开发工作流程</li></ul><h3 id="1-安装pipenv"><a href="#1-安装pipenv" class="headerlink" title="1. 安装pipenv"></a>1. 安装pipenv</h3><p>如果你的电脑上没有安装 pipenv，可以使用如下方法安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># mac</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brew install pipenv</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># windows</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pip install [--user] pipenv</span></span><br></pre></td></tr></table></figure><p>如果你的电脑是 windows 的。</p><p><img src="http://image.iswbm.com/Fk6WZ2xbqg2DM3AvnYCpsiKQ4xOn" alt=""></p><p>需要将如标示路径，加入到 环境变量 PATH 中。</p><p><img src="http://image.iswbm.com/FjuJ8yZsgjkzVuBRZHxK1ZnnzaEX" alt=""></p><p>然后需要重启一下，CMD 终端才能够刷新环境变量。</p><h3 id="2-创建虚拟环境"><a href="#2-创建虚拟环境" class="headerlink" title="2. 创建虚拟环境"></a>2. 创建虚拟环境</h3><p>DjangoWebBlog 是我们的项目目录，进入这个目录下创建虚拟环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> DjangoWebBlog &amp;&amp; <span class="built_in">cd</span> DjangoWebBlog</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 在当前目录下创建一个虚拟环境（默认的Python版本）</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv install</span></span><br></pre></td></tr></table></figure><p>你也可以指定版本创建</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv --two      <span class="comment"># 相当于 pipenv --python /usr/bin/python2</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv --three    <span class="comment"># 相当于 pipenv --python /usr/bin/python3</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv --python 3.7 <span class="comment"># 也可以指定具体的版本</span></span></span><br><span class="line">pipenv install --python 2</span><br></pre></td></tr></table></figure><p>这边以安装 python2 版本的虚拟环境为例说明。</p><p><img src="http://image.iswbm.com/20190612211330.png" alt=""></p><p>如果你原项目使用的是 requirements.txt 这个管理包的方式，这时候执行 <code>pipenv --tow</code> 创建一个虚拟环境后，会找到 requirements.txt ，并根据这里面的依赖包生成 Pipfile文件。</p><p><img src="http://image.iswbm.com/20190612213015.png" alt=""></p><h3 id="3-查询虚拟环境"><a href="#3-查询虚拟环境" class="headerlink" title="3. 查询虚拟环境"></a>3. 查询虚拟环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 返回项目的路径</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv --<span class="built_in">where</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 返回虚拟环境路径</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv --venv</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 返回该虚拟环境的解释器</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv --py</span></span><br></pre></td></tr></table></figure><p>演示如下：</p><p><img src="http://image.iswbm.com/20190612213950.png" alt=""></p><h3 id="4-操作虚拟环境"><a href="#4-操作虚拟环境" class="headerlink" title="4. 操作虚拟环境"></a>4. 操作虚拟环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 进入这个虚拟环境</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv shell</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 退出这个虚拟环境</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">deactivate</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 移除当前目录的虚拟环境</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv --<span class="built_in">rm</span></span></span><br></pre></td></tr></table></figure><p>执行 <code>pipenv shell</code> 就可以进入这个虚拟环境，在头部会有虚拟环境的标识名称。有这个标识，说明已经进入虚拟环境。</p><p><img src="http://image.iswbm.com/20190612211925.png" alt=""></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 在当前虚拟环境中运行</span></span><br><span class="line">$ pipenv run python  <span class="comment"># 进入交互式,跟直接执行 python 一样</span></span><br><span class="line">$ pipenv run python 文件名 <span class="comment"># 运行文件</span></span><br><span class="line">$ pipenv run pip ...  <span class="comment"># 运行pip</span></span><br></pre></td></tr></table></figure><h3 id="5-虚拟环境包管理"><a href="#5-虚拟环境包管理" class="headerlink" title="5. 虚拟环境包管理"></a>5. 虚拟环境包管理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 安装一个本地包（setup.py）到虚拟环境（Pipfile）</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv install -e .</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 安装、卸载模块</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv install requests</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv uninstall requests</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv uninstall --all   <span class="comment"># 卸载全部包</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv install -r path/to/requirements.txt</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 安装所有依赖</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv install --dev</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 更新包</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv update <span class="comment"># 更新所有包</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv update --outdated <span class="comment"># 打印所有要更新的包</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv update &lt;包名&gt; <span class="comment"># 更新指定的包</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 将Pipfile和Pipfile.lock文件里面的包导出为requirements.txt文件</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv run pip freeze  <span class="comment"># 相当于pipenv run pip freeze &gt;requirements.txt</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv lock -r &gt; requirements.txt</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv lock -r --dev <span class="comment"># 若只想导出开发用的包</span></span></span><br></pre></td></tr></table></figure><h3 id="6-其他命令"><a href="#6-其他命令" class="headerlink" title="6. 其他命令"></a>6. 其他命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 创建一个包含预发布的锁文件:</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv lock --pre</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 打印所有包的依赖关系图</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv graph</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 检查安全漏洞</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipenv check</span></span><br></pre></td></tr></table></figure><p>打印该虚拟环境下所有包的依赖关系图</p><p><img src="http://image.iswbm.com/20190614000336.png" alt=""></p><p>有的python第三方包旧版本会有安全漏洞，使用 pipenv check 可以检查安全漏洞。</p><p><img src="http://image.iswbm.com/20190612215924.png" alt=""></p><h2 id="12-4-【虚拟环境】方案三：使用-pipx"><a href="#12-4-【虚拟环境】方案三：使用-pipx" class="headerlink" title="12.4 【虚拟环境】方案三：使用 pipx"></a>12.4 【虚拟环境】方案三：使用 pipx</h2><h3 id="1-什么是-pipx"><a href="#1-什么是-pipx" class="headerlink" title="1. 什么是 pipx"></a>1. 什么是 pipx</h3><p>pipx 是一款用于帮助你安装和运行那些用 python 编写的终端程序，它类似于 macOS 上的 brew，Ubuntu 上的 apt，CentOS 上的 yum。</p><p>pipx 依赖 pip 和 venv，它只能在 python 3.6+ 的 Python 版本中才能使用。</p><p>默认情况下，pipx 和 pip 一样会从 pypi 上安装包，同时 pipx 也能像 pip 一样从本地、git仓库、wheel 文件中安装包。</p><p>为了避免你在安装 python app时，由于多版本而导致冲突，通常我们会使用 venv 或者 virtualenv 新建一个虚拟环境，然后将 app 安装到虚拟环境中。</p><p>后续你对这个 app 的管理操作，都得先进入这个虚拟环境。</p><p>发现没有？好像有点麻烦。</p><p>pipx 的存在使这个流程变得更加舒畅，使用 pipx 你可以无需关注虚拟环境的存在，并在你的机器上安装多个版本的 python app。</p><h3 id="2-安装使用"><a href="#2-安装使用" class="headerlink" title="2. 安装使用"></a>2. 安装使用</h3><p>安装 pipx</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3 -m pip install --user pipx</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3 -m userpath append ~/.local/bin</span></span><br><span class="line">Success!</span><br></pre></td></tr></table></figure><p>使用 Pipx 需要注意两个路径</p><ol><li>二进制文件的保存位置：默认是 <code>~/.local/bin</code>，可使用环境变量 <code>PIPX_BIN_DIR</code> 进行更改，或者执行如下命令(<code>python3 -m userpath append $&#123;you_path&#125;</code>)</li><li>虚拟环境的保存位置：默认是 <code>~/.local/pipx</code>，可使用环境变量 <code>PIPX_HOME</code> 进行更改</li></ol><p>在我安装好 pipx ，准备使用的时候，发现全局找不到 pipx 这个命令。</p><p><img src="http://image.iswbm.com/image-20201130124107950.png" alt=""></p><p>按照如上图所示，难道使用全路径执行命令？</p><p><strong>不，怎么都觉得不太对劲。。</strong></p><p>想要解决这个问题，其实很简单，有两种方法（两种都可以，我演示使用的第一种方法）：</p><ol><li>添加个软链接指向刚刚那个全路径就好啦</li><li>将这个路径添加到 PATH 中 <code>/Users/MING/Library/Python/3.9/bin/</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ln</span> -s /Users/MING//Library/Python/3.9/bin/pipx /usr/local/bin/pipx</span></span><br></pre></td></tr></table></figure><p>软链接建好后，就可以直接使用 <code>pipx</code> 的命令啦。</p><p><img src="http://image.iswbm.com/image-20201130124554404.png" alt=""></p><p>刚刚我使用 pipx 安装了 youtube-dl 后，其实并没有将这个 youtube-dl 安装到系统全局的 Python 环境中。</p><p>还记得最开始，我强调过两个非常重要的路径吗？</p><p>现在来看一下，这个路径下面都有哪些东西？</p><p><img src="http://image.iswbm.com/image-20201130125257203.png" alt=""></p><p>从截图上可以看出</p><ul><li>pipx 在 <code>~/.local/pipx/venvs</code> 目录下新建了个名叫 <code>youtube-dl</code> 的虚拟机环境</li><li>并将 <code>youtube-dl</code> 安装到这个虚拟机环境中</li><li>然后在 <code>~/.local/bin</code> 的目录下新建一个软链接，指向这个虚拟环境中</li><li>这样 <code>youtube-dl</code> 就变成全局的工具啦。</li></ul><p><img src="http://image.iswbm.com/image-20201130131138939.png" alt=""></p><p>为了避免你新安装的 youtube-dl 与全局的冲突，你也可以指定 pipx 的命令来运行 youtube-dl </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx run youtube-dl --no-check-certificate https://www.bilibili.com/video/BV1jK4y1h7uA</span></span><br></pre></td></tr></table></figure><p>运行效果如下：</p><p><img src="http://image.iswbm.com/image-20201130210539907.png" alt=""></p><p>pip run 也可以直接执行在线的 python 脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx run https://gist.githubusercontent.com/cs01/fa721a17a326e551ede048c5088f9e0f/raw/6bdfbb6e9c1132b1c38fdd2f195d4a24c540c324/pipx-demo.py</span></span><br><span class="line">pipx is working!</span><br></pre></td></tr></table></figure><h3 id="3-查看包"><a href="#3-查看包" class="headerlink" title="3. 查看包"></a>3. 查看包</h3><p>查看已安装过的包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx list</span></span><br></pre></td></tr></table></figure><h3 id="4-安装包"><a href="#4-安装包" class="headerlink" title="4. 安装包"></a>4. 安装包</h3><p>下载最新版本的 python 包，并安装到新建的虚拟环境中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx install &lt;PACKAGE&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4-运行APP"><a href="#4-运行APP" class="headerlink" title="4. 运行APP"></a>4. 运行APP</h3><p><code>pipx run</code> 后面可接一个包的 url 链接，会将这个包下载下来并运行，也可以接已安装过的应用名来直接运行它</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx run &lt;PACKAGE_URL/APP&gt;</span></span><br></pre></td></tr></table></figure><p>如果一个 app 有多个版本，那么可以通过 <code>spec</code> 指定版本号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx run --spec PACKAGE==1.0.0 app</span></span><br></pre></td></tr></table></figure><p>更神奇的是，pipx 支持指定 git 代码仓库直接运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx run --spec git+https://github.com/psf/black.git black</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 指定分支</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx run --spec git+https://github.com/psf/black.git@branch black</span>  </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 指定某个git hash</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx run --spec git+https://github.com/psf/black.git@ce14fa8b497bae2b50ec48b3bd7022573a59cdb1 black</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 指定某个发行版本</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx run --spec https://github.com/psf/black/archive/18.9b0.zip black <span class="comment"># install a release</span></span></span><br></pre></td></tr></table></figure><h3 id="5-升级包"><a href="#5-升级包" class="headerlink" title="5. 升级包"></a>5. 升级包</h3><p>升级某个包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx upgrade &lt;pkg&gt;</span></span><br></pre></td></tr></table></figure><p>升级全部包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx upgrade-all</span></span><br></pre></td></tr></table></figure><h3 id="6-卸载包"><a href="#6-卸载包" class="headerlink" title="6. 卸载包"></a>6. 卸载包</h3><p>卸载某个包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx uninstall &lt;pkg&gt;</span></span><br></pre></td></tr></table></figure><p>卸载全部包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx uninstall-all</span></span><br></pre></td></tr></table></figure><p>重装全部包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx reinstall-all</span></span><br></pre></td></tr></table></figure><h3 id="7-使用-pip"><a href="#7-使用-pip" class="headerlink" title="7. 使用 pip"></a>7. 使用 pip</h3><p>每执行一次 pipx install 就会新建一个虚拟环境，那我们有没有办法管理这些虚拟机环境呢？</p><p>比如我想看这个虚拟环境里安装了哪些包？</p><p>使用如下命令就可以像使用 pip 一样，来管理 pipx 的虚拟环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipx runpip &lt;env_name&gt; &lt;args&gt;</span></span><br></pre></td></tr></table></figure><p>效果如下</p><p><img src="http://image.iswbm.com/image-20201130215320069.png" alt=""></p><h3 id="8-其他"><a href="#8-其他" class="headerlink" title="8. 其他"></a>8. 其他</h3><p>执行 <code>pipx completions</code> 可以启用 pipx 的补全说明。</p><p>对于不同的终端开启方式不一样，我使用的是 zsh，方法是</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">autoload</span> -U bashcompinit</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bashcompinit</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(register-python-argcomplete pipx)</span>&quot;</span></span></span><br></pre></td></tr></table></figure><p>我安装好后，可以使用 tab 键进行命令补全。</p><p><img src="http://image.iswbm.com/image-20201130220233001.png" alt=""></p><p>执行 <code>pipx ensurepath</code> 可以确保 <code>~/.local/bin</code> 这个重要的目录，已经放入到 <code>$PATH</code> 的变量中。</p><p><img src="http://image.iswbm.com/image-20201130215826513.png" alt=""></p><h3 id="9-pipx-vs-pip"><a href="#9-pipx-vs-pip" class="headerlink" title="9. pipx vs pip"></a>9. pipx vs pip</h3><p>pipx 只是解决 pip 的一个痛点，因此他的适用场景比较单一，它只适用于安装和运行那些有提供命令行入口的app。</p><ul><li>pip 适用于大多数的 Python 版本，而 pipx 需要 Python 3.6+ 才可以使用</li><li>pipx 依赖 pip 和 venv，可以使用 pip 安装pipx ，反过来则不行。</li><li>pip 和 pipx 默认都是从 pypi 上安装包</li><li>pipx 在安装和管理 cli 应用程序时，比 pip 更灵活，它可以在允许在隔离环境中安装和运行 Python 应用</li></ul><h3 id="10-参考文章"><a href="#10-参考文章" class="headerlink" title="10. 参考文章"></a>10. 参考文章</h3><ul><li><a href="https://github.com/pipxproject/pipx">https://github.com/pipxproject/pipx</a></li><li><a href="https://pipxproject.github.io/pipx/comparisons/">https://pipxproject.github.io/pipx/comparisons/</a></li></ul><h2 id="12-5-【虚拟环境】方案四：使用-poetry"><a href="#12-5-【虚拟环境】方案四：使用-poetry" class="headerlink" title="12.5 【虚拟环境】方案四：使用 poetry"></a>12.5 【虚拟环境】方案四：使用 poetry</h2><h3 id="1-安装-poetry"><a href="#1-安装-poetry" class="headerlink" title="1. 安装 poetry"></a>1. 安装 poetry</h3><p>poetry提供多种安装方式，个人推荐从以下2种方式中选择：</p><p>方式一：（推荐）使用在线脚本进行安装，是最为推荐的安装方式</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python</span></span><br></pre></td></tr></table></figure><p>方式二：（pip） 官方不建议这么做，因为有可能会造成依赖冲突，可以考虑用 pipx 或 pipsi</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pip install --user poetry</span></span><br></pre></td></tr></table></figure><p>安装后，可以使用如下命令检测是否可用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry --version</span></span><br><span class="line">Poetry version 1.1.4</span><br></pre></td></tr></table></figure><h3 id="2-创建项目"><a href="#2-创建项目" class="headerlink" title="2. 创建项目"></a>2. 创建项目</h3><p>如果你是在一个已有的项目里使用 Poetry，你只需要执行 poetry init 命令来创建一个 pyproject.toml 文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry init</span></span><br></pre></td></tr></table></figure><p>而如果是新建 一个项目，可以使用这个命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry new demo-priject</span></span><br></pre></td></tr></table></figure><p>运行完后，在当前目录下就会多一个 <code>demo-project</code> 的目录，这个目录下的文件结构如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree demo-priject</span></span><br><span class="line">demo-priject</span><br><span class="line">├── README.rst</span><br><span class="line">├── demo_priject</span><br><span class="line">│   └── __init__.py</span><br><span class="line">├── pyproject.toml</span><br><span class="line">└── tests</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    └── test_demo_priject.py</span><br></pre></td></tr></table></figure><p>如果要把项目代码放入到 src 目录下，在创建项目时，可以加上 <code>--src</code> 参数。</p><h3 id="3-创建虚拟环境"><a href="#3-创建虚拟环境" class="headerlink" title="3. 创建虚拟环境"></a>3. 创建虚拟环境</h3><p>使用 poetry install 命令创建虚拟环境（确保当前目录有 pyproject.toml 文件）：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry install</span></span><br></pre></td></tr></table></figure><p>这个命令会读取 pyproject.toml 中的所有依赖（包括开发依赖）并安装，如果不想安装开发依赖，可以附加 —no-dev 选项。如果项目根目录有 poetry.lock 文件，会安装这个文件中列出的锁定版本的依赖。如果执行 add/remove 命令的时候没有检测到虚拟环境，也会为当前目录自动创建虚拟环境。</p><p><img src="http://image.iswbm.com/image-20201220164337699.png" alt=""></p><h3 id="4-使用虚拟环境"><a href="#4-使用虚拟环境" class="headerlink" title="4. 使用虚拟环境"></a>4. 使用虚拟环境</h3><p>创建虚拟环境后，如果想要在虚拟环境下执行命令，比如去执行脚本，去使用 pip list 等等。</p><p>可以在项目目录下，使用如下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry run &lt;commands&gt;</span></span><br></pre></td></tr></table></figure><p>比如我查看该虚拟环境中安装了哪些包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry run pip list</span></span><br></pre></td></tr></table></figure><p>再比如我想在该虚拟环境下执行 <code>app.py</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry run python app.py</span></span><br></pre></td></tr></table></figure><p>每次在虚拟环境下做点啥事，命令前面都要加上 <code>poetry run</code>，有点太麻烦了。</p><p>这时可以使用下面这条命令，直接激活当前的虚拟环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry shell</span></span><br></pre></td></tr></table></figure><h3 id="5-包的管理"><a href="#5-包的管理" class="headerlink" title="5. 包的管理"></a>5. 包的管理</h3><p>安装包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry add &lt;pkg&gt;</span></span><br></pre></td></tr></table></figure><p>添加 —dev 参数可以指定为开发依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry add pytest --dev</span></span><br></pre></td></tr></table></figure><p>查看所有安装的依赖包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry show</span></span><br></pre></td></tr></table></figure><p>加上 <code>--tree</code> 可以查看他们的依赖关系</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry show --tree</span></span><br></pre></td></tr></table></figure><p>加上 <code>--outdated</code> 可以查看可以更新的依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry show --outdated</span></span><br></pre></td></tr></table></figure><p>如果要更新依赖可以执行这个命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 更新全部</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry update</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 更新某个依赖</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry update foo</span></span><br></pre></td></tr></table></figure><p>想卸载某个包，用这个命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry remove foo</span></span><br></pre></td></tr></table></figure><h3 id="6-常用配置"><a href="#6-常用配置" class="headerlink" title="6. 常用配置"></a>6. 常用配置</h3><p>Poetry 的配置存储在单独的文件中，比 Pipenv 设置环境变量的方式要方便一点。配置通过 poetry config 命令设置，比如下面的命令可以写入 PyPI 的账号密码信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry config http-basic.pypi username password</span></span><br></pre></td></tr></table></figure><p>下面的命令设置在项目内创建虚拟环境文件夹：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">poetry config settings.virtualenvs.in-project <span class="literal">true</span></span></span><br></pre></td></tr></table></figure><p>另一个常用的配置是设置 PyPI 镜像源，以使用豆瓣提供的 PyPI 镜像源为例，你需要在 pyproject.toml 文件里加入这部分内容：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[[tool.poetry.source]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;douban&quot;</span></span><br><span class="line"><span class="attr">url</span> = <span class="string">&quot;https://pypi.doubanio.com/simple/&quot;</span></span><br></pre></td></tr></table></figure><p>不过经过测试 Poetry 会使用 pip.ini 设置的 PyPI 镜像，而且豆瓣的源好像很久没更新了（创建虚拟环境安装的默认依赖里 importlib-metadata==0.20 找不到），<a href="https://link.zhihu.com/?target=http%3A//greyli.com/set-custom-pypi-mirror-url-for-pip-pipenv-poetry-and-flit/">这篇文章</a>列出了一些其他国内的 PyPI 源。</p><h3 id="7-参考文章"><a href="#7-参考文章" class="headerlink" title="7. 参考文章"></a>7. 参考文章</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/81025311">相比 Pipenv，Poetry 是一个更好的选择</a></li></ul><h2 id="12-6-【虚拟环境】方案五：使用-venv"><a href="#12-6-【虚拟环境】方案五：使用-venv" class="headerlink" title="12.6 【虚拟环境】方案五：使用 venv"></a>12.6 【虚拟环境】方案五：使用 venv</h2><p>在前面介绍的几种方法中，都需要借助第三方模块来完成虚拟环境的管理。</p><p>但其实在 Python 3 中就自带了一个专门用门管理虚拟环境的模块，它叫 <code>venv</code>。</p><h3 id="1-创建虚拟环境"><a href="#1-创建虚拟环境" class="headerlink" title="1. 创建虚拟环境"></a>1. 创建虚拟环境</h3><p><code>venv</code> 后可以接一个目录（如果此目录不存在，会自动创建）用于创建你的虚拟环境，他可以是绝对路径，也可以是相对路径。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># mac or linux</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3 -m venv [venv_dir]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># windows: 一定要指定  --without-pip</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 最后再手动执行命令安装 python -m ensurepip</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3 -m venv --without-pip [venv_dir]</span></span><br></pre></td></tr></table></figure><p>使用 venv 创建虚拟环境的速度非常快，大概只需要两三秒的样子。</p><p><img src="http://image.iswbm.com/image-20201226172542169.png" alt=""></p><p>创建完成后，在你所指定的目录下会有一个 <code>pyvenv.cfg</code> 的配置文件，它记录着虚拟环境的基本信息，包括你使用的 Python 的家目录，还有当前虚拟环境的 Python 版本，是否开启使用系统的 site-packages 模块，如果开启了，那么当你就可以直接使用系统中已经装过的第三方模块，但是你在虚拟环境下装的模块就不能被其他地方的程序使用。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">home</span> = /usr/local/bin</span><br><span class="line"><span class="attr">include-system-site-packages</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">version</span> = <span class="number">3.9</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure><p>如果你的环境中有 Python 3.8 也有 Python 3.9 ，那该怎么办呢？</p><p>只要你在创建时，用你预期版本的 Python 去执行就好啦</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3.8 -m venv [venv_dir]</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3.9 -m venv [venv_dir]</span></span><br></pre></td></tr></table></figure><p>可如果你的环境中有两个 Python 3.9 呢？你想使用不在 <code>PATH</code> 的中的 Python 去创建，就要用绝对路径去创建了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/usr/local/bin/python3 -m venv [venv_dir]</span></span><br></pre></td></tr></table></figure><h3 id="2-进入创建环境"><a href="#2-进入创建环境" class="headerlink" title="2. 进入创建环境"></a>2. 进入创建环境</h3><p>进入虚拟环境的方法，对比之前介绍的方案，venv 的方法就相当原始了。</p><p>如果你使用 Windows ，那么在 cmd 下进行 <code>Scripts</code> 目录，执行 <code>activate.bat</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># cmd.exe</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">.\Scripts\activate.bat</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># PowserShell</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">.\Scripts\Activate.ps1</span></span><br></pre></td></tr></table></figure><p>如果你使用PowserShell激活虚拟环境出现如下错误，那要先执行这个命令：<code>Set-ExecutionPolicy RemoteSigned</code>，再按 <code>Y</code></p><p><img src="http://image.iswbm.com/20201231140727.png" alt=""></p><p>而如果你使用的 Mac 或者 Linux，那么直接执行下面命令就行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">source</span> bin/activate</span></span><br></pre></td></tr></table></figure><p>执行完后，若在你的命令行下有 <code>demo</code> 字样（之所以是 demo ，因为我们创建时的目录名就是 demo），说明你已经处于虚拟环境下。 由于虚拟环境是全新的干净环境，此时你使用 <code>pip list</code> ，会看到啥包都没有，只有最基本的 pip 和 setuptools 。</p><p><img src="http://image.iswbm.com/image-20201226174305992.png" alt=""></p><h3 id="3-退出虚拟环境"><a href="#3-退出虚拟环境" class="headerlink" title="3. 退出虚拟环境"></a>3. 退出虚拟环境</h3><p>退出虚拟环境，无论是 Windows 、 Mac 、 还是 Linux ，方法都是同一条命令。退出后，你的虚拟环境名称（如上面的 <code>demo</code> ）也会消失。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">deactivate</span></span><br></pre></td></tr></table></figure><h3 id="4-总结一下"><a href="#4-总结一下" class="headerlink" title="4. 总结一下"></a>4. 总结一下</h3><p><code>venv</code> 是 Python3 中自带的虚拟环境管理工具，不需要额外安装，功能简单，用法也简单。但是它不能像 poetry 和 pipenv 用于项目的管理，因此 venv 建议只做了解，在一些简单的场景中可以使用，如果是复杂的项目中，可以直接上 poetry 和 pipenv。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：本文介绍Python中常用虚拟环境的用法。</summary>
    
    
    
    <category term="python" scheme="https://hwame.top/categories/python/"/>
    
    
    <category term="python" scheme="https://hwame.top/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Windows命令行中正确显示颜色</title>
    <link href="https://hwame.top/20210618/ansi-color-in-windows-cmd.html"/>
    <id>https://hwame.top/20210618/ansi-color-in-windows-cmd.html</id>
    <published>2021-06-18T12:03:20.000Z</published>
    <updated>2021-06-27T10:33:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：win10的cmd对颜色的显示不太友好，在捯饬的过程中差点把电脑搞崩。<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>参考资料：</strong></p><ul><li><a href="https://blog.csdn.net/qq_15158911/article/details/88943571">解决CMD命令行窗口不显示颜色问题python</a></li><li><a href="https://blog.csdn.net/qq_23452385/article/details/109271221">cmd命令提示符文本颜色输出</a></li><li><a href="https://github.com/adoxa/ansicon">Github ANSICON</a></li><li><a href="https://blog.csdn.net/Chameleons1/article/details/107338482">CMD窗口无法显示带颜色文字输出</a></li><li><a href="https://blog.csdn.net/agzhchren/article/details/78940058">特殊命令之REG命令</a></li><li><a href="https://blog.51cto.com/me2xp/1437542">转义序列Escape Sequences及Linux echo命令多种颜色显示</a></li><li><a href="https://www.cnblogs.com/crabxx/p/4046498.html">Linux终端和win32控制台文本颜色输出</a></li><li><a href="https://my.oschina.net/dingdayu/blog/1537064">控制台输出颜色控制（Console 模式下的颜色显示）</a></li><li><a href="https://www.kancloud.cn/skyerisme/tech_knowledge/1778337">命令行里输出带颜色的字体</a></li><li><a href="https://my.oschina.net/SamXIAO/blog/2959478">Windows cmd(DOS)命令窗口中echo命令ANSI转义显示彩色字或背景</a></li></ul><p><strong>文章链接：</strong><a href="https://hwame.top/20210618/ansi-color-in-windows-cmd.html">Windows命令行中正确显示颜色</a></p></blockquote><h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h2><blockquote><p>为了搞好这个问题，差点把电脑给搞崩了，在这里特意记录下来，算是留给自己的一个教训。</p></blockquote><p>临近毕业，这两天什么事情都没有，就等着参加毕业典礼然后跑路。就想着写点东西吧，hexo部署的时候无法正常显示颜色。如图（注意最后一行）：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210620颜色显示异常.png" alt="颜色显示异常"><br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210620颜色显示正常.png" alt="颜色显示正常"></p><p>其实呢，这个问题早就出现了，见<a href="https://hwame.top/20200520/hello-hexo-setup-deploy.html#5-5-%E9%83%A8%E7%BD%B2Hexo">Hexo博客搭建(1)——建站及部署之部署Hexo</a>，只不过一直没管它，现在闲下来了就想拯救一下处女座强迫症。</p><p>不仅如此，cmd中只能识别<code>^[[35m 文字 ^[[0m</code>而不能识别<code>\33[35m 文字 \33[0m</code>，也就是说无法正确转义<code>\033</code>。</p><p>需要注意的是，<code>^[</code>是一个字符，且只能在命令行下通过组合键<code>Ctrl + [</code>输入（还有其他方式输入，见后文）。</p><p>鉴于以上问题，在经过较长时间的折腾后，找到了一个可用的方法：<a href="https://github.com/adoxa/ansicon">ANSICON</a>。</p><h2 id="2-解决方案"><a href="#2-解决方案" class="headerlink" title="2.解决方案"></a>2.解决方案</h2><h3 id="2-1-colorama"><a href="#2-1-colorama" class="headerlink" title="2.1.colorama"></a>2.1.<code>colorama</code></h3><p>在Python中显示颜色主要参考「<a href="https://blog.csdn.net/qq_15158911/article/details/88943571">解决CMD命令行窗口不显示颜色问题python</a>」，用到的库为<code>colorama</code>，代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> colorama <span class="keyword">import</span> init </span><br><span class="line">init(autoreset=<span class="literal">True</span>)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\033[35m 紫色 \033[0m&quot;</span>) <span class="comment">#紫色</span></span><br></pre></td></tr></table></figure></p><p>上述方法通过颜色代码实现颜色的显示，也可以使用<code>Fore</code>设置颜色：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> colorama <span class="keyword">import</span> init, Fore</span><br><span class="line">init(autoreset=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;黄色&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;普通文字&quot;</span>) </span><br><span class="line"><span class="built_in">print</span>(Fore.MAGENTA + <span class="string">&quot;洋红色&quot;</span>)</span><br></pre></td></tr></table></figure><br><code>colorama</code>方法只适用于python程序在终端上打印彩色文字，并不能解决其他程序的输出。</p><h3 id="2-2-ANSICON"><a href="#2-2-ANSICON" class="headerlink" title="2.2.ANSICON"></a>2.2.<code>ANSICON</code></h3><p>鉴于上述问题，在查找了海量资料后，参考「<a href="https://blog.csdn.net/qq_23452385/article/details/109271221">cmd命令提示符文本颜色输出</a>」，最终找到了<a href="https://github.com/adoxa/ansicon">ANSICON</a>。<br>ANSICON基本上可以完美解决遇到的关于cmd颜色的所有问题，这是它的自我介绍：</p><blockquote><p>ANSICON provides ANSI escape sequences for Windows console programs. It provides much the same functionality as <code>ANSI.SYS</code> does for MS-DOS.</p></blockquote><p>在64位Windows上，ANSICON包含了主程序<code>ansicon.exe</code>和扩展<code>ANSI64.dll</code>，在cmd中运行该程序即可<strong>开启一个子shell</strong>，在子shell中即可<a href="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210620颜色显示正常.png">正常显示</a>颜色，不会出现<a href="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210620颜色显示异常.png">图一</a>的问题。</p><p>ANSICON帮助信息如下：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ANSICON <span class="keyword">by</span> Jason Hood &lt;jadoxa@yahoo.com.au&gt;.</span><br><span class="line"><span class="keyword">Version</span> 1.89 (29 April, 2019).  Freeware.</span><br><span class="line">http:<span class="comment">//ansicon.adoxa.vze.com/</span></span><br><span class="line"></span><br><span class="line">Process ANSI escape sequences <span class="keyword">in</span> Windows console programs.</span><br><span class="line"></span><br><span class="line">ansicon [-lLEVEL] [-i] [-I] [-<span class="keyword">u</span>] [-<span class="keyword">U</span>] [-<span class="keyword">m</span>[ATTR]] [-p[<span class="keyword">u</span>]]</span><br><span class="line">        [-<span class="keyword">e</span>|<span class="keyword">E</span> STRING | -t|T [<span class="keyword">FILE</span>...] | <span class="keyword">PROGRAM</span> [<span class="keyword">ARGS</span>]]</span><br><span class="line"></span><br><span class="line">  -<span class="keyword">l</span>            <span class="keyword">set</span> the logging level (1=process, 2=module, 3=function,</span><br><span class="line">                 +4=output, +8=<span class="keyword">append</span>, +16=imports, +32=files) <span class="keyword">for</span> <span class="keyword">PROGRAM</span></span><br><span class="line">  -i            install - add ANSICON to CMD&#x27;s AutoRun entry (also implies -p)</span><br><span class="line">  -<span class="keyword">u</span>            uninstall - remove ANSICON from the AutoRun entry</span><br><span class="line">  -I -<span class="keyword">U</span>         <span class="keyword">use</span> <span class="keyword">local</span> machine instead of current user</span><br><span class="line">  -<span class="keyword">m</span>            <span class="keyword">use</span> grey <span class="keyword">on</span> black (<span class="string">&quot;monochrome&quot;</span>) or ATTR <span class="keyword">as</span> default color</span><br><span class="line">  -p            hook into the parent process</span><br><span class="line">  -pu           unhook from the parent process</span><br><span class="line">  -<span class="keyword">e</span>            echo STRING</span><br><span class="line">  -<span class="keyword">E</span>            echo STRING, don&#x27;t <span class="keyword">append</span> newline</span><br><span class="line">  -t            <span class="keyword">display</span> files (<span class="string">&quot;-&quot;</span> <span class="keyword">for</span> stdin), combined <span class="keyword">as</span> a single stream</span><br><span class="line">  -T            <span class="keyword">display</span> files, name first, blank <span class="keyword">line</span> before and after</span><br><span class="line">  <span class="keyword">PROGRAM</span>       <span class="keyword">run</span> the specified <span class="keyword">program</span></span><br><span class="line">  nothing       <span class="keyword">run</span> a new command processor, or <span class="keyword">display</span> stdin <span class="keyword">if</span> redirected</span><br><span class="line"></span><br><span class="line">ATTR is <span class="keyword">one</span> or <span class="keyword">two</span> hexadecimal digits; please <span class="keyword">use</span> <span class="string">&quot;COLOR /?&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">It may start with &#x27;-&#x27; to reverse foreground and background (but not <span class="keyword">for</span> -p).</span><br></pre></td></tr></table></figure></p><p>由上可知，直接运行该程序将不带任何参数，开启一个新的命令行进程，这也是后来悲催的直接原因。现在看来，貌似只需要加上<code>-i</code>选项将其添加到cmd的<code>AutoRun</code>即可。</p><h2 id="3-采坑之路"><a href="#3-采坑之路" class="headerlink" title="3.采坑之路"></a>3.采坑之路</h2><h3 id="3-1-问题产生"><a href="#3-1-问题产生" class="headerlink" title="3.1.问题产生"></a>3.1.问题产生</h3><p>到目前为止，好像一切正常，文章开始说的「差点把电脑搞崩」又是怎么回事呢？</p><p>因为担心会出现其他问题，所以并没有安装ANSICON，开启子shell<strong>好像</strong>也没有什么问题，无非就是每次都要手动输入命令<code>/path/to/ansicon.exe</code>。这也不是什么问题，只要把<code>ansicon.exe</code>文件路径加入到环境变量中即可。<br>为了省事我直接把<code>ansicon.exe</code>和<code>ANSI64.dll</code>复制到<code>C:/Windows/System32/</code>目录下，这样一来在任何命令行下都可以直接运行<code>ansicon</code>命令了。</p><p>当需要正常显示颜色时，输入<code>ansicon</code>即可，如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210627ansicon命令.png" alt="ansicon命令开启子shell"><br>上图中，直接打印颜色将显示乱码，在ansicon的子shell中则可以正常显示，输入<code>exit</code>才可退出shell。此时再打印颜色仍会乱码，因为只有在ansicon的shell中才可以正常显示。</p><p>在查资料的时候，偶然看到了一篇文章：<a href="https://blog.csdn.net/Chameleons1/article/details/107338482">CMD窗口无法显示带颜色文字输出</a>。文章中提到，利用注册表的<code>AutoRun</code>字符串值可以实现在打开CMD窗口时自动执行命令。于是，我就设想修改注册表，在每次打开CMD的时候让他自动执行<code>ansicon</code>命令，那么就不需要手动输入了。</p><p>说干就干，<code>Win + R</code>打开运行，输入<code>regedit</code>打开注册表编辑器，定位到<code>计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Command Processor</code>下，新建字符串值<code>AutoRun</code>，双击该值，在数值数据中填写<code>ansicon</code>，一气呵成。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210627修改注册表.png" alt="修改注册表"></p><p>此时我已经迫不及待地要测试了，然而，当我打开cmd的时候，窗口中却疯狂打印<code>Microsoft Windows [版本 10.0.18363.1556](c) 2019 Microsoft Corporation。保留所有权利。</code>，此时我已经感觉不妙。好在它只开了一个窗口（注意，这是一个伏笔……），我不得不一直按<code>Ctrl + C</code>让它停下来，甚至直接叉掉这个窗口。</p><p>我又查了半天，一直都以为是注册表修改方式不对，又不知道在哪里看到了<code>cmd /k xxx</code>这样的一个命令，就是这个命令让我的电脑直接崩溃。该命令会打开一个新窗口来执行<code>xxx</code>命令。于是抱着试一试的心态我把上面注册表的数值数据改成了<code>cmd /k ansicon</code>，当我打开CMD窗口的一瞬间，电脑内存急剧增加，无限开启新窗口并执行<code>ansicon</code>命令。</p><p>自此走上了修电脑的艰难之路。</p><h3 id="3-2-艰难解决"><a href="#3-2-艰难解决" class="headerlink" title="3.2.艰难解决"></a>3.2.艰难解决</h3><p>由于电脑内存卡爆，无法进行任何操作，就算想删除注册表值也没办法，因为鼠标键盘根本动不了。无奈之下，准备重启电脑，跟它抢速度，在内存爆满之前把注册表改回来。事实证明我还是太天真了，电脑一开机他就开始了，根本不给时间你去做其他操作，如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210627内存爆满.png" alt="内存爆满"></p><p>到这里已经没有任何办法了，系统还原也不行，因为我很早就删除了系统还原点（只为节省那么一丢丢内存…），现在只能重装系统了，甚至连U盘启动盘都做好了。重装系统倒是无所谓，但是电脑里有很多重要的文件、配置、安装的软件等。我真的不想重装系统，但是没办法啊！</p><p>上图是准备重装系统之前拍的照，为的是留一个桌面布局，可以看到右侧命令行窗口边缘厚厚的一层黑边，都不知道开了多少个窗口了。</p><p>从U盘重装系统还要设置一下BIOS，开启UEFI什么的。然而哪有那么顺利，就在我失败了无数次一心想要操作系统的时候，他却提示各种错误，要么是某个地方设置不对、要么是某个选项没有开启。在反复的重启和设置中，突然发现了一个修复的选项。在这种连系统都不让我重装的情况下，无疑给了我一丝希望。</p><p>然而，新的问题又出现了，所有的修复选项都试过了还是没用，这让我整个人都不好了，一度濒临崩溃。</p><p>世事总是这样，在你最绝望的时候才会显现一丝曙光。</p><p>在某一个修复选项中，可以打开命令行窗口，目测盘符<code>X</code>应该是U盘吧，<code>Source</code>目录就是启动盘的位置。如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/miscellanea/20210627命令行窗口X.png" alt="命令行窗口X"></p><p>但是一个命令行能干什么呢？这里的命令行是有管理员权限的，最直接的想法就是在这里删除注册表值，然后重启就完美了。<br>搜了一下，发现还真有操作注册表的命令<code>REG</code>，还有对应的<code>QUREY</code>、<code>ADD</code>、<code>DELETE</code>等选项，此处参考了<a href="https://blog.csdn.net/agzhchren/article/details/78940058">特殊命令之REG命令</a>。这令我大喜过望，感觉胜利就在眼前。然而，当我查询<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Command Processor</code>下的值时，却没有<code>AutoRun</code>这一项（如上图），只有如下几项：<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">CompletionChar</span>      REG_DWORD    <span class="number">0</span>x9</span><br><span class="line"><span class="attribute">DefaultColor</span>        REG_DWORD    <span class="number">0</span>x0</span><br><span class="line"><span class="attribute">EnableExtensions</span>    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line"><span class="attribute">PathCompletionChar</span>  REG_DWORD    <span class="number">0</span>x9</span><br></pre></td></tr></table></figure><br>通过对比<a href="#3-1-%E9%97%AE%E9%A2%98%E4%BA%A7%E7%94%9F">3.1节《问题产生》</a>的图二和上图，唯独少了<code>AutoRun</code>这一项。这另外百思不得其解的同时，也是十分郁闷。我测试过<code>REG ADD</code>和<code>REG DELETE</code>，好像都成功了，为何这里就查询不到呢？看来这个方法又行不通了。</p><p>就在我一筹莫展的时候，突然灵机一动，产生问题的根本原因在于无限启动新窗口从而运行<code>ansicon</code>命令，那我可以人为破坏掉他的运行环境啊。<br>于是我在命令行里试着删除文件<code>C:\Windows\System32\ANSI64.dll</code>，结果成功了。</p><p>赶紧重启电脑，尽管仍然会无限开启新窗口，但果然没那么卡了，因为<code>ansicon</code>命令无法正常运行。于是可以打开注册表编辑器，删除掉罪魁祸首<code>AutoRun</code>，再重启电脑就恢复正常了。</p><p>至此，历经千辛万苦，电脑总算是修好了，可算是不需要重装系统了。</p><h2 id="4-附录"><a href="#4-附录" class="headerlink" title="4.附录"></a>4.附录</h2><h3 id="4-1-ANSI颜色序列格式"><a href="#4-1-ANSI颜色序列格式" class="headerlink" title="4.1.ANSI颜色序列格式"></a>4.1.ANSI颜色序列格式</h3><blockquote><p>本段来自<a href="https://blog.51cto.com/me2xp/1437542">转义序列Escape Sequences及Linux echo命令多种颜色显示</a>。<br>在计算机界，ANSI<strong>转义编码（escape code）</strong>或者<strong>转义序列（escape sequences）</strong>是带内信号（元数据和控制信号，译者注）控制视频文字终端的格式、颜色、其他输出选项的一种方法。<br>为了编码这些格式信息，它把某种字节序列嵌入到文本中，该序列必须特别的解释，且不应该作为字符的本义。<br>尽管硬件字符终端在21世纪已经变得很愈来愈少见，这种标准依然具有实用价值，是因为大多数终端仿真器至少还能解释在输出文本中的一些ANSI转义序列。<br>但微软的win32控制台组件就是一个明显的例外。</p></blockquote><p>上文中的「<code>\033[35m</code>」和「<code>\033[0m</code>」就是ANSI转义序列（ANSI escape code/sequence），转义序列使用ESC控制字符开始，ESC键位于键盘左上角，其对应的ASCII码为<code>\033（八进制）</code>、<code>\27（十进制）</code>和<code>\0x1b（十六进制）</code>。</p><p>通用的控制文本颜色的转义序列格式为<code>CSI n1[;n2[;...]] m</code>，其中<code>CSI</code>全称为「控制序列引导器（Control Sequence Introducer/Initiator）」，即上述<code>\033</code>、<code>\x1b</code>和<code>\e</code>等；<code>n1</code>、<code>n2</code>等表示SGR参数，多个SGR参数可以组合使用，见下表。</p><p>通常，我们只需要用到表中部分属性，更详细的属性值可参考<a href="https://www.kancloud.cn/skyerisme/tech_knowledge/1778337">命令行里输出带颜色的字体</a>。</p><p>一般格式：<code>CSI[显示方式;前景色;背景色m 文字 CSI[0m</code>。</p><blockquote><p><strong>注：</strong>经测试，在Linux下<code>\033</code>、<code>\x1b</code>和<code>\e</code>可用，<code>\33</code>、<code>\0x1b</code>和<code>\27</code>不可用。<br><strong>注：</strong>在Windows下只有<code>\033</code>、<code>\33</code>、<code>\x1b</code>、<code>^[</code>可用（不一定准确），<code>\e</code>不可用。</p></blockquote><div class="table-container"><table><thead><tr><th style="text-align:center">编码</th><th style="text-align:center">说明</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td style="text-align:center"><code>0</code></td><td style="text-align:center">关闭所有格式，还原为初始状态</td><td style="text-align:center">终端默认设置</td></tr><tr><td style="text-align:center"><code>1</code></td><td style="text-align:center">粗体/高亮显示</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>2</code></td><td style="text-align:center">模糊/弱化</td><td style="text-align:center">不是所有的终端仿真器都支持，只有少数仿真器支持</td></tr><tr><td style="text-align:center"><code>3</code></td><td style="text-align:center">斜体</td><td style="text-align:center">不是所有的终端仿真器都支持，只有少数仿真器支持</td></tr><tr><td style="text-align:center"><code>4</code></td><td style="text-align:center">下划线（单线）</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>5</code></td><td style="text-align:center">闪烁（慢）</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>6</code></td><td style="text-align:center">闪烁（快）</td><td style="text-align:center">不是所有的终端仿真器都支持，只有少数仿真器支持</td></tr><tr><td style="text-align:center"><code>7</code></td><td style="text-align:center">交换背景色与前景色（反显）</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>8</code></td><td style="text-align:center">隐藏（伸手不见五指，啥也看不见）</td><td style="text-align:center">不是所有的终端仿真器都支持，只有少数仿真器支持</td></tr><tr><td style="text-align:center"><code>22</code></td><td style="text-align:center">设置一般密度</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>24</code></td><td style="text-align:center">关闭下划线</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>25</code></td><td style="text-align:center">关闭闪烁</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>27</code></td><td style="text-align:center">关闭反向图像，即关闭<code>7</code></td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>30-37</code></td><td style="text-align:center">前景色，即<code>30+x</code>，<code>x</code>表示不同的颜色（参见下面的「颜色表」）</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>38</code></td><td style="text-align:center">在缺省的前景颜色上设置下划线</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>39</code></td><td style="text-align:center">在缺省的前景颜色上关闭下划线</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>40-47</code></td><td style="text-align:center">背景色，即<code>40+x</code>，<code>x</code>表示不同的颜色（参见下面的「颜色表」）</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center"><code>49</code></td><td style="text-align:center">设置缺省黑色背景</td><td style="text-align:center">无</td></tr></tbody></table></div><div class="table-container"><table><thead><tr><th style="text-align:center">颜色值<code>x</code></th><th style="text-align:center">前景色编码</th><th style="text-align:center">背景色编码</th><th style="text-align:center">颜色</th><th style="text-align:center">效果</th></tr></thead><tbody><tr><td style="text-align:center"><code>0</code></td><td style="text-align:center"><code>30</code></td><td style="text-align:center"><code>40</code></td><td style="text-align:center">黑色</td><td style="text-align:center"><font color=#000000>黑色</font></td></tr><tr><td style="text-align:center"><code>1</code></td><td style="text-align:center"><code>31</code></td><td style="text-align:center"><code>41</code></td><td style="text-align:center">红色</td><td style="text-align:center"><font color=#FF0000>红色</font></td></tr><tr><td style="text-align:center"><code>2</code></td><td style="text-align:center"><code>32</code></td><td style="text-align:center"><code>42</code></td><td style="text-align:center">绿色</td><td style="text-align:center"><font color=#008000>绿色</font></td></tr><tr><td style="text-align:center"><code>3</code></td><td style="text-align:center"><code>33</code></td><td style="text-align:center"><code>43</code></td><td style="text-align:center">黄色</td><td style="text-align:center"><font color=#FFFF00>黄色</font></td></tr><tr><td style="text-align:center"><code>4</code></td><td style="text-align:center"><code>34</code></td><td style="text-align:center"><code>44</code></td><td style="text-align:center">蓝色</td><td style="text-align:center"><font color=#0000FF>蓝色</font></td></tr><tr><td style="text-align:center"><code>5</code></td><td style="text-align:center"><code>35</code></td><td style="text-align:center"><code>45</code></td><td style="text-align:center">紫色</td><td style="text-align:center"><font color=#800080>紫色</font></td></tr><tr><td style="text-align:center"><code>6</code></td><td style="text-align:center"><code>36</code></td><td style="text-align:center"><code>46</code></td><td style="text-align:center">青色</td><td style="text-align:center"><font color=#00FFFF>青色</font></td></tr><tr><td style="text-align:center"><code>7</code></td><td style="text-align:center"><code>37</code></td><td style="text-align:center"><code>47</code></td><td style="text-align:center">白色</td><td style="text-align:center"><font color=#FFFFFF>白色</font></td></tr></tbody></table></div><h3 id="4-2-设置颜色"><a href="#4-2-设置颜色" class="headerlink" title="4.2.设置颜色"></a>4.2.设置颜色</h3><p>一般格式：<code>CSI</code> <code>[</code> <code>显示方式;</code> <code>前景色;</code> <code>背景色</code> <code>m</code> <code>文字部分</code> <code>CSI</code> <code>[</code> <code>0</code> <code>m</code>。</p><div class="table-container"><table><thead><tr><th style="text-align:center"><code>CSI</code></th><th style="text-align:center">显示方式</th><th style="text-align:center">前景色</th><th style="text-align:center">背景色</th></tr></thead><tbody><tr><td style="text-align:center"><code>\033</code> <code>\x1b</code> <code>\e</code><br><code>ESC（^[）</code></td><td style="text-align:center"><code>0-9</code>等</td><td style="text-align:center"><code>30-37</code></td><td style="text-align:center"><code>40-47</code></td></tr></tbody></table></div><p>需要说明的是，在同一处的CSI最好保持一致，「显示方式」、「前景色」和「背景色」的顺序不重要。</p><p>关于Windows下CMD中<code>ESC（^[）</code>的输入方式，参考<a href="https://my.oschina.net/SamXIAO/blog/2959478">《Windows cmd(DOS)命令窗口中echo命令ANSI转义显示彩色字或背景》</a>：</p><blockquote><p>Windows下CMD中<code>^[</code>是ANSI的ESC一个字符（注意<code>^</code>和<code>[</code>是一个字符，就好比我们<code>Ctrl + C</code>时显示的<code>^C</code>一样），并不是我们看到的键盘上左上角那个ESC按键。其ASCII码值的十进制是<code>27</code>， 八进制是<code>33</code>（一般写为<code>\033</code>)，十六进制是<code>1b</code>（一般写为<code>\x1b</code>）。其输入方法有以下几种：</p><ul><li><strong>方法一</strong>（只能在CMD窗口中输入）：在CMD窗口中按<code>Ctrl + [</code>组合键即可，这种方法最简单。</li><li><strong>方法二</strong>（只能在CMD窗口中输入）：在CMD窗口中按<code>Alt + 2 + 7</code>组合键即可，注意必须是小键盘上的数字键<code>2</code>和<code>7</code>，先按住<code>Alt</code>不放再按<code>2</code>和<code>7</code>最后放开<code>Alt</code>。如果没有数字小键盘，则不能用这种方式。</li><li><strong>方法三</strong>（编辑器中先输入再替换）：略。垃圾软件不配。</li></ul></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：win10的cmd对颜色的显示不太友好，在捯饬的过程中差点把电脑搞崩。</summary>
    
    
    
    <category term="miscellanea" scheme="https://hwame.top/categories/miscellanea/"/>
    
    
    <category term="miscellanea" scheme="https://hwame.top/tags/miscellanea/"/>
    
  </entry>
  
  <entry>
    <title>如何将嵌套列表展开为一维</title>
    <link href="https://hwame.top/20210610/flatten-a-nested-list.html"/>
    <id>https://hwame.top/20210610/flatten-a-nested-list.html</id>
    <published>2021-06-10T11:56:05.000Z</published>
    <updated>2021-06-20T10:43:21.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>参考资料：</strong></p><ul><li><a href="https://stackoverflow.com/questions/952914/how-to-make-a-flat-list-out-of-a-list-of-lists">How to make a flat list out of a list of lists?</a></li><li><a href="http://rightfootin.blogspot.com/2006/09/more-on-python-flatten.html">Right Foot In: More on python flatten</a>（有缘人才能打开）</li><li><a href="https://stackoverflow.com/questions/2158395/flatten-an-irregular-list-of-lists">Flatten an irregular list of lists</a></li><li><a href="https://mathieularose.com/how-not-to-flatten-a-list-of-lists-in-python">How Not to Flatten a List of Lists in Python</a></li></ul><p><strong>文章链接：</strong><a href="https://hwame.top/20210610/flatten-a-nested-list.html">https://hwame.top/20210610/flatten-a-nested-list.html</a></p></blockquote><h2 id="1-引言"><a href="#1-引言" class="headerlink" title="1.引言"></a>1.引言</h2><p>闲来无事逛<a href="https://stackoverflow.com">Stack Overflow</a>，发现了一个挺有意思的问题：<a href="https://stackoverflow.com/questions/952914/how-to-make-a-flat-list-out-of-a-list-of-lists">How to make a flat list out of a list of lists?</a>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 怎样快速优雅地将src转换成dst？</span></span><br><span class="line">src = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>], [<span class="number">8</span>, <span class="number">9</span>]]</span><br><span class="line">dst = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br></pre></td></tr></table></figure><p>乍一看，对于所给的二维数组，<code>for</code>循环是最容易想到的思路，但是有没有<font color=purple><b>some cool “one-liner”</b></font>的办法呢？顺着这个问题往下看，还挺有意思。</p><p><strong>说明：</strong>此处仅讨论各方法的正确性，至于性能和效率可自行测试。</p><h2 id="2-解决方案"><a href="#2-解决方案" class="headerlink" title="2.解决方案"></a>2.解决方案</h2><h3 id="2-1-方法一：functools-reduce"><a href="#2-1-方法一：functools-reduce" class="headerlink" title="2.1.方法一：functools.reduce"></a>2.1.方法一：<code>functools.reduce</code></h3><p>该问题的提出者<a href="https://stackoverflow.com/users/110527/emma">Emma</a>提供了一个思路，利用标准库函数<code>reduce</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line">src = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>], [<span class="number">8</span>, <span class="number">9</span>]]</span><br><span class="line"><span class="comment">#reduce(lambda x, y: x.extend(y), src)</span></span><br><span class="line">reduce(<span class="keyword">lambda</span> x, y: x + y, src)</span><br></pre></td></tr></table></figure><br>这个方法是可行的，但为何不能用<code>x.extend(y)</code>呢？原因是列表的<code>extend</code>方法不返回值（返回<code>None</code>），故在下一轮次的reduce过程中会导致<code>None.extend</code>，从而<code>raise AttributeError: &#39;NoneType&#39; object has no attribute &#39;extend&#39;</code>。而<strong>列表</strong>加法则会返回「extended」列表。</p><p>如果非要用<code>extend</code>呢？既然返回<code>None</code>，我们是否可以人为给返回赋值？<a href="https://stackoverflow.com/users/437728/lbarret">LBarret</a>给出了一个方案：<code>reduce(lambda x, y : x.extend(y) or x, src, [])</code>，或者省略<code>initial</code>参数：<code>reduce(lambda x, y : x.extend(y) or x, src)</code>。其中<code>x.extend(y) or x</code>实现了<code>x + y</code>并返回<code>x</code>，因为<code>bool(x.extend(y)) = False</code>。</p><p><a href="https://stackoverflow.com/users/893/greg-hewgill">Greg Hewgill</a>提到，<code>extend()</code>方法会修改列表<code>x</code>，而不是返回一个<code>functools.reduce()</code>所期望的「有用的」值，因此<code>x + y</code>优于<code>x.extend(y)</code>。</p><p>需要指出的是，这种<code>reduce</code>方法只能解决二维数组，多层嵌套或非列表元素将抛错，例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">src1 = [[<span class="number">1</span>], [], [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], <span class="number">5</span>]           <span class="comment"># 含有非列表元素5</span></span><br><span class="line">src2 = [[<span class="number">1</span>], [], [<span class="number">2</span>, <span class="number">3</span>], [[<span class="number">4</span>], [<span class="number">5</span>, <span class="number">6</span>]]]  <span class="comment"># 多层嵌套</span></span><br><span class="line">reduce(<span class="keyword">lambda</span> x, y: x + y, src1)</span><br><span class="line"><span class="comment"># TypeError: can only concatenate list (not &quot;int&quot;) to list</span></span><br><span class="line"></span><br><span class="line">reduce(<span class="keyword">lambda</span> x, y: x + y, src2)</span><br><span class="line"><span class="comment"># [1, 2, 3, [4], [5, 6]]</span></span><br><span class="line"><span class="comment"># 只能展开一层，若再reduce一次则含非列表元素</span></span><br></pre></td></tr></table></figure></p><h3 id="2-2-方法二：列表生成式"><a href="#2-2-方法二：列表生成式" class="headerlink" title="2.2.方法二：列表生成式"></a>2.2.方法二：列表生成式</h3><p>列表生成式也是很容易想到的办法，因为它本质上就是<code>for</code>循环：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列表生成式</span></span><br><span class="line">dst = [item <span class="keyword">for</span> sublist <span class="keyword">in</span> src <span class="keyword">for</span> item <span class="keyword">in</span> sublist]</span><br><span class="line"></span><br><span class="line"><span class="comment"># for循环等价写法</span></span><br><span class="line">dst = []</span><br><span class="line"><span class="keyword">for</span> sublist <span class="keyword">in</span> src:</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> sublist:</span><br><span class="line">        dst.append(item)</span><br><span class="line"></span><br><span class="line"><span class="comment"># lambda表达式</span></span><br><span class="line">flatten = <span class="keyword">lambda</span> t: [item <span class="keyword">for</span> sublist <span class="keyword">in</span> t <span class="keyword">for</span> item <span class="keyword">in</span> sublist]</span><br><span class="line">dst = flatten(src)</span><br></pre></td></tr></table></figure><br>两层<code>for</code>循环写成列表生成式不太直观，借用<a href="https://stackoverflow.com/users/75033/john-mee">John Mee</a>的例子会更容易理解和应用：<code>[leaf for tree in forest for leaf in tree]</code>。表达式中「叶 → 树 → 林」的关系很清晰地表现了内外循环的层级。</p><p>当然也有不同的观点，例如<a href="https://stackoverflow.com/users/6419007/eric-duminil">Eric Duminil</a>和<a href="https://stackoverflow.com/users/1335793/davos">Davos</a>。尽管John Mee的写法与<code>for</code>循环相同，但顺序杂乱不易理解（直观仅限于<code>leaf</code>、<code>tree</code>和<code>forest</code>），Davos更推荐使用<code>leaf for leaf in tree for tree in forest</code>这种「递进式写法」。</p><h3 id="2-3-方法三：itertools-chain"><a href="#2-3-方法三：itertools-chain" class="headerlink" title="2.3.方法三：itertools.chain"></a>2.3.方法三：<code>itertools.chain</code></h3><p><code>itertools.chain</code>先将二维数组解包为一维然后连接为迭代器，再转化为列表；<code>itertools.chain.from_iterable</code>则无需先解包：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line">src = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>], [<span class="number">8</span>, <span class="number">9</span>]]</span><br><span class="line"></span><br><span class="line">dst = <span class="built_in">list</span>(itertools.chain(*src))</span><br><span class="line">dst = <span class="built_in">list</span>(itertools.chain.from_iterable(src))</span><br></pre></td></tr></table></figure><br>借用该回答下<a href="https://stackoverflow.com/users/1342079/tim-dierks">Tim Dierks</a>的评论，<code>*</code>将列表解包为多个参数传递给<code>chain</code>，导致将顶级列表（最外层）扩展为参数，再将这些可迭代对象连接在一起而不会进入更深层级。在这种情况下，列表生成式将比链式用法的可读性更好。</p><h3 id="2-4-方法四：sum"><a href="#2-4-方法四：sum" class="headerlink" title="2.4.方法四：sum"></a>2.4.方法四：<code>sum</code></h3><p>这种方法既不直观也不高效，但是很有趣，计算机科学中的monoids定义如下：</p><blockquote><p><strong><a href="https://en.wikipedia.org/wiki/Monoid#Monoids_in_computer_science">Monoids in computer science</a></strong>【来自维基百科】</p><p>在计算机科学中，许多<a href="https://en.wikipedia.org/wiki/Abstract_data_types">抽象数据类型（Abstract Data Types，ADT）</a>都具有monoid结构。在一个常见的模式中，monoid的一<a href="https://en.wikipedia.org/wiki/Sequence">系列</a>元素被「<a href="https://en.wikipedia.org/wiki/Fold_(higher-order_function"><strong>折叠</strong></a>)」或「<strong>累积</strong>」以产生最终值。例如，许多迭代算法需要在每次迭代时更新某种「运行总数」；这种模式可以通过monoid运算优雅地表达。或者，monoid运算的关联性确保可以通过使用<a href="https://en.wikipedia.org/wiki/Prefix_sum">前缀和</a>或类似算法来<a href="https://en.wikipedia.org/wiki/Parallelization">并行化</a>运算，以便有效地利用多个内核或处理器。<br>给定一系列「$M$类型」且具有「标识元素$\varepsilon$」和「关联操作$\bullet$」的值，折叠操作定义如下：</p><script type="math/tex; mode=display">\displaystyle \mathrm {fold:} M^{*}\rightarrow M=\ell \mapsto {\begin{cases}\varepsilon &{\mbox{if }}\ell =\mathrm {nil} \\m\bullet \mathrm {fold}\,\ell '&{\mbox{if }}\ell =\mathrm {cons} \,m\,\ell '\end{cases}}</script><p>此外，如果给定其元素的序列化，任何<a href="https://en.wikipedia.org/wiki/Data_structure">数据结构</a>都可以以类似的方式「折叠」。例如，「折叠」<a href="https://en.wikipedia.org/wiki/Binary_tree">二叉树</a>的结果可能会因<a href="https://en.wikipedia.org/wiki/Tree_traversal">遍历方式</a>（前序遍历pre-order与后序遍历post-order）的不同而不同。</p></blockquote><p>代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>], [<span class="number">8</span>, <span class="number">9</span>]]</span><br><span class="line">dst = <span class="built_in">sum</span>(src, [])</span><br></pre></td></tr></table></figure><br>这只是对第一个参数中传递的iterable元素进行求和，而将第二个元素视为总和的初始值。<code>sum</code>函数的声明为<code>sum(iterable, start=0, /)</code>，在上例中如果不传仅限位置参数<code>start</code>，将取默认值<code>0</code>，在这种情况下将抛出<code>TypeError</code>：不能将整数和列表相加。</p><p>毫无疑问，这种方法是所有答案中最「<strong>简洁</strong>」、最「<strong>聪明</strong>」的，答案评论区争论的焦点之一就是低效，原因是列表连接时产生了大量不必要的复制，时间复杂度高达$O(n^2)$。当然，这并非本文重点，有兴趣可移步<a href="https://mathieularose.com/">Mathieu Larose</a>的文章：<a href="https://mathieularose.com/how-not-to-flatten-a-list-of-lists-in-python">How Not to Flatten a List of Lists in Python</a>。</p><p>同时，该方法仅用于二维嵌套列表，对于更深层级的嵌套，则需寻求其他方法。</p><h3 id="2-5-方法五：现有的轮子"><a href="#2-5-方法五：现有的轮子" class="headerlink" title="2.5.方法五：现有的轮子"></a>2.5.方法五：现有的轮子</h3><p>有这么句话，<font color=red><b>Do not reinvent the wheel!</b></font>，即<font color=red><b>不要重复造轮子</b></font>。<a href="https://stackoverflow.com/users/1977620/max-malysh">Max Malysh</a>可谓是贯彻了这一理念，很多第三方库甚至是python自带的库或函数，都提供了相应的方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">src = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>], [<span class="number">8</span>, <span class="number">9</span>]]</span><br><span class="line"><span class="comment"># Django</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.admin.utils <span class="keyword">import</span> flatten</span><br><span class="line">dst = flatten(src)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pandas</span></span><br><span class="line"><span class="keyword">from</span> pandas.core.common <span class="keyword">import</span> flatten</span><br><span class="line">dst = <span class="built_in">list</span>(flatten(src))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Numpy</span></span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> concatenate</span><br><span class="line">dst = <span class="built_in">list</span>(concatenate(src))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Matplotlib</span></span><br><span class="line"><span class="keyword">from</span> matplotlib.cbook <span class="keyword">import</span> flatten</span><br><span class="line">dst = <span class="built_in">list</span>(flatten(src))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Unipath</span></span><br><span class="line"><span class="keyword">from</span> unipath.path <span class="keyword">import</span> flatten</span><br><span class="line">dst = <span class="built_in">list</span>(flatten(src))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Setuptools</span></span><br><span class="line"><span class="keyword">from</span> setuptools.namespaces <span class="keyword">import</span> flatten</span><br><span class="line">dst = <span class="built_in">list</span>(flatten(src))</span><br></pre></td></tr></table></figure><br>pandas提供的<code>flatten</code>函数不仅能解决多层嵌套，还能连接整数和列表，这或许是终极答案了。</p><p>关于造轮子的说法，使用别人造好了的轮子固然可以提高效率，但是自己造轮子难道不是一种更好的学习方式吗？正如<a href="https://stackoverflow.com/users/6084517/nathan-chappell">Nathan Chappell</a>所言：</p><blockquote><p>All these great libraries reinvented the wheel, why shouldn’t I?</p></blockquote><h3 id="2-6-方法六：operator"><a href="#2-6-方法六：operator" class="headerlink" title="2.6.方法六：operator"></a>2.6.方法六：<code>operator</code></h3><p><code>operator</code>模块中提供了很多方法，例如<code>concat</code>、<code>add</code>等，需要配合<code>functools.reduce</code>一起使用：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line">src = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>], [<span class="number">8</span>, <span class="number">9</span>]]</span><br><span class="line"></span><br><span class="line">reduce(operator.concat, src)</span><br><span class="line">reduce(operator.add, src)</span><br></pre></td></tr></table></figure></p><h3 id="2-6-方法七：map"><a href="#2-6-方法七：map" class="headerlink" title="2.6.方法七：map"></a>2.6.方法七：<code>map</code></h3><p><a href="https://stackoverflow.com/users/5922329/daniel-braun">Daniel Braun</a>给出的<code>map</code>方法，个人认为不是很好（可能这也是vote数比较少的原因吧）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">flatten</span>(<span class="params">src</span>):</span><br><span class="line">    dst = []</span><br><span class="line">    tmp = <span class="built_in">list</span>(<span class="built_in">map</span>(dst.extend, src))</span><br><span class="line">    <span class="keyword">return</span> dst</span><br><span class="line"></span><br><span class="line">flatten([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>], [<span class="number">8</span>, <span class="number">9</span>]])</span><br></pre></td></tr></table></figure></p><h2 id="3-其他问题"><a href="#3-其他问题" class="headerlink" title="3.其他问题"></a>3.其他问题</h2><p>上述各种方法都有一定的局限性，最大的问题就是对于数据类型的制约以及嵌套深度的限制，<a href="https://stackoverflow.com/users/4531270/pylang">pylang</a>给出了一种适用于数字、字符串、嵌套列表及其复合体的通用方法，该方法参考了<a href="https://stackoverflow.com/users/680/cristian">Cristian</a>的<a href="https://stackoverflow.com/questions/2158395/flatten-an-irregular-list-of-lists/2158532#2158532">在Flatten an irregular list of lists的回答</a>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Iterable </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flatten</span>(<span class="params">items</span>):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, Iterable) <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(x, (<span class="built_in">str</span>, <span class="built_in">bytes</span>)):</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> flatten(x)</span><br><span class="line">            <span class="comment"># *注：上句可展开为</span></span><br><span class="line">            <span class="comment"># for sub_x in flatten(x):</span></span><br><span class="line">            <span class="comment">#     yield sub_x</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">yield</span> x</span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span>(flatten([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>], [<span class="number">8</span>, <span class="number">9</span>]]))   <span class="comment"># 简单情况</span></span><br><span class="line"><span class="built_in">list</span>(flatten([[<span class="number">1</span>, [<span class="number">2</span>]], (<span class="number">3</span>, <span class="number">4</span>, &#123;<span class="number">5</span>, <span class="number">6</span>&#125;, <span class="number">7</span>), <span class="number">8</span>, <span class="string">&quot;9&quot;</span>])) <span class="comment"># 复杂情况</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;font size=5&gt;&lt;b&gt;文章说明&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;strong&gt;文章作者：&lt;/strong&gt;&lt;a href=&quot;https://hwame.top&quot;&gt;鴻塵&lt;/a&gt;&lt;br&gt;&lt;strong&gt;参考资料：&lt;/strong&gt;&lt;/p&gt;
&lt;u</summary>
      
    
    
    
    <category term="python" scheme="https://hwame.top/categories/python/"/>
    
    
    <category term="python" scheme="https://hwame.top/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>命令行帮助文档语法格式详解</title>
    <link href="https://hwame.top/20210112/command-line-description.html"/>
    <id>https://hwame.top/20210112/command-line-description.html</id>
    <published>2021-01-12T12:40:13.000Z</published>
    <updated>2021-04-15T06:43:04.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：了解命令行帮助文档的语法格式有助于正确使用其命令，但是命令选项参数难懂难记，因此做以记录。<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>参考内容：</strong></p><ul><li><a href="http://docopt.org/">DOCOPT: Command-line interface description language</a></li><li><a href="https://blog.csdn.net/wq6ylg08/article/details/88919530">Linux命令行帮助文档命令语法公式格式详解和Git命令语法格式解读</a></li></ul><p><strong>文章链接：</strong><a href="https://hwame.top/20210112/command-line-description.html">https://hwame.top/20210112/command-line-description.html</a></p></blockquote><h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h2><p>在终端下查看某个命令的用法时，通常会出现一大堆的<strong><em>选项</em></strong> 和<strong><em>参数</em></strong>，了解掌握其语法格式就无需某度某歌了，工作效率也会upup。</p><p>本文主要翻译自<a href="http://docopt.org/">DOCOPT: Command-line interface description language</a>，并参考<a href="https://blog.csdn.net/wq6ylg08/article/details/88919530">Linux命令行帮助文档命令语法公式格式详解和Git命令语法格式解读</a>。</p><h2 id="2-文档翻译"><a href="#2-文档翻译" class="headerlink" title="2.文档翻译"></a>2.文档翻译</h2><h3 id="2-1-命令行界面描述语言（概述）"><a href="#2-1-命令行界面描述语言（概述）" class="headerlink" title="2.1.命令行界面描述语言（概述）"></a>2.1.命令行界面描述语言（概述）</h3><p><code>docopt</code>可用于为命令行应用定义接口，并且自动生成解析器。</p><p><code>docopt</code>基于已使用数十年的惯例，用于描述程序接口的帮助信息（help messages）和手册页（man pages）。<code>docopt</code>中正式的接口描述如下例所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20210412接口描述.png" alt="接口描述帮助信息"></p><p>上图中的例子描述了可执行程序<code>naval_fate</code>（海军命运）的调用接口，可由<strong>命令（commands）</strong>、<strong>选项（options）</strong>和<strong>位置参数（positional arguments）</strong>三者的不同组合来使用：</p><ul><li>命令（commands）：<code>ship</code>，<code>new</code>，<code>move</code>等。</li><li>选项（options）：<code>-h</code>，<code>--help</code>，<code>--speed=&lt;kn&gt;</code>等。</li><li>位置参数（positional arguments）：<code>&lt;name&gt;</code>，<code>&lt;x&gt;</code>，<code>&lt;y&gt;</code>等。</li></ul><p>该示例使用<strong>方括号<code>[]</code></strong>、<strong>圆括号<code>()</code></strong>、<strong>管道符<code>|</code></strong>和<strong>省略号<code>...</code></strong>分别描述<strong>可选</strong>、<strong>必需</strong>、<strong>互斥</strong>和<strong>重复</strong>的元素。这些元素组成了有效的<strong>使用模式（usage patterns）</strong>，每个使用模式都以程序的名称<code>naval_fate</code>开始。</p><p>使用模式下方为带有描述的选项列表，它们描述了一个选项是否有 <strong>短格式（例如<code>-h</code>）或长格式（例如<code>-–help</code>）</strong> 、是否有一个参数（例如<code>–speed=&lt;kn&gt;</code>），以及该参数是否有默认值（例如<code>[default: 10]</code>）。</p><p>一个<strong>「<code>docopt</code>实现」</strong>将提取所有上述信息并生成命令行参数解析器，当使用<code>-h</code>或<code>-–help</code>选项调用程序时，界面描述的文本将作为帮助消息显示。</p><h3 id="2-2-使用模式（usage-patterns）"><a href="#2-2-使用模式（usage-patterns）" class="headerlink" title="2.2.使用模式（usage patterns）"></a>2.2.使用模式（usage patterns）</h3><p>位于<strong><em>关键字<code>usage:</code></em></strong>（不分大小写）和<strong><em>明显空行</em></strong> 之间的文本将被解释为<strong>使用模式列表</strong>，<strong><em>关键字<code>usage:</code></em></strong>后的第一个单词将被解释为<strong>程序名称</strong>。下面是一个无需命令行参数程序的最小示例：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span></span><br></pre></td></tr></table></figure><br>程序可以有多个使用模式，以各种元素列出来描述该使用模式：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span></span><br><span class="line">    <span class="string">my_program</span> <span class="string">command</span> <span class="string">--option</span> <span class="string">&lt;argument&gt;</span></span><br><span class="line">    <span class="string">my_program</span> [<span class="string">&lt;optional-argument&gt;</span>]</span><br><span class="line">    <span class="string">my_program</span> <span class="string">--another-option=&lt;with-argument&gt;</span></span><br><span class="line">    <span class="string">my_program</span> <span class="string">(--either-that-option</span> <span class="string">|</span> <span class="string">&lt;--or-this-argument&gt;)</span></span><br><span class="line">    <span class="string">my_program</span> <span class="string">&lt;repeating-argument&gt;</span> <span class="string">&lt;repeating-argument&gt;</span> <span class="string">...</span></span><br></pre></td></tr></table></figure><br>每个元素和结构将在下文介绍，用<code>word</code>表示一个由<strong>「空格」</strong>、<strong>「字符串<code>[]()|</code>」之一</strong>或<strong>「<code>...</code>」</strong>分隔的序列。</p><h4 id="①参数-lt-argument-gt-ARGUMENT"><a href="#①参数-lt-argument-gt-ARGUMENT" class="headerlink" title="①参数&lt;argument&gt; ARGUMENT"></a>①参数<code>&lt;argument&gt;</code> <code>ARGUMENT</code></h4><p>以<code>&lt;</code>开头且<code>&gt;</code>结尾的单词和大写单词将被解释为<strong>位置参数</strong>（positional arguments）：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> <span class="string">&lt;host&gt;</span> <span class="string">&lt;port&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="②选项-o-option"><a href="#②选项-o-option" class="headerlink" title="②选项-o --option"></a>②选项<code>-o</code> <code>--option</code></h4><p>以单连字符<code>-</code>或双连字符<code>--</code>开头的<strong><em>单词</em></strong> 将被分别解释为<strong>短格式选项</strong>（一个字母的「单词」）和<strong>长格式选项</strong>，除了<code>-</code>和<code>--</code>本身之外【特殊含义详见下文<a href="#%E2%91%A8%E9%80%89%E9%A1%B9%E5%8F%82%E6%95%B0%E5%88%86%E9%9A%94%E7%AC%A6">选项参数分隔符</a>和<a href="#%E2%91%A9%E5%A4%84%E7%90%86%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5">处理标准输入</a>】。</p><ul><li>短格式选项可以<strong>堆叠</strong>，这意味着<code>-abc</code>和<code>-a -b -c</code>是等价的；</li><li>长格式选项可以有位于<code>空格</code>或<code>等号＝</code>之后的指定的参数，即<code>--input=ARG</code>与<code>--input ARG</code>等价；</li><li>短格式选项可以有位于<strong>可选的</strong><code>空格</code>之后的指定的参数，即<code>-f FILE</code>与<code>-fFILE</code>等价；</li></ul><p><strong>注1：</strong><code>--input ARG</code>【而非<code>--input=ARG</code>】这种写法语义模棱两可，因为不知道<code>ARG</code>到底是<strong>选项参数</strong>还是<strong>位置参数</strong>。在使用模式中，只有提供了「<a href="#2-3-%E9%80%89%E9%A1%B9%E6%8F%8F%E8%BF%B0">选项描述</a>」时才会被解释为带参数的选项，否则将会被解释为一个选项和独立的位置参数。<br><strong>注2：</strong>同样会引起歧义的是<code>-f FILE</code>和<code>-fFILE</code>，因为后者不知道是多个堆叠的短格式选项（<code>-f -F -I -L -E</code>）还是带参数的单个选项（<code>-f</code>为选项，<code>FILE</code>为对应参数）。只有提供了选项描述时，后者这种写法才会被解释为带参数的单个选项。</p><h4 id="③命令command"><a href="#③命令command" class="headerlink" title="③命令command"></a>③命令<code>command</code></h4><p>所有不遵循上述①②约定（即参数<code>&lt;argument&gt;</code>和选项<code>--option</code>）的「单词」，都将被解释为命令或子命令。</p><h4 id="④可选元素-optional-elements"><a href="#④可选元素-optional-elements" class="headerlink" title="④可选元素[optional elements]"></a>④可选元素<code>[optional elements]</code></h4><p>包含在方括号<code>[]</code>中的<strong>元素</strong>（选项、参数、命令）被标为「可选」。元素是否包含在相同或不同的括号内并不重要，例如下面两种写法是等价的：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> [<span class="string">command</span> <span class="string">--option</span> <span class="string">&lt;argument&gt;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> [<span class="string">command</span>] [<span class="string">--option</span>] [<span class="string">&lt;argument&gt;</span>]</span><br></pre></td></tr></table></figure></p><h4 id="⑤必选元素-required-elements"><a href="#⑤必选元素-required-elements" class="headerlink" title="⑤必选元素(required elements)"></a>⑤必选元素<code>(required elements)</code></h4><p>如果不在方括号<code>[]</code>里，那么默认情况下所有元素都是必选的。但是有时候需要用圆括号<code>()</code>将必选元素显式地标出，例如需要对互斥元素（见下节<a href="#%E2%91%A5%E4%BA%92%E6%96%A5%E5%85%83%E7%B4%A0element-another">互斥元素</a>）分组的时候：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> <span class="string">(--either-this</span> <span class="string">&lt;and-that&gt;</span> <span class="string">|</span> <span class="string">&lt;or-this&gt;)</span></span><br></pre></td></tr></table></figure><br>另一种用法是，当你需要制定如果有一个元素存在，那么就需要另一个元素，则可以这样实现：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> [<span class="string">(&lt;one-argument&gt;</span> <span class="string">&lt;another-argument&gt;)</span>]</span><br></pre></td></tr></table></figure><br>在这种情况下，有效的程序调用要么没有参数，要么就有两个参数。</p><h4 id="⑥互斥元素element-another"><a href="#⑥互斥元素element-another" class="headerlink" title="⑥互斥元素element | another"></a>⑥互斥元素<code>element | another</code></h4><p>互斥元素以管道符<code>|</code>进行分隔：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> <span class="string">go</span> <span class="string">(--up</span> <span class="string">|</span> <span class="string">--down</span> <span class="string">|</span> <span class="string">--left</span> <span class="string">|</span> <span class="string">--right)</span></span><br></pre></td></tr></table></figure><br>在各个互斥情况下，当有一个为必选时使用圆括号<code>()</code>对元素进行分组，当没有必选时使用方括号<code>[]</code>对元素进行分组：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> <span class="string">go</span> [<span class="string">--up</span> <span class="string">|</span> <span class="string">--down</span> <span class="string">|</span> <span class="string">--left</span> <span class="string">|</span> <span class="string">--right</span>]</span><br></pre></td></tr></table></figure><br><strong>注意：</strong>指定多个使用模式的运行恰如管道符<code>|</code>，这就是说以下两者写法是等价的：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> <span class="string">run</span> [<span class="string">--fast</span>]</span><br><span class="line">       <span class="string">my_program</span> <span class="string">jump</span> [<span class="string">--high</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> <span class="string">(run</span> [<span class="string">--fast</span>] <span class="string">|</span> <span class="string">jump</span> [<span class="string">--high</span>]<span class="string">)</span></span><br></pre></td></tr></table></figure></p><h4 id="⑦重复元素element"><a href="#⑦重复元素element" class="headerlink" title="⑦重复元素element..."></a>⑦重复元素<code>element...</code></h4><p>使用省略号<code>...</code>表示左边的一个或一组参数可被重复一次或多次：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> <span class="string">open</span> <span class="string">&lt;file&gt;...</span></span><br><span class="line">       <span class="string">my_program</span> <span class="string">move</span> <span class="string">(&lt;from&gt;</span> <span class="string">&lt;to&gt;)...</span></span><br></pre></td></tr></table></figure><br>可以灵活地指定必需参数的数量，例如：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 零个或多个必选参数（3种冗余的方法）：</span></span><br><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> [<span class="string">&lt;file&gt;...</span>]</span><br><span class="line">       <span class="string">my_program</span> [<span class="string">&lt;file&gt;</span>]<span class="string">...</span></span><br><span class="line">       <span class="string">my_program</span> [<span class="string">&lt;file&gt;</span> [<span class="string">&lt;file&gt;</span> <span class="string">...</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个或多个必选参数：</span></span><br><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> <span class="string">&lt;file&gt;...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 两个或多个必选参数：</span></span><br><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> <span class="string">&lt;file&gt;</span> <span class="string">&lt;file&gt;...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 诸如此类...</span></span><br></pre></td></tr></table></figure></p><h4 id="⑧选项简写-options"><a href="#⑧选项简写-options" class="headerlink" title="⑧选项简写[options]"></a>⑧选项简写<code>[options]</code></h4><p>「<strong><code>[options]</code></strong>」是一种选项的简写方式，该方式可以避免在使用模式中列出所有的选项（从带有描述的选项列表中）。例如以下两种写法是等价的：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简写</span></span><br><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> [<span class="string">options</span>] <span class="string">&lt;path&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">--all</span>             <span class="string">List</span> <span class="string">everything.</span></span><br><span class="line"><span class="string">--long</span>            <span class="string">Long</span> <span class="string">output.</span></span><br><span class="line"><span class="string">--human-readable</span>  <span class="string">Display</span> <span class="string">in</span> <span class="string">human-readable</span> <span class="string">format.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 非简写</span></span><br><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> [<span class="string">--all</span> <span class="string">--long</span> <span class="string">--human-readable</span>] <span class="string">&lt;path&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">--all</span>             <span class="string">List</span> <span class="string">everything.</span></span><br><span class="line"><span class="string">--long</span>            <span class="string">Long</span> <span class="string">output.</span></span><br><span class="line"><span class="string">--human-readable</span>  <span class="string">Display</span> <span class="string">in</span> <span class="string">human-readable</span> <span class="string">format.</span></span><br></pre></td></tr></table></figure><br>如果有很多选项，并且它们都适用于其中一种使用模式，那么这种简写将很有用。或者，如果同时具有短格式和长格式两种版本的选项（详见<a href="#2-3-%E9%80%89%E9%A1%B9%E6%8F%8F%E8%BF%B0">选项描述</a>部分），则可以在一个使用模式中列出其中之一：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> [<span class="string">-alh</span>] <span class="string">&lt;path&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">-a,</span> <span class="string">--all</span>             <span class="string">List</span> <span class="string">everything.</span></span><br><span class="line"><span class="string">-l,</span> <span class="string">--long</span>            <span class="string">Long</span> <span class="string">output.</span></span><br><span class="line"><span class="string">-h,</span> <span class="string">--human-readable</span>  <span class="string">Display</span> <span class="string">in</span> <span class="string">human-readable</span> <span class="string">format.</span></span><br></pre></td></tr></table></figure><br>关于如何书写「选项描述」将在下文介绍。</p><h4 id="⑨选项参数分隔符"><a href="#⑨选项参数分隔符" class="headerlink" title="⑨选项参数分隔符[--]"></a>⑨选项参数分隔符<code>[--]</code></h4><p>双连字符<code>--</code>在不属于选项的一部分时，按照惯例通常用于分隔选项和位置参数，以便处理诸如将文件名误认为是选项的情况。为了支持该约定，只需在使用模式的位置参数前加上<code>[--]</code>即可：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">my_program</span> [<span class="string">options</span>] [<span class="string">--</span>] <span class="string">&lt;file&gt;...</span></span><br></pre></td></tr></table></figure><br>除此之外，<code>--</code>只是一个普通的命令，因此可应用于任何前述操作，譬如去掉方括号<code>[]</code>使其成为必选。</p><h4 id="⑩处理标准输入"><a href="#⑩处理标准输入" class="headerlink" title="⑩处理标准输入[-]"></a>⑩处理标准输入<code>[-]</code></h4><p>单连字符<code>-</code>在不属于选项的一部分时，按照惯例通常表示程序用于处理标准输入<code>stdin</code>而非文件。如果要遵循该约定，只需将<code>[-]</code>添加到使用模式中。<code>-</code>自身仅仅是一个普通命令，可赋予任何意义。</p><h3 id="2-3-选项描述"><a href="#2-3-选项描述" class="headerlink" title="2.3.选项描述"></a>2.3.选项描述</h3><p>选项描述是位于使用模式下面的一系列选项。如果使用模式不存在歧义（详见上文<a href="#%E2%91%A1%E9%80%89%E9%A1%B9-o-option">选项option</a>），则可以选择指定它们。</p><p>一个选项描述允许指定：</p><ul><li>某些短格式和长格式选项为同义词；</li><li>一个选项有一个参数；</li><li>选项的参数提供默认值。</li></ul><p>这些规则遵循：以不计空格的以<code>-</code>或<code>--</code>开头的每一行都将视为选项描述。例如：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Options:</span></span><br><span class="line">  <span class="string">--verbose</span>   <span class="comment"># GOOD，以「--」开头</span></span><br><span class="line">  <span class="string">-o</span> <span class="string">FILE</span>     <span class="comment"># GOOD，以「-」开头</span></span><br><span class="line"><span class="attr">Other:</span> <span class="string">--bad</span>  <span class="comment"># BAD，不以「-」开头</span></span><br></pre></td></tr></table></figure></p><p>若要明确指定一个选项带有一个参数，则需：</p><ol><li>在空格或等号<code>=</code>后放一个描述该参数的词，如下所示。</li><li>选项参数遵循尖括号<code>&lt;argument&gt;</code>或全大写<code>ARGUMENT</code>的约定。</li><li>如果有必要，可以使用逗号<code>,</code>分隔选项。</li></ol><p>尽管下例中的两行都是有效的，但是建议坚持使用单一风格而不要混着用：<br>【注：根据下文分析中的<a href="#3-%E5%85%B3%E4%BA%8E%E3%80%8C%E9%80%89%E9%A1%B9%E3%80%8D%E5%8F%8A%E6%AD%A7%E4%B9%89">规范书写命令第4点</a>，推荐使用全大写而非尖括号】</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-o FILE --output=FILE       # 有等号、全大写、无逗号（推荐）</span><br><span class="line">-i &lt;file&gt;, --input &lt;file&gt;   # 无等号、尖括号、有逗号（不推荐）</span><br></pre></td></tr></table></figure><p>用（至少）两个空格来分隔选项和它们的非正式描述【如果只用一个空格，可能会将描述的首个词当做选项的参数】：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">--verbose</span> <span class="string">MORE</span> <span class="string">text.</span>    <span class="comment"># BAD，将被视为选项verbose有一个参数MORE，</span></span><br><span class="line">                        <span class="comment"># 故需使用两个空格</span></span><br><span class="line"><span class="string">-q</span>        <span class="string">Quit.</span>         <span class="comment"># GOOD，8空格</span></span><br><span class="line"><span class="string">-o</span> <span class="string">FILE</span>   <span class="string">Output</span> <span class="string">file.</span>  <span class="comment"># GOOD，3空格</span></span><br><span class="line"><span class="string">--stdout</span>  <span class="string">Use</span> <span class="string">stdout.</span>   <span class="comment"># GOOD，2空格</span></span><br></pre></td></tr></table></figure><br>如果要为带有参数的选项设置默认值，则使用<code>[default: the-default-value]</code>的形式将其放到选项描述中：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">--coefficient=K</span>  <span class="string">The</span> <span class="string">K</span> <span class="string">coefficient</span> [<span class="attr">default:</span> <span class="number">2.95</span>]</span><br><span class="line"><span class="string">--output=FILE</span>    <span class="string">Output</span> <span class="string">file</span> [<span class="attr">default:</span> <span class="string">test.txt</span>]</span><br><span class="line"><span class="string">--directory=DIR</span>  <span class="string">Some</span> <span class="string">directory</span> [<span class="attr">default:</span> <span class="string">./</span>]</span><br></pre></td></tr></table></figure></p><h3 id="2-4-其他"><a href="#2-4-其他" class="headerlink" title="2.4.其他"></a>2.4.其他</h3><ul><li>在浏览器中体验<code>docopt</code>：<a href="http://try.docopt.org/">Try docopt</a>。</li><li><code>docopt</code>可用于多种编程语言，其官方实现列在<a href="https://github.com/docopt">GitHub上的docopt组织</a>中。</li></ul><h2 id="3-注意事项"><a href="#3-注意事项" class="headerlink" title="3.注意事项"></a>3.注意事项</h2><blockquote><p>为了和<a href="http://docopt.org/">docopt文档</a>原有结构保持一致，本文第二章<a href="#2-%E6%96%87%E6%A1%A3%E7%BF%BB%E8%AF%91">文档翻译</a>没有在对应位置添加注释，故此列出各个注意事项。</p></blockquote><h4 id="1-关于「命令」"><a href="#1-关于「命令」" class="headerlink" title="(1)关于「命令」"></a>(1)关于「命令」</h4><p>在本文中使用模式格式为<code>my_program command --option &lt;argument&gt;</code>，各元素依次称为<code>程序</code>、<code>命令</code>、<code>选项</code>和<code>参数</code>；而一般Linux命令中将这里的<code>程序</code>也称为<code>命令</code>，在这种条件下<code>my_program command --option &lt;argument&gt;</code>中各元素依次称为<code>命令</code>、<code>子命令</code>、<code>选项</code>和<code>参数</code>，例如<code>yum install package_name -y</code>。<strong>注意：</strong>「子命令」不一定总有，例如<code>du -h ./</code>。</p><p>由于Linux中都是称<code>cd</code>、<code>ls</code>等为「命令」，因此个人倾向于「<code>命令</code> <code>子命令</code>」的说法，而非「<code>程序</code> <code>命令</code>」。</p><h4 id="2-关于「参数」"><a href="#2-关于「参数」" class="headerlink" title="(2)关于「参数」"></a>(2)关于「参数」</h4><p><a href="http://docopt.org/">docopt文档</a>对某些名词和概念没有具体解释，容易让人误解，尤其是翻译的时候<strong>名词的形容词化</strong>。</p><blockquote><p><strong><code>parameter</code>和<code>argument</code>的区别：</strong><br>The term <strong><em>parameter</em></strong> is used to describe the names for values that are expected to be supplied.<br>The term <strong><em>argument</em></strong> is used for the values provided for each parameter.</p><p><code>parameter</code>指函数定义中的形式参数（Formal Parameter）。<br><code>argument</code>指函数调用时的实际参数（Actual Argument）。</p></blockquote><p>在本文中只有实际参数（因为只需调用程序嘛），但参数又分为<a href="#%E2%91%A0%E5%8F%82%E6%95%B0-lt-argument-gt-ARGUMENT">位置参数</a>和<a href="#%E2%91%A1%E9%80%89%E9%A1%B9-o-option">选项参数</a>：</p><ul><li><strong>位置参数</strong>是指包含于尖括号<code>&lt;&gt;</code>中的单词和大写单词；</li><li><strong>选项参数</strong>是指紧跟在选项后的参数，用于指定选项的惭怍对象，如<code>-o argument</code>或<code>--option=argument</code>中的「<code>argument</code>」即选项参数。</li></ul><h4 id="3-关于「选项」及歧义"><a href="#3-关于「选项」及歧义" class="headerlink" title="(3)关于「选项」及歧义"></a>(3)关于「选项」及歧义</h4><p>「选项」主要用于改变命令执行动作的类型。一般而言，短格式选项是长格式选项的缩写，也就是一个短格式选项会有对应的长格式选项。当然也有例外，比如<code>ls</code>命令的短格式选项<code>-l</code>就没有对应的长格式选项。</p><p>上文<a href="#%E2%91%A1%E9%80%89%E9%A1%B9-o-option">选项option</a>一节注解中提到的歧义问题：</p><ul><li>长格式选项<code>--input ARG</code>中的<code>ARG</code>是<font color=purple><b>选项参数</b></font>还是<font color=purple><b>位置参数</b></font>？</li><li>短格式选项<code>-f FILE</code>中的<code>FILE</code>是<font color=purple><b>选项参数</b></font>还是<font color=purple><b>位置参数</b></font>？</li><li>短格式选项<code>-fFILE</code>是由<code>-f -F -I -L -E</code>堆叠的<font color=purple><b>多个选项</b></font>还是带参数<code>FILE</code>的<font color=purple><b>单个选项</b></font><code>-f</code>？</li></ul><p>为了避免引起上述歧义，最好规范书写命令，如下所示：</p><ul><li>1.书写带参数的短格式选项命令时，最好写成带空格的形式<code>-f FILE</code>；</li><li>2.书写带参数的长格式选项命令时，最好写成带等号的形式<code>--input=ARG</code>；</li><li>3.事实上，带空格的形式<code>-f FILE</code>仍然存在歧义【<code>FILE</code>是<font color=purple><b>选项参数</b></font>还是<font color=purple><b>位置参数</b></font>】，这是不可避免的，唯有开发者在帮助文档中用<code>-f FILE</code>和<code>-f &lt;FILE&gt;</code>分别表示选项参数和位置参数，才能使使用者更明确。</li><li>4.尽管文档中<a href="#%E2%91%A0%E5%8F%82%E6%95%B0-lt-argument-gt-ARGUMENT">参数argument</a>将<code>&lt;argument&gt;</code>和<code>ARGUMENT</code>统称为「位置参数」，但如果将其分别表示位置参数和选项参数则可消除该歧义。</li></ul><h4 id="4-关于「可选元素」"><a href="#4-关于「可选元素」" class="headerlink" title="(4)关于「可选元素」"></a>(4)关于「可选元素」</h4><p>由于<a href="#%E2%91%A3%E5%8F%AF%E9%80%89%E5%85%83%E7%B4%A0-optional-elements">可选元素</a>是否包含在相同或不同的括号内并不重要，因此<code>my_program [command --option &lt;argument&gt;]</code>中的3个元素共有8种组合而不是2种：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 错误的「所有可能性」：</span></span><br><span class="line"><span class="string">my_program</span></span><br><span class="line"><span class="string">my_program</span> <span class="string">command</span> <span class="string">--option</span> <span class="string">argument</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 正确的「所有可能性」：</span></span><br><span class="line"><span class="string">my_program</span></span><br><span class="line"><span class="string">my_program</span> <span class="string">command</span></span><br><span class="line"><span class="string">my_program</span> <span class="string">--option</span></span><br><span class="line"><span class="string">my_program</span> <span class="string">argument</span></span><br><span class="line"><span class="string">my_program</span> <span class="string">command</span> <span class="string">--option</span></span><br><span class="line"><span class="string">my_program</span> <span class="string">command</span> <span class="string">argument</span></span><br><span class="line"><span class="string">my_program</span> <span class="string">--option</span> <span class="string">argument</span></span><br><span class="line"><span class="string">my_program</span> <span class="string">command</span> <span class="string">--option</span> <span class="string">argument</span></span><br></pre></td></tr></table></figure><br>如果将其改写为它的等价形式<code>my_program [command] [--option] [&lt;argument&gt;]</code>则很容易理解，难的是理解两者为何等价。</p><h4 id="5-关于「连字符」"><a href="#5-关于「连字符」" class="headerlink" title="(5)关于「连字符」"></a>(5)关于「连字符」</h4><p><a href="#%E2%91%A8%E9%80%89%E9%A1%B9%E5%8F%82%E6%95%B0%E5%88%86%E9%9A%94%E7%AC%A6">双连字符</a>和<a href="#%E2%91%A9%E5%A4%84%E7%90%86%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5">单连字符</a>除去上文特殊含义外<font color=purple><b>「仅仅是一个普通命令，可赋予任何意义」</b></font>。</p><p>文档没有对这句话进行解释，我的理解是<code>my_program command</code>也可以写作<code>my_program --</code>或者<code>my_program -</code>，如果该命令是可选的，那么<code>my_program [--]</code>岂不是又会有到底是<font color=purple><b>选项参数分隔符</b></font>还是<font color=purple><b>命令</b></font>的歧义了。</p><p>所以说，最好还是将它们限制在<a href="#%E2%91%A8%E9%80%89%E9%A1%B9%E5%8F%82%E6%95%B0%E5%88%86%E9%9A%94%E7%AC%A6">选项参数分隔符</a>和<a href="#%E2%91%A9%E5%A4%84%E7%90%86%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5">处理标准输入</a>的特定含义吧。</p><h4 id="6-关于「约定惯例」"><a href="#6-关于「约定惯例」" class="headerlink" title="(6)关于「约定惯例」"></a>(6)关于「约定惯例」</h4><p>约定或惯例（convention）只是为了方便彼此交流和理解而形成的规定，并不是一项带强制性的标准，因此并非所有帮助信息都遵循了这些规定，所以更多时候需要结合具体情况来推断。</p><p>以下列举几个例子：<br><strong>①<code>vim</code>命令。</strong>包括「命令的简要描述」、「使用模式」和「选项描述」三个部分，如图（截图不完整）。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20210414vim命令.png" alt="vim命令"></p><p>图中将「选项」写作「Arguments」，需要根据该帮助信息来推断各元素的含义。<br>其中，<font color=purple><b>紫色框中</b></font>以单连字符<code>-</code>表示从标准输入<code>stdin</code>读取文本，双连字符<code>--</code>表示后面的参数为文件。</p><p>同理，在<code>cat</code>命令中单连字符<code>-</code>含义与此相同，如图所示（截图为<code>cat --help</code>的部分内容）：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20210414cat部分命令.png" alt="cat部分命令"></p><p>双连字符<code>--</code>在<code>rm</code>命令中还可以标识以单连字符<code>-</code>开头的文件，例如删除当前文件夹下名为<code>-foo</code>的文件，可以使用<code>rm -- -foo</code>或<code>rm ./-foo</code>，如图所示（截图为<code>rm --help</code>的部分内容）：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20210414rm部分命令.png" alt="rm部分命令"></p><p><strong>②<code>chmod</code>命令。</strong>包括「使用模式」、「命令描述」、「选项描述」以及「补充信息」四个部分，如图所示。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20210414chmod命令.png" alt="chmod命令"></p><p>注意<code>chmod</code>命令第一种使用模式中<code>MODE[,MODE]...</code>的<a href="#%E2%91%A6%E9%87%8D%E5%A4%8D%E5%85%83%E7%B4%A0element">重复元素</a>写法。</p><p><strong>③<code>who</code>命令</strong>包括「使用模式」、「命令描述」、「选项描述」以及「补充信息」四个部分，如图所示。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20210414who命令.png" alt="who命令"></p><p>注意<code>who</code>命令使用模式中<code>[FILE | ARG1 ARG2]</code>的<code>FILE</code>和<code>ARG1 ARG2</code>这对<a href="#%E2%91%A5%E4%BA%92%E6%96%A5%E5%85%83%E7%B4%A0element-another">互斥元素</a>实际上包含了两种使用模式，这在后面的「补充信息」中也有说明即：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage:</span> <span class="string">who</span> [<span class="string">option</span>]<span class="string">...</span> [<span class="string">FILE</span>]</span><br><span class="line"><span class="attr">Usage:</span> <span class="string">who</span> [<span class="string">option</span>]<span class="string">...</span> [<span class="string">(ARG1</span> <span class="string">ARG2)</span>]</span><br></pre></td></tr></table></figure></p><p>同时，上文<a href="#3-%E5%85%B3%E4%BA%8E%E3%80%8C%E9%80%89%E9%A1%B9%E3%80%8D%E5%8F%8A%E6%AD%A7%E4%B9%89">关于「选项」及歧义</a>中指出：<font color=purple><b>一般而言，短格式选项是长格式选项的缩写，也就是一个短格式选项会有对应的长格式选项。</b></font>从上面的例子可以看出，一个选项可以只有短格式选项（如<code>-m</code>），可以只有长格式选项（如<code>--version</code>），也可以同时都有（如<code>-a，--all</code>）。</p><hr><p><strong>注意：</strong>尽管大多数命令都有<a href="#2-3-%E9%80%89%E9%A1%B9%E6%8F%8F%E8%BF%B0">选项描述</a>，因此上述提到的歧义都将解释为带参数的单个选项。但是也有一些命令没有<a href="#2-3-%E9%80%89%E9%A1%B9%E6%8F%8F%E8%BF%B0">选项描述</a>，例如<code>ssh</code>命令。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20210415ssh命令.png" alt="ssh命令"></p><p>在这种情况下，诸如<code>-b bind_address</code>中的<code>address</code>将被解释为独立的位置参数【而不是<code>-b</code>的选项参数】。然而此处这两种理解的运行效果没有分别，因此尽管在理论上会存在歧义，但实际上开发者会避免掉歧义情况的出现。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：了解命令行帮助文档的语法格式有助于正确使用其命令，但是命令选项参数难懂难记，因此做以记录。</summary>
    
    
    
    <category term="Linux" scheme="https://hwame.top/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://hwame.top/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux中易混淆的概念</title>
    <link href="https://hwame.top/20201129/confusing-concepts-in-linux.html"/>
    <id>https://hwame.top/20201129/confusing-concepts-in-linux.html</id>
    <published>2020-11-29T05:52:55.000Z</published>
    <updated>2020-11-30T00:00:56.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章说明：</strong>学习<code>Linux</code> <code>shell</code>过程中的记录，参考书籍主要有《Linux命令行与shell脚本编程大全（第3版）》，《鸟哥的Linux私房菜（第三版）》系列和《快乐的 Linux 命令行》，参考资料主要有<a href="https://man.linuxde.net/">Linux命令大全</a>等。<br><strong>文章链接：</strong><a href="https://hwame.top/20201129/confusing-concepts-in-linux.html">https://hwame.top/20201129/confusing-concepts-in-linux.html</a></p></blockquote><h2 id="1-单引号、双引号和反引号"><a href="#1-单引号、双引号和反引号" class="headerlink" title="1.单引号、双引号和反引号"></a>1.单引号、双引号和反引号</h2><p><strong>①</strong><code>echo</code>命令可用单引号或双引号来划定文本字符串。如果在字符串中用到了它们，你需要在文本中使用其中一种引号，而用另外一种来将字符串划定起来。</p><ul><li>单引号字符串的限制：<ul><li>单引号里的任何字符都会原样输出，单引号字符串中的变量是无效的；</li><li>单引号字串中不能出现单独一个的单引号（对单引号使用转义符后也不行），但可成对出现，作为字符串拼接使用。</li></ul></li><li>双引号的优点：<ul><li>双引号里可以有变量</li><li>双引号里可以出现转义字符</li></ul></li></ul><p><strong>②</strong>反引号<code>ˋ</code>用于从命令输出中提取信息，将命令输出赋给变量，另一种格式是<code>$()</code>，例如：</p><p><strong>注意：</strong>赋值等号和命令替换字符之间没有空格。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">testing</span>=`date`</span><br><span class="line"><span class="attr">testing</span>=$(date)</span><br></pre></td></tr></table></figure></p><h2 id="2-各种括号的作用"><a href="#2-各种括号的作用" class="headerlink" title="2.各种括号的作用"></a>2.各种括号的作用</h2><blockquote><p>本部分<a href="#2-%E5%90%84%E7%A7%8D%E6%8B%AC%E5%8F%B7%E7%9A%84%E4%BD%9C%E7%94%A8">各种括号的作用</a>内容参考：<a href="https://blog.csdn.net/taiyang1987912/article/details/39551385">shell中各种括号的作用()、(())、[]、[[]]、{}</a></p></blockquote><h3 id="2-1-小括号-圆括号"><a href="#2-1-小括号-圆括号" class="headerlink" title="2.1.小括号/圆括号"></a>2.1.小括号/圆括号</h3><ul><li>单小括号<code>()</code><ul><li>①<strong>命令组</strong>。括号中的命令将会新开一个子shell顺序执行，所以括号中的变量不能够被脚本余下的部分使用。括号中多个命令之间用分号隔开，最后一个命令可以没有分号，各命令和括号之间不必有空格。</li><li>②<strong>命令替换</strong>。等同于<code>cmd</code>，shell扫描一遍命令行，发现了<code>$( cmd )</code>结构，便将<code>$( cmd )</code>中的<code>cmd</code>执行一次，得到其标准输出，再将此输出放到原来命令。有些shell不支持，如tcsh。</li><li>③<strong>初始化数组</strong>。如：<code>array=(a b c d)</code>。</li></ul></li><li>双小括号<code>(( ))</code><ul><li>①<strong>整数扩展</strong>。这种扩展计算是整数型的计算，不支持浮点型。<code>((exp))</code>结构扩展并计算一个算术表达式的值，如果表达式的结果为<code>0</code>，那么返回的退出状态码为<code>1</code>（或者是「假」），而一个非零值的表达式所返回的退出状态码将为<code>0</code>（或者是「真」）。若是逻辑判断，表达式<code>exp</code>为真则为<code>1</code>，假则为<code>0</code>。</li><li>②<strong>C语言运算规则</strong>。只要括号中的运算符、表达式符合C语言运算规则，都可用在<code>$(( exp ))</code>中，甚至是三目运算符。作不同进位(如二进制、八进制、十六进制)运算时，输出结果全都自动转化成了十进制。如：<code>echo $(( 16#5f ))</code>结果为<code>95</code>(16进位转十进制)。</li><li>③单纯用 (( )) 也可<strong>重定义变量值</strong>，比如<code>a=5; (( a++ ))</code>可将<code>$a</code>重定义为<code>6</code>。</li><li>④常用于<strong>算术运算比较</strong>，双括号中的变量可以不使用<code>$</code>符号前缀。括号内支持多个表达式用逗号分开。 只要括号中的表达式符合C语言运算规则，比如可以直接使用<code>for (( i = 0; i &lt; 5; i++ ))</code>，如果不使用双括号，则为<code>for i in ˋseq 0 4ˋ</code>或者<code>for i in &#123;0..4&#125;</code>。再如可以直接使用<code>if (($i&lt;5))</code>，如果不使用双括号，则为<code>if [ $i -lt 5 ]</code>。</li></ul></li></ul><h3 id="2-2-中括号-方括号"><a href="#2-2-中括号-方括号" class="headerlink" title="2.2.中括号/方括号"></a>2.2.中括号/方括号</h3><ul><li>单中括号<code>[]</code><ul><li>①bash的<strong>内部命令</strong>，<code>[</code>和<code>test</code>是等同的。如果我们不用绝对路径指明，通常我们用的都是bash自带的命令。<code>if/test</code>结构中的左中括号是调用<code>test</code>的命令标识，右中括号是关闭条件判断的。这个命令把它的参数作为<strong>比较表达式</strong>或者作为<strong>文件测试</strong>，并且根据比较的结果来返回一个退出状态码。<code>if/test</code>结构中并不是必须右中括号，但是新版的Bash中要求必须这样。</li><li>②<code>test</code>和<code>[]</code>中可用的比较运算符只有<code>==</code>和<code>!=</code>，两者都是用于字符串比较的，不可用于整数比较，整数比较只能使用<code>-eq</code>、<code>-gt</code>这种形式。无论是字符串比较还是整数比较都不支持大于号小于号。如果实在想用，对于字符串比较可以使用转义形式，例如：<code>[ ab \&lt; bc ]</code>，结果为真，也就是返回状态为<code>0</code>。<code>[ ]</code>中的逻辑与和逻辑或使用<code>-a</code>和<code>-o</code>表示。</li><li>③<strong>字符范围</strong>。用作正则表达式的一部分，描述一个匹配的字符范围，作为<code>test</code>用途的中括号内不能使用正则。</li><li>④在一个<code>array</code>结构的上下文中，中括号用来<strong>引用数组中每个元素的编号</strong>。</li></ul></li><li>双中括号<code>[[ ]]</code><ul><li>①<code>[[</code>是bash程序语言的<strong>关键字</strong>，并不是一个命令，<code>[[ ]]</code>结构比<code>[ ]</code>结构更加通用。在<code>[[</code>和<code>]]</code>之间所有的字符都不会发生文件名扩展或者单词分割，但是会发生参数扩展和命令替换。</li><li>②支持字符串的<strong>模式匹配</strong>，使用<code>=~</code>操作符时甚至支持shell的正则表达式。字符串比较时可以把右边的作为一个模式，而不仅仅是一个字符串，比如<code>[[ hello == hell? ]]</code>，结果为真。<code>[[ ]]</code>中匹配字符串或通配符，不需要引号。</li><li>③使用<code>[[ ... ]]</code>条件判断结构而非<code>[ ... ]</code>，能够防止脚本中的许多逻辑错误。比如，<code>&amp;&amp;</code>、<code>||</code>、<code>&lt;</code>和<code>&gt;</code>操作符能够正常存在于<code>[[ ]]</code>条件判断结构中，但是如果出现在<code>[ ]</code>结构中的话会报错。比如可以直接使用<code>if [[ $a != 1 &amp;&amp; $a != 2 ]]</code>，如果不使用双括号则为<code>if [ $a -ne 1] &amp;&amp; [ $a != 2 ]</code>或者<code>if [ $a -ne 1 -a $a != 2 ]</code>。</li><li>④bash把双中括号中的表达式看作一个单独的元素，并返回一个退出状态码。</li></ul></li></ul><h3 id="2-3-大括号-花括号"><a href="#2-3-大括号-花括号" class="headerlink" title="2.3.大括号/花括号"></a>2.3.大括号/花括号</h3><h4 id="⑴常规用法"><a href="#⑴常规用法" class="headerlink" title="⑴常规用法"></a>⑴常规用法</h4><ul><li><strong>大括号拓展</strong>。通配（globbing）将对大括号中的文件名做扩展。在大括号中，不允许有空白，除非这个空白被引用或转义。<ul><li>第一种：对大括号中的以逗号分割的文件列表进行拓展。如<code>touch &#123;a,b&#125;.txt</code>结果为<code>a.txt b.txt</code>。</li><li>第二种：对大括号中以点点<code>..</code>分割的顺序文件列表起拓展作用，如：<code>touch &#123;a..d&#125;.txt</code>结果为<code>a.txt b.txt c.txt d.txt</code>。</li><li><strong>注：</strong>在参考文章关于<a href="https://blog.csdn.net/taiyang1987912/article/details/39551385#t6">大括号拓展</a>举例中，<code>ls &#123;ex[1-3],ex4&#125;.sh</code>可以扩展，但<code>touch &#123;ex[1-3],ex4&#125;.sh</code>只创建了两个文件。</li></ul></li><li><strong>代码块</strong>，又被称为内部组，这个结构事实上创建了一个匿名函数。与小括号中的命令不同，<strong>大括号内的命令不会新开一个子shell运行</strong>，即脚本余下部分仍可使用括号内变量。括号内的命令间用分号隔开，最后一个也必须有分号。<code>&#123;&#125;</code>的第一个命令和左括号之间必须要有一个空格。</li></ul><h4 id="⑵几种特殊的替换结构"><a href="#⑵几种特殊的替换结构" class="headerlink" title="⑵几种特殊的替换结构"></a>⑵几种特殊的替换结构</h4><ul><li>①<code>$&#123;var:-string&#125;</code>：若变量<code>var</code>为空，则用在命令行中用<code>string</code>来替换<code>$&#123;var:-string&#125;</code>；变量<code>var</code>不为空时，则用变量<code>var</code>的值来替换<code>$&#123;var:-string&#125;</code>。</li><li>②<code>$&#123;var:=string&#125;</code>：替换规则和①相同，所不同之处是<code>$&#123;var:=string&#125;</code>若<code>var</code>为空时，用<code>string</code>替换<code>$&#123;var:=string&#125;</code>的同时还把<code>string</code>赋给变量<code>var</code>。<code>$&#123;var:=string&#125;</code>很常用的一种用法是，判断某个变量是否赋值，没有的话则给它赋上一个默认值。</li><li>②<code>$&#123;var:+string&#125;</code>的替换规则和上面①②相反，即只有当<code>var</code>不是空的时候才替换成<code>string</code>，若<code>var</code>为空时则不替换或者说是替换成变量<code>var</code>即空值。</li><li>③<code>$&#123;var:?string&#125;</code>替换规则为：若变量<code>var</code>不为空，则用变量<code>var</code>的值来替换<code>$&#123;var:?string&#125;</code>；若变量<code>var</code>为空，则把<code>string</code>输出到标准错误中，并从脚本中退出。我们可利用此特性来检查是否设置了变量的值。</li></ul><p>补充扩展：在上面的替换结构中<code>string</code>不一定是常值的，可用另外一个变量的值或是一种命令的输出。</p><h4 id="⑶四种模式匹配替换结构"><a href="#⑶四种模式匹配替换结构" class="headerlink" title="⑶四种模式匹配替换结构"></a>⑶四种模式匹配替换结构</h4><blockquote><p>模式匹配记忆方法：</p><ul><li><code>#</code>是去掉左边(在键盘上#在$之左边)</li><li><code>%</code>是去掉右边(在键盘上%在$之右边)</li><li><code>#</code>和<code>%</code>中的单一符号是最小匹配，两个相同符号是最大匹配</li></ul></blockquote><ul><li>第一种模式：<code>$&#123;variable%pattern&#125;</code>。shell在<code>variable</code>中查找，看它是否以给的模式<code>pattern</code>结尾，如果是，就从命令行把<code>variable</code>中的内容去掉<strong>右边最短</strong>的匹配模式；</li><li>第二种模式：<code>$&#123;variable%%pattern&#125;</code>。shell在<code>variable</code>中查找，看它是否以给的模式<code>pattern</code>结尾，如果是，就从命令行把<code>variable</code>中的内容去掉<strong>右边最长</strong>的匹配模式；</li><li>第三种模式：<code>$&#123;variable#pattern&#125;</code>。shell在<code>variable</code>中查找，看它是否以给的模式<code>pattern</code>开始，如果是，就从命令行把<code>variable</code>中的内容去掉<strong>左边最短</strong>的匹配模式；</li><li>第四种模式：<code>$&#123;variable##pattern&#125;</code>。shell在<code>variable</code>中查找，看它是否以给的模式<code>pattern</code>结尾，如果是，就从命令行把<code>variable</code>中的内容去掉<strong>左边最长</strong>的匹配模式。</li></ul><p>这四种模式中都不会改变<code>variable</code>的值，其中，只有在<code>pattern</code>中使用了<code>*</code>匹配符号时，<code>%</code>和<code>%%</code>、<code>#</code>和<code>##</code>才有区别。结构中的<code>pattern</code>支持通配符，<code>*</code>表示零个或多个任意字符，<code>?</code>表示仅与一个任意字符匹配，<code>[...]</code>表示匹配中括号里面的字符，<code>[!...]</code>表示不匹配中括号里面的字符 。</p><h4 id="⑷字符串提取和替换"><a href="#⑷字符串提取和替换" class="headerlink" title="⑷字符串提取和替换"></a>⑷字符串提取和替换</h4><ul><li>第一种模式：<code>$&#123;var:num&#125;</code>。shell在<code>var</code>中提取第<code>num</code>个字符到末尾的所有字符。若<code>num</code>为正数，从左边<code>0</code>处开始；若<code>num</code>为负数，从右边开始提取字串，但必须<strong>在冒号后面加空格或一个数字或整个<code>num</code>加上括号</strong>，如<code>$&#123;var: -2&#125;</code>、<code>$&#123;var:1-3&#125;</code>或<code>$&#123;var:(-2)&#125;</code>。</li><li>第二种模式：<code>$&#123;var:num1:num2&#125;</code>。<code>num1</code>是位置，<code>num2</code>是长度。表示从<code>$var</code>字符串的第<code>$num1</code>个位置开始提取长度为<code>$num2</code>的子串。不能为负数。</li><li>第三种模式：<code>$&#123;var/pattern/pattern&#125;</code>。将<code>var</code>字符串的<strong>第一个匹配</strong>的<code>pattern</code>替换为另一个<code>pattern</code>。</li><li>第四种模式：<code>$&#123;var//pattern/pattern&#125;</code>。将<code>var</code>字符串中的<strong>所有能匹配</strong>的<code>pattern</code>替换为另一个<code>pattern</code>。</li></ul><h3 id="2-4-符号-后的括号"><a href="#2-4-符号-后的括号" class="headerlink" title="2.4.符号$后的括号"></a>2.4.符号<code>$</code>后的括号</h3><ul><li>（1）<code>$&#123;a&#125;</code>：变量<code>a</code>的值，在不引起歧义的情况下可以省略大括号。</li><li>（2）<code>$(cmd)</code>：命令替换，和<code>cmd</code>效果相同，结果为<code>cmd</code>命令的输出，不过某些Shell版本不支持<code>$()</code>形式的命令替换，如tcsh。</li><li>（3）<code>$((expression))</code>：效果和<code>expr expression</code>相同，计算数学表达式<code>expression</code>的数值，其中<code>expression</code>只要符合C语言的运算规则即可，甚至三目运算符和逻辑表达式都可以计算。</li></ul><h3 id="2-5-使用括号将多条命令执行"><a href="#2-5-使用括号将多条命令执行" class="headerlink" title="2.5.使用括号将多条命令执行"></a>2.5.使用括号将多条命令执行</h3><ul><li>（1）单小括号：<code>(cmd1; cmd2; cmd3)</code>。新开一个子shell顺序执行命令<code>cmd1, cmd2, cmd3</code>，各命令之间用分号隔开，最后一个命令后可以没有分号。</li><li>（2）单大括号：<code>&#123; cmd1; cmd2; cmd3;&#125;</code>。在当前shell顺序执行命令<code>cmd1, cmd2, cmd3</code>，各命令之间用分号隔开，最后一个命令后必须有分号，第一条命令和左括号之间必须用空格隔开。</li></ul><p><strong>注意：</strong>对<code>&#123;&#125;</code>和<code>()</code>而言，括号中的重定向符只影响该条命令， 而括号外的重定向符影响到括号中的所有命令。</p><h2 id="3-重定向和管道"><a href="#3-重定向和管道" class="headerlink" title="3.重定向和管道"></a>3.重定向和管道</h2><ul><li>输出重定向（<code>&gt;</code>）：将命令的输出发送到一个文件中，其中单大于号（<code>&gt;</code>）会覆盖文件内容，双大于号（<code>&gt;&gt;</code>）用以向文件追加数据。</li><li>输入重定向（<code>&lt;</code>）：将文件的内容重定向到命令，与输出重定向正好相反。</li><li>内联输入重定向（<code>&lt;&lt;</code>）：输入重定向的另一种方法，这种方法无需使用文件进行重定向，只需要在命令行中指定用于输入重定向的数据就可以了。必须指定一个文本标记来划分输入数据的开始和结尾。任何字符串都可作为文本标记，但在数据的开始和结尾文本标记必须一致。<blockquote><p><strong>记忆方法：</strong>在命令行上，命令总是在左侧，而重定向符号「指向」数据流动的方向。小于号说明数据正在从输入文件流向命令。</p></blockquote></li><li>管道（<code>|</code>）：将一个命令的输出作为另一个命令的输入（虽然可以用重定向来实现，但是有些笨拙）。<blockquote><p><strong>注意：</strong></p><ul><li><strong>①</strong>不要以为由管道串起的两个命令会依次执行。 Linux系统实际上会同时运行这两个命令，在系统内部将它们连接起来。在第一个命令产生输出的同时，输出会被立即送给第二个命令。数据传输不会用到任何中间文件或缓冲区。</li><li><strong>②</strong>可以在一条命令中使用任意多条管道。</li></ul></blockquote></li></ul><h2 id="4-退出状态码"><a href="#4-退出状态码" class="headerlink" title="4.退出状态码"></a>4.退出状态码</h2><p>shell中运行的每个命令都使用退出状态码（exit status）告诉shell它已经运行完毕。</p><p>按照惯例，<strong>一个成功结束的命令的退出状态码是0</strong>。如果一个命令结束时有错误，退出状态码就是一个正数值。</p><p>退出状态码是一个<code>0～255</code>的整数值，在命令结束运行时由命令传给shell，可以使用变量<code>$?</code>捕获这个值（上个已执行命令的退出状态码）并在脚本中使用。<br>自定义退出状态码（<code>exit n</code>）时，若<code>n</code>超出<code>0~255</code>区间则对<code>256</code>取余。</p><div class="table-container"><table><thead><tr><th style="text-align:center">状态码</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center"><code>0</code></td><td style="text-align:left">命令成功结束</td></tr><tr><td style="text-align:center"><code>1</code></td><td style="text-align:left">一般性未知错误</td></tr><tr><td style="text-align:center"><code>2</code></td><td style="text-align:left">不适合的shell命令</td></tr><tr><td style="text-align:center"><code>126</code></td><td style="text-align:left">命令不可执行</td></tr><tr><td style="text-align:center"><code>127</code></td><td style="text-align:left">没找到命令</td></tr><tr><td style="text-align:center"><code>128</code></td><td style="text-align:left">无效的退出参数</td></tr><tr><td style="text-align:center"><code>128+x</code></td><td style="text-align:left">与Linux信号<code>x</code>相关的严重错误</td></tr><tr><td style="text-align:center"><code>130</code></td><td style="text-align:left">通过<code>Ctrl+C</code>终止的命令</td></tr><tr><td style="text-align:center"><code>255</code></td><td style="text-align:left">正常范围之外的退出状态码</td></tr></tbody></table></div><h2 id="5-待续"><a href="#5-待续" class="headerlink" title="5.待续"></a>5.待续</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;font size=5&gt;&lt;b&gt;文章说明&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;strong&gt;文章作者：&lt;/strong&gt;&lt;a href=&quot;https://hwame.top&quot;&gt;鴻塵&lt;/a&gt;&lt;br&gt;&lt;strong&gt;文章说明：&lt;/strong&gt;学习&lt;code</summary>
      
    
    
    
    <category term="Linux" scheme="https://hwame.top/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://hwame.top/tags/Linux/"/>
    
    <category term="shell" scheme="https://hwame.top/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>Linux世界的规则</title>
    <link href="https://hwame.top/20201129/rules-of-linux.html"/>
    <id>https://hwame.top/20201129/rules-of-linux.html</id>
    <published>2020-11-29T05:51:52.000Z</published>
    <updated>2020-12-03T13:05:34.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章说明：</strong>学习Linux过程中的记录，参考书籍主要有《Linux命令行与shell脚本编程大全（第3版）》，《鸟哥的Linux私房菜（第三版）》系列和《快乐的 Linux 命令行》，参考资料主要有<a href="https://man.linuxde.net/">Linux命令大全</a>等。<br><strong>文章链接：</strong><a href="https://hwame.top/20201129/rules-of-linux.html">https://hwame.top/20201129/rules-of-linux.html</a></p></blockquote><h2 id="1-常见Linux目录名称"><a href="#1-常见Linux目录名称" class="headerlink" title="1.常见Linux目录名称"></a>1.常见Linux目录名称</h2><div class="table-container"><table><thead><tr><th style="text-align:center">目录</th><th style="text-align:left">用途</th></tr></thead><tbody><tr><td style="text-align:center"><code>/</code></td><td style="text-align:left">虚拟目录的根目录，万物起源。通常不会在这里存储文件</td></tr><tr><td style="text-align:center"><code>/bin</code></td><td style="text-align:left">二进制目录，存放许多用户级的GNU工具</td></tr><tr><td style="text-align:center"><code>/boot</code></td><td style="text-align:left">启动目录，包含Linux内核，存放启动文件<br><code>/boot/grub/grub.conf</code> or <code>menu.lst</code>，被用来配置启动加载程序<br><code>/boot/vmlinuz</code>，Linux 内核</td></tr><tr><td style="text-align:center"><code>/dev</code></td><td style="text-align:left">设备目录，Linux在这里创建设备节点</td></tr><tr><td style="text-align:center"><code>/etc</code></td><td style="text-align:left">系统配置文件目录，也包含一系列的<code>shell</code>脚本<br><code>/etc/crontab</code>，定义自动运行的任务<br><code>/etc/fstab</code>，包含存储设备的列表，以及与他们相关的挂载点<br><code>/etc/passwd</code>，包含用户帐号列表</td></tr><tr><td style="text-align:center"><code>/home</code></td><td style="text-align:left">主目录，Linux在这 里创建用户目录</td></tr><tr><td style="text-align:center"><code>/lib</code></td><td style="text-align:left">库目录，存放系统和应用程序的库文件</td></tr><tr><td style="text-align:center"><code>/media</code></td><td style="text-align:left">媒体目录，可移动媒体设备的常用挂载点</td></tr><tr><td style="text-align:center"><code>/mnt</code></td><td style="text-align:left">挂载目录，另一个可移动媒体设备的常用挂载点</td></tr><tr><td style="text-align:center"><code>/opt</code></td><td style="text-align:left">可选目录，常用于存放第三方软件包和数据文件</td></tr><tr><td style="text-align:center"><code>/proc</code></td><td style="text-align:left">进程目录，存放现有硬件及当前进程的相关信息</td></tr><tr><td style="text-align:center"><code>/root</code></td><td style="text-align:left"><code>root</code>用户的主目录</td></tr><tr><td style="text-align:center"><code>/sbin</code></td><td style="text-align:left">系统二进制目录，存放许多GNU管理员级工具</td></tr><tr><td style="text-align:center"><code>/run</code></td><td style="text-align:left">运行目录，存放系统运作时的运行时数据</td></tr><tr><td style="text-align:center"><code>/srv</code></td><td style="text-align:left">服务目录，存放本地服务的相关文件</td></tr><tr><td style="text-align:center"><code>/sys</code></td><td style="text-align:left">系统目录，存放系统硬件信息的相关文件</td></tr><tr><td style="text-align:center"><code>/tmp</code></td><td style="text-align:left">临时目录，可以在该目录中创建和删除临时工作文件</td></tr><tr><td style="text-align:center"><code>/usr</code></td><td style="text-align:left">用户二进制目录，大量用户级的GNU工具和数据文件都存储在这里，它可能是Linux系统中最大的一个<br><code>/usr/bin</code>，包含系统安装的可执行程序，通常会包含许多程序<br><code>/usr/lib</code>，包含由<code>/usr/bin</code>目录中的程序所用的共享库<br><code>/usr/local</code>，非系统发行版自带却打算让系统使用的程序的安装目录<br><code>/usr/sbin</code>，包含许多系统管理程序<br><code>/usr/share</code>，包含许多由<code>/usr/bin</code>目录中的程序使用的共享数据，其中包括像默认的配置文件、图标、桌面背景、音频文件等等<br><code>/usr/share/doc</code>，大多数安装在系统中的软件包会包含一些文档</td></tr><tr><td style="text-align:center"><code>/var</code></td><td style="text-align:left">可变目录，用以存放经常变化的文件，比如日志文件</td></tr></tbody></table></div><h2 id="2-通配符"><a href="#2-通配符" class="headerlink" title="2.通配符"></a>2.通配符</h2><h3 id="2-1-通配符"><a href="#2-1-通配符" class="headerlink" title="2.1.通配符"></a>2.1.通配符</h3><div class="table-container"><table><thead><tr><th style="text-align:center">通配符</th><th style="text-align:left">意义</th></tr></thead><tbody><tr><td style="text-align:center"><code>*</code></td><td style="text-align:left">匹配任意<strong>多个</strong>字符（包括零个或一个）</td></tr><tr><td style="text-align:center"><code>?</code></td><td style="text-align:left">匹配任意<strong>一个</strong>字符（不包括零个）</td></tr><tr><td style="text-align:center"><code>[characters]</code></td><td style="text-align:left">匹配任意一个属于字符集中的字符</td></tr><tr><td style="text-align:center"><code>[!characters]</code></td><td style="text-align:left">匹配任意一个不是字符集中的字符</td></tr><tr><td style="text-align:center"><code>[[:class:]]</code></td><td style="text-align:left">匹配任意一个属于指定<strong>字符类</strong>中的字符</td></tr></tbody></table></div><p><strong>注意：</strong>不同于正则表达式中的<code>.</code>，此处的<code>.</code>仍表示其自身。</p><blockquote><p>参考<a href="https://blog.csdn.net/weini1111/article/details/72896874">「通配符」和「正则表达式」的区别</a>：<br><strong>通配符</strong>是系统级的，多用于文件名上，如<code>find</code>、<code>ls</code>、<code>cp</code>等；<br><strong>正则表达式</strong>则需要相关工具的支持，如<code>egrep</code>、<code>awk</code>、<code>vi</code>、<code>perl</code>等，多用于针对文件内容的文本过滤工具，如<code>awk</code>、<code>sed</code>等。</p></blockquote><h3 id="2-2-常用的字符类"><a href="#2-2-常用的字符类" class="headerlink" title="2.2.常用的字符类"></a>2.2.常用的字符类</h3><div class="table-container"><table><thead><tr><th style="text-align:center">通配符</th><th style="text-align:left">意义</th></tr></thead><tbody><tr><td style="text-align:center"><code>[:alnum:]</code></td><td style="text-align:left">匹配任意一个字母或数字</td></tr><tr><td style="text-align:center"><code>[:alpha:]</code></td><td style="text-align:left">匹配任意一个字母</td></tr><tr><td style="text-align:center"><code>[:digit:]</code></td><td style="text-align:left">匹配任意一个数字</td></tr><tr><td style="text-align:center"><code>[:lower:]</code></td><td style="text-align:left">匹配任意一个小写字母</td></tr><tr><td style="text-align:center"><code>[:upper:]</code></td><td style="text-align:left">匹配任意一个大写字母</td></tr></tbody></table></div><h3 id="2-3-通配符范例"><a href="#2-3-通配符范例" class="headerlink" title="2.3.通配符范例"></a>2.3.通配符范例</h3><div class="table-container"><table><thead><tr><th style="text-align:center">模式</th><th style="text-align:left">匹配对象</th></tr></thead><tbody><tr><td style="text-align:center"><code>*</code></td><td style="text-align:left">所有文件</td></tr><tr><td style="text-align:center"><code>g*</code></td><td style="text-align:left">文件名以<code>g</code>开头的文件</td></tr><tr><td style="text-align:center"><code>b*.txt</code></td><td style="text-align:left">以<code>b</code>开头，中间任意多个（$\ge 0$）字符，并以<code>.txt</code>结尾的文件</td></tr><tr><td style="text-align:center"><code>Data???</code></td><td style="text-align:left">以<code>Data</code>开头，其后紧接着 3 个字符的文件</td></tr><tr><td style="text-align:center"><code>[abc]*</code></td><td style="text-align:left">文件名以<code>a</code>或<code>b</code>或<code>c</code>开头的文件</td></tr><tr><td style="text-align:center"><code>BACK.[0-9][0-9]</code></td><td style="text-align:left">以<code>BACK.</code>开头并紧接2个数字的文件</td></tr><tr><td style="text-align:center"><code>[[:upper:]]*</code></td><td style="text-align:left">以大写字母开头的文件</td></tr><tr><td style="text-align:center"><code>[![:digit:]]*</code></td><td style="text-align:left">不以数字开头的文件</td></tr><tr><td style="text-align:center"><code>*[[:lower:]123]</code></td><td style="text-align:left">以小写字母、<code>1</code>、<code>2</code>、<code>3</code>四种之一结尾的文件</td></tr></tbody></table></div><h2 id="3-命令表示法"><a href="#3-命令表示法" class="headerlink" title="3.命令表示法"></a>3.命令表示法</h2><p>很多时候我们需要参考某个命令的用法，例如用<code>command --help</code>或<code>man command</code>查看帮助文档，但是选项参数太多，语法规则不知道意义，以下是简单介绍各符号的意义：</p><div class="table-container"><table><thead><tr><th style="text-align:center">符号</th><th style="text-align:center">意义</th></tr></thead><tbody><tr><td style="text-align:center"><code>[]</code></td><td style="text-align:center">表示可选的项目</td></tr><tr><td style="text-align:center"><code>&lt;&gt;</code></td><td style="text-align:center">位置参数</td></tr><tr><td style="text-align:center"><code>()</code></td><td style="text-align:center">必需</td></tr><tr><td style="text-align:center"><code>丨</code></td><td style="text-align:center">表示互斥选项</td></tr><tr><td style="text-align:center"><code>...</code></td><td style="text-align:center">表示参数可重复</td></tr></tbody></table></div><p>详细说明请参考：</p><ul><li><a href="https://blog.csdn.net/wq6ylg08/article/details/88919530">Linux命令行帮助文档命令语法公式格式详解和Git命令语法格式解读</a></li><li><a href="http://docopt.org/">DOCOPT: Command-line interface description language</a></li><li><a href="https://hwame.top/command-line-description.html">命令行帮助文档语法格式详解</a></li></ul><h2 id="4-文件描述符与重定向"><a href="#4-文件描述符与重定向" class="headerlink" title="4.文件描述符与重定向"></a>4.文件描述符与重定向</h2><p>Linux中万物皆文件，用<strong>文件描述符</strong>（file descriptor）来标识每个文件对象。每个进程一次最多可以有九个文件描述符。出于特殊目的，bash shell保留了前三个文件描述符：</p><div class="table-container"><table><thead><tr><th style="text-align:center">文件描述符</th><th style="text-align:center">缩写</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center"><code>0</code></td><td style="text-align:center"><code>STDIN</code></td><td style="text-align:center">标准输入</td></tr><tr><td style="text-align:center"><code>1</code></td><td style="text-align:center"><code>STDOUT</code></td><td style="text-align:center">标准输出</td></tr><tr><td style="text-align:center"><code>2</code></td><td style="text-align:center"><code>STDERR</code></td><td style="text-align:center">标准错误</td></tr></tbody></table></div><p>默认情况下，<code>STDERR</code>文件描述符会和<code>STDOUT</code>文件描述符指向同样的地方（尽管分配给它们的文件描述符值不同）。也就是说，默认情况下，错误消息也会输出到显示器输出中。但<code>STDERR</code>并不会随着<code>STDOUT</code>的重定向而发生改变，例如将<code>STDOUT</code>重定向到某文件但是<code>STDERR</code>依然会打印到屏幕。</p><ul><li><strong>只重定向错误：</strong>只重定向错误消息需要将该文件描述符值放在重定向符号前，该值必须紧紧地放在重定向符号前，否则不会工作：<code>command 2&gt; error.txt</code>。注意，shell会只重定向错误消息，正常输出仍会显示在屏幕上。</li><li><strong>重定向错误和数据：</strong>如果想重定向错误和正常输出，必须用两个重定向符号。需要在符号前面放上待重定向数据所对应的文件描述符，然后指向用于保存数据的输出文件：<code>command 2&gt; error.txt 1&gt; output.txt</code>。可以用这种方法将脚本的正常输出和脚本生成的错误消息分离开来。如果想将错误和正常输出重定向到同一个输出文件，则需使用特殊的重定向符号<code>&amp;&gt;</code>，即<code>command &amp;&gt; allinfo.txt</code>。注意，当使用<code>&amp;&gt;</code>符时命令生成的所有输出都会发送到同一位置，包括数据和错误，但是错误消息具有更高的优先级。</li></ul><p><br></p><hr><ul><li><strong>在脚本中重定向输出：</strong>包括「临时重定向行输出」和「永久重定向脚本中的所有命令」。<ul><li><strong>①</strong>使用输出重定向符来将输出信息重定向到<code>STDERR</code>文件描述符，在重定向到文件描述符时必须在文件描述符数字之前加一个<code>&amp;</code>：<code>command &gt;&amp;2</code>。因为Linux默认会将<code>STDERR</code>导向<code>STDOUT</code>，因此直接运行没有区别，必须使用<code>./mz.sh 2&gt; stderr.txt</code>才能将脚本中所有导向<code>STDERR</code>的文本重定向到txt文件。见下例：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is an error&quot;</span> &gt;&amp;2</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is normal output&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行将输出两句：./mz.sh</span></span><br><span class="line"><span class="comment"># 执行将输出一句：./mz.sh 2&gt; stderr.txt</span></span><br></pre></td></tr></table></figure></li><li><strong>②</strong>如果脚本中有大量数据需要重定向，那么每句都重定向会很烦琐，因此可以用<code>exec</code>命令告诉shell在脚本执行期间重定向某个特定文件描述符，见下例：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">exec</span> 2&gt;testerror</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is the start of the script&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;now redirecting all output to another location&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> 1&gt;testout</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This output should go to the testout file&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;but this should go to the testerror file&quot;</span> &gt;&amp;2</span><br></pre></td></tr></table></figure>运行该脚本，四个<code>echo</code>语句中的一二句会打印到屏幕，第三句重定向到<code>testout</code>，第四句重定向到<code>testerror</code>。<br><strong>注意：</strong>一旦重定向了<code>STDOUT</code>或<code>STDERR</code>，就很难再将它们重定向回原来的位置。如果你需要在重定向中来回切换的话，见下文。</li></ul></li><li><strong>在脚本中重定向输入：</strong><code>exec</code>命令允许你将<code>STDIN</code>重定向到Linux系统上的文件中：<code>exec 0&lt; stdin.txt</code>。这个命令会告诉shell它应该从<strong>文件<code>stdin.txt</code></strong>中获得输入，而不是<strong><code>STDIN</code></strong>。这个重定向<strong>只要在脚本需要输入时就会作用</strong>。见下例：<br><code>read</code>命令读取用户在键盘上输入的数据。将<code>STDIN</code>重定向到文件后，当<code>read</code>命令试图从<code>STDIN</code>读入数据时，它会到文件去取数据，而不是键盘。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">exec</span> 0&lt; testfile</span><br><span class="line">count=1</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Line #<span class="variable">$count</span>: <span class="variable">$line</span>&quot;</span></span><br><span class="line">    count=$[ <span class="variable">$count</span> + 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></li></ul><p>在shell中最多可以有9个打开的文件描述符。其他6个从3~8的文件描述符均可用作输入或输出重定向。你可以将这些文件描述符中的任意一个分配给文件，然后在脚本中使用它们。<br>你可以分配另外一个文件描述符给标准文件描述符，反之亦然。这意味着你可以将<code>STDOUT</code>的原来位置重定向到另一个文件描述符，然后再利用该文件描述符重定向回<code>STDOUT</code>。见下例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">exec</span> 3&gt;&amp;1</span><br><span class="line"><span class="built_in">exec</span> 1&gt;testout</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This should store in the output file&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;along with this line.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> 1&gt;&amp;3</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Now things should be back to normal&quot;</span></span><br></pre></td></tr></table></figure><br>首先，脚本将<strong>文件描述符3</strong>重定向到<strong>文件描述符1</strong>(<code>STDOUT</code>)的当前位置，这意味着任何发送给文件描述符3的输出都将出现在显示器上。第二个<code>exec</code>命令将<code>STDOUT</code>重定向到文件， shell现在会将发送给<code>STDOUT</code>的输出直接重定向到输出文件中。但是，文件描述符3仍然指向<code>STDOUT</code>原来的位置，也就是显示器。如果此时将输出数据发送给文件描述符3，它仍然会出现在显示器上，尽管<code>STDOUT</code>已经被重定向了。在向<code>STDOUT</code>（现在指向一个文件）发送一些输出之后，脚本将<code>STDOUT</code>重定向到文件描述符3的当前位置（现在仍然是显示器）。这意味着现在<code>STDOUT</code>又指向了它原来的位置：显示器。<br>这个方法可能有点叫人困惑，但这是一种在脚本中临时重定向输出，然后恢复默认输出设置的常用方法。</p><p>同样，在重定向到文件之前，先将<code>STDIN</code>文件描述符保存到另外一个文件描述符，然后在读取完文件之后再将<code>STDIN</code>恢复到它原来的位置。见下例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">exec</span> 6&lt;&amp;0</span><br><span class="line"><span class="built_in">exec</span> 0&lt; testfile</span><br><span class="line">count=1</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Line #<span class="variable">$count</span>: <span class="variable">$line</span>&quot;</span></span><br><span class="line">    count=$[ <span class="variable">$count</span> + 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exec</span> 0&lt;&amp;6</span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;Are you done now? &quot;</span> answer</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$answer</span> <span class="keyword">in</span></span><br><span class="line">    Y|y) <span class="built_in">echo</span> <span class="string">&quot;Goodbye&quot;</span>;;</span><br><span class="line">    N|n) <span class="built_in">echo</span> <span class="string">&quot;Sorry, this is the end.&quot;</span>;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><br>文件描述符6用来保存<code>STDIN</code>的位置，然后脚本将<code>STDIN</code>重定向到一个文件<code>testfile</code>。<code>read</code>命令的所有输入都来自重定向后的<code>STDIN</code>（也就是输入文件）。在读取了所有行之后，脚本会将<code>STDIN</code>重定向到文件描述符6，从而将<code>STDIN</code>恢复到原先的位置。该脚本用了另外一个<code>read</code>命令来测试<code>STDIN</code>是否恢复正常了，这次它会等待键盘的输入。</p><h2 id="5-待续"><a href="#5-待续" class="headerlink" title="5.待续"></a>5.待续</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;font size=5&gt;&lt;b&gt;文章说明&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;strong&gt;文章作者：&lt;/strong&gt;&lt;a href=&quot;https://hwame.top&quot;&gt;鴻塵&lt;/a&gt;&lt;br&gt;&lt;strong&gt;文章说明：&lt;/strong&gt;学习Linux</summary>
      
    
    
    
    <category term="Linux" scheme="https://hwame.top/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://hwame.top/tags/Linux/"/>
    
    <category term="shell" scheme="https://hwame.top/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>Linux下shell脚本编程学习</title>
    <link href="https://hwame.top/20201127/learning-linux-shell-script.html"/>
    <id>https://hwame.top/20201127/learning-linux-shell-script.html</id>
    <published>2020-11-27T06:19:03.000Z</published>
    <updated>2020-12-09T11:14:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：从11月27日到12月9日，大概花了一个星期的时间，终于啃完了621页的《Linux命令行与shell脚本编程大全》。<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章说明：</strong>学习<code>shell</code>过程中的记录，参考书籍主要有《Linux命令行与shell脚本编程大全（第3版）》，《鸟哥的Linux私房菜（第三版）》系列和《快乐的 Linux 命令行》，参考资料主要有<a href="https://man.linuxde.net/">Linux命令大全</a>等。<br><strong>文章链接：</strong><a href="https://hwame.top/20201127/learning-linux-shell-script.html">https://hwame.top/20201127/learning-linux-shell-script.html</a></p></blockquote><h2 id="1-构建基本脚本"><a href="#1-构建基本脚本" class="headerlink" title="1.构建基本脚本"></a>1.构建基本脚本</h2><h3 id="1-1-创建shell脚本文件"><a href="#1-1-创建shell脚本文件" class="headerlink" title="1.1.创建shell脚本文件"></a>1.1.创建shell脚本文件</h3><p>创建shell脚本文件时，必须在文件的<strong>第一行</strong>指定要使用的shell。其格式为：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br></pre></td></tr></table></figure><br>在指定了shell之后，就可以在文件的每一行中输入命令，然后加一个回车符。</p><p>在通常的shell脚本中，井号（<code>#</code>）用作注释行。shell不会解释以<code>#</code>开头的行（除了以<code>#!</code>开头的第一行）。</p><h3 id="1-2-运行脚本"><a href="#1-2-运行脚本" class="headerlink" title="1.2.运行脚本"></a>1.2.运行脚本</h3><p><strong>①作为可执行程序</strong><br>首先需要具有执行权限：<code>chmod +x ./myfile</code>，然后在脚本所在目录输入<code>./myfile</code>执行脚本。<br><strong>注意：</strong>若直接输入<code>myfile</code>则会报错「命令未找到」，因为shell会通过<code>PATH</code>环境变量来查找命令，所以可以采取两种方法：</p><ul><li>将shell脚本文件所处的目录添加到<code>PATH</code>环境变量中；</li><li>用绝对或相对文件路径来引用shell脚本文件，如上使用相对路径。</li></ul><p><strong>②作为解释器参数</strong><br>直接运行解释器，其参数就是shell脚本的文件名。例如<code>/bin/sh myfile</code>。注意，Linux下的可执行文件不需要拓展名，只需要拥有执行权限即可，因此文件名为<code>myfile</code>或<code>myfile.sh</code>都行。</p><h2 id="2-使用结构化命令"><a href="#2-使用结构化命令" class="headerlink" title="2.使用结构化命令"></a>2.使用结构化命令</h2><h3 id="2-1-使用if-then语句"><a href="#2-1-使用if-then语句" class="headerlink" title="2.1.使用if-then语句"></a>2.1.使用<code>if-then</code>语句</h3><p>最基本的结构化命令就是<code>if-then</code>语句。<code>if-then</code>语句有如下格式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">command</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    commands</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><br><strong>注意：</strong>在其他编程语言中，<code>if</code>语句之后的对象是一个等式，这个等式的求值结果为<code>TRUE</code>或<code>FALSE</code>，条件为真时才执行<code>then</code>部分。bash shell的<code>if</code>语句会运行<code>if</code>后面的那个命令，如果该命令的退出状态码是0（即该命令成功运行），位于<code>then</code>部分的命令就会被执行。如果该命令的退出状态码是其他值，<code>then</code>部分的命令就不会被执行。<br><strong>注意：</strong>再说一遍，<code>command</code>一定会执行！<br><strong>注意：</strong><code>if-then</code>语句的另一种形式如下，通过把分号放在待求值的命令尾部，就可以将<code>then</code>语句放在同一行上了，这样看起来更像其他编程语言中的<code>if-then</code>语句。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">command</span>; <span class="keyword">then</span></span><br><span class="line">    commands</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p><h3 id="2-2-使用if-then-else语句"><a href="#2-2-使用if-then-else语句" class="headerlink" title="2.2.使用if-then-else语句"></a>2.2.使用<code>if-then-else</code>语句</h3><p>当<code>if</code>语句中的命令返回退出状态码0时，<code>then</code>部分中的命令会被执行，这跟普通的<code>if-then</code>语句一样。当<code>if</code>语句中的命令返回非零退出状态码时，bash shell会执行<code>else</code>部分中的命令。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">command</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    commands1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    commands2</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p><h3 id="2-3-使用嵌套的if语句"><a href="#2-3-使用嵌套的if语句" class="headerlink" title="2.3.使用嵌套的if语句"></a>2.3.使用嵌套的<code>if</code>语句</h3><p>有时你需要检查脚本代码中的多种条件。对此，可以使用嵌套的<code>if-then</code>语句。<br>书写多个<code>if-then</code>语句会使代码不易阅读，很难理清逻辑流程，因此可以使用<code>else</code>部分的另一种形式：<strong><code>elif</code></strong>。</p><p>这样就不用再书写多个<code>if-then</code>语句了。<code>elif</code>使用另一个<code>if-then</code>语句延续<code>else</code>部分。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> command1</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    commands1</span><br><span class="line"><span class="keyword">elif</span> command2</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    commands2</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p><h3 id="2-4-test命令"><a href="#2-4-test命令" class="headerlink" title="2.4.test命令"></a>2.4.<code>test</code>命令</h3><p><code>test</code>命令提供了在<code>if-then</code>语句中测试不同条件的途径，可以测试命令退出状态码之外的条件。</p><p>如果<code>test</code>命令中列出的条件成立，<code>test</code>命令就会退出并返回退出状态码0。这样<code>if-then</code>语句就与其他编程语言中的<code>if-then</code>语句以类似的方式工作了。如果条件不成立，<code>test</code>命令就会退出并返回非零的退出状态码，这使得<code>if-then</code>语句不会再被执行。<code>test</code>命令的格式非常简单：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span> condition</span><br><span class="line"><span class="comment"># condition是test命令要测试的一系列参数和值</span></span><br></pre></td></tr></table></figure><br><strong>注意：</strong>如果不写<code>test</code>命令的<code>condition</code>部分，它会以非零的退出状态码退出，并执行<code>else</code>语句块。<br><strong>注意：</strong>bash shell提供了另一种条件测试方法，无需在<code>if-then</code>语句中声明<code>test</code>命令，即使用方括号定义测试条件，如<code>if [ condition ]</code><strong>注意，第一个方括号之后和第二个方括号之前必须加上一个空格，否则就会报错</strong>。</p><p><code>test</code>命令判断三类条件：①<strong>数值比较</strong>；②<strong>字符串比较</strong>；③<strong>文件比较</strong>。</p><h4 id="数值比较"><a href="#数值比较" class="headerlink" title="数值比较"></a>数值比较</h4><div class="table-container"><table><thead><tr><th style="text-align:center">比较</th><th style="text-align:center">含义</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center"><code>n1 -eq n2</code></td><td style="text-align:center"><code>equal</code></td><td style="text-align:left">检查n1是否与n2<strong>相等</strong></td></tr><tr><td style="text-align:center"><code>n1 -ge n2</code></td><td style="text-align:center"><code>greater or equal</code></td><td style="text-align:left">检查n1是否<strong>大于或等于</strong>n2</td></tr><tr><td style="text-align:center"><code>n1 -gt n2</code></td><td style="text-align:center"><code>greater than</code></td><td style="text-align:left">检查n1是否<strong>大于</strong>n2</td></tr><tr><td style="text-align:center"><code>n1 -le n2</code></td><td style="text-align:center"><code>less or equal</code></td><td style="text-align:left">检查n1是否<strong>小于或等于</strong>n2</td></tr><tr><td style="text-align:center"><code>n1 -lt n2</code></td><td style="text-align:center"><code>less than</code></td><td style="text-align:left">检查n1是否<strong>小于</strong>n2</td></tr><tr><td style="text-align:center"><code>n1 -ne n2</code></td><td style="text-align:center"><code>not equal</code></td><td style="text-align:left">检查n1是否<strong>不等于</strong>n2</td></tr></tbody></table></div><p><strong>注意：</strong>bash shell只能处理整数，不能在<code>test</code>命令中使用浮点值。</p><h4 id="字符串比较"><a href="#字符串比较" class="headerlink" title="字符串比较"></a>字符串比较</h4><div class="table-container"><table><thead><tr><th style="text-align:center">比较</th><th style="text-align:center">描述</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td style="text-align:center"><code>str1 = str2</code></td><td style="text-align:center">检查str1是否和str2<strong>相同</strong></td><td style="text-align:center">考虑标点和大小写情况</td></tr><tr><td style="text-align:center"><code>str1 != str2</code></td><td style="text-align:center">检查str1是否和str2<strong>不同</strong></td><td style="text-align:center">考虑标点和大小写情况</td></tr><tr><td style="text-align:center"><code>str1 &lt; str2</code></td><td style="text-align:center">检查str1是否比str2<strong>小</strong></td><td style="text-align:center">需转义，注意顺序</td></tr><tr><td style="text-align:center"><code>str1 &gt; str2</code></td><td style="text-align:center">检查str1是否比str2<strong>大</strong></td><td style="text-align:center">需转义，注意顺序</td></tr><tr><td style="text-align:center"><code>-n str1</code></td><td style="text-align:center">检查str1是否<strong>长度非0</strong></td><td style="text-align:center">「非0」和「为0」恰好相反</td></tr><tr><td style="text-align:center"><code>-z str1</code></td><td style="text-align:center">检查str1是否<strong>长度为0</strong></td><td style="text-align:center">空的和未初始化的变量长度为0</td></tr></tbody></table></div><p><strong>注意：</strong>比较字符串的大小时，大于号和小于号必须转义，否则shell会把它们当作重定向符号，把字符串值当作文件名。<br><strong>注意：</strong>比较字符串的大小时，大于和小于顺序和<code>sort</code>命令所采用的不同：在比较测试中，大写字母被认为是小于小写字母的，但<code>sort</code>命令恰好相反。<br><strong>注意：</strong>空的和未初始化的变量会对shell脚本测试造成灾难性的影响。如果不是很确定一个变量的内容，最好在将其用于数值或字符串比较之前先通过<code>-n</code>或<code>-z</code>来测试一下变量是否含有值。</p><h4 id="文件比较"><a href="#文件比较" class="headerlink" title="文件比较"></a>文件比较</h4><p>文件比较很有可能是shell编程中最为强大、也是用得最多的比较形式。它允许你测试Linux文件系统上文件和目录的状态。</p><div class="table-container"><table><thead><tr><th style="text-align:center">比较</th><th style="text-align:center">含义</th><th style="text-align:left">描述</th><th style="text-align:left">备注</th></tr></thead><tbody><tr><td style="text-align:center"><code>-d file</code></td><td style="text-align:center"><code>directory</code></td><td style="text-align:left">检查file是否存在并是一个目录</td><td style="text-align:left">——</td></tr><tr><td style="text-align:center"><code>-e file</code></td><td style="text-align:center"><code>exist</code></td><td style="text-align:left">检查file是否存在</td><td style="text-align:left">可用于文件和目录</td></tr><tr><td style="text-align:center"><code>-f file</code></td><td style="text-align:center"><code>file</code></td><td style="text-align:left">检查file是否存在并是一个文件</td><td style="text-align:left">——</td></tr><tr><td style="text-align:center"><code>-r file</code></td><td style="text-align:center"><code>readable</code></td><td style="text-align:left">检查file是否存在并可读</td><td style="text-align:left">——</td></tr><tr><td style="text-align:center"><code>-s file</code></td><td style="text-align:center">——</td><td style="text-align:left">检查file是否存在并非空</td><td style="text-align:left">状态码0说明有数据</td></tr><tr><td style="text-align:center"><code>-w file</code></td><td style="text-align:center"><code>writable</code></td><td style="text-align:left">检查file是否存在并可写</td><td style="text-align:left">判断你对文件是否有可写权限</td></tr><tr><td style="text-align:center"><code>-x file</code></td><td style="text-align:center"><code>executable</code></td><td style="text-align:left">检查file是否存在并可执行</td><td style="text-align:left">——</td></tr><tr><td style="text-align:center"><code>-O file</code></td><td style="text-align:center"><code>Owner</code></td><td style="text-align:left">检查file是否存在并属当前用户所有</td><td style="text-align:left">测试你是否是文件的属主</td></tr><tr><td style="text-align:center"><code>-G file</code></td><td style="text-align:center"><code>Group</code></td><td style="text-align:left">检查file是否存在并且默认组与当前用户相同</td><td style="text-align:left">检查文件的默认组<br>非用户所属所有组</td></tr><tr><td style="text-align:center"><code>file1 -nt file2</code></td><td style="text-align:center"><code>new than</code></td><td style="text-align:left">检查file1是否比file2新</td><td style="text-align:left">指创建日期，越早创建越旧</td></tr><tr><td style="text-align:center"><code>file1 -ot file2</code></td><td style="text-align:center"><code>old than</code></td><td style="text-align:left">检查file1是否比file2旧</td><td style="text-align:left">指创建日期，越早创建越旧</td></tr></tbody></table></div><p><strong>注意：</strong>在使用<code>-nt</code>或<code>-ot</code>比较文件之前，必须先确认文件是存在的，因为他们都不会先检查文件是否存在，所以会导致直接运行了<code>else</code>部分。</p><h3 id="2-5-复合条件测试"><a href="#2-5-复合条件测试" class="headerlink" title="2.5.复合条件测试"></a>2.5.复合条件测试</h3><p><code>if-then</code>语句允许使用<strong>布尔逻辑</strong>来组合测试，布尔逻辑是一种能够将可能的返回值简化为<code>TRUE</code>或<code>FALSE</code>的方法。有<code>AND</code>和<code>OR</code>两种布尔运算符可用：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ condition1 ] &amp;&amp; [ condition2 ]</span><br><span class="line">[ condition1 ] || [ condition2 ]</span><br></pre></td></tr></table></figure></p><h3 id="2-6-if-then的高级特性"><a href="#2-6-if-then的高级特性" class="headerlink" title="2.6.if-then的高级特性"></a>2.6.<code>if-then</code>的高级特性</h3><p>bash shell提供了两项可在<code>if-then</code>语句中使用的高级特性：</p><ul><li>①用于<strong>数学表达式</strong>的双括号<code>(( expression ))</code>。<code>expression</code>可以是任意的数学赋值或比较表达式。除了<code>test</code>命令使用的标准数学运算符，双括号命令中会用到的其他运算符还有：<code>val++</code>，后增；<code>val--</code>，后减；<code>++val</code>，先增；<code>--val</code>，先减；<code>!</code>，逻辑求反；<code>~</code>，位求反；<code>**</code>，幂运算；<code>&lt;&lt;</code>，左位移；<code>&gt;&gt;</code>，右位移；<code>&amp;</code>，位布尔和；<code>|</code>，位布尔或；<code>&amp;&amp;</code>，逻辑和；<code>||</code>，逻辑或。<br><strong>注意⑴：</strong>可以在<code>if</code>语句中用双括号命令，也可以在脚本中的普通命令里使用来赋值。<br><strong>注意⑵：</strong>不需要将双括号中表达式里的大于号转义，这是双括号命令提供的另一个高级特性。</li><li>②用于<strong>高级字符串处理功能</strong>的双方括号<code>[[ expression ]]</code>，注意<strong>不是所有的shell都支持双方括号</strong>。与<code>test</code>命令相比主要是指「<strong>模式匹配</strong>（pattern matching）」，例如：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># using pattern matching</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$USER</span> == h* ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Hello <span class="variable">$USER</span>.&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Sorry, I do not know you.&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>在上例中我们使用了双等号（<code>==</code>）将右边的字符串（<code>h*</code>）视为一个模式，并应用模式匹配规则。运行该脚本将输出「<code>Hello hwame.</code>」。</li></ul><h3 id="2-7-case命令"><a href="#2-7-case命令" class="headerlink" title="2.7.case命令"></a>2.7.<code>case</code>命令</h3><p><code>case</code>命令采用列表格式来检查单个变量的多个值，而不需要再写出所有的<code>elif</code>语句来不停地检查同一个变量的值了：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> variable <span class="keyword">in</span></span><br><span class="line">pattern1 | pattern2) commands1;;</span><br><span class="line">           pattern3) commands2;;</span><br><span class="line">                  *) commands_default;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><br><code>case</code>命令提供了一个更清晰的方法来为变量每个可能的值指定不同的选项，将指定的变量与不同模式进行比较。</p><p>如果变量和模式是匹配的，那么shell会执行为该模式指定的命令。可以通过<strong>单竖线操作符</strong>在一行中分隔出多个模式模式。<strong>星号</strong>会捕获所有与已知模式不匹配的值。</p><h2 id="3-循环语句"><a href="#3-循环语句" class="headerlink" title="3.循环语句"></a>3.循环语句</h2><h3 id="3-1-for命令"><a href="#3-1-for命令" class="headerlink" title="3.1.for命令"></a>3.1.<code>for</code>命令</h3><p>重复执行一系列命令在编程中很常见，<code>for</code>循环不用说，基本格式如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> list</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    commands</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br><code>for</code>命令读取值的方式有：①<strong>从列表中读取值</strong>；②<strong>从变量读取列表</strong>；③<strong>从命令读取值</strong>；④<strong>用通配符读取目录</strong>。</p><p><strong>注意：</strong>列表中各值按空格依次排列，不需要括号。<br><strong>注意：</strong>考虑下例，第2行输出将两个单引号间的部分<strong>拼接</strong>到<code>don</code>和<code>ll</code>中间了。这种问题可以采用①使用转义字符<code>\</code>将单引号转义；②使用双引号来定义用到单引号的值。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">test</span> <span class="keyword">in</span> I don<span class="string">&#x27;t know if this&#x27;</span>ll work; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;word:<span class="variable">$test</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出：</span></span><br><span class="line">word:I</span><br><span class="line">word:dont know <span class="keyword">if</span> thisll</span><br><span class="line">word:work</span><br></pre></td></tr></table></figure><br><strong>注意：</strong><code>for</code>循环假定每个值都是用空格分割的。如果在单独的数据值中有空格，就必须用双引号将这些值圈起来。<br><strong>注意：</strong>在某个值两边使用双引号时，shell并不会将双引号当成值的一部分。</p><p>通常shell脚本遇到的情况是，你将一系列值都集中存储在了一个变量中，然后需要遍历变量中的整个列表。也可以通过<code>for</code>命令完成这个任务，例如：<br>注意，代码还是用了另一个赋值语句向<code>$list</code>变量包含的已有列表中添加（或者说是<strong>拼接</strong>）了一个值。这是向变量中存储的已有文本字符串尾部添加文本的一个常用方法：<code>list=$list&quot; Connecticut&quot;</code>。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">list=<span class="string">&quot;Alabama Alaska Arizona Arkansas Colorado&quot;</span></span><br><span class="line">list=<span class="variable">$list</span><span class="string">&quot; Connecticut&quot;</span></span><br><span class="line"><span class="keyword">for</span> state <span class="keyword">in</span> <span class="variable">$list</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Have you ever visited <span class="variable">$state</span>?&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p><p>上述代码中，shell以空格分隔列表，事实上是由特殊的环境变量<code>IFS</code>（Internal Field Separator，内部字段分隔符）控制。默认情况下， bash shell会将「<strong>空格</strong>」、「<strong>制表符</strong>」、「<strong>换行符</strong>」当作字段分隔符。<br>如果需要临时使用新的字段分隔符，可以先保存旧值，使用完新值后再还原：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IFS.OLD=<span class="variable">$IFS</span></span><br><span class="line">IFS=$<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">&lt;在代码中使用新的IFS值&gt;</span><br><span class="line">IFS=<span class="variable">$IFS</span>.OLD</span><br></pre></td></tr></table></figure></p><p>如果要指定多个<code>IFS</code>字符，只要将它们<strong>在赋值行串起来</strong>就行：<code>IFS=$&#39;\n&#39;:;&quot;</code>，这个赋值会将换行符、冒号、分号和双引号作为字段分隔符。如何使用<code>IFS</code>字符解析数据没有任何限制。</p><p>可以用<code>for</code>命令来自动遍历目录中的文件。进行此操作时，必须在文件名或路径名中使用通配符。它会强制shell使用文件扩展匹配。文件扩展匹配是生成匹配指定通配符的文件名或路径名的过程。<br>也可以在<code>for</code>命令中列出多个目录通配符，将目录查找和列表合并进同一个<code>for</code>语句。<br><strong>注意：</strong>在Linux中，目录名和文件名中包含空格当然是合法的。要适应这种情况，应该将<code>$file</code>变量用双引号圈起来：<code>if [ -d &quot;$file&quot; ]</code>。如果不这么做，遇到含有空格的目录名或文件名时就会有错误产生：<code>[: too many arguments</code>，在<code>test</code>命令中，bash shell会将额外的单词当作参数，进而造成错误。</p><h3 id="3-2-C语言风格的for命令"><a href="#3-2-C语言风格的for命令" class="headerlink" title="3.2.C语言风格的for命令"></a>3.2.C语言风格的<code>for</code>命令</h3><p>下面为C语言代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The next number is %d\n&quot;</span>, i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>以下是bash中C语言风格的<code>for</code>循环的基本格式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (( variable assignment ; condition ; iteration process ))</span><br><span class="line"><span class="keyword">for</span> (( a = <span class="number">1</span>; a &lt; <span class="number">10</span>; a++ ))</span><br></pre></td></tr></table></figure><br>注意，有些部分并没有遵循bash shell标准的<code>for</code>命令：</p><ul><li>变量赋值可以有空格；</li><li>条件中的变量不以美元符开头；</li><li>迭代过程的算式未用expr命令格式。</li></ul><p>C语言风格的<code>for</code>命令也允许为迭代使用多个变量。循环会单独处理每个变量，你可以为每个变量定义不同的迭代过程。尽管可以使用多个变量，但你只能在<code>for</code>循环中定义<strong>一种</strong>条件，例如<code>for (( a=1, b=10; a &lt;= 10; a++, b-- ))</code>。</p><h3 id="3-3-while命令"><a href="#3-3-while命令" class="headerlink" title="3.3.while命令"></a>3.3.<code>while</code>命令</h3><p><code>while</code>命令某种意义上是<code>if-then</code>语句和<code>for</code>循环的混杂体：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> test_command</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    commands</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br><code>while</code>命令中定义的<code>test_command</code>和<code>if-then</code>语句中的格式一模一样。可以使用任何普通的bash shell命令，或者用<code>test</code>命令进行条件测试，比如测试变量值。<code>while</code>命令的关键在于所指定的<code>test_command</code>的退出状态码必须随着循环中运行的命令而改变。如果退出状态码不发生变化，<code>while</code>循环就将一直不停地进行下去从而陷入无限循环。</p><p>最常见的<code>test_command</code>的用法是用方括号来检查循环命令中用到的shell变量的值，<code>while</code>命令定义了每次迭代时检查的测试条件。</p><p><code>while</code>命令允许你在<code>while</code>语句行定义多个测试命令。<strong>只有最后一个测试命令的退出状态码会被用来决定什么时候结束循环</strong>，见下例。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">var1=10</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">echo</span> <span class="variable">$var1</span></span><br><span class="line">      [ <span class="variable">$var1</span> -ge 0 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;This is inside the loop&quot;</span></span><br><span class="line">    var1=$[ <span class="variable">$var1</span> - 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br>运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201130多个测试命令.png" alt="多个测试命令导致的结果"><br><code>while</code>循环会在<code>var1</code>变量等于<code>0</code>时执行<code>echo</code>语句，然后将<code>var1</code>变量的值减一。接下来再次执行测试命令，用于下一次迭代。<code>echo</code>测试命令被执行并显示了<code>var</code>变量的值（现在小于<code>0</code>了）。直到shell执行<code>test</code>测试命令，<code>while</code>循环才会停止。</p><p>这说明在含有多个命令的<code>while</code>语句中，在每次迭代中所有的测试命令都会被执行，包括测试命令失败的最后一次迭代。要留心这种用法。另一处要留意的是该如何指定多个测试命令。注意，<strong>每个测试命令都出现在单独的一行上</strong>。</p><h3 id="3-4-until命令"><a href="#3-4-until命令" class="headerlink" title="3.4.until命令"></a>3.4.<code>until</code>命令</h3><p><code>until</code>命令和<code>while</code>命令工作的方式完全相反。<code>until</code>命令要求你指定一个通常返回非零退出状态码的测试命令。只有测试命令的退出状态码不为<code>0</code>，bash shell才会执行循环中列出的命令。一旦测试命令返回了退出状态码<code>0</code>，循环就结束了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">until <span class="built_in">command</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    commands</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br>和<code>while</code>命令类似，你可以在<code>until</code>命令语句中放入多个测试命令。只有最后一个命令的退出状态码决定了bash shell是否执行已定义的<code>commands</code>，例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">var1=100</span><br><span class="line">until <span class="built_in">echo</span> <span class="variable">$var1</span></span><br><span class="line">      [ <span class="variable">$var1</span> -eq 0 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> Inside the loop: <span class="variable">$var1</span></span><br><span class="line">    var1=$[ <span class="variable">$var1</span> - 25 ]</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br>运行结果如图，shell会执行指定的多个测试命令，只有在最后一个命令成立时停止。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201until多个测试命令.png" alt="until多个测试命令"></p><h3 id="3-5-嵌套循环"><a href="#3-5-嵌套循环" class="headerlink" title="3.5.嵌套循环"></a>3.5.嵌套循环</h3><p>循环语句可以在循环内使用任意类型的命令，包括其他循环命令，这种循环叫作嵌套循环（nested loop），被嵌套的循环也称为内部循环（inner loop）。</p><p>内外循环的两个<code>do</code>和<code>done</code>命令没有任何差别。bash shell知道当第一个<code>done</code>命令执行时是指内部循环而非外部循环。</p><p>在混用循环命令时也一样，比如在<code>while</code>循环内部放置一个<code>for</code>循环，或者在<code>until</code>循环内部放置一个<code>while</code>循环。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># using until and while loops</span></span><br><span class="line">var1=3</span><br><span class="line">until [ <span class="variable">$var1</span> -eq 0 ]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Outer loop: <span class="variable">$var1</span>&quot;</span></span><br><span class="line">    var2=1</span><br><span class="line">    <span class="keyword">while</span> [ <span class="variable">$var2</span> -lt 5 ]; <span class="keyword">do</span></span><br><span class="line">        var3=$(<span class="built_in">echo</span> <span class="string">&quot;scale=4; <span class="variable">$var1</span> / <span class="variable">$var2</span>&quot;</span> | bc)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot; Inner loop: <span class="variable">$var1</span> / <span class="variable">$var2</span> = <span class="variable">$var3</span>&quot;</span></span><br><span class="line">        var2=$[ <span class="variable">$var2</span> + 1 ]</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    var1=$[ <span class="variable">$var1</span> - 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br>运行结果如图，外部的<code>until</code>循环以值<code>3</code>开始，并继续执行到值等于<code>0</code>。内部<code>while</code>循环以值<code>1</code>开始并一直执行，只要值小于<code>5</code>。每个循环都必须改变在测试条件中用到的值，否则循环就会无止尽进行下去。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201until嵌套while.png" alt="until嵌套while"></p><h3 id="3-6-循环处理文件数据"><a href="#3-6-循环处理文件数据" class="headerlink" title="3.6.循环处理文件数据"></a>3.6.循环处理文件数据</h3><p>通常必须遍历存储在文件中的数据，这需要使用到上文提到的①使用嵌套循环；②修改<code>IFS</code>环境变量。</p><p>典型的例子是处理<code>/etc/passwd</code>文件中的数据。这要求你逐行遍历该文件，并将<code>IFS</code>变量的值改成冒号，这样就能分隔开每行中的各个数据段了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">IFS.OLD=<span class="variable">$IFS</span></span><br><span class="line">IFS=$<span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="keyword">for</span> entry <span class="keyword">in</span> $(<span class="built_in">cat</span> /etc/passwd)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Values in <span class="variable">$entry</span> –&quot;</span></span><br><span class="line">    IFS=:</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> <span class="variable">$entry</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot; <span class="variable">$value</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p><h3 id="3-7-控制循环"><a href="#3-7-控制循环" class="headerlink" title="3.7.控制循环"></a>3.7.控制循环</h3><p><code>break</code>命令和<code>continue</code>命令能帮我们控制循环内部的情况，而不必等到循环完成所有的迭代：</p><ul><li><code>break</code>命令：用来退出任意类型的循环，包括<code>while</code>和<code>until</code>循环。<br><code>break</code>命令接受单个命令行参数值：<code>break n</code>，其中<code>n</code>指定了要跳出的循环层级。默认情况下跳出的是<strong>当前的循环</strong>（即省略<code>n</code>时为<code>n=1</code>）；如果你<code>n</code>设为<code>2</code>就会停止下一级的外部循环。</li><li><code>continue</code>命令：<code>continue</code>命令可以提前中止某次循环中的命令，但并不会完全终止整个循环。亦即停止当前进行的一次迭代，直接进入下一次迭代，注意<strong>仍在同级循环中</strong>。<br>和<code>break</code>命令一样，<code>continue</code>命令也允许通过命令行参数指定要继续执行哪一级循环：<code>continue n</code>，其中<code>n</code>定义了要继续的循环层级。</li></ul><p><strong>注意：</strong>可以在<code>while</code>和<code>until</code>循环中使用<code>continue</code>命令，但要特别小心。记住，当shell执行<code>continue</code>命令时，它会跳过剩余的命令。如果你在其中某个条件里对测试条件变量进行增值，问题就会出现：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># improperly using the continue command in a while loop</span></span><br><span class="line">var1=0</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">echo</span> <span class="string">&quot;while iteration: <span class="variable">$var1</span>&quot;</span></span><br><span class="line">      [ <span class="variable">$var1</span> -lt 15 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$var1</span> -gt 5 ] &amp;&amp; [ <span class="variable">$var1</span> -lt 10 ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;    Inside iteration number: <span class="variable">$var1</span>&quot;</span></span><br><span class="line">    var1=$[ <span class="variable">$var1</span> + 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br>由于该程序会陷入死循环，因此可以将脚本的输出重定向到了<code>more</code>命令：<code>./mytest | more</code>，这样才能停止输出。运行结果如下：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201continue死循环.png" alt="continue死循环"><br>在<code>if-then</code>的条件成立之前，所有一切看起来都很正常，然后shell执行了<code>continue</code>命令。当shell执行<code>continue</code>命令时，它跳过了<code>while</code>循环中余下的命令。不幸的是，被跳过的部分正是<code>$var1</code>计数变量增值的地方，而这个变量又被用于<code>while</code>测试命令中，这意味着这个变量的值不会再变化了，从前面连续的输出显示中你也可以看出来。</p><p>下面是继续外部<code>for</code>循环的一个例子：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># continuing an outer loop</span></span><br><span class="line"><span class="keyword">for</span> (( a = <span class="number">1</span>; a &lt;= <span class="number">5</span>; a++ ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Iteration <span class="variable">$a</span>:&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (( b = <span class="number">1</span>; b &lt; <span class="number">3</span>; b++ ))</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$a</span> -gt 2 ] &amp;&amp; [ <span class="variable">$a</span> -lt 4 ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">continue</span> 2</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        var3=$[ <span class="variable">$a</span> * <span class="variable">$b</span> ]</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot; The result of <span class="variable">$a</span> * <span class="variable">$b</span> is <span class="variable">$var3</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br>其中的<code>if-then</code>语句用<code>continue</code>命令来停止处理循环内的命令，但会继续处理外部循环。注意，值为<code>3</code>的那次迭代并没有处理任何内部循环语句，因为尽管<code>continue</code>命令停止了处理过程，但外部循环依然会继续。运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201continue继续外部循环.png" alt="continue继续外部循环"></p><h3 id="3-8-处理循环的输出"><a href="#3-8-处理循环的输出" class="headerlink" title="3.8.处理循环的输出"></a>3.8.处理循环的输出</h3><p>在shell脚本中，你可以对循环的输出使用管道或进行重定向，这可以通过在<code>done</code>命令之后添加一个处理命令来实现。</p><p>可以将循环的结果通过管道管接给另一个命令，例如将<code>for</code>命令的输出传给了<code>sort</code>命令，该命令会改变<code>for</code>命令输出结果的顺序，注意<strong>结果已经在脚本内部排好序了</strong>。</p><p>例如下面将<code>for</code>命令的输出重定向到文件的例子，在<code>for</code>命令之后正常显示了<code>echo</code>语句：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> (( a = <span class="number">1</span>; a &lt; <span class="number">10</span>; a++ ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The number is <span class="variable">$a</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span> &gt; output.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The command is finished.&quot;</span></span><br></pre></td></tr></table></figure><br>运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201部分输出重定向到文件.png" alt="部分输出重定向到文件"></p><h2 id="4-处理用户输入"><a href="#4-处理用户输入" class="headerlink" title="4.处理用户输入"></a>4.处理用户输入</h2><h3 id="4-1-命令行参数"><a href="#4-1-命令行参数" class="headerlink" title="4.1.命令行参数"></a>4.1.命令行参数</h3><p>向shell脚本传递数据的最基本方法是使用命令行参数，他允许在运行脚本时向命令行添加数据，例如<code>./mytest 10 30</code>向脚本<code>mytest</code>传递了两个命令行参数（<code>10</code>和<code>30</code>）。脚本会通过<strong>特殊的变量</strong>来处理命令行参数。</p><p>bash shell会将一些称为位置参数（positional parameter）的特殊变量分配给输入到命令行中的所有参数，这也包括shell所执行的<strong>脚本名称</strong>。</p><p>位置参数变量是标准的数字：<code>$0</code>是程序名，<code>$1</code>是第一个参数，<code>$2</code>是第二个参数，依次类推，直到第九个参数<code>$9</code>。如果脚本需要的命令行参数不止9个，则必须在变量数字周围加上花括号，比如<code>$&#123;10&#125;</code>。</p><p>如果需要输入更多的命令行参数，则每个参数都必须用空格分开，shell会将每个参数分配给对应的变量。要在参数值中包含空格，必须要用引号（单引号或双引号均可）。<br><strong>注意：</strong>将文本字符串作为参数传递时，引号并非数据的一部分，它们只是表明数据的起止位置。<br><strong>注意：</strong>利用<code>$0</code>读取脚本名时存在一个潜在的问题，即<code>$0</code>参数会同时包含路径和连在一起的命令，如下表所示。解决这个问题只需要使用<code>basename</code>命令，他会返回不包含路径的脚本名：<code>basename $0</code>，例如<code>script=$(basename $0)</code>。</p><div class="table-container"><table><thead><tr><th style="text-align:center">执行命令</th><th style="text-align:center"><code>$0</code>变量</th><th style="text-align:left">备注</th></tr></thead><tbody><tr><td style="text-align:center"><code>bash mz.sh</code></td><td style="text-align:center"><code>mz.sh</code></td><td style="text-align:left">没有问题</td></tr><tr><td style="text-align:center"><code>./mz.sh</code></td><td style="text-align:center"><code>./mz.sh</code></td><td style="text-align:left">包含命令</td></tr><tr><td style="text-align:center"><code>bash /home/hwame/mz.sh</code></td><td style="text-align:center"><code>/home/hwame/mz.sh</code></td><td style="text-align:left">包含路径</td></tr></tbody></table></div><p>在shell脚本中使用命令行参数时要小心些。当脚本认为参数变量中会有数据而实际上并没有时，脚本很有可能会产生错误消息。<br>通俗的说，当脚本中使用了变量<code>$1</code>、<code>$2</code>、<code>$3</code>时，如果允许脚本时没有给出对应的命令行参数则会报错。</p><p>因此<strong>在使用参数前一定要检查其中是否存在数据</strong>，一种方法是使用<code>-n</code>测试来检查命令行参数<code>$1</code>中是否有数据：<code>if [ -n &quot;$1&quot;]; then</code>。</p><h3 id="4-2-特殊参数变量"><a href="#4-2-特殊参数变量" class="headerlink" title="4.2.特殊参数变量"></a>4.2.特殊参数变量</h3><p>如果每次都在脚本中使用之前检查一下命令行参数，无疑比较麻烦。bash shell为此提供了一个<br>特殊变量<code>$#</code>，他含有<strong>脚本运行时携带的命令行参数的个数</strong>。可以在脚本中任何地方使用这个特殊变量，就跟普通变量一样。注意，变量<code>$#</code>的值不包括脚本名称。</p><p><strong>那么问题来了。</strong>既然<code>$#</code>变量含有参数的总数，那么变量<code>$&#123;$#&#125;</code>就代表了最后一个命令行参数变量。然而并不是这样，你不能在花括号内使用美元符，必须将美元符换成感叹号即<code>$&#123;!#&#125;</code>。<u>很奇怪，但不讲道理。</u>我们也可以拆分一下，将<code>$#</code>赋值给一个变量<code>params</code>然后再使用<code>params</code>变量：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Grabbing the last parameter</span></span><br><span class="line">params=<span class="variable">$#</span></span><br><span class="line"><span class="built_in">echo</span> The last parameter is <span class="variable">$params</span></span><br><span class="line"><span class="built_in">echo</span> The last parameter is <span class="variable">$&#123;!#&#125;</span></span><br></pre></td></tr></table></figure><br>上述示例中的两种方式都没问题。但要注意，当命令行上没有任何参数时，<code>$#</code>的值为<code>0</code>，<code>params</code>变量的值也一样，但<code>$&#123;!#&#125;</code>变量会返回命令行用到的脚本名。</p><p>有时候需要抓取命令行上提供的所有参数，希望能够<strong>在单个变量中存储所有的命令行参数</strong>，而不是先用<code>$#</code>变量来判断命令行上有多少参数，然后再进行遍历。</p><p>可以使用一组其他的特殊变量<code>$*</code>和<code>$@</code>来解决这个问题：</p><ul><li><code>$*</code>变量会将命令行上提供的所有参数<strong>当作一个单词</strong>保存，这个单词包含了命令行中出现的每一个参数值。基本上<code>$*</code>变量会将这些参数视为一个整体，而不是多个个体。</li><li><code>$@</code>变量会将命令行上提供的所有参数<strong>当作同一字符串中的多个独立的单词</strong>。通常通过<code>for</code>命令遍历所有的参数值，得到每个参数。</li></ul><p>通过使用<code>for</code>命令遍历这两个特殊变量，可以看到它们是如何不同地处理命令行参数的。 <code>$*</code>变量会将所有参数当成单个参数，而<code>$@</code>变量会单独处理每个参数。这是遍历命令行参数的一个绝妙方法。二者之间的差异见下例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">count=1</span><br><span class="line"><span class="keyword">for</span> param <span class="keyword">in</span> <span class="string">&quot;$*&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\$* Parameter #<span class="variable">$count</span> = <span class="variable">$param</span>&quot;</span></span><br><span class="line">    count=$[ <span class="variable">$count</span> + 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">count=1</span><br><span class="line"><span class="keyword">for</span> param <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;\$@ Parameter #<span class="variable">$count</span> = <span class="variable">$param</span>&quot;</span></span><br><span class="line">    count=$[ <span class="variable">$count</span> + 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br>运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201抓取所有参数的两种方法.png" alt="抓取所有参数的两种方法"></p><h3 id="4-3-移动变量"><a href="#4-3-移动变量" class="headerlink" title="4.3.移动变量"></a>4.3.移动变量</h3><p>bash shell的<code>shift</code>命令能够用来操作命令行参数。顾名思义，他会根据它们的相对位置来移动命令行参数。<br>默认情况下它会将每个参数变量向左移动一个位置。所以，变量<code>$3</code>的值会移到<code>$2</code>中，变量<code>$2</code>的值会移到<code>$1</code>中，而变量<code>$1</code>的值则会被删除（注意，变量<code>$0</code>的值即程序名不会改变）。也可以一次性移动多个位置，只需要给<code>shift</code>命令提供一个参数指明要移动的位置数就行了：<code>shift n</code>。<br><strong>注意：</strong>如果某个参数被移出，它的值就被丢弃了，无法再恢复。</p><p>这是遍历命令行参数的另一个好方法，尤其是在你不知道到底有多少参数时。你可以只操作第一个参数，移动参数，然后继续操作第一个参数，例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">count=1</span><br><span class="line"><span class="keyword">while</span> [ -n <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Parameter #<span class="variable">$count</span> = <span class="variable">$1</span>&quot;</span></span><br><span class="line">    count=$[ <span class="variable">$count</span> + 1 ]</span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br>运行结果如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201移动变量.png" alt="移动变量"></p><h3 id="4-4-处理选项"><a href="#4-4-处理选项" class="headerlink" title="4.4.处理选项"></a>4.4.处理选项</h3><p>「<code>选项</code>」是跟在单破折线后面的<strong>单个字母</strong>，它能改变命令的行为，此处介绍3种在脚本中处理选项的方法。</p><h4 id="1-查找选项"><a href="#1-查找选项" class="headerlink" title="(1)查找选项"></a>(1)查找选项</h4><p>表面上看，命令行选项也没什么特殊的。在命令行上，它们紧跟在脚本名之后，就跟命令行参数一样。实际上，如果愿意，你可以像处理命令行参数一样处理命令行选项。</p><ul><li><strong>①处理简单选项：</strong>可以用<code>shift</code>命令来处理脚本程序携带的命令行选项，用<code>case</code>语句来判断某个参数是否为选项。<code>case</code>语句会检查每个参数是不是有效选项，如果是就运行对应语句中的命令。不管选项按什么顺序出现在命令行上，这种方法都适用。示例如下：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># extracting command line options as parameters</span></span><br><span class="line"><span class="keyword">while</span> [ -n <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        -a) <span class="built_in">echo</span> <span class="string">&quot;Found the -a option&quot;</span> ;;</span><br><span class="line">        -b) <span class="built_in">echo</span> <span class="string">&quot;Found the -b option&quot;</span> ;;</span><br><span class="line">        -c) <span class="built_in">echo</span> <span class="string">&quot;Found the -c option&quot;</span> ;;</span><br><span class="line">         *) <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> is not an option&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></li><li><strong>②分离参数和选项：</strong>对于在shell脚本中同时使用<strong>选项</strong>和<strong>参数</strong>的情况，标准方式是用特殊字符（双破折线<code>--</code>）来将二者分开，该字符会告诉脚本<strong>何时选项结束</strong>以及<strong>普通参数何时开始</strong>。<br>shell会用双破折线来表明选项列表结束。在双破折线之后，脚本就可以放心地将剩下的命令行参数当作<strong>参数</strong>，而不是<strong>选项</strong>来处理了。要检查双破折线，只要在case语句中加一项就行了，如下例所示：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># extracting options and parameters</span></span><br><span class="line"><span class="keyword">while</span> [ -n <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        -a) <span class="built_in">echo</span> <span class="string">&quot;Found the -a option&quot;</span> ;;</span><br><span class="line">        -b) <span class="built_in">echo</span> <span class="string">&quot;Found the -b option&quot;</span> ;;</span><br><span class="line">        -c) <span class="built_in">echo</span> <span class="string">&quot;Found the -c option&quot;</span> ;;</span><br><span class="line">        --) <span class="built_in">shift</span></span><br><span class="line">            <span class="built_in">break</span> ;;</span><br><span class="line">         *) <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> is not an option&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">count=1</span><br><span class="line"><span class="keyword">for</span> param <span class="keyword">in</span> <span class="variable">$@</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Parameter #<span class="variable">$count</span>: <span class="variable">$param</span>&quot;</span></span><br><span class="line">    count=$[ <span class="variable">$count</span> + 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>运行结果如图，可以看出，第一次未分离时脚本认为所有的命令行参数都是选项；第二次使用<code>--</code>分离后，当脚本遇到双破折线时，它会停止处理选项，并将剩下的参数都当作命令行参数。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201分离参数和选项.png" alt="分离参数和选项"></li><li><strong>③处理带值的选项：</strong>有些选项会带上一个额外的参数值，例如：<code>./mz.sh -a test1 -b -c -d test2</code>。当命令行选项要求额外的参数时，脚本必须能检测到并正确处理，如下例：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># extracting command line options and values</span></span><br><span class="line"><span class="keyword">while</span> [ -n <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        -a) <span class="built_in">echo</span> <span class="string">&quot;Found the -a option&quot;</span>;;</span><br><span class="line">        -b) param=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Found the -b option, with parameter value <span class="variable">$param</span>&quot;</span></span><br><span class="line">            <span class="built_in">shift</span> ;;</span><br><span class="line">        -c) <span class="built_in">echo</span> <span class="string">&quot;Found the -c option&quot;</span>;;</span><br><span class="line">        --) <span class="built_in">shift</span></span><br><span class="line">            <span class="built_in">break</span> ;;</span><br><span class="line">         *) <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> is not an option&quot;</span>;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">count=1</span><br><span class="line"><span class="keyword">for</span> param <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Parameter #<span class="variable">$count</span>: <span class="variable">$param</span>&quot;</span></span><br><span class="line">    count=$[ <span class="variable">$count</span> + 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>在这个例子中，<code>case</code>语句定义了三个它要处理的选项，其中<code>-b</code>选项还需要一个额外的参数值。由于要处理的参数是<code>$1</code>，额外的参数值就应该位于<code>$2</code>（因为所有的参数在处理完之后都会被移出）。只要将参数值从<code>$2</code>变量中提取出来就可以了。当然，因为这个选项占用了两个参数位，所以你还需要使用<code>shift</code>命令多移动一个位置。运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201处理带值的选项.png" alt="处理带值的选项"></li></ul><h4 id="2-getopt命令"><a href="#2-getopt命令" class="headerlink" title="(2)getopt命令"></a>(2)<code>getopt</code>命令</h4><p>上述shell脚本已经有了处理命令行选项的基本能力，但还有一些限制。比如，<strong>合并选项</strong>是Linux中一个很常见的用法，如果你想<strong>将多个选项放进一个参数中</strong>时，它就不能工作了。<br><code>getopt</code>命令是一个在处理命令行选项和参数时非常方便的工具。它能够识别命令行参数，从而在脚本中解析它们时更方便。</p><p>命令格式：<code>getopt optstring parameters</code>。<br><code>optstring</code>是这个过程的关键所在，<u>它定义了命令行有效的选项字母，还定义了哪些选项字母需要参数值</u>。<br>首先，在<code>optstring</code>中列出你要在脚本中用到的每个命令行选项字母。然后，在每个需要参数值的选项字母后加一个冒号。<code>getopt</code>命令会基于你定义的<code>optstring</code>解析提供的参数。</p><p>举例如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201getopt命令.png" alt="getopt命令"><br>命令行<code>getopt ab:cd -a -b test1 -cd test2 test3</code>中的<code>optstring</code>定义了四个有效选项字母：<code>a</code>、<code>b</code>、<code>c</code>和<code>d</code>。冒号（<code>:</code>）被放在了字母<code>b</code>后面，因为<code>b</code>选项需要一个参数值。当<code>getopt</code>命令运行时，它会检查提供的参数列表（<code>-a -b test1 -cd test2 test3</code>），并基于提供的<code>optstring</code>进行解析。注意，它会自动将<code>-cd</code>选项分成两个单独的选项，并插入双破折线来分隔行中的额外参数<code>test2 test3</code>。<br><strong>注意：</strong>如果指定了一个不在<code>optstring</code>中的选项，默认情况下<code>getopt</code>命令会产生一条错误消息，可以在命令后加<code>-q</code>选项来忽略这条错误消息。如下图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201201多余的选项.png" alt="多余的选项"></p><hr><p>可以在脚本中使用<code>getopt</code>来格式化脚本所携带的任何命令行选项或参数，但用起来略微复杂。<br>用<code>getopt</code>命令生成的格式化后的版本来替换已有的命令行选项和参数，<code>set</code>命令的选项之一是双破折线<code>--</code>，它会将命令行参数替换成<code>set</code>命令的命令行值。</p><p>该方法会将原始脚本的命令行参数传给<code>getopt</code>命令，之后再将<code>getopt</code>命令的输出传给<code>set</code>命令，用<code>getopt</code>格式化后的命令行参数来替换原始的命令行参数，格式看起来如下所示：<code>set -- $(getopt -q ab:cd &quot;$@&quot;)</code>。<br>现在原始的命令行参数变量的值会被<code>getopt</code>命令的输出替换，而<code>getopt</code>已经为我们格式化<br>好了命令行参数。利用该方法就可以写出能帮我们处理命令行参数的脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -- $(getopt -q ab:<span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>)</span><br><span class="line"><span class="keyword">while</span> [ -n <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        -a) <span class="built_in">echo</span> <span class="string">&quot;Found the -a option&quot;</span> ;;</span><br><span class="line">        -b) param=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Found the -b option, with parameter value <span class="variable">$param</span>&quot;</span></span><br><span class="line">            <span class="built_in">shift</span> ;;</span><br><span class="line">        -c) <span class="built_in">echo</span> <span class="string">&quot;Found the -c option&quot;</span> ;;</span><br><span class="line">        --) <span class="built_in">shift</span></span><br><span class="line">            <span class="built_in">break</span> ;;</span><br><span class="line">         *) <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> is not an option&quot;</span>;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">count=1</span><br><span class="line"><span class="keyword">for</span> param <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Parameter #<span class="variable">$count</span>: <span class="variable">$param</span>&quot;</span></span><br><span class="line">    count=$[ <span class="variable">$count</span> + 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br>注意到该例和上文<a href="#1-%E6%9F%A5%E6%89%BE%E9%80%89%E9%A1%B9">查找选项</a>中第三种情况「处理带值的选项」一样，唯一不同的是加入了<code>getopt</code>命令来帮助格式化命令行参数。并且可以运行带有复杂选项的脚本如合并的选项：<code>./mz.sh -ac</code>，同时之前的功能照样没有问题。</p><h4 id="3-更高级的getopts命令"><a href="#3-更高级的getopts命令" class="headerlink" title="(3)更高级的getopts命令"></a>(3)更高级的<code>getopts</code>命令</h4><p>然而，<code>getopt</code>命令并不擅长处理带空格和引号的参数值，它会将空格当作参数分隔符，而不是根据双引号将二者当作一个参数。</p><p><code>getopts</code>命令（<strong>注意是复数</strong>）内建于bash shell，它跟近亲<code>getopt</code>看起来很像，但多了一些扩展功能。<code>getopt</code>将命令行上选项和参数处理后只生成一个输出，而<code>getopts</code>命令能够和已有的shell参数变量配合默契。</p><p>每次调用<code>getopts</code>时，它一次只处理命令行上检测到的一个参数。处理完所有的参数后，它会退出并返回一个大于<code>0</code>的退出状态码。这让它非常适合用于解析命令行所有参数的循环中。</p><p><code>getopts</code>命令的格式如下：<code>getopts optstring variable</code>。<br><code>optstring</code>值类似于<code>getopt</code>命令中的那个。有效的选项字母都会列在<code>optstring</code>中，如果选项字母要求有个参数值，就加一个冒号。要去掉错误消息的话，可以在<code>optstring</code>之前加一个冒号。<code>getopts</code>命令将当前参数保存在命令行中定义的<code>variable</code>中。<br><code>getopts</code>命令会用到两个环境变量：<code>OPTARG</code>环境变量保存选项需要跟的一个参数值；<code>OPTIND</code>环境变量保存了参数列表中<code>getopts</code>正在处理的参数位置。这样你就能在处理完选项之后继续处理其他命令行参数了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># simple demonstration of the getopts command</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> :ab:c opt</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$opt</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        a) <span class="built_in">echo</span> <span class="string">&quot;Found the -a option&quot;</span> ;;</span><br><span class="line">        b) <span class="built_in">echo</span> <span class="string">&quot;Found the -b option, with value <span class="variable">$OPTARG</span>&quot;</span>;;</span><br><span class="line">        c) <span class="built_in">echo</span> <span class="string">&quot;Found the -c option&quot;</span> ;;</span><br><span class="line">        *) <span class="built_in">echo</span> <span class="string">&quot;Unknown option: <span class="variable">$opt</span>&quot;</span>;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br><code>while</code>语句定义了<code>getopts</code>命令，指明了要查找哪些命令行选项，以及每次迭代中存储它们的变量名（<code>opt</code>）。注意到在本例中<code>case</code>语句的用法有些不同：<code>getopts</code>命令解析命令行选项时会移除开头的单破折线，所以在<code>case</code>定义中不用单破折线。<br><code>getopts</code>命令有几个好用的功能：①可以在参数值中包含空格；②可以将选项字母和参数值放在一起使用，而不用加空格，<code>getopts</code>命令能够从选项中正确解析出参数值；③可以将命令行上所有未定义的选项统一输出成问号，以问号形式发送给代码。<br>上述代码运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201202getopts命令用法.png" alt="getopts命令用法"></p><p><code>getopts</code>命令知道何时停止处理选项，并将参数留给你处理。在<code>getopts</code>处理每个选项时，它会将<code>OPTIND</code>环境变量值增一。在<code>getopts</code>完成处理时，你可以使用<code>shift</code>命令和<code>OPTIND</code>值来移动参数。如下例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> :ab:<span class="built_in">cd</span> opt</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$opt</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        a) <span class="built_in">echo</span> <span class="string">&quot;Found the -a option&quot;</span> ;;</span><br><span class="line">        b) <span class="built_in">echo</span> <span class="string">&quot;Found the -b option, with value <span class="variable">$OPTARG</span>&quot;</span> ;;</span><br><span class="line">        c) <span class="built_in">echo</span> <span class="string">&quot;Found the -c option&quot;</span> ;;</span><br><span class="line">        d) <span class="built_in">echo</span> <span class="string">&quot;Found the -d option&quot;</span> ;;</span><br><span class="line">        *) <span class="built_in">echo</span> <span class="string">&quot;Unknown option: <span class="variable">$opt</span>&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">shift</span> $[ <span class="variable">$OPTIND</span> - 1 ]</span><br><span class="line">count=1</span><br><span class="line"><span class="keyword">for</span> param <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Parameter <span class="variable">$count</span>: <span class="variable">$param</span>&quot;</span></span><br><span class="line">    count=$[ <span class="variable">$count</span> + 1 ]</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br>运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201202环境变量OPTIND.png" alt="环境变量OPTIND"></p><h3 id="4-5-将选项标准化"><a href="#4-5-将选项标准化" class="headerlink" title="4.5.将选项标准化"></a>4.5.将选项标准化</h3><p>所谓选项标准化，就是尽量遵循某些字母选项在Linux世界里已经拥有的某种程度的标准含义，而不是随意决定用哪些字母选项以及它们的用法，将选项标准化使得脚本看起来能更友好一些。常用的Linux命令选项如下：</p><div class="table-container"><table><thead><tr><th style="text-align:center">选项</th><th style="text-align:center">含义</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center"><code>-a</code></td><td style="text-align:center"><code>all</code></td><td style="text-align:left">显示所有对象</td></tr><tr><td style="text-align:center"><code>-c</code></td><td style="text-align:center"><code>count</code></td><td style="text-align:left">生成一个计数</td></tr><tr><td style="text-align:center"><code>-d</code></td><td style="text-align:center"><code>directory</code></td><td style="text-align:left">指定一个目录</td></tr><tr><td style="text-align:center"><code>-e</code></td><td style="text-align:center"><code>extend</code></td><td style="text-align:left">扩展一个对象</td></tr><tr><td style="text-align:center"><code>-f</code></td><td style="text-align:center"><code>file</code></td><td style="text-align:left">指定读入数据的文件</td></tr><tr><td style="text-align:center"><code>-h</code></td><td style="text-align:center"><code>help</code></td><td style="text-align:left">显示命令的帮助信息</td></tr><tr><td style="text-align:center"><code>-i</code></td><td style="text-align:center"><code>ignorecase</code></td><td style="text-align:left">忽略文本大小写</td></tr><tr><td style="text-align:center"><code>-l</code></td><td style="text-align:center"><code>long</code></td><td style="text-align:left">产生输出的长格式版本</td></tr><tr><td style="text-align:center"><code>-n</code></td><td style="text-align:center"><code>non-interactive</code></td><td style="text-align:left">使用非交互模式（批处理）</td></tr><tr><td style="text-align:center"><code>-o</code></td><td style="text-align:center"><code>output redirect</code></td><td style="text-align:left">将所有输出重定向到指定的输出文件</td></tr><tr><td style="text-align:center"><code>-q</code><br><code>-s</code></td><td style="text-align:center"><code>quiet</code><br><code>silent</code></td><td style="text-align:left">以安静模式运行</td></tr><tr><td style="text-align:center"><code>-r</code></td><td style="text-align:center"><code>recursive</code></td><td style="text-align:left">递归地处理目录和文件</td></tr><tr><td style="text-align:center"><code>-v</code></td><td style="text-align:center"><code>verbose</code></td><td style="text-align:left">生成详细输出</td></tr><tr><td style="text-align:center"><code>-x</code></td><td style="text-align:center"><code>exclude</code></td><td style="text-align:left">排除某个对象</td></tr><tr><td style="text-align:center"><code>-y</code></td><td style="text-align:center"><code>yes</code></td><td style="text-align:left">对所有问题回答yes</td></tr></tbody></table></div><h3 id="4-6-获得用户输入"><a href="#4-6-获得用户输入" class="headerlink" title="4.6.获得用户输入"></a>4.6.获得用户输入</h3><p>尽管命令行选项和参数是从脚本用户处获得输入的一种重要方式，但有时脚本的交互性还需要更强一些。比如你想要在脚本运行时问个问题，并等待运行脚本的人来回答。bash shell为此提供了<code>read</code>命令。</p><h4 id="1-基本的读取"><a href="#1-基本的读取" class="headerlink" title="(1)基本的读取"></a>(1)基本的读取</h4><p><code>read</code>命令从标准输入（键盘）或另一个文件描述符中接受输入，在收到输入后会将数据放进一个指定的变量。例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;Enter your name: &quot;</span></span><br><span class="line"><span class="built_in">read</span> name</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello <span class="variable">$name</span>, welcome to my program. &quot;</span></span><br></pre></td></tr></table></figure><br>注意，上例中生成提示的<code>echo</code>命令使用了<code>-n</code>选项。该选项不会在字符串末尾输出换行符，允许脚本用户紧跟其后输入数据，而不是下一行。这让脚本看起来更像表单。<br>实际上，<strong><code>read</code>命令包含了<code>-p</code>选项，允许你直接在<code>read</code>命令行指定提示符</strong>。例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;Please enter your age: &quot;</span> age</span><br><span class="line">days=$[ <span class="variable">$age</span> * 365 ]</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;That makes you over <span class="variable">$days</span> days old! &quot;</span></span><br></pre></td></tr></table></figure><br><code>read</code>命令也允许指定多个变量，输入的每个数据值都会分配给变量列表中的下一个变量。如果变量数量不够，剩下的数据就全部分配给最后一个变量。是不是和Python中的<code>*args</code>和<code>**kwargs</code>有点像呢？<br>也可以在<code>read</code>命令行中不指定变量，这样它收到的任何数据都会放进特殊环境变量<code>REPLY</code>中。<code>REPLY</code>环境变量会保存输入的所有数据，可以在shell脚本中像其他变量一样使用。</p><h4 id="2-超时"><a href="#2-超时" class="headerlink" title="(2)超时"></a>(2)超时</h4><p>如果不管是否有数据输入，脚本都必须继续执行，你可以用<code>-t</code>选项来指定一个计时器，他指定了<code>read</code>命令等待输入的秒数。当计时器过期后，<code>read</code>命令会返回一个非零退出状态码，可以使用<code>if-then</code>语句或<code>while</code>循环这种标准的结构化语句来理清所发生的具体情况。</p><p>也可以不对输入过程计时，而是让<code>read</code>命令来统计输入的字符数。当输入的字符达到预设的字符数时，就自动退出，将输入的数据赋给变量。可以将<code>-n</code>选项和值<code>1</code>一起使用，告诉<code>read</code>命令在接受<strong>单个字符</strong>后退出。只要按下单个字符回答后，<code>read</code>命令就会接受输入并将它传给变量，无需按回车键。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">read</span> -n1 -p <span class="string">&quot;Do you want to continue [Y/N]? &quot;</span> answer</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$answer</span> <span class="keyword">in</span></span><br><span class="line">    Y | y) <span class="built_in">echo</span></span><br><span class="line">           <span class="built_in">echo</span> <span class="string">&quot;fine, continue on…&quot;</span>;;</span><br><span class="line">    N | n) <span class="built_in">echo</span></span><br><span class="line">           <span class="built_in">echo</span> OK, goodbye</span><br><span class="line">           <span class="built_in">exit</span>;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is the end of the script&quot;</span></span><br></pre></td></tr></table></figure><br>运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201202read命令接受指定字符.png" alt="read命令接受指定字符"></p><h4 id="3-隐藏方式读取"><a href="#3-隐藏方式读取" class="headerlink" title="(3)隐藏方式读取"></a>(3)隐藏方式读取</h4><p>当需要输入类似密码这种需要从脚本用户处得到输入，但又在屏幕上显示输入信息时，可以使用<code>-s</code>选项不回显终端的输入（实际上数据会被显示，只是<code>read</code>命令会将文本颜色设成跟背景色一样）。输入提示符输入的数据不会出现在屏幕上，但会赋给变量，以便在脚本中使用。例如：<code>read -s -p &quot;Enter your password: &quot; password</code>。</p><h4 id="4-从文件中读取"><a href="#4-从文件中读取" class="headerlink" title="(4)从文件中读取"></a>(4)从文件中读取</h4><p>可以用<code>read</code>命令来读取文件里的数据，每次调用<code>read</code>命令都会从文件中读取一行文本。当文件中再没有内容时，<code>read</code>命令会退出并返回非零退出状态码。<br>如何将文件中的数据传给<code>read</code>命令呢？最常见的方法是对文件使用<code>cat</code>命令，将结果通过管道直接传给含有<code>read</code>命令的<code>while</code>命令。见下例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">count=1</span><br><span class="line"><span class="built_in">cat</span> textfile | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Line <span class="variable">$count</span>: <span class="variable">$line</span>&quot;</span></span><br><span class="line">    count=$[ <span class="variable">$count</span> + 1]</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Finished processing the file&quot;</span></span><br></pre></td></tr></table></figure><br>文件<code>textfile</code>内容及运行结果如下：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201202从文件中读取数据.png" alt="从文件中读取数据"></p><h2 id="5-创建函数"><a href="#5-创建函数" class="headerlink" title="5.创建函数"></a>5.创建函数</h2><h3 id="5-1-基本脚本函数"><a href="#5-1-基本脚本函数" class="headerlink" title="5.1.基本脚本函数"></a>5.1.基本脚本函数</h3><p>函数是一个脚本代码块，你可以为其命名并在<strong>代码中任何位置</strong>重用，调用函数（在脚本中使用该代码块）时只要使用所起的函数名就行了。</p><p><strong>创建函数的第一种格式</strong>是采用关键字<code>function</code>，后跟分配给该代码块的函数名：<br><code>name</code>属性定义了赋予函数的唯一名称，脚本中定义的每个函数都必须有一个唯一的名称。<code>commands</code>是构成函数的一条或多条bash shell命令，在调用该函数时会按命令在函数中出现的顺序依次执行，就像在普通脚本中一样。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> name &#123;</span><br><span class="line">    commands</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>创建函数的第二种格式</strong>更接近于其他编程语言中定义函数的方式：<br>函数名后的空括号表明正在定义的是一个函数，这种格式的命名规则和之前定义shell脚本函数的格式一样。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">name</span></span>() &#123;</span><br><span class="line">    commands</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><hr><p>至于使用函数，只需要像其他shell命令一样，在行中<strong>指定函数名</strong>就行了。</p><p><strong>注意①：</strong>函数定义不一定非得是shell脚本中首先要做的事，但必须在使用函数之前定义它，否则会收到一条<code>command not found</code>的错误消息。<br><strong>注意②：</strong>函数名必须是唯一的，如果你重定义了函数，新定义会覆盖原来函数的定义，这一切不会产生任何错误消息。</p><h3 id="5-2-返回值"><a href="#5-2-返回值" class="headerlink" title="5.2.返回值"></a>5.2.返回值</h3><p>bash shell会把函数当作一个小型脚本，运行结束时会返回一个退出状态码，生成退出状态码有以下3种不同的方法：</p><ul><li><strong>默认退出状态码：</strong>默认情况下，函数的退出状态码是<strong>函数中最后一条命令返回的退出状态码</strong>。在函数执行结束后，可以用标准变量<code>$?</code>来确定函数的退出状态码。<br><strong>注意</strong>：由于函数的默认退出状态码取决于函数体中最后一条命令的退出状态码，因此你无法知道函数中其他命令中是否成功运行，所以这种方法很危险。</li><li><strong>使用<code>return</code>命令：</strong>使用<code>return</code>命令来退出函数并返回特定的退出状态码，它允许指定一个整数值来定义函数的退出状态码，从而提供了一种简单的途径来编程设定函数退出状态码。<br><strong>注意</strong>：①函数一结束就取返回值，否则可能会丢失返回值。②退出状态码的范围是0~255，超出则会取余。</li><li><strong>使用函数输出：</strong>正如可以将命令的输出保存到shell变量中一样，你也可以对函数的输出采用同样的处理办法。可以用这种技术来获得任何类型的函数输出，并将其保存到变量中。见下例：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> myfunc &#123;</span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;Enter a value: &quot;</span> value</span><br><span class="line">    <span class="built_in">echo</span> $[ <span class="variable">$value</span> * 2 ]</span><br><span class="line">&#125;</span><br><span class="line">result=$(myfunc)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The new value is <span class="variable">$result</span>&quot;</span></span><br></pre></td></tr></table></figure><strong>注意①</strong>：该函数实际上输出了两条消息，<code>read</code>命令输出了一条简短的消息来向用户询问输入值，但bash shell并不将其作为<code>STDOUT</code>输出的一部分，并且忽略掉它。如果你用<code>echo</code>语句生成这条消息来向用户查询，那么它会与输出值一起被读进shell变量中。<br><strong>注意②</strong>：这种方法还可以返回浮点值和字符串值，这使它成为一种获取函数返回值的强大方法。上例运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201209使用函数输出返回值.png" alt="使用函数输出返回值"></li></ul><h3 id="5-3-在函数中使用变量"><a href="#5-3-在函数中使用变量" class="headerlink" title="5.3.在函数中使用变量"></a>5.3.在函数中使用变量</h3><blockquote><p>在函数中使用变量时，你需要注意它们的定义方式以及处理方式——这是shell脚本中常见错误的根源。</p></blockquote><h4 id="向函数传递参数"><a href="#向函数传递参数" class="headerlink" title="向函数传递参数"></a>向函数传递参数</h4><p>bash shell会将函数当作小型脚本来对待，这意味着你可以像普通脚本那样向函数传递参数。</p><p>函数可以使用标准的参数环境变量来表示命令行上传给函数的参数。例如，函数名会在<code>$0</code>变量中定义，函数命令行上的任何参数都会通过<code>$1</code>、<code>$2</code>等定义。也可以用特殊变量<code>$#</code>来判断传给函数的参数数目。<br><strong>注意①：</strong>在脚本中指定函数时，必须将参数和函数放在同一行，例如<code>func1 $value1 10</code>，<code>result=$(func1 $value1 10)</code>；<br><strong>注意②：</strong>由于函数使用特殊参数环境变量作为自己的参数值，因此它<strong>无法直接获取脚本在命令行中的参数值</strong>。尽管函数也使用了<code>$1</code>和<code>$2</code>变量，但它们和脚本主体中的<code>$1</code>和<code>$2</code>变量并不相同。要在函数中使用这些值，必须在调用函数时手动将它们传过去。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> myfunc &#123;</span><br><span class="line">    <span class="built_in">echo</span> $[ <span class="variable">$1</span> * <span class="variable">$2</span> ]</span><br><span class="line">&#125;</span><br><span class="line">value1=$(myfunc 10 20)</span><br><span class="line">value2=$(myfunc)</span><br><span class="line">value3=$(myfunc <span class="variable">$1</span> <span class="variable">$2</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The result is <span class="variable">$valuex</span>&quot;</span></span><br></pre></td></tr></table></figure><br>如上例，<code>value1</code>是正常的函数调用方式，将参数和函数放在同一行。如果想让<code>value2</code>以这种方式直接获取命令行参数值将报错：<code>syntax error: operand expected...</code>，原因见上，解决办法就是按<code>value3</code>的方式。尽管在函数的定义和调用时都使用了<code>$1</code>和<code>$2</code>变量，但他们的区别就如同形参和实参。</p><h4 id="在函数中处理变量"><a href="#在函数中处理变量" class="headerlink" title="在函数中处理变量"></a>在函数中处理变量</h4><p>变量的作用域也会经常带来麻烦，作用域是变量可见的区域。函数中定义的变量与普通变量的作用域不同，也就是说，对脚本的其他部分而言，它们是隐藏的。</p><p>函数使用两种类型的变量：<strong>全局变量</strong>和<strong>局部变量</strong>。</p><ul><li><strong>全局变量：</strong>在shell脚本中任何地方都有效的变量。如果你在脚本的主体部分定义了一个全局变量，那么可以在函数内读取它的值。<strong>类似地，如果你在函数内定义了一个全局变量，可以在脚本的主体部分读取它的值。</strong>默认情况下，在脚本中定义的任何变量都是全局变量。在函数外定义的变量可在函数内正常访问。<br><strong>注意：</strong>在使用全局变量时，如果变量被修改后新值将依然有效，这有时会产生难以预料的后果。它要求你清清楚楚地知道函数中具体使用了哪些变量，包括那些用来计算非返回值的变量。</li><li><strong>局部变量：</strong><code>local</code>关键字保证了变量只局限在该函数中，如果脚本中在该函数之外有同样名字的变量，那么shell将会保持这两个变量的值是分离的。<br>如果要将函数内部使用的任何变量都声明成局部变量，只需要在变量声明的前面加上<code>local</code>关键字：<code>local temp</code>。也可以在变量赋值语句中使用<code>local</code>关键字：<code>local temp=$[ $value + 5 ]</code>。</li></ul><h3 id="5-4-数组变量和函数"><a href="#5-4-数组变量和函数" class="headerlink" title="5.4.数组变量和函数"></a>5.4.数组变量和函数</h3><h4 id="向函数传递数组参数"><a href="#向函数传递数组参数" class="headerlink" title="向函数传递数组参数"></a>向函数传递数组参数</h4><p>向脚本函数传递数组变量的方法会有点不好理解。将数组变量当作单个参数传递的话，它不会起作用。见下例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> testit &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The parameters are: <span class="variable">$@</span>&quot;</span></span><br><span class="line">    thisarray=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The received array is <span class="variable">$&#123;thisarray[*]&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">myarray=(1 2 3 4 5)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The original array is: <span class="variable">$&#123;myarray[*]&#125;</span>&quot;</span></span><br><span class="line">testit <span class="variable">$myarray</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果如下：</span></span><br><span class="line"><span class="comment"># The original array is: 1 2 3 4 5</span></span><br><span class="line"><span class="comment"># The parameters are: 1</span></span><br><span class="line"><span class="comment"># The received array is 1</span></span><br></pre></td></tr></table></figure><br>如你所见，如果将该数组变量作为函数参数，函数只会取数组变量的第一个值。要解决这个问题，必须将该数组变量的值分解成单个值，然后将这些值作为函数参数使用。在函数内部，可以将所有的参数重新组合成一个新的变量。<br>如下例所示，<code>$myarray</code>变量来保存所有的数组元素，然后将它们都放在函数的命令行上。该函数随后从命令行参数中重建数组变量。在函数内部，数组仍然可以像其他数组一样使用。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> testit &#123;</span><br><span class="line">    <span class="built_in">local</span> newarray</span><br><span class="line">    newarray=($(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>))</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The new array value is: <span class="variable">$&#123;newarray[*]&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">myarray=(1 2 3 4 5)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The original array is <span class="variable">$&#123;myarray[*]&#125;</span>&quot;</span></span><br><span class="line">testit <span class="variable">$&#123;myarray[*]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果如下：</span></span><br><span class="line"><span class="comment"># The original array is 1 2 3 4 5</span></span><br><span class="line"><span class="comment"># The new array value is: 1 2 3 4 5</span></span><br></pre></td></tr></table></figure><br>下面是一个遍历数组并将所有元素累加的例子：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> addarray &#123;</span><br><span class="line">    <span class="built_in">local</span> <span class="built_in">sum</span>=0</span><br><span class="line">    <span class="built_in">local</span> newarray</span><br><span class="line">    newarray=($(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>))</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> <span class="variable">$&#123;newarray[*]&#125;</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">sum</span>=$[ <span class="variable">$sum</span> + <span class="variable">$value</span> ]</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$sum</span></span><br><span class="line">&#125;</span><br><span class="line">myarray=(1 2 3 4 5)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The original array is: <span class="variable">$&#123;myarray[*]&#125;</span>&quot;</span></span><br><span class="line">arg1=$(<span class="built_in">echo</span> <span class="variable">$&#123;myarray[*]&#125;</span>)</span><br><span class="line">result=$(addarray <span class="variable">$arg1</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The result is <span class="variable">$result</span>&quot;</span></span><br></pre></td></tr></table></figure><br>运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201209遍历数组累加.png" alt="遍历数组累加"></p><h4 id="从函数返回数组"><a href="#从函数返回数组" class="headerlink" title="从函数返回数组"></a>从函数返回数组</h4><p>从函数里向shell脚本传回数组变量也用类似的方法：函数用<code>echo</code>语句来按正确顺序输出单个数组值，然后脚本再将它们重新放进一个新的数组变量中。见下例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> returnarray &#123;</span><br><span class="line">    <span class="built_in">local</span> oriarray</span><br><span class="line">    <span class="built_in">local</span> newarray</span><br><span class="line">    <span class="built_in">local</span> elements</span><br><span class="line">    <span class="built_in">local</span> i</span><br><span class="line">    oriarray=($(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>))</span><br><span class="line">    newarray=($(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>))</span><br><span class="line">    elements=$[ <span class="variable">$#</span> - 1 ]</span><br><span class="line">    <span class="keyword">for</span> (( i = <span class="number">0</span>; i &lt;= <span class="variable">$elements</span>; i++ ))</span><br><span class="line">    &#123;</span><br><span class="line">        newarray[<span class="variable">$i</span>]=$[ <span class="variable">$&#123;oriarray[$i]&#125;</span> * 2 ]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$&#123;newarray[*]&#125;</span></span><br><span class="line">&#125;</span><br><span class="line">myarray=(1 2 3 4 5)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The original array is: <span class="variable">$&#123;myarray[*]&#125;</span>&quot;</span></span><br><span class="line">arg1=$(<span class="built_in">echo</span> <span class="variable">$&#123;myarray[*]&#125;</span>)</span><br><span class="line">result=($(returnarray <span class="variable">$arg1</span>))</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The new array is: <span class="variable">$&#123;result[*]&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><br>该脚本用<code>$arg1</code>变量将数组值传给<code>returnarray</code>函数，函数将该数组重组到新的数组变量中，生成该输出数组变量的一个副本。然后对数据元素进行遍历，将每个元素值翻倍，并将结果存入函数中该数组变量的副本。<br><code>returnarray</code>函数使用<code>echo</code>语句来输出每个数组元素的值。脚本用<code>returnarray</code>函数的输出来重新生成一个新的数组变量。运行结果如图：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201209从函数返回数组.png" alt="从函数返回数组"></p><h3 id="5-5-函数递归"><a href="#5-5-函数递归" class="headerlink" title="5.5.函数递归"></a>5.5.函数递归</h3><p>局部函数变量的一个特性是<strong>自成体系</strong>，除了从脚本命令行处获得的变量，自成体系的函数不需要使用任何外部资源。这个特性使得函数可以递归地调用，也就是说，函数可以调用自己来得到结果。<br>通常递归函数都有一个最终可以迭代到的基准值。许多高级数学算法用递归对复杂的方程进行逐级规约，直到基准值定义的那级。递归算法的经典例子是计算阶乘：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> factorial &#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$1</span> -eq 1 ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> 1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">local</span> temp=$[ <span class="variable">$1</span> - 1 ]</span><br><span class="line">        <span class="built_in">local</span> result=$(factorial <span class="variable">$temp</span>)</span><br><span class="line">        <span class="built_in">echo</span> $[ <span class="variable">$result</span> * <span class="variable">$1</span> ]</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;Enter value: &quot;</span> value</span><br><span class="line">result=$(factorial <span class="variable">$value</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The factorial of <span class="variable">$value</span> is: <span class="variable">$result</span>&quot;</span></span><br></pre></td></tr></table></figure><br>运行结果如下：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201209计算简单阶乘.png" alt="计算简单阶乘"></p><h3 id="5-6-创建库"><a href="#5-6-创建库" class="headerlink" title="5.6.创建库"></a>5.6.创建库</h3><p>bash shell允许创建函数<strong>库文件</strong>，然后在多个脚本中引用该库文件。<br>第一步需要创建一个包含脚本中所需函数的公用库文件，例如定义了3个简单的函数的库文件<code>myfuncs</code>。第二步就是在用到这些函数的脚本文件中包含该库文件，但是问题就来了。</p><blockquote><p>和环境变量一样，shell函数仅在定义它的shell会话内有效。如果你在shell命令行界面的提示符下运行<code>myfuncs</code>的shell脚本，shell会创建一个新的shell并在其中运行这个脚本。它会为那个新shell定义这三个函数，但当你运行另外一个要用到这些函数的脚本时，它们是无法使用的。<br>这同样适用于脚本：如果你尝试像普通脚本文件那样运行库文件，函数并不会出现在脚本中。例如运行下例将报错<code>addem: command not found</code>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">./myfuncs</span><br><span class="line"><span class="comment"># 库文件中的函数addem将两数相加</span></span><br><span class="line">result=$(addem 10 15)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The result is <span class="variable">$result</span>&quot;</span></span><br></pre></td></tr></table></figure></p></blockquote><p>使用函数库的关键在于<code>source</code>命令。 <code>source</code>命令会在当前shell上下文中执行命令，而不是创建一个新shell。可以用<code>source</code>命令来在shell脚本中运行库文件脚本。这样脚本就可以使用库中的函数了。<br><code>source</code>命令有个快捷的别名<code>.</code>，称作点操作符（dot operator）。要在shell脚本中运行<code>myfuncs</code>库文件，只需添加：<code>. ./myfuncs</code>。如果库文件和shell脚本不是位于同一目录，则需要使用相应路径访问该库文件。</p><h3 id="5-7-在命令行上使用函数"><a href="#5-7-在命令行上使用函数" class="headerlink" title="5.7.在命令行上使用函数"></a>5.7.在命令行上使用函数</h3><p>和在shell脚本中将脚本函数当命令使用一样，在命令行界面的提示符下你也可以直接使用这些函数。一旦在shell中定义了函数，你就可以在整个系统中使用它了，无需担心脚本是不是在<code>PATH</code>环境变量里。<br><strong>重点在于让shell能够识别这些函数</strong>，有以下两种方法：</p><ul><li>在命令行上创建函数；</li><li>在<code>.bashrc</code>文件中定义函数。</li></ul><p>对于简单的函数，可以在命令行上直接定义一个函数，因为shell会解释用户输入的命令。如果采用<strong>单行方式定义函数</strong>，必须在每个命令后面加个分号，这样shell就能知道在哪里是命令的起止了；如果采用<strong>多行方式定义函数</strong>，则不需要添加分号，只需要回车即可。如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/shell/20201209命令行上使用函数.png" alt="命令行上使用函数"><br><strong>注意：</strong>在命令行上创建函数时，如果你给函数起了个跟内建命令或另一个命令相同的名字，函数将会覆盖原来的命令。</p><hr><p>在命令行上创建函数不仅输入不便，而且最主要的问题是退出shell时函数就消失了。最简单的解决办法就是将函数定义在<code>.bashrc</code>文件中，bash shell在每次启动时都会在主目录下查找这个文件，不管是交互式shell还是从现有shell中启动的新shell。</p><ul><li><strong>直接定义函数</strong>，可以直接在主目录下的<code>.bashrc</code>文件中定义函数。许多Linux发行版已经在<code>.bashrc</code>文件中定义了一些东西，所以注意不要误删了，把你写的函数放在文件末尾就行了。</li><li><strong>读取函数文件</strong>，只要是在shell脚本中，都可以用<code>source</code>命令（或者它的别名<code>.</code>操作符）将库文件中的函数添加到<code>.bashrc</code>脚本中。 shell还会将定义好的函数传给子shell进程，这样一来，这些函数就自动能够用于该shell会话中的任何shell脚本了。</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：从11月27日到12月9日，大概花了一个星期的时间，终于啃完了621页的《Linux命令行与shell脚本编程大全》。</summary>
    
    
    
    <category term="Linux" scheme="https://hwame.top/categories/Linux/"/>
    
    
    <category term="shell" scheme="https://hwame.top/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>搭建Github图床并利用jsDelivr加速</title>
    <link href="https://hwame.top/20201125/github-pics-with-jsdelivr.html"/>
    <id>https://hwame.top/20201125/github-pics-with-jsdelivr.html</id>
    <published>2020-11-25T03:13:37.000Z</published>
    <updated>2020-11-27T01:56:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：之前都是将博文图片直接放在<code>images</code>文件夹下，图片加载较慢，故搭建<code>Github</code>图床并利用<code>jsDelivr</code>加速（先看<a href="#4-%E5%90%8E%E8%AE%B0">后记</a>有惊喜）。<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>文章链接：</strong><a href="https://hwame.top/20201125/github-pics-with-jsdelivr.html">https://hwame.top/20201125/github-pics-with-jsdelivr.html</a></p></blockquote><h2 id="1-搭建Github图床"><a href="#1-搭建Github图床" class="headerlink" title="1.搭建Github图床"></a>1.搭建Github图床</h2><h3 id="1-1-新建仓库"><a href="#1-1-新建仓库" class="headerlink" title="1.1.新建仓库"></a>1.1.新建仓库</h3><p>登陆<code>Github</code>账户，新建仓库【或直接点击<a href="https://github.com/new">https://github.com/new</a>】，按如下设置后点击<code>Create repository</code>，如图所示：</p><ul><li><code>Repository name</code>：仓库名称（英文），即图床名；</li><li><code>Description</code>：描述；</li><li><code>Public/Private</code>：选择公开；</li><li><code>Add a README file</code>：使用<code>README.md</code>初始化，可选。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/hexo/20201125新建仓库.png" alt="新建仓库"></p><h3 id="1-2-上传图片"><a href="#1-2-上传图片" class="headerlink" title="1.2.上传图片"></a>1.2.上传图片</h3><p>仓库创建完成后，就已经可以直接使用了。<br>可以直接在网页端点击<code>Add file</code>→<code>Upload files</code>即可上传文件/文件夹，如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/hexo/20201125上传文件.png" alt="上传图片"></p><p>也可以使用其他软件，如PicGo等【需要访问令牌，见下文】。</p><h3 id="1-3-使用图片"><a href="#1-3-使用图片" class="headerlink" title="1.3.使用图片"></a>1.3.使用图片</h3><p>对于仓库中的文件（图片），有以下两种方式：<br><strong>说明：</strong>使用<code>jsDelivr</code>的<code>CDN</code>加速服务，它可以加速Github仓库的文件，免费且无需注册、无需额外配置，只需要一个正确的<code>URL</code>即可。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接引用</span></span><br><span class="line">![图片描述](https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/username/</span>repos<span class="regexp">/branch/</span>path/xxx.png)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用CDN加速</span></span><br><span class="line">![图片描述](https:<span class="regexp">//</span>cdn.jsdelivr.net<span class="regexp">/gh/u</span>sername<span class="regexp">/repos@version/</span>path/xxx.png)</span><br></pre></td></tr></table></figure><br>以下是两种方式使用效果，感受一下加载速度的区别：</p><ul><li><a href="https://raw.githubusercontent.com/hwame/pics/main/avatar.jpg">https://raw.githubusercontent.com/hwame/pics/main/avatar.jpg</a></li><li><a href="https://cdn.jsdelivr.net/gh/hwame/pics@main/avatar.jpg">https://cdn.jsdelivr.net/gh/hwame/pics@main/avatar.jpg</a></li></ul><hr><h2 id="2-使用PicGo上传图片"><a href="#2-使用PicGo上传图片" class="headerlink" title="2.使用PicGo上传图片"></a>2.使用PicGo上传图片</h2><h3 id="2-1-说明"><a href="#2-1-说明" class="headerlink" title="2.1.说明"></a>2.1.说明</h3><p><a href="https://github.com/Molunerfinn/PicGo">PicGo</a>是一个用于快速上传图片并获取图片<code>URL</code>链接的开源工具，使用它可以解放写作双手、提高生产力。使用PicGo的原因仅仅是因为能够方便地将上传图片到Github，并直接获取jsDelivr的加速后的图片地址。</p><p>下载地址：<a href="https://github.com/Molunerfinn/PicGo/releases">https://github.com/Molunerfinn/PicGo/releases</a></p><p><strong>说明：</strong>由于使用PicGo上传文件需要获取控制仓库的权限，因此需要访问令牌，如果不需要借助第三方工具上传，则无需此步骤，自行取舍（比如我还是喜欢自己动动手）。<br><strong>说明：</strong>由于我未使用第三方工具，此部分主要目的是解释一下token并不是必须的，内容参考<a href="https://blog.iljw.me/">如风蒹葭</a>的文章<a href="https://blog.iljw.me/2019/05/jsdelivr-cdn-github.html">使用 jsDelivr CDN 加速 Github 仓库的图片，以作为博客的图床</a>。</p><h3 id="2-2-生成令牌"><a href="#2-2-生成令牌" class="headerlink" title="2.2.生成令牌"></a>2.2.生成令牌</h3><p>以此点击头像→<code>Settings</code>→<code>Developer settings</code>→<code>Personal access tokens</code>【或直接点击<a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a>】，可以看到已有的访问令牌，但是口令只显示一次，所以不可复用，需要重新生成。<br>点击<code>Generate new token</code>，可能需要输入密码，在    <code>New personal access token</code>中填写备注、勾选<code>repo</code>整个复选框，如图所示。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/hexo/20201125配置token.png" alt="配置token"></p><p>最后点击<code>Generate token</code>即可，将生成的<code>token</code>【图中打码处】复制保存，<strong>只显示一次，否则需要重新生成</strong>，如图所示。<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/hexo/20201125访问令牌.png" alt="访问令牌"></p><h3 id="2-3-PicGo配置"><a href="#2-3-PicGo配置" class="headerlink" title="2.3.PicGo配置"></a>2.3.PicGo配置</h3><p>下载安装好以后，配置「Github图床」：</p><ul><li>设定仓库名：Github仓库，格式为<code>username/repos</code>，示例：<code>hwame/pics</code>。</li><li>设定分支名：Github仓库的分支，格式为<code>branch</code>，示例：<code>main</code>。<blockquote><p><strong>注意：</strong>由于众所周知的原因，Github新创建的仓库默认分支已不再是<code>master</code>而是<code>main</code>了！！</p></blockquote></li><li>设定<code>Token</code>：即上一步生成的访问令牌。</li><li>指定存储路径：可选。不填则为仓库根目录，建议按图片分类放在不同文件夹下。</li><li>设定自定义域名：此即<code>jsDelivr</code>的配置，格式为<code>https://cdn.jsdelivr.net/gh/username/repos@branch</code>，示例：<code>https://cdn.jsdelivr.net/gh/hwame/pics@main</code><ul><li><code>gh</code>：表示来自<code>Github</code>的内容；</li><li><code>username</code>：Github用户名；</li><li><code>repos</code>：Github仓库；</li><li><code>branch</code>：仓库分支，注意是<code>master</code>还是<code>main</code>。</li></ul></li></ul><h3 id="2-4-PicGo使用"><a href="#2-4-PicGo使用" class="headerlink" title="2.4.PicGo使用"></a>2.4.PicGo使用</h3><p>PicGo配置完成后即可使用了，它支持拖拽、点击、剪贴板上传，上传后，图片链接直接复制的你的剪贴板中，极大地提高了生产效率。</p><hr><h2 id="3-图床迁移"><a href="#3-图床迁移" class="headerlink" title="3.图床迁移"></a>3.图床迁移</h2><p>截至目前，博客使用的「图床」共有以下几种：</p><ul><li><a href="https://imgchr.com/hwamei">路过图床</a>：<ul><li>优点：免费且稳定，可创建多相册，图片可标记</li><li>缺点：需要额外使用邮箱注册账号，内容不易维护</li></ul></li><li><a href="https://www.aliyun.com/">阿里云服务器</a>：<ul><li>优点：对文件拥有绝对权限，可定制程度高，任何部分都可以随心所欲地配置（<del>只要你有钞能力</del>）</li><li>缺点：价格与网络带宽直接挂钩，有使用期限，服务器到期后文件迁移及博客内容更新耗时费力，最主要还是<strong>贵</strong>！</li></ul></li><li><a href="https://raw.githubusercontent.com">直接引用Github图片</a>：<ul><li>直接引用只在「文章缩略图」作为图标引用的，例如<a href="https://raw.githubusercontent.com/hexojs/logo/master/hexo-logo-avatar.png">Hexo Logo</a>，图标文件一般较小，因此没必要放到图床上，不必迁移</li></ul></li><li>直接放在「本地」，和博客文件放在一起：<ul><li>优点：静态文件都在一个地方，管理较为方便</li><li>缺点：<strong>慢！</strong></li></ul></li></ul><p>基于以上因素，我决定将所有图片都放在Github图床上，并使用jsDelivr加速，迁移内容主要有：</p><ul><li>文章图片；</li><li>相册图片；</li><li>最新文章缩略图；</li></ul><p>目前看来体验还不错。最主要的是，Hexo博客的文件和图片文件都托管在Github上了，管理起来很方便，不用担心服务器挂掉或者到期，也不用担心其他图床失效，而且通过jsDelivr加速后图片资源加载速度有明显改善，网站浏览体验满分~</p><hr><h2 id="4-后记"><a href="#4-后记" class="headerlink" title="4.后记"></a>4.后记</h2><p>写到这里其实可以发现，jsDelivr和图片在哪个仓库并没有什么关系！我们不必单独新建仓库，在<code>./themes/pure/source/</code>文件夹下的文件都会直接上传到<code>hwame.github.io</code>仓库的根目录，所以我们在<code>./themes/pure/source/images/</code>下的文件会同步到<code>hwame/hwame.github.io/images/</code>下，因此也可以直接利用jsDelivr加速！</p><p>只需要将原来的图片地址<code>/images/xxx.png</code>对应修改为<code>https://cdn.jsdelivr.net/gh/hwame/hwame.github.io@master/images/xxx.png</code>即可，同一张图片【<a href="https://github.com/hwame/hwame.github.io/blob/master/images/avatar.jpg">Github文件位置</a>】的测试：</p><ul><li><a href="https://hwame.top/images/avatar.jpg">https://hwame.top/images/avatar.jpg</a></li><li><a href="https://cdn.jsdelivr.net/gh/hwame/hwame.github.io@master/images/avatar.jpg">https://cdn.jsdelivr.net/gh/hwame/hwame.github.io@master/images/avatar.jpg</a></li></ul><p><font size=4><b>结论：</b></font><br><u>所以没必要重新创建图床仓库，只需要更新一下文章的图片链接即可。</u></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：之前都是将博文图片直接放在&lt;code&gt;images&lt;/code&gt;文件夹下，图片加载较慢，故搭建&lt;code&gt;Github&lt;/code&gt;图床并利用&lt;code&gt;jsDelivr&lt;/code&gt;加速（先看&lt;a href=&quot;#4-%E5%90%8E%E8%AE%B0&quot;&gt;后记&lt;/a&gt;有惊喜）。</summary>
    
    
    
    <category term="Hexo" scheme="https://hwame.top/categories/Hexo/"/>
    
    
    <category term="Hexo" scheme="https://hwame.top/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>循环中的lambda函数产生的作用域及闭包问题</title>
    <link href="https://hwame.top/20201020/python-lambda-in-a-for-loop.html"/>
    <id>https://hwame.top/20201020/python-lambda-in-a-for-loop.html</id>
    <published>2020-10-20T08:45:08.000Z</published>
    <updated>2020-11-27T06:17:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：在Python循环中定义函数时涉及到的作用域和闭包等问题。<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章作者：</strong><a href="https://hwame.top">鴻塵</a><br><strong>参考内容：</strong></p><ul><li><a href="https://docs.python.org/zh-cn/3/faq/programming.html#why-do-lambdas-defined-in-a-loop-with-different-values-all-return-the-same-result">为什么在具有不同值的循环中定义的lambdas都返回相同的结果？</a></li><li><a href="https://www.jianshu.com/p/4aad4c6baeb1">Python经典的大坑问题：lambda和循环作用域问题</a></li><li><a href="https://stackoverflow.com/questions/19837486/python-lambda-in-a-loop">Python Lambda in a loop</a></li><li><a href="https://stackoverflow.com/questions/2295290/what-do-lambda-function-closures-capture">What do lambda function closures capture?</a></li></ul><p><strong>文章链接：</strong><a href="https://hwame.top/20201020/python-lambda-in-a-for-loop.html">https://hwame.top/20201020/python-lambda-in-a-for-loop.html</a></p></blockquote><h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h2><p>最近有同学问我一个使用<code>scipy</code>进行参数优化的问题，目标函数：</p><script type="math/tex; mode=display">f(x) = \frac{a + x_1}{b + x_2} - c \times x_3 + d \times x_4</script><p>由于涉及到较多的参数和约束条件，因此考虑使用<code>for</code>循环，程序主要代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scipy.optimize <span class="keyword">import</span> minimize</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fun</span>(<span class="params">args</span>):</span><br><span class="line">    <span class="comment"># 目标函数及系数</span></span><br><span class="line">    a, b, c, d = args</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">lambda</span> x: (a + x[<span class="number">0</span>]) / (b + x[<span class="number">1</span>]) - c * x[<span class="number">0</span>] + d * x[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cons</span>():</span><br><span class="line">    <span class="comment"># 约束条件constraints，暂时略过</span></span><br><span class="line">    cons = [fun1, fun2, fun3, fun4, fun5, fun6]</span><br><span class="line">    <span class="keyword">return</span> cons</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    args = (<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>)               <span class="comment"># 定义常量值a, b, c, d</span></span><br><span class="line">    cons = cons()                     <span class="comment"># 生成约束</span></span><br><span class="line">    x0 = np.asarray((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))  <span class="comment"># 设置初始猜测值</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 开始优化</span></span><br><span class="line">    res = minimize(fun(args), x0, method=<span class="string">&#x27;SLSQP&#x27;</span>, constraints=cons)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(res.fun)      <span class="comment"># 优化结果，即最优目标函数值</span></span><br><span class="line">    <span class="built_in">print</span>(res.success)  <span class="comment"># 优化状态，即是否成功</span></span><br><span class="line">    <span class="built_in">print</span>(res.x)        <span class="comment"># 优化结果，即x的最优解</span></span><br></pre></td></tr></table></figure><p>对于约束函数的生成，由于每个 $x$ 分量都有一个上界和下界，范围为$[0.1, 0.9]$，所以约束条件会随分量的增多呈线性增长，因此写死是不现实的，考虑用<code>for</code>循环：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接把所有情况写死</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cons</span>():</span><br><span class="line">    cons = (&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;ineq&#x27;</span>, <span class="string">&#x27;fun&#x27;</span>: <span class="keyword">lambda</span> x:  x[<span class="number">0</span>] - <span class="number">0.1</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;ineq&#x27;</span>, <span class="string">&#x27;fun&#x27;</span>: <span class="keyword">lambda</span> x: -x[<span class="number">0</span>] + <span class="number">0.9</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;ineq&#x27;</span>, <span class="string">&#x27;fun&#x27;</span>: <span class="keyword">lambda</span> x:  x[<span class="number">1</span>] - <span class="number">0.1</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;ineq&#x27;</span>, <span class="string">&#x27;fun&#x27;</span>: <span class="keyword">lambda</span> x: -x[<span class="number">1</span>] + <span class="number">0.9</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;ineq&#x27;</span>, <span class="string">&#x27;fun&#x27;</span>: <span class="keyword">lambda</span> x:  x[<span class="number">2</span>] - <span class="number">0.1</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;ineq&#x27;</span>, <span class="string">&#x27;fun&#x27;</span>: <span class="keyword">lambda</span> x: -x[<span class="number">2</span>] + <span class="number">0.9</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> cons</span><br><span class="line"></span><br><span class="line"><span class="comment"># 借助for循环</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cons</span>():</span><br><span class="line">    cons = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        b = &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;ineq&#x27;</span>, <span class="string">&#x27;fun&#x27;</span>: <span class="keyword">lambda</span> x: x[i] - <span class="number">0.1</span>&#125;</span><br><span class="line">        c = &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;ineq&#x27;</span>, <span class="string">&#x27;fun&#x27;</span>: <span class="keyword">lambda</span> x: <span class="number">0.9</span> - x[i]&#125;</span><br><span class="line">        cons.append(b)</span><br><span class="line">        cons.append(c)</span><br><span class="line">    <span class="keyword">return</span> cons</span><br></pre></td></tr></table></figure></p><h2 id="2-问题描述"><a href="#2-问题描述" class="headerlink" title="2.问题描述"></a>2.问题描述</h2><p>显然，使用循环的方式便于程序的拓展，而且也省时，但是会出一个问题：<strong>生成的<code>cons</code>约束函数只有最后一个生效，且所有函数都相同</strong>。</p><p>这个问题我曾经遇到过，第一反应就确定了问题出在循环上。尽管当时解决了却并没有完全弄懂它，以致于再次遇到还是一脸懵逼，因此查阅了详细的资料，在此记录下来。</p><h2 id="3-原因分析"><a href="#3-原因分析" class="headerlink" title="3.原因分析"></a>3.原因分析</h2><h3 id="3-1-问题引入"><a href="#3-1-问题引入" class="headerlink" title="3.1.问题引入"></a>3.1.问题引入</h3><blockquote><p>借助<a href="https://docs.python.org/zh-cn/3/faq/programming.html#why-do-lambdas-defined-in-a-loop-with-different-values-all-return-the-same-result">官方文档</a>中一个简单的例子来说明。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func = []</span><br><span class="line"><span class="keyword">for</span> myx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    func.append(<span class="keyword">lambda</span>: myx**<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用函数</span></span><br><span class="line">func[<span class="number">0</span>](), func[<span class="number">1</span>](), func[<span class="number">2</span>](), func[<span class="number">3</span>]()</span><br><span class="line"><span class="comment"># 预期结果：(0, 1, 4, 9)</span></span><br><span class="line"><span class="comment"># 实际结果：(9, 9, 9, 9)</span></span><br></pre></td></tr></table></figure><h3 id="3-2-原因解释"><a href="#3-2-原因解释" class="headerlink" title="3.2.原因解释"></a>3.2.原因解释</h3><p>来自<a href="https://docs.python.org/zh-cn/3/faq/programming.html#why-do-lambdas-defined-in-a-loop-with-different-values-all-return-the-same-result">官方文档</a>的解释：</p><blockquote><p>发生这种情况是因为<code>myx</code>不是<code>lambdas</code>的内部变量，而是在<strong>外部作用域</strong>中定义，并且在<strong>调用</strong><code>lambda</code>时访问它——而不是在<strong>定义</strong>它时。<br>当循环结束时，<code>myx</code>的值是3，所以所有的函数现在返回<code>3**2</code>，即9。你可以通过更改<code>myx</code>的值来验证这一点，即使退出了循环，列表中的函数仍然发生了变化且是所有并查看<code>lambdas</code>的结果如何变化:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myx = <span class="number">8</span></span><br><span class="line">func[<span class="number">1</span>]()</span><br><span class="line"><span class="comment"># 输出：64，且func[0](), func[2](), func[3]()皆输出64</span></span><br></pre></td></tr></table></figure></p></blockquote><h3 id="3-3-作用域和闭包"><a href="#3-3-作用域和闭包" class="headerlink" title="3.3.作用域和闭包"></a>3.3.作用域和闭包</h3><p>来自<a href="https://stackoverflow.com/users/181765/max-shawabkeh">Max Shawabkeh</a>的解释，<a href="https://stackoverflow.com/questions/2295290/what-do-lambda-function-closures-capture/2295368#2295368">原文链接</a>：</p><blockquote><p>Scoping in Python is dynamic and lexical. A closure will always remember the name and scope of the variable, not the object it’s pointing to. Since all the functions in your example are created in the same scope and use the same variable name, they always refer to the same variable.</p><p><strong>翻译：</strong>Python的作用域是动态且词汇丰富的。闭包将始终记住变量的名称和范围，而不是其指向的对象。由于示例中的所有函数都是在同一作用域中创建的，并且使用相同的变量名称，因此它们始终引用相同的变量。</p></blockquote><hr><p>来自<a href="https://stackoverflow.com/users/15055/claudiu">Claudiu</a>的解释：</p><blockquote><p>Python has static scoping, not dynamic scoping.. it’s just all variables are references, so when you set a variable to a new object, the variable itself (the reference) has the same location, but it points to something else.</p><p><strong>翻译：</strong>Python具有静态作用域，而不是动态作用域。它只是所有变量都是引用，因此当您将变量设置为新对象时，变量本身（引用）具有相同的位置，但指向其他对象。</p></blockquote><hr><p>来自<a href="https://www.jianshu.com/u/04c94aef17d6">欢喜明</a>的解释，<a href="https://www.jianshu.com/p/4aad4c6baeb1">原文链接</a>：</p><blockquote><p>函数在定义的时候，并没有分配内存空间用来保存任何变量的值，只有在执行的时候才会分配空间保存变量的值。</p><p>Python的作用域由<code>def</code>、<code>class</code>、<code>lambda</code>等语句产生，而<code>if</code>、<code>try</code>、<code>for</code>等语句并不会产生新的作用域。</p><p>Python变量名引用的查找顺序为：</p><ul><li>①<strong>本地作用域（Local）</strong>；</li><li>②<strong>外围作用域</strong>，即当前作用域是一个内嵌作用域（Enclosing Locals）；</li><li>③<strong>全局/模块作用域（Global）</strong>，即模块内的作用域，其作用范围是单一文件内；</li><li>④<strong>内置作用域（Built-in）</strong>。</li></ul></blockquote><hr><p>来自<a href="https://www.zhihu.com/people/wudikucha">千山飞雪</a>的解释，<a href="https://zhuanlan.zhihu.com/p/22229197">原文链接</a>：</p><blockquote><p>在一个内部函数中，对外部作用域的变量进行引用，(并且一般外部函数的返回值为内部函数)，那么内部函数就被认为是闭包。</p><p>闭包无法修改外部函数的局部变量；python循环中不包含域的概念。</p></blockquote><hr><p>来自<a href="https://stackoverflow.com/users/197325/walter-mundt">Walter Mundt</a>的解释，<a href="https://stackoverflow.com/questions/11408515/about-python-closure/11408601#11408601">原文链接</a>：</p><blockquote><p>The corollary is that the outer function can change <code>i</code> but the inner function cannot (since that would make <code>i</code> a local instead of a closure based on Python’s syntactic rules).</p><p><strong>翻译：</strong>结论是外部函数可以更改<code>i</code>，而内部函数则不能（因为这将使<code>i</code>成为局部变量，而不是基于Python语法规则的闭包）。</p></blockquote><h3 id="3-4-解决方案"><a href="#3-4-解决方案" class="headerlink" title="3.4.解决方案"></a>3.4.解决方案</h3><blockquote><p>以上文所举的<a href="#3-1-%E9%97%AE%E9%A2%98%E5%BC%95%E5%85%A5">一个简单的例子</a>来说明。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一个简单的例子</span></span><br><span class="line">func = []</span><br><span class="line"><span class="keyword">for</span> myx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    func.append(<span class="keyword">lambda</span>: myx**<span class="number">2</span>)</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="方案一：带默认值的参数"><a href="#方案一：带默认值的参数" class="headerlink" title="方案一：带默认值的参数"></a>方案一：带默认值的参数</h4><p><strong>①</strong>使用具有默认值的参数来强制捕获变量，即<a href="https://docs.python.org/zh-cn/3/faq/programming.html#why-do-lambdas-defined-in-a-loop-with-different-values-all-return-the-same-result">官方文档</a>所谓之<strong>「将值保存在<code>lambdas</code>的局部变量中」</strong>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func = []</span><br><span class="line"><span class="keyword">for</span> myx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    func.append(<span class="keyword">lambda</span> tmp=myx: tmp**<span class="number">2</span>)</span><br></pre></td></tr></table></figure><br><strong>②</strong>上述方法①等价的写法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func = []</span><br><span class="line"><span class="keyword">for</span> myx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">myfunc</span>(<span class="params">tmp=myx</span>):</span><br><span class="line">        <span class="keyword">return</span> tmp**<span class="number">2</span></span><br><span class="line">    func.append(myfunc)</span><br></pre></td></tr></table></figure></p><h4 id="方案二：使内部函数成为闭包"><a href="#方案二：使内部函数成为闭包" class="headerlink" title="方案二：使内部函数成为闭包"></a>方案二：使内部函数成为闭包</h4><p><strong>①</strong>创建一个外部函数包裹内部函数，使内部函数成为闭包，<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func = []</span><br><span class="line"><span class="keyword">for</span> myx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">makefunc</span>(<span class="params">myx</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">myfunc</span>():</span><br><span class="line">            <span class="keyword">return</span> myx**<span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> myfunc</span><br><span class="line">    func.append(makefunc(myx))</span><br></pre></td></tr></table></figure><br><strong>②</strong>上述方法①可以简化为使用单个的<code>makefunc()</code>函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">makefunc</span>(<span class="params">myx</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">myfunc</span>():</span><br><span class="line">        <span class="keyword">return</span> myx**<span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> myfunc</span><br><span class="line"></span><br><span class="line">func = []</span><br><span class="line"><span class="keyword">for</span> myx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    func.append(makefunc(myx))</span><br></pre></td></tr></table></figure><br><strong>③</strong>当内部函数较为简单时，可以使用<code>lambda</code>简化代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">makefunc</span>(<span class="params">param</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">lambda</span>: param**<span class="number">2</span></span><br><span class="line"></span><br><span class="line">func = []</span><br><span class="line"><span class="keyword">for</span> myx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    func.append(makefunc(myx))</span><br></pre></td></tr></table></figure><br><strong>④</strong>同样，可以使用<strong>嵌套</strong>的<code>lambda</code>函数简化上述方法①的代码，这可能看起来不太直观：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func = []</span><br><span class="line"><span class="keyword">for</span> myx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    func.append((<span class="keyword">lambda</span> myx: <span class="keyword">lambda</span>: myx**<span class="number">2</span>)(myx))</span><br></pre></td></tr></table></figure></p><h4 id="方案三：使用标准库函数partial"><a href="#方案三：使用标准库函数partial" class="headerlink" title="方案三：使用标准库函数partial"></a>方案三：使用标准库函数<code>partial</code></h4><p>Python的<code>functools</code>模块提供了「偏函数<code>partial</code>」，其返回一个新的「<code>partial</code>对象」（<a href="https://docs.python.org/zh-cn/3/library/functools.html#partial-objects">参考这里</a>），它会被「冻结了」一部分函数参数和/或关键字的部分函数应用所使用，从而得到一个具有简化签名的新对象。<a href="https://docs.python.org/zh-cn/3/library/functools.html#functools.partial">官方文档</a>如图所示：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20201127functools.partial.png" alt="偏函数functools.partial官方文档"> </p><p>其他参考资料：</p><ul><li><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017454145929440">廖雪峰的官方网站之偏函数</a>；</li><li><a href="https://wiki.jikexueyuan.com/project/explore-python/Functional/partial.html">极客学院之Python的partial函数</a>；</li><li><a href="https://www.runoob.com/w3cnote/python-partial.html">菜鸟教程之Python偏函数</a>；</li></ul><p>方案三代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line">func = []</span><br><span class="line"><span class="keyword">for</span> myx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    func.append(partial(<span class="keyword">lambda</span> param: param**<span class="number">2</span>, myx))</span><br></pre></td></tr></table></figure></p><p><a href="https://stackoverflow.com/users/7851470/georgy">Georgy</a>认为，<code>lambda</code>可以使用<code>functools.partial</code>来代替，这是一种语法更简单的方法。以下是一个便于理解的例子，<a href="https://stackoverflow.com/questions/19837486/python-lambda-in-a-loop/57288183#57288183">原文链接</a>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nums = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">lambdas = [<span class="keyword">lambda</span>: <span class="built_in">print</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> nums]</span><br><span class="line">binding = [<span class="keyword">lambda</span> i=i: <span class="built_in">print</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> nums]</span><br><span class="line">partials = [partial(<span class="built_in">print</span>, i) <span class="keyword">for</span> i <span class="keyword">in</span> nums]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> function <span class="keyword">in</span> lambdas:</span><br><span class="line">    function()  <span class="comment"># 输出：3 3 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> function <span class="keyword">in</span> binding:</span><br><span class="line">    function()  <span class="comment"># 输出：1 2 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> function <span class="keyword">in</span> partials:</span><br><span class="line">    function()  <span class="comment"># 输出：1 2 3</span></span><br></pre></td></tr></table></figure></p><h3 id="3-5-说明"><a href="#3-5-说明" class="headerlink" title="3.5.说明"></a>3.5.说明</h3><ul><li>上述各例中的函数调用时是不需要传参的，这对于需要传参的函数没什么区别。</li><li>本文以循环中的<code>lambda</code>函数引入作用域及闭包问题，但需注意的是<strong>这种行为并不是<code>lambda</code>所特有的，也适用于常规函数</strong>。</li></ul><p>上述各种方案运行结果如下：</p><div class="table-container"><table><thead><tr><th style="text-align:center">方案名</th><th style="text-align:center">描述</th><th style="text-align:center">运行结果</th></tr></thead><tbody><tr><td style="text-align:center">方案一①</td><td style="text-align:center">带默认值的参数，<br>使用<code>lambda</code></td><td style="text-align:center"><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20201128164732.png" alt="方案一①结果"></td></tr><tr><td style="text-align:center">方案一②</td><td style="text-align:center">带默认值的参数，<br>不使用<code>lambda</code></td><td style="text-align:center"><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20201128164854.png" alt="方案一②结果"></td></tr><tr><td style="text-align:center">方案二①</td><td style="text-align:center">使内部函数成为闭包，<br>函数置于循环中</td><td style="text-align:center"><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20201128164953.png" alt="方案二①结果"></td></tr><tr><td style="text-align:center">方案二②</td><td style="text-align:center">使内部函数成为闭包，<br>使用单个的<code>makefunc()</code>函数</td><td style="text-align:center"><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20201128165128.png" alt="方案二②结果"></td></tr><tr><td style="text-align:center">方案二③</td><td style="text-align:center">使内部函数成为闭包，<br>使用<code>lambda</code>的单个函数</td><td style="text-align:center"><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20201128165223.png" alt="方案二③结果"></td></tr><tr><td style="text-align:center">方案二④</td><td style="text-align:center">使内部函数成为闭包，<br>使用嵌套的<code>lambda</code>的函数</td><td style="text-align:center"><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20201128165328.png" alt="方案二④结果"></td></tr><tr><td style="text-align:center">方案三</td><td style="text-align:center">使用标准库函数<br><code>functools.partial</code></td><td style="text-align:center"><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20201128165433.png" alt="方案三结果"></td></tr></tbody></table></div><h2 id="4-实际问题的解决办法"><a href="#4-实际问题的解决办法" class="headerlink" title="4.实际问题的解决办法"></a>4.实际问题的解决办法</h2><p>至此，解决方案很简单了，只需要绑定外部变量到<code>lambda</code>函数中即可，就像在函数中设置默认值一样<code>def myfunc(x, tmp=i)</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">cons</span>():</span><br><span class="line">    cons = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        b = &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;ineq&#x27;</span>, <span class="string">&#x27;fun&#x27;</span>: <span class="keyword">lambda</span> x, tmp=i: x[tmp] - <span class="number">0.1</span>&#125;</span><br><span class="line">        c = &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;ineq&#x27;</span>, <span class="string">&#x27;fun&#x27;</span>: <span class="keyword">lambda</span> x, tmp=i: <span class="number">0.9</span> - x[tmp]&#125;</span><br><span class="line">        cons.append(b)</span><br><span class="line">        cons.append(c)</span><br><span class="line">    <span class="keyword">return</span> cons</span><br></pre></td></tr></table></figure><br>当然，也可以使用上文提到的另外的方法。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：在Python循环中定义函数时涉及到的作用域和闭包等问题。</summary>
    
    
    
    <category term="python" scheme="https://hwame.top/categories/python/"/>
    
    
    <category term="python" scheme="https://hwame.top/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>如何将matplotlib图像渲染到前端</title>
    <link href="https://hwame.top/20201008/render-matplotlib-figure-to-flaskweb.html"/>
    <id>https://hwame.top/20201008/render-matplotlib-figure-to-flaskweb.html</id>
    <published>2020-10-08T01:06:32.000Z</published>
    <updated>2020-10-08T07:26:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>摘要：<code>matplotlib</code>结合<code>seaborn</code>二维绘图功能强大，可以绘制<code>eCharts</code>画不出的图像，因此考虑直接将<code>matplotlib</code>图像渲染到前端。<span id="more"></span></p><blockquote><p><font size=5><b>文章说明</b></font><br><strong>文章说明：</strong>前端绘图一般是用百度<code>eCharts</code>，但其样式不够丰富且可定制化程度不高，有时无法满足需求，因此直接将<code>python</code>的<code>matplotlib</code>数据可视化渲染到前端。<br><strong>另请参考：</strong><a href="https://blog.csdn.net/qq965194745/article/details/80034291"><code>python</code>将<code>matplotlib</code>输出到web</a><br><strong>另请参考：</strong><a href="https://xungejiang.com/2018/08/04/matplotlib-html/">如何将<code>Matplotlib</code>图像展示在web页面上</a><br><strong>另请参考：</strong><a href="https://www.codenong.com/cs106837014/">Mac使用<code>matplotlib.pyplot</code>画图出现中文乱码</a><br><strong>文章作者：</strong>鴻塵<br><strong>文章链接：</strong><a href="https://hwame.top/20201008/render-matplotlib-figure-to-flaskweb.html">https://hwame.top/20201008/render-matplotlib-figure-to-flaskweb.html</a></p></blockquote><h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><p>前端页面的数据可视化一般是用百度<code>eCharts</code>，但其样式不够丰富且可定制化程度不高，有时无法满足需求。<br>最近需要在前端展示相关图（Correlogram），<code>python</code>中可以使用<code>matplotlib</code>结合<code>seaborn</code>轻松实现，但<a href="https://echarts.apache.org/examples/zh/index.html">eCharts实例</a>中没有类似的样例，因此考虑直接将<code>matplotlib</code>图像渲染到前端。</p><h2 id="二、思路"><a href="#二、思路" class="headerlink" title="二、思路"></a>二、思路</h2><h3 id="1-保存图片到服务器static目录"><a href="#1-保存图片到服务器static目录" class="headerlink" title="1.保存图片到服务器static目录"></a>1.保存图片到服务器<code>static</code>目录</h3><p>将画好的图片保存在服务器的<code>static</code>目录下，前端再从该目录读取图片进行展示。这种思路很直接，是最容易想到的，但是存在以下问题：</p><ul><li>无法判断响应时间。因为图像生成是通过前端用户传递一系列参数，再根据这些参数计算相应的数据，利用计算的数据进行可视化，因此后端生成图片的时间未知，所以只能采用在前端延时展示。</li><li>前端访问<code>static</code>目录不方便。前端<code>VUE</code>＋后端<code>Flask</code>的前后端分离的项目中，前端访问<code>static</code>目录不方便。</li><li>占用服务器内存和带宽。将图片保存在服务器，前端从服务器获取资源时会占用一部分网络带宽，影响到前端资源加载的速度，并且图片累积将会占用服务器内存。</li></ul><h3 id="2-使用请求的方式将图像传到前端"><a href="#2-使用请求的方式将图像传到前端" class="headerlink" title="2.使用请求的方式将图像传到前端"></a>2.使用请求的方式将图像传到前端</h3><p>将图像以请求的方式传到前端，前端只需将<code>&lt;img&gt;</code>标签的<code>src</code>属性赋值为后端的请求路径即可。<br>该方法可以在后端生成完图像后再发送给前端，无需设置延时获取图像。拟采用该方法。</p><h3 id="3-将图像以Base64格式发送给前端"><a href="#3-将图像以Base64格式发送给前端" class="headerlink" title="3.将图像以Base64格式发送给前端"></a>3.将图像以<code>Base64</code>格式发送给前端</h3><p>这种思路和思路2类似，但是区别在于调用<code>savefig</code>方法时不存储为图像，而是存储为二进制格式，二进制格式再转化为<code>Base64</code>字符串格式，并将其发送给前端，前端只需要将<code>&lt;img&gt;</code>标签的<code>src</code>属性赋值为该字符串即可。</p><h2 id="三、代码实现"><a href="#三、代码实现" class="headerlink" title="三、代码实现"></a>三、代码实现</h2><p>对比三种方法，显然思路3为最优解：</p><ul><li>在后端生成完图像后再发送给前端，无需设置延时获取图像；</li><li>只需要往前端发送一次请求，代码更加精简；</li><li>调用了 savefig 方法，可以去除白边。</li></ul><p>接口使用<code>python</code>的<code>flask</code>框架，代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line">matplotlib.use(<span class="string">&#x27;Agg&#x27;</span>)  <span class="comment"># 不出现画图的框</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/correlation&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">correlation</span>():</span><br><span class="line">    data = df.corr()</span><br><span class="line">    <span class="comment"># 开始画图</span></span><br><span class="line">    plt.figure(figsize=(<span class="number">12</span>, <span class="number">10</span>), dpi=<span class="number">80</span>)</span><br><span class="line">    sns.heatmap(data, xticklabels=data.columns, yticklabels=data.columns, cmap=<span class="string">&#x27;RdYlGn&#x27;</span>, center=<span class="number">0</span>, annot=<span class="literal">True</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Correlogram&#x27;</span>, fontsize=<span class="number">22</span>)</span><br><span class="line">    plt.xticks(fontsize=<span class="number">12</span>)</span><br><span class="line">    plt.yticks(fontsize=<span class="number">12</span>)</span><br><span class="line">    <span class="comment"># plt.show()</span></span><br><span class="line">    <span class="comment"># 转成图片的步骤</span></span><br><span class="line">    sio = BytesIO()</span><br><span class="line">    plt.savefig(sio, <span class="built_in">format</span>=<span class="string">&#x27;png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>, pad_inches=<span class="number">0.0</span>)</span><br><span class="line">    data = base64.encodebytes(sio.getvalue()).decode()</span><br><span class="line">    src = <span class="string">&quot;data:image/png;base64,&#123;&#125;&quot;</span>.<span class="built_in">format</span>(data)</span><br><span class="line">    plt.close()  <span class="comment"># 记得关闭，不然画出来的图是重复的</span></span><br><span class="line">    <span class="keyword">return</span> src</span><br></pre></td></tr></table></figure></p><h2 id="四、效果预览"><a href="#四、效果预览" class="headerlink" title="四、效果预览"></a>四、效果预览</h2><p>前端通过请求获取该<code>src</code>后，只需将其赋值给<code>&lt;img&gt;</code>标签的<code>src</code>属性即可：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;&#123;src&#125;&#125;</span>&gt;</span></span><br></pre></td></tr></table></figure><br>预览图如下：<br><img src="https://cdn.jsdelivr.net/gh/hwame/pics@main/few-pics/20201008效果预览.png" alt="效果预览图"></p><h2 id="五、部署问题"><a href="#五、部署问题" class="headerlink" title="五、部署问题"></a>五、部署问题</h2><h3 id="1-无GUI图形界面"><a href="#1-无GUI图形界面" class="headerlink" title="1.无GUI图形界面"></a>1.无GUI图形界面</h3><p>服务器是不带GUI界面的<code>CentOS 7</code>，但是<code>matplotlib.pyplot</code>是需要<code>tkinter</code>库的支持的：<code>_tkinter.TclError: no display name and no $DISPLAY environment variable</code>。<br>然而，我们并不需要安装<code>tkinter</code>、<code>tcl-devel</code>和<code>tk-devel</code>等，因为<strong>我们并不是需要在<code>Linux</code>上看到画出的图</strong>，只需要改一下后端<code>agg</code>即可【貌似<code>Linux</code>下默认后端已是<code>Agg</code>，从配置文件可以看到】，代码如下：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib <span class="keyword">as</span> mpl</span><br><span class="line">mpl.use(<span class="string">&#x27;Agg&#x27;</span>)</span><br><span class="line"># 在<span class="keyword">from</span> matplotlib <span class="keyword">import</span> pylot之前添加mpl.use(<span class="string">&#x27;Agg&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pylot</span><br></pre></td></tr></table></figure></p><h3 id="2-中文字体乱码"><a href="#2-中文字体乱码" class="headerlink" title="2.中文字体乱码"></a>2.中文字体乱码</h3><h4 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h4><p>由于<code>matplotlib</code>没有中文字体，直接会报错：<code>RuntimeWarning: Glyph xxxxx missing from current font.</code>，网上有说需要添加两行代码（在缺少字体文件的情况下，这种方法无效），即：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plt<span class="selector-class">.rcParams</span><span class="selector-attr">[<span class="string">&#x27;font.sans-serif&#x27;</span>]</span> = <span class="selector-attr">[<span class="string">&#x27;SimHei&#x27;</span>]</span></span><br><span class="line">#设置字体，设置了字体后，负号会变成乱码</span><br><span class="line"></span><br><span class="line">plt<span class="selector-class">.rcParams</span><span class="selector-attr">[<span class="string">&#x27;axes.unicode_minus&#x27;</span>]</span> = False</span><br><span class="line">#让负号的乱码正常显示</span><br></pre></td></tr></table></figure></p><p>因为没有<strong>黑体</strong>这个字体，所以仍会报错，因此需要手动下载对应字体。并将其复制到对应位置：<code>./python3.6/site-packages/matplotlib/mpl-data/fonts/ttf/</code>。</p><h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p>解决字体缺失的问题后，还需要修改配置文件<code>matplotlibrc</code>，文件位置：<code>./python3.6/site-packages/matplotlib/mpl-data/matplotlibrc</code>。直接修改配置文件的好处是，不需要每次都在程序代码中添加诸如<code>plt.rcParams[&#39;font.sans-serif&#39;] = [&#39;SimHei&#39;]</code>的配置项。</p><ul><li>将<code>#font.family  : sans-serif</code>修改为<code>font.family  : sans-serif</code>（去掉注释）</li><li>将<code>#font.sans-serif  : DejaVu Serif, ...</code>修改为<code>font.sans-serif  : SimHei, DejaVu Serif, ...</code>（去掉注释，添加<code>SimHei</code>）</li><li>将<code>#axes.unicode_minus  : True</code>修改为<code>axes.unicode_minus  : False</code>（去掉注释，属性设置为<code>False</code>）</li></ul><p><strong>说明：</strong>黑体<code>SimHei</code>也可以改为其他字体，最接近宋体和Times New Roman的是<code>STSong</code>，参考<a href="https://hwame.top/20200521/customize-matplotlib-fonts.html">如何使matplotlib同时使用宋体和Times New Roman</a>。</p><h4 id="删除matplotlib缓存"><a href="#删除matplotlib缓存" class="headerlink" title="删除matplotlib缓存"></a>删除<code>matplotlib</code>缓存</h4><p><code>Linux</code>上的<code>matplotlib</code>缓存文件位于用户家目录下的”~/.cache/matplotlib/“，可以看到其下包含了缓存文件<code>fontlist-v310.json</code>及缓存文件夹<code>tex.cache</code>。若不删除缓存，可能看不到配置生效。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf ~/.cache/matplotlib/</span><br></pre></td></tr></table></figure></p><h3 id="3-其他"><a href="#3-其他" class="headerlink" title="3.其他"></a>3.其他</h3><p>任何人都没法保证自己写的代码没有bug，而且测试时也不可能考虑到所有的情况。一旦程序部署上线作为服务运行，出现问题用户也只能看到<code>50x</code>的错误，因此要养成善于查看日志的习惯！从日志入手，才能分析问题出现的原因，从而能打补丁、修bug、改代码，使程序更健壮、服务更稳定。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;摘要：&lt;code&gt;matplotlib&lt;/code&gt;结合&lt;code&gt;seaborn&lt;/code&gt;二维绘图功能强大，可以绘制&lt;code&gt;eCharts&lt;/code&gt;画不出的图像，因此考虑直接将&lt;code&gt;matplotlib&lt;/code&gt;图像渲染到前端。</summary>
    
    
    
    <category term="python" scheme="https://hwame.top/categories/python/"/>
    
    
    <category term="Linux" scheme="https://hwame.top/tags/Linux/"/>
    
    <category term="python" scheme="https://hwame.top/tags/python/"/>
    
    <category term="matplotlib" scheme="https://hwame.top/tags/matplotlib/"/>
    
  </entry>
  
</feed>
